---
original: 4fa583e01aac2244fc54cd7e5eb428d9c3f72c755ecacd3d86a7f941dd9b5036
---

---
eip: 1959
title: chainIDがチェーンの履歴の一部であるかどうかを確認する新しいオペコード
author: Ronan Sandford (@wighawag)
category: Core
type: Standards Track
discussions-to: https://ethereum-magicians.org/t/eip-1959-valid-chainid-opcode/3170
status: Stagnant
created: 2019-04-20
requires: 155
---


## 簡単な要約
オフチェーンのメッセージがさまざまなチェーン間で再利用されるのを防ぐために、スマートコントラクトにそのチェーンのみを受け入れるメカニズムを提供する必要があります。チェーンはchainIDを変更できるため、メカニズムは古いchainIDも有効と見なす必要があります。

## 概要
このEIPは、指定された数値がチェーンの履歴(現在のchainIDを含む)の中で有効なchainID(EIP-155の一意の識別子)であったかどうかを返すオペコードを追加します。

## 動機
[EIP-155](./eip-155.md)は、異なるチェーン間の再生攻撃を防ぐためにchainIDの使用を提案しています。[EIP-712](./eip-712.md)を使用するレイヤー2の署名スキームを処理する際に、同様の機能をスマートコントラクト内で持つことは大変有益です。

[EIP-1344](./eip-1344.md)はこの問題を解決しようとしていますが、chainIDの履歴の先端にアクセスすることしかできません。これは不十分です。なぜなら、その値は変化し続けるためです。そのため、EIP-1344はこの問題を回避するためにコントラクトベースのソリューションを記述しています。より単純で、より安価で、より安全な方法で解決することが望ましいです。EIP-1344に存在する潜在的なリスクを排除することができます。

## 仕様
新しいオペコード ```VALID_CHAINID``` を0x46に追加します。これは1つのスタック引数を使用します: chainIDをテストする32バイトの値。chainIDの履歴(ジェネシスから)に含まれている場合は```0x1```を、そうでない場合は```0x0```をスタックにプッシュします。

この操作の実行コストは`G_blockhash`です。

操作コストは、チェーンのchainID履歴の長さが増えるにつれて後で調整する必要があるかもしれません。

ただし、古いchainIDを追跡するための代替手段であるEIP-1344が提案するスマートコントラクトベースのキャッシュソリューションは、全体的により高いガスコストがかかります。したがって、ガスコストは単にこの機能に必要な必要コストです。

## 根拠
現在利用可能なアプローチは、コンパイル時にチェーンIDを指定することです。このアプローチを使用すると、contentious hardforkの後に問題が発生します。なぜなら、新しいchainIDで署名されたメッセージをコントラクトが受け入れられなくなるためです。

EIP-1344が提案するアプローチは、最新のchainIDにアクセスすることです。これ自体では十分ではなく、上述の問題とは逆の問題を引き起こします。なぜなら、chainIDを変更するhardforkが発生した場合、[EIP-712](./eip-712.md)に従って(以前のchainIDで)署名されたすべてのL2メッセージがコントラクトによって受け入れられなくなるためです。

そのため、EIP-1344の根拠では、ユーザーがスマートコントラクトを介した信頼できるキャッシュメカニズムを実装/使用して、過去のchainIDの有効性を確認する必要があると述べられています。

これは機能しますが(直前のchainIDが有効と見なされない一時的な間隙を除いて)、chainIDを更新するhardforkの前に署名されたメッセージを受け入れるためには、すべてのコントラクトでこの手順を実行する必要があります。つまり、EIP-1344はそのようなリスクを露呈しており、単に```chainID == CHAIN_ID()```をチェックするだけでは、過去のchainIDを考慮しないコントラクトが簡単に存在する可能性があります。

実際、L2メッセージの検証に最新のchainIDにアクセスすることは危険です。最新のchainIDは、chainID履歴の先端にすぎません。変化する値であるため、最新のchainIDはL2メッセージの有効性を確保するのに適切ではありません。

オフチェーンメッセージに署名するユーザーは、署名時から有効であり続けることを期待しており、将来のhardforkの影響を受けることを期待していません。コントラクトが最新のchainIDをそのまま検証に使用する場合、chainIDを更新するhardforkが発生すると、メッセージは無効になります。一部のアプリケーションでは、ユーザーが新しいメッセージを再送信する必要があり(メタトランザクションを考えてみてください)、ユーザーに潜在的な損失(またはhardforkの移行中の不便)を引き起こす可能性があります。他のアプリケーションでは(ステートチャンネルなど)、オフチェーンの状態全体が利用できなくなり、潜在的に深刻な事態を招く可能性があります。

言い換えると、有効なchainIDで署名されたすべてのオフチェーンメッセージを、チェーンのオフチェーンステートの一部と見なすべきです。ここで提案されているオペコードは、スマートコントラクトに、オフチェーンステートがフォーク間で有効に保たれるようにする簡単で安全な方法を提供します。

リプレイ保護に関しては、有効なchainIDで署名されたすべてのオフチェーンメッセージをチェーンのオフチェーンステートの一部と見なすというアイデアは、共通のchainID履歴(分岐点まで)を共有する異なるフォーク間でこれらのオフチェーンメッセージを再利用できることを意味します。これは実際に重要な機能です。なぜなら、ユーザーは署名時から有効であり続けることを期待しているためです。その時点から、これらのメッセージはチェーンのオフチェーンステートの一部と見なされるべきです。hardforkでそれらを無効にすべきではありません。これは、以前のオンチェーンステートが2つのhardfork間で共有されるのと同様です。

ウォレットは、常に使用中のチェーンの最新のchainIDを使用してサインメッセージリクエストを行うようにします。これにより、異なるchainID履歴を持つチェーンへの再生攻撃を防ぐことができます(同じ最新のchainIDを持っていないため)。

[EIP1344の議論](https://ethereum-magicians.org/t/eip-1344-add-chain-id-opcode/1131)では、contentious hardforkが発生し、フォークの一方が chainIDを更新しない場合、そのフォークが再生攻撃に対して脆弱になると主張されています。これはEIP-1344にも存在する問題です。

これは、L2メッセージの唯一のアンチリプレイ情報としてchainIDを使用することの自然な結果に過ぎません。ただし、hardforkが少数派によって作成された場合、これが問題になる可能性があります。その場合、多数派がフォークを無視してchainIDを更新しない場合、多数派の現在のchainIDが少数派主導のフォークのchainID履歴の一部でもあるため、多数派の新しいメッセージすべて(chainIDを更新するまで)が少数派主導のフォークで再生される可能性があります。

これを修正するには、各メッセージにそれが署名された時点のブロック番号を指定する必要があります。その後、コントラクトはそのメッセージの一部として指定されたchainIDがその特定のブロックで有効であったことを確認できます。

EIP-1344はキャッシュシステムのギャップのため、これを正確に行うことはできませんが、このプロポーザルは、chainIDが無効になったブロック番号を返すように変更すれば、これを解決できます。残念ながら、コントラクトがこのチェックを実行しないようにするのは簡単です。そして、重要なアプリケーションの1つがこの手順に従わない場合、少数派主導のフォークを保護するという目的を達成できません。

多数派に無視されている少数派主導のフォークの場合、多数派はそこに提出されるメッセージ(ステートチャンネルなど)を追跡しないでしょう。そのため、そのようなフォークが後に注目を集めた場合、それは多数派のユーザーの犠牲の上に成り立つことになります。彼らはそのフォークの存在を知らなかったからです。

したがって、このプロポーザルは、少数派主導のフォークが後に注目を集めることはないと想定しており、それを保護する必要はないと考えています。

## テストケース
TBD

## 実装
TBD

## 下位互換性
このEIPは、EIP-155のチェーンID(ドメイン区切り文字)を使用してトランザクションに署名するすべてのチェーンと完全に下位互換性があります。既存のコントラクトは影響を受けません。

EIP-1344と同様に、EIP-712(Draft中)を更新して、ドメイン区切り文字とは別にchainIDを扱うことが有益かもしれません。chainIDは変更されることが期待されるため、ドメイン区切り文字にchainIDが含まれる場合、動的に計算する必要があります。ただし、スマートコントラクトはキャッシュメカニズムを使用できます。

## 参考文献
これは以前、[EIP-1344の議論](https://ethereum-magicians.org/t/eip-1344-add-chain-id-opcode/1131/39)の一部として提案されていました。

## 著作権
著作権およびそれに関連する権利は[CC0](../LICENSE.md)によって放棄されています。