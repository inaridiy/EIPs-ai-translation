---
original: dd4f5777c3cc02596e02dc196e5e78b15474f33cc671def3dd2cfc4b5bc8421b
---

---
eip: 86
title: トランザクション発信元とシグネチャの抽象化
author: Vitalik Buterin (@vbuterin)
type: Standards Track
category: Core
status: Stagnant
created: 2017-02-10
---

# 概要

トランザクション処理に現在ハードコーディングされているシグネチャ検証とノンス確認のメカニズムを「抽象化」する一連の変更を実装します。これにより、ユーザーは任意のシグネチャ/ノンス確認を実行する「アカウントコントラクト」を作成できるようになります。

# パラメータ

* METROPOLIS_FORK_BLKNUM: 未定
* CHAIN_ID: EIP 155と同じ (メインネットは1、テストネットは3)
* NULL_SENDER: 2**160 - 1

# 仕様

`block.number >= METROPOLIS_FORK_BLKNUM`の場合:
1. トランザクションのシグネチャが`(CHAIN_ID, 0, 0)`(つまり`r = s = 0`, `v = CHAIN_ID`)の場合、それを有効とみなし、送信者アドレスを`NULL_SENDER`に設定する
2. このようなフォームのトランザクションでは、gasprice = 0、nonce = 0、value = 0でなければならず、`NULL_SENDER`アカウントのノンスは増加しない
3. スタックの引数が4つ(value、salt、mem_start、mem_size)の新しいオペコード`0xfb`、`CREATE2`を追加する。これは作成アドレスを`sha3(sender + salt + sha3(init code)) % 2**160`に設定する。ここで`salt`は常に32バイトの値として表される
4. コントラクト作成操作(トランザクションとオペコード)すべてに、作成先アドレスにすでにコードが存在し、かつノンスが0以外の場合は失敗し0を返すという規則を追加する。ただし、アカウントにコードとノンスが空でも残高がある場合は、作成操作が成功する可能性がある

# 根拠

これらの変更の目的は、アカウントセキュリティの抽象化の基盤を整えることです。ECDSAとデフォルトのノンススキームがプロトコル内で唯一の「標準的」なアカウントセキュリティ手段として組み込まれるのではなく、長期的にはすべてのアカウントがコントラクトであり、コントラクトがガス代を支払い、ユーザーが独自のセキュリティモデルを定義できるようにすることです。

EIP 86の下では、ユーザーはイーサを以下のようなコントラクト(Serpent例)に保管することが期待されます:

```python
# トランザクションデータからシグネチャを取得
sig_v = ~calldataload(0)
sig_r = ~calldataload(32)
sig_s = ~calldataload(64)
# トランザクション引数を取得
tx_nonce = ~calldataload(96)
tx_to = ~calldataload(128)
tx_value = ~calldataload(160)
tx_gasprice = ~calldataload(192)
tx_data = string(~calldatasize() - 224)
~calldataload(tx_data, 224, ~calldatasize())
# 署名ハッシュを取得
signing_data = string(~calldatasize() - 64)
~mstore(signing_data, tx.startgas)
~calldataload(signing_data + 32, 96, ~calldatasize() - 96)
signing_hash = sha3(signing_data:str)
# 通常のチェックを実行
prev_nonce = ~sload(-1)
assert tx_nonce == prev_nonce + 1
assert self.balance >= tx_value + tx_gasprice * tx.startgas
assert ~ecrecover(signing_hash, sig_v, sig_r, sig_s) == <公開鍵ハッシュ>
# ノンスを更新
~sstore(-1, prev_nonce + 1)
# ガス代を支払う
~send(MINER_CONTRACT, tx_gasprice * tx.startgas)
# メインコールを行う
~call(msg.gas - 50000, tx_to, tx_value, tx_data, len(tx_data), 0, 0)
# 残りのガス代を受け取る
~call(20000, MINER_CONTRACT, 0, [msg.gas], 32, 0, 0)
```

これは「転送コントラクト」と考えることができます。2**160 - 1の「エントリポイントアドレス」からデータを受け取り、それが`[sig, nonce, to, value, gasprice, data]`の形式であることを期待します。転送コントラクトはシグネチャを検証し、正しい場合はマイナーへの支払いを設定してから、指定のアドレスにコールを送信します。

この機能が最も興味深い場合は以下のようなメリットがあります:

- **マルチシグウォレット**: 現在、マルチシグウォレットから送金するには、各操作を参加者が承認する必要があり、各承認がトランザクションになります。これをシンプル化するには、他の参加者のシグネチャを含む1つの承認トランザクションを行えばよくなります。しかし、参加者のアカウントにETHを保持しておく必要があるため、依然として複雑さが残ります。このEIPにより、コントラクトにETHを保持させ、すべてのシグネチャを含むトランザクションをコントラクトに直接送信できるようになります。コントラクトがガス代を支払うことができます。
- **リングシグネチャミキサー**: リングシグネチャミキサーは、N人の個人がそれぞれ1コインをコントラクトに送金し、後にリンク可能なリングシグネチャを使って1コインを引き出すというものです。リンク可能なリングシグネチャにより、引き出しトランザクションを入金トランザクションにリンクできないようになっています。しかし、現在はプライバシーリスクがあります。引き出しには、ガス代を支払うためのコインが必要ですが、これらのコインが適切にミックスされていない場合、プライバシーが侵害される可能性があります。このEIPにより、引き出したコインからガス代を支払えるようになります。
- **カスタム暗号**: ユーザーはECDSAではなく、ed25519シグネチャ、Lamportハッシュラダーシグネチャなど、任意の暗号方式にアップグレードできます。
- **暗号以外の変更**: ユーザーは、トランザクションに有効期限を設けたり(これが標準化されれば、古い空のアカウントをセキュアに削除できる)、k並列ノンス(トランザクションを若干の順序違いで確認できるスキーム、トランザクション間の依存関係を減らす)を使ったりするなど、その他の変更を行えます。

(2)と(3)は、ビットコインのP2SHに似た機能を導入します。これにより、アカウントがオンチェーンに存在する前に、特定のコードにのみマッピングされるアドレスにfunds を送信できるようになります。これは、すべてのアカウントがコントラクトになる世界では不可欠な機能です。

# マイナーとトランザクションリプレイ戦略

マイナーはこれらのトランザクションを受け入れる戦略を持つ必要があります。この戦略は非常に慎重でなければなりません。そうしないと、手数料を受け取らないトランザクションや、効果がない(つまり、すでにブロックに含まれているため、ノンスが最新ではない)トランザクションを受け入れてしまう可能性があります。

1つの単純な戦略は、「安全」と見なされる「標準アカウントタイプ」ごとに正規表現のセットを持ち、to アドレスがそれらに一致するかどうかをチェックすることです。アカウントにそのコードがあり、アカウントの残高、ストレージ、トランザクションデータを使った特定のチェックに合格した場合、トランザクションをブロックに含めればマイナーは報酬を得られます。

例えば以下のようにチェックできます:

1. to アドレスのコードが上記のSerpentコードのコンパイル版であり、`<公開鍵ハッシュ>`が任意の公開鍵ハッシュに置き換えられていることを確認する
2. トランザクションデータのシグネチャがその公開鍵ハッシュで検証できることを確認する
3. トランザクションデータのgaspriceが十分に高いことを確認する
4. ステートのノンスがトランザクションデータのノンスと一致することを確認する
5. アカウントにトランザクション手数料を支払うだけの ETH が十分にあることを確認する

これらすべてのチェックに合格した場合、トランザクションをリレーおよび/またはマイニングする。

より緩やかですが効果的な戦略は、上記の一般的な形式に合うコードであれば受け入れ、ノンスとシグネチャのチェックに限定的なガスを消費し、トランザクション手数料がマイナーに支払われることを保証することです。別の戦略は、他のアプローチと並行して、25万ガス以下を要求するトランザクションを処理し、マイナーの残高がその実行前より適切に高くなっている場合にのみそれを含めることです。

# 著作権

著作権およびそれに関連する権利はCC0で放棄されています。