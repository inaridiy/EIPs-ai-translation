---
original: 5784aa84f7ee540abdb32cfd338a0c588e58b67ec1eac1fc0a05679315aa8525
---

---
eip: 3508
title: トランザクションデータオペコード
author: Alex Papageorgiou (@alex-ppg)
discussions-to: https://ethereum-magicians.org/t/eip-draft-transaction-data-opcodes/6017
status: 停滞
type: Standards Track
category: Core
created: 2021-04-16
---

## 簡単な要約

オリジナルのトランザクションデータにアクセスする。

## 概要

このEIPでは、以下の3つのEVMインストラクションを導入します: `ORIGINDATALOAD`、`ORIGINDATASIZE`、`ORIGINDATACOPY`。

これらの3つのインストラクションは、オリジナルのトランザクションの `data` ペイロードにアクセスすることを目的としており、大規模なデータペイロードを含むクロスコントラクトコールの効率的なアクセスを可能にします。

## 動機

Ethereumの開発シーンが成熟するにつれ、より野心的で複雑な機能がスマートコントラクトに頻繁に導入されるようになり、複雑で大規模なデータ構造の利用が必要になっています。しかし、EVMの固有の制限により、コントラクト間で大規模なデータ構造を転送するのは非常にコストがかかる作業であり、ガス消費がガスリミットを超えてしまったり、ETHの大部分を費やさざるを得ないような状況にもなりかねません。

このEIPの目的は、マルチコントラクトシステムがデータペイロードを完全に転送することなく同じメモリ内のデータソースにアクセスできるようにすることで、これらの機能を実現可能にすることです。

このEIPにより、Merkle Patricia木の検証などの高度な信頼できるスキームや、EVM ベースのレイヤー2ソリューションなどが、呼び出しレベルのデータを渡すのではなく、オリジナルのトランザクションペイロードからデータを効率的に読み取ることで実現可能になります。

この変更の副作用として、オリジナルデータに完全に依存するスマートコントラクトシステムは、中間のスマートコントラクトコールによってデータが不正に変更されていないことを保証できるようになります。

## 仕様

### ORIGINDATALOAD (`0x47`)、ORIGINDATASIZE (`0x48`)、ORIGINDATACOPY (`0x49`)

これらのインストラクションは、それぞれ `CALLDATALOAD` (`0x35`)、`CALLDATASIZE` (`0x36`)、`CALLDATACOPY` (`0x37`)と同様の動作をしますが、現在のコールのデータではなく、オリジナルのトランザクション `data` に対して動作します。具体的には:

- ORIGINDATALOAD (`0x47`) は CALLDATALOAD (`0x35`) と同様の動作をします
- ORIGINDATASIZE (`0x48`) は CALLDATASIZE (`0x36`) と同様の動作をします
- ORIGINDATACOPY (`0x49`) は CALLDATACOPY (`0x37`) と同様の動作をします

データは実行環境から再度取得されるため、3つのインストラクションのガスコストは、それぞれ `G_verylow`、`G_base`、`G_base + G_verylow * (コピーするワード数、切り上げ)` となります。

`ORIGINDATA*` オペコードが操作するトランザクションデータは、スタック上の最も近い `AUTHCALL` (`0xf7`) の `args*` パラメータで指定された `calldata` と等価になります。スタックに `AUTHCALL` がない場合は、`ORIGINDATA*` はトランザクションの元の `data` フィールドに対して動作します。

この相互作用により、[EIP-3074](./eip-3074.md)との完全な互換性が確保され、このEIPによって差別が再び導入されることはありません。例えば、`ORIGINDATA*` に完全に依存するコントラクトが、EOAからのみデータを受け付けるようになるということはありません。

## 根拠

### AUTHCALL (`0xf7`) との相互作用

ロンドンフォークに含まれる [EIP-3074](./eip-3074.md) では、新しい呼び出しインストラクション `AUTHCALL` (`0xf7`) が導入され、トランザクションの `ORIGIN` (`0x32`) が `authorized` コンテキスト変数に置き換えられます。`AUTHCALL` の目的は、`ORIGIN` が当初促進していたスマートコントラクトとEOAの間の差別を防ぐことです。そのため、`ORIGINDATA*` オペコードが取得する値も `AUTHCALL` で使用されるものに置き換えるのが適切です。

### 命名規則

`ORIGIN`-prefixed インストラクションは、`ORIGIN` (`0x32`) インストラクション(これは `CALLER` (`0x33`) インストラクションと同等ですが、オリジナルのトランザクションコンテキストに対して動作する)の存在を考慮し、`CALL`-prefixed インストラクションの既存の命名規則に準拠しようとしています。

### インストラクションアドレス空間

`0x30-0x3f` のインストラクションアドレス空間は、呼び出しに関する情報を提供するインストラクションによって既に使い尽くされているため、EIPの目的に適した新しい範囲を特定する必要がありました。

[EIP-1344](./eip-1344.md) の `CHAINID` オペコードが `0x46` に含まれていたことから、トランザクションペイロードにもチェーンIDが含まれていることから、`0x46-0x4f` のアドレス空間をトランザクションに関連するデータ(将来的にEOAのnonceなど)に予約するのが適切だと判断しました。

### ガスコスト

ORIGINDATALOAD (`0x47`)、ORIGINDATASIZE (`0x48`)、ORIGINDATACOPY (`0x49`) のオペコードは、それぞれ CALLDATALOAD (`0x35`)、CALLDATASIZE (`0x36`)、CALLDATACOPY (`0x37`) と同じ動作をするため、まったく同じガスコストを共有します。

### インストラクション空間の汚染

新しいEVMインストラクションを複数追加することで、EVMインストラクションアドレス空間が汚染される可能性があり、将来のインストラクションに適切なインストラクションコードを割り当てる際に問題が生じる可能性があるという議論があります。この特定の問題は評価され、生のRLP エンコードされたトランザクションをEVMから直接アクセスできるようにする方法が考案されました。これにより、新しいインストラクションセットを将来的に使用できるようにし、トランザクションの他の要素へのアクセスも可能になりますが、`ORIGIN` オペコードの冗長性も生じる可能性があります。

## 下位互換性

このEIPは、EVMの既存の機能を変更または調整するものではないため、既知の問題はありません。

## テストケース

TODO.

## セキュリティ上の考慮事項

### 自己内省型コントラクト

`ORIGINDATALOAD` と `ORIGINDATACOPY` の値は、適切な関数シグネチャと引数を持つエントリコントラクトを作成し、それが呼び出しチェーン内の他のコントラクトを呼び出すことで簡単にスプーフィングできるため、本質的に安全ではありません。要するに、`tx.data != calldata` であると常に想定し、これらのインストラクションを単独の内省ツールとして使用してはいけません。

### サービス拒否攻撃

このEIPによって生じる初期的な懸念は、EVMがこれらの `ORIGINDATALOAD` および `ORIGINDATACOPY` インストラクションを使用できるようにするために、ノードのソフトウェアレベルで提供しなければならない追加のコンテキストデータによる、メモリ消費の増加です。

しかし、トランザクションのデータはすでにブロックへの取り込み処理の一部として、メモリ内に存在しているはずなので、この増加は無視できるか、まったく存在しないはずです。

### マルチコントラクトシステムのガス削減

今日Ethereumにデプロイされている複雑なスマートコントラクトシステムの多くは、コントラクト間の相互作用に依存しており、値が関数呼び出しを介して1つのコントラクトから別のコントラクトに渡されています。`ORIGIN`-prefixed インストラクションセットにより、呼び出しチェーン内の任意の時点でオリジナルのトランザクションデータにアクセスできるようになるため、コントラクト間の呼び出しでやり取りされるデータが削減されることで、全体的なガス消費が減少する可能性があります。

ただし、このガス削減は実装ベースの最適化であり、主にメモリ引数ではなくストレージベースのデータに適用されるものです。そのため、この変更によって観察されるガス削減全体は、ほとんどの実装では微々たるものになるでしょう。

## 著作権

著作権およびその関連権利は [CC0](../LICENSE.md) で放棄されています。