---
original: f8787b2899a3e6a058cd71876122367d3295b311d213e386ae6722646aaeb9d2
---

---
eip: 1829
title: 楕円曲線線形結合のための前処理
author: Remco Bloemen <Recmo@0x.org>
discussions-to: https://ethereum-magicians.org/t/ewasm-precompile-for-general-elliptic-curve-math/2581
status: 停滞
type: Standards Track
category: Core
created: 2019-03-06
---

# 楕円曲線線形結合のための前処理

## 簡単な要約

現在、EVMは `ecrecover` を通じて *secp256k1* を、2つの前処理を通じて *altbn128* をわずかにサポートしています。他の曲線を追加するための提案もあります。既存のシステムとの統合や、ゼロ知識証明のための新しく開発された曲線など、多くの楕円曲線が有用な用途があります。

このEIPは、これらの曲線クラス全体を使用できるようにする前処理を追加します。

## 概要

曲線と、曲線上の点の線形結合を計算する前処理。

## 動機

## 仕様

整数 `m, α` および `β`、スカラー `s_i`、曲線上の点 `A_i` が与えられたとき、次の楕円曲線を構築します:

```
y² = x³ + α ⋅ x + β  mod  m
```

そして次のように計算します:

```
C = s₀ ⋅ A₀ + s₁ ⋅ A₁ + ⋯ + s_n ⋅ A_n
```

これは *線形結合*、*内積*、*マルチ乗算* または *マルチ指数関数* とも呼ばれます。

```
(Cx, Cy) := ecmul(m, α, β,  s0, Ax0, As0, s1, Ax1, As1, ...)
```

### ガスコスト

```
BASE_GAS = ...
ADD_GAS  = ...
MUL_GAS  = ...
```

合計ガスコストは `BASE_GAS` に、`s_i` が `1` の場合は `ADD_GAS`、`s_i > 1` の場合は `MUL_GAS` を加算したものです (`s_i = 0` は無料)。

### 点のエンコーディング

`(x, y')` としてエンコードします。ここで `s` は `y` または `-y` を取るべきかを示します。SEC 1 v 1.9 2.3.4に従いますが、非圧縮点 (`y' = 0x04`) はサポートされません。

|  `y'`  | `(x, y)` |
|--------|-----|
| `0x00` | 無限遠点 |
| `0x02` | `y` が偶数の解 |
| `0x03` | `y` が奇数の解 |

アファイン座標から圧縮座標への変換は簡単です: `y' = 0x02 | (y & 0x01)`.

### 特殊ケース

**座標の復元。** `s₀ = 1` とします。出力は `A₀` の復元された座標になります。

**曲線上チェック。** 座標の復元を行い、`y` 座標を比較します。

**加算。** `s₀ = s₁ = 1` とすると、出力は `A₀ + A₁` になります。

**倍点。** `s₀ = 2` とすると、出力は `2 ⋅ A₀` になります。(注: 現在のガスモデルでは、自己加算よりも高コストになる可能性があります!)

**スカラー乗算。** `s₀` のみ設定すると、出力は `s₀ ⋅ A₀` になります。

**剰余平方根。** `α = s₀ = A = 0` とすると、出力は `Cy² = β   mod  m` になります。

### エッジケース

* 素数でないモジュラスや、モジュラスが小さすぎる場合
* モジュラスを超えるフィールド要素
* 曲線に特異点がある場合 (`4 α³ + 27 β² = 0`)
* 無効な符号バイト
* 曲線上にない `x` 座標
* 無限遠点を返す
* (その他のケースがあれば追加してください)

## 根拠

**汎用フィールドと曲線。** 多くの重要な最適化はフィールドと曲線に依存しません。見落とされた特定の最適化には以下のようなものがあります:

* フィールドプライムのバイナリ構造に特化した剰余計算。
* モンゴメリ係数の事前計算。
* 一般的な点、特に生成点の倍数の事前計算。
* `α = -3`、`α = -1`、`α = 0`、`β = 0` の特別な点加算/倍点[公式][formulas]。

[formulas]: https://www.hyperelliptic.org/EFD/g1p/auto-shortw.html

TODO: `α` と `β` の特別ケースを実装し、ガス割引を提供するのも価値があるかもしれません。

**圧縮座標。** 圧縮座標を使うことで、契約は `x` 座標と符号バイトのみで動作できます。また、点が曲線上にないというエラーを防ぐこともできます。圧縮座標への変換は簡単です。

**線形結合。** 代わりに単純な乗算 `C = r ⋅ A` を行うこともできます。その場合、加算の前処理が別途必要になります。さらに、線形結合では Shamir のトリックのような、単一のスカラー乗算では利用できない最適化が可能です。ECDSA は `s₀ ⋅ A₀ + s₁ ⋅ A₁` を必要とし、この機能から恩恵を受けるでしょう。

[EIP-196][EIP-196] の前処理で導入された BN254 (別名 alt_bn8) の乗算演算は、単一のスカラー乗算のみを扱います。見逃された性能は、[Weierstrudel][ws]によって実証されたように、2つ以上の点を使う場合にはEVMを使う方が安価になるほどです。

[EIP-196]: ./eip-196.md
[ws]: https://medium.com/aztec-protocol/huffing-for-crypto-with-weierstrudel-9c9568c06901

**可変時間の数学。** トランザクション中に呼び出される場合、プライバシーの前提はなく、サイドチャネル攻撃の緩和策は必要ありません。

**素数フィールド。** このEIPは大きな特性を持つフィールド用です。バイナリフィールドやその他の非素数特性のフィールドはカバーしていません。

**256ビットモジュラス。** このEIPは `2^{256}` 未満のフィールドモジュラスを対象としています。これには多くの一般的な曲線が含まれ、かつすべてのパラメータがEVMワード1つに収まります。

TODO: 2倍ワードのバージョンを検討してください。512ビットなら、E-521を除くすべての既知の曲線をカバーできます。特に、エストニアのe-IDで使用されているNIST P-384曲線や、[ZCash Sappling][sappling]で使用されているBLS12-381曲線をカバーできます。

[sappling]: https://z.cash/blog/new-snark-curve/

**短Weierstrass曲線。** このEIPは短Weierstrass形式で指定されたフィールド用です。[変数の置換][cov]によって任意の曲線を短Weierstrass形式に変換できますが、その特定の形式の性能上の利点を逸失してしまいます。

[cov]: https://safecurves.cr.yp.to/equation.html

## 下位互換性

## テストケース

## 実装

Rustベースの参照実装を作成します。既存のライブラリ(特にZCashとThe Matter Inc.のもの)を利用します。

参照実装は本番品質で、ネイティブライブラリとC APIおよびWebAssemblyバージョンをコンパイルします。Nodeの開発者は参照実装を使うことが奨励され、Rustライブラリ、ネイティブCバインディング、WebAssemblyモジュールのいずれかを使用できます。もちろん、独自の実装を行うこともできます。

## 参考文献

このEIPは以下の範囲と重複します:

* [EIP-196](./eip-196.md): altbn128のecadd、ecmul
* [EIP issue 603](https://github.com/ethereum/EIPs/issues/603): SECP256k1のecadd、ecmul
* [EIP-665](./eip-665.md): ED25519のECDSA verify
* [EIP-1108](./eip-1108.md): altbn128のecadd、ecmulの最適化

## 著作権
著作権およびその関連権利は[CC0](../LICENSE.md)で放棄されています。