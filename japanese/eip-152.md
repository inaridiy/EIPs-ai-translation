---
original: 6a8e682d70dc38a7114b6a90e91c5c266388508f14db8dc6d4ae8fceffec044c
---

---
eip: 152
title: BLAKE2 圧縮関数 `F` プリコンパイルの追加
author: Tjaden Hess <tah83@cornell.edu>、Matt Luongo (@mhluongo)、Piotr Dyraga (@pdyraga)、James Hancock (@MadeOfTin)
discussions-to: https://github.com/ethereum/EIPs/issues/152
status: Final
type: Standards Track
category: Core
created: 2016-10-04
---

## 簡単な要約

このEIPにより、BLAKE2b ハッシュ関数およびその他の64ビットBLAKE2バリアントをEVM上で安価に実行できるようになり、Ethereum とZcash、およびその他のEquihash ベースのPoWコインとの相互運用性が容易になります。

## 概要

このEIPは、BLAKE2暗号化ハッシュアルゴリズムで使用される圧縮関数 `F` を実装する新しいプリコンパイルドコントラクトを導入するものです。これにより、EVMとZcashの相互運用性を可能にし、EVMにより柔軟な暗号化ハッシュプリミティブを導入することを目的としています。

## 動機

BLAKE2は有用な暗号化ハッシュ関数であり、SHA3ファイナリストでもあります。また、Zcashで使用されるEquihash PoWの効率的な検証を可能にするため、Ethereum 上でBTC RelayスタイルのSPVクライアントを実現できます。Equihash PoWの検証には512回のハッシュ関数の反復が必要であるため、SolidityでBLAKE2を実装すると、Zcashブロックヘッダーの検証が非常に高コストになってしまいます。

一般的な64ビットBLAKE2バリアントであるBLAKE2bは高度に最適化されており、現代のプロセッサーではMD5よりも高速です。

Zcashとの相互運用性により、両チェーン間の信頼できる原子スワップなどのコントラクトを実現できるようになり、非常に公開的なEthereum ブロックチェーンにプライバシーの側面を提供することができます。

## 仕様

私たちは、[BLAKE2 `F` 圧縮関数](https://tools.ietf.org/html/rfc7693#section-3.2)をラップする、アドレス `0x09` のプリコンパイルドコントラクトを追加することを提案します。

このプリコンパイルには、以下のように説明されている6つの入力が厳密に213バイトでエンコーディングされて渡されます。これらの入力は、[BLAKE2 RFC セクション3.2](https://tools.ietf.org/html/rfc7693#section-3.2)で指定されたものに対応しています:

- `rounds` - ラウンド数 - 32ビットの符号なし ビッグエンディアンワード
- `h` - 状態ベクトル - 8つの符号なし64ビットリトルエンディアンワード
- `m` - メッセージブロックベクトル - 16の符号なし64ビットリトルエンディアンワード
- `t_0, t_1` - オフセットカウンター - 2つの符号なし64ビットリトルエンディアンワード
- `f` - 最終ブロックインジケーターフラグ - 8ビットワード

```
[4 bytes for rounds][64 bytes for h][128 bytes for m][8 bytes for t_0][8 bytes for t_1][1 byte for f]
```

ブール値の `f` パラメーターは、`1` に設定されている場合は `true` と見なされ、`0` に設定されている場合は `false` と見なされます。その他の値は `f` の無効なエンコーディングとみなされます。

プリコンパイルは、[RFCで指定された](https://tools.ietf.org/html/rfc7693#section-3.2)通りに `F` 関数を計算し、変更された状態ベクトル `h` をそのままの符号化(リトルエンディアン)で返す必要があります。

### Solidityでの使用例

プリコンパイルは、`F` への開発者にとってより使いやすいインターフェイスを提供するためにSolidityでラップすることができます。

```solidity
function F(uint32 rounds, bytes32[2] memory h, bytes32[4] memory m, bytes8[2] memory t, bool f) public view returns (bytes32[2] memory) {
  bytes32[2] memory output;

  bytes memory args = abi.encodePacked(rounds, h[0], h[1], m[0], m[1], m[2], m[3], t[0], t[1], f);

  assembly {
    if iszero(staticcall(not(0), 0x09, add(args, 32), 0xd5, output, 0x40)) {
      revert(0, 0)
    }
  }

  return output;
}

function callF() public view returns (bytes32[2] memory) {
  uint32 rounds = 12;

  bytes32[2] memory h;
  h[0] = hex"48c9bdf267e6096a3ba7ca8485ae67bb2bf894fe72f36e3cf1361d5f3af54fa5";
  h[1] = hex"d182e6ad7f520e511f6c3e2b8c68059b6bbd41fbabd9831f79217e1319cde05b";

  bytes32[4] memory m;
  m[0] = hex"6162630000000000000000000000000000000000000000000000000000000000";
  m[1] = hex"0000000000000000000000000000000000000000000000000000000000000000";
  m[2] = hex"0000000000000000000000000000000000000000000000000000000000000000";
  m[3] = hex"0000000000000000000000000000000000000000000000000000000000000000";

  bytes8[2] memory t;
  t[0] = hex"03000000";
  t[1] = hex"00000000";

  bool f = true;

  // 期待される出力:
  // ba80a53f981c4d0d6a2797b69f12f6e94c212f14685ac4b74b12bb6fdbffa2d1
  // 7d87c5392aab792dc252d5de4533cc9518d38aa8dbf1925ab92386edd4009923
  return F(rounds, h, m, t, f);
}
```

### ガスコストとベンチマーク

各操作のコストは `GFROUND * rounds` ガスとなり、`GFROUND = 1` です。詳細なベンチマークは付録のベンチマークセクションに示されています。

## 根拠

BLAKE2はプリコンパイルの優れた候補です。BLAKE2は現代の64ビットCPUに最適化されており、特に24ビットと63ビットの回転を利用してSIMD命令とリトルエンディアンの算術によるパラレル性を実現しています。これらの特性により、ネイティブのCPUでは非常に高速な動作が可能です: 1ギビバイトあたり3.08サイクル、またはIntel i5で1秒あたり1ギビバイトです。

対照的に、EVMの32バイトのビッグエンディアンセマンティクスはBLAKE2の効率的な実装には適していないため、EVMでハッシュを計算するのに関連するガスコストは、ネイティブで計算する真の費用に比べて過剰になります。

明らかな実装はBLAKE2bハッシュ関数のプリコンパイルです。一見すると、BLAKE2bプリコンパイルはEVM上のほとんどのハッシュ化と相互運用性の要件を満たします。しかし、掘り下げていくと、さまざまなプロジェクトの要件やライブラリに基づいて、BLAKE2bの実装には特定の機能と内部修正が必要であることが明らかになりました。

[Zcashチームとのスレッド](https://github.com/ethereum/EIPs/issues/152#issuecomment-499240310)では、この問題が明確になっています。

> ZEC-ETHリレーに必要な最小限のことは、BLAKE2b圧縮関数 Fのプリコンパイルの実装です。

> BLAKE2b圧縮関数 Fのプリコンパイルでも、Filecoinおよび Handshakeの相互運用性の目標に十分です。

> 完全なBLAKE2bプリコンパイルでも、ZEC-ETHリレーに十分ですが、実装では私たちが必要とするBLAKE2 APIの一部(パーソナライゼーション、その他何か)をサポートする必要があります。

> Filecoinおよび Handshakeの目標にも完全なBLAKE2bプリコンパイルが適しているかどうかは100%確信がありません。彼らが必要とするAPIをすべてサポートしていれば、ほぼ確実に適しているでしょう。

> BLAKE2s - 圧縮関数 Fでも完全なハッシュでも - はZEC-ETHリレーの目的には「あると良い」程度のものです。

このチームとの他の会話から、まずは相互運用性プロジェクトに厳密に必要な `F` プリコンパイルに焦点を当てるべきだと考えています。BLAKE2bプリコンパイルは「あると良い」ものですが、フレキシブルなAPIを見つけられるかどうかは不明確であり、イスタンブールまでに間に合わない可能性があります。

コア `F` 圧縮関数のみの実装により、プロトコルレベルの変更を最小限に抑えつつ、大幅な柔軟性と拡張性を実現できます。これにより、ツリーハッシング、インクリメンタルハッシング、キー付き/塩付き/パーソナライズドハッシング、可変長ダイジェストなど、現在EVMでは利用できない機能を提供できます。

## 下位互換性

このEIPには、アドレス `0x09` が空であることに依存するコントラクトを構築していた場合を除いて、ほとんど下位互換性の問題はありません。この可能性は低く、特定のインスタンスが発生した場合でも、アドレスを任意の値に選択すれば、ほとんどリスクはありません。

## テストケース

#### テストベクトル0
* 入力: (空)
* 出力: エラー "BLAKE2 Fプリコンパイルの入力長は正確に213バイトでなければなりません"

#### テストベクトル1
* 入力:
`00000c48c9bdf267e6096a3ba7ca8485ae67bb2bf894fe72f36e3cf1361d5f3af54fa5d182e6ad7f520e511f6c3e2b8c68059b6bbd41fbabd9831f79217e1319cde05b61626300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000001`
* 出力: エラー "BLAKE2 Fプリコンパイルの入力長は正確に213バイトでなければなりません"

#### テストベクトル2
* 入力:
`000000000c48c9bdf267e6096a3ba7ca8485ae67bb2bf894fe72f36e3cf1361d5f3af54fa5d182e6ad7f520e511f6c3e2b8c68059b6bbd41fbabd9831f79217e1319cde05b61626300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000001`
* 出力: エラー "BLAKE2 Fプリコンパイルの入力長は正確に213バイトでなければなりません"

#### テストベクトル3
* 入力:
`0000000c48c9bdf267e6096a3ba7ca8485ae67bb2bf894fe72f36e3cf1361d5f3af54fa5d182e6ad7f520e511f6c3e2b8c68059b6bbd41fbabd9831f79217e1319cde05b61626300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000002`
* 出力: エラー "最終ブロックインジケーターフラグが正しくありません"

#### テストベクトル4
* 入力:
`0000000048c9bdf267e6096a3ba7ca8485ae67bb2bf894fe72f36e3cf1361d5f3af54fa5d182e6ad7f520e511f6c3e2b8c68059b6bbd41fbabd9831f79217e1319cde05b61626300000000000000000000000000000000000000
000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000001`
* 出力:
`08c9bcf367e6096a3ba7ca8485ae67bb2bf894fe72f36e3cf1361d5f3af54fa5d282e6ad7f520e511f6c3e2b8c68059b9442be0454267ce079217e1319cde05b`

#### テストベクトル5
* 入力:
`0000000c48c9bdf267e6096a3ba7ca8485ae67bb2bf894fe72f36e3cf1361d5f3af54fa5d182e6ad7f520e511f6c3e2b8c68059b6bbd41fbabd9831f79217e1319cde05b61626300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000001`
* 出力: `ba80a53f981c4d0d6a2797b69f12f6e94c212f14685ac4b74b12bb6fdbffa2d17d87c5392aab792dc252d5de4533cc9518d38aa8dbf1925ab92386edd4009923`

#### テストベクトル6
* 入力:
`0000000c48c9bdf267e6096a3ba7ca8485ae67bb2bf894fe72f36e3cf1361d5f3af54fa5d182e6ad7f520e511f6c3e2b8c68059b6bbd41fbabd9831f79217e1319cde05b61626300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000000`
* 出力:
`75ab69d3190a562c51aef8d88f1c2775876944407270c42c9844252c26d2875298743e7f6d5ea2f2d3e8d226039cd31b4e426ac4f2d3d666a610c2116fde4735`

#### テストベクトル7
* 入力:
`0000000148c9bdf267e6096a3ba7ca8485ae67bb2bf894fe72f36e3cf1361d5f3af54fa5d182e6ad7f520e511f6c3e2b8c68059b6bbd41fbabd9831f79217e1319cde05b61626300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000001`
* 出力:
`b63a380cb2897d521994a85234ee2c181b5f844d2c624c002677e9703449d2fba551b3a8333bcdf5f2f7e08993d53923de3d64fcc68c034e717b9293fed7a421`

#### テストベクトル8
* 入力:
`ffffffff48c9bdf267e6096a3ba7ca8485ae67bb2bf894fe72f36e3cf1361d5f3af54fa5d182e6ad7f520e511f6c3e2b8c68059b6bbd41fbabd9831f79217e1319cde05b61626300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000300000000000000000000000000000001`
* 出力:
`fc59093aafa9ab43daae0e914c57635c5402d8e3d2130eb9b3cc181de7f0ecf9b22bf99a7815ce16419e200e01846e6b5df8cc7703041bbceb571de6631d2615`

## 実装

Go言語での `F` 関数の初期実装は、標準ライブラリから改変したものが[我々のGo BLAKE2ライブラリのフォーク](https://github.com/keep-network/blake2-f)にあります。また、プリコンパイルの実装は[go-ethereumのフォーク](https://github.com/keep-network/go-ethereum/pull/4)にもあります。

## 参考文献

参考として、このEIPに関する以下のPRおよびissueでも議論が行われました。

 * [オリジナルのissue](https://github.com/ethereum/EIPs/issues/152)
 * [Ethereum Magicians](https://ethereum-magicians.org/t/blake2b-f-precompile/3157)
 * [PR 2129](https://github.com/ethereum/EIPs/pull/2129)

## 付録 - ベンチマーク

ecRecoverプリコンパイルが完璧に価格付けされていると仮定して、Blake2b F圧縮関数プリコンパイルとecRecoverプリコンパイルを比較するベンチマークを実行しました。ベンチマークには3.1 GHz Intel Core i7 64ビットマシンを使用しました。

```sh
$ sysctl -n machdep.cpu.brand_string
Intel(R) Core(TM) i7-7920HQ CPU @ 3.10GHz
```

### 12ラウンド

12ラウンドのF プリコンパイルコールのガス価格の平均は、ecRecoverと比較して `6.74153` となり、1ラウンドあたり `0.5618` ガスになります。

```
Name                                         Gascost         Time (ns)     MGas/S    Gasprice for 10MGas/S    Gasprice for ECDSA eq
-----------------------------------------  ---------  ----------------  ---------  -----------------------  -----------------------
PrecompiledEcrecover/                           3000  152636              19.6546                 1526.36               3000
PrecompiledBlake2F/testVectors2bX_0               12     338              35.503                     3.38                  6.64326
PrecompiledBlake2F/testVectors2bX_3               12     336              35.7143                    3.36                  6.60395
PrecompiledBlake2F/testVectors2bX_70              12     362              33.1492                    3.62                  7.11497
PrecompiledBlake2F/testVectors2bX_140             12     339              35.3982                    3.39                  6.66291
PrecompiledBlake2F/testVectors2bX_230             12     339              35.3982                    3.39                  6.66291
PrecompiledBlake2F/testVectors2bX_300             12     343              34.9854                    3.43                  6.74153
PrecompiledBlake2F/testVectors2bX_370             12     336              35.7143                    3.36                  6.60395
PrecompiledBlake2F/testVectors2bX_440             12     337              35.6083                    3.37                  6.6236
PrecompiledBlake2F/testVectors2bX_510             12     345              34.7826                    3.45                  6.78084
PrecompiledBlake2F/testVectors2bX_580             12     355              33.8028                    3.55                  6.97738
```

列の説明:

* `MGas/S` - その時点でその機械で測定されたMGas/秒を示します
* `Gasprice for 10MGas/S` は、10 MGas/秒に到達するために必要だったガス価格を示します
* `Gasprice for ECDSA eq` は、ecRecoverと同じコスト/サイクルになるためのガス価格を示します

### 1200ラウンド

1200ラウンドのF プリコンパイルコールのガス価格の平均は、ecRecoverと比較して `436.1288` となり、1ラウンドあたり `0.3634` ガスになります。

```
Name                                         Gascost         Time (ns)     MGas/S    Gasprice for 10MGas/S    Gasprice for ECDSA eq
-----------------------------------------  ---------  ----------------  ---------  -----------------------  -----------------------
PrecompiledEcrecover/                           3000  156152              19.212                  1561.52               3000
PrecompiledBlake2F/testVectors2bX_0             1200   22642              52.9989                  226.42                434.999
PrecompiledBlake2F/testVectors2bX_3             1200   22885              52.4361                  228.85                439.668
PrecompiledBlake2F/testVectors2bX_70            1200   22737              52.7774                  227.37                436.824
PrecompiledBlake2F/testVectors2bX_140           1200   22602              53.0926                  226.02                434.231
PrecompiledBlake2F/testVectors2bX_230           1200   22501              53.331                   225.01                432.29
PrecompiledBlake2F/testVectors2bX_300           1200   22435              53.4879                  224.35                431.022
PrecompiledBlake2F/testVectors2bX_370           1200   22901              52.3995                  229.01                439.975
PrecompiledBlake2F/testVectors2bX_440           1200   23134              51.8717                  231.34                444.452
PrecompiledBlake2F/testVectors2bX_510           1200   22608              53.0786                  226.08                434.346
PrecompiledBlake2F/testVectors2bX_580           1200   22563              53.1844                  225.63                433.481
```

### 1ラウンド

1ラウンドのF プリコンパイルコールのガス価格の平均は、ecRecoverと比較して `2.431701` となりますが、このシナリオでは動的コストが呼び出しコストを完全に上回ってしまうでしょう。

```
Name                                         Gascost         Time (ns)      MGas/S    Gasprice for 10MGas/S    Gasprice for ECDSA eq
-----------------------------------------  ---------  ----------------  ----------  -----------------------  -----------------------
PrecompiledEcrecover/                           3000  157544              19.0423                  1575.44               3000
PrecompiledBlake2F/testVectors2bX_0                1     126               7.93651                    1.26                  2.39933
PrecompiledBlake2F/testVectors2bX_3                1     127               7.87402                    1.27                  2.41837
PrecompiledBlake2F/testVectors2bX_70               1     128               7.8125                     1.28                  2.43741
PrecompiledBlake2F/testVectors2bX_140              1     125               8                          1.25                  2.38029
PrecompiledBlake2F/testVectors2bX_230              1     128               7.8125                     1.28                  2.43741
PrecompiledBlake2F/testVectors2bX_300              1     127               7.87402                    1.27                  2.41837
PrecompiledBlake2F/testVectors2bX_370              1     131               7.63359                    1.31                  2.49454
PrecompiledBlake2F/testVectors2bX_440              1     129               7.75194                    1.29                  2.45646
PrecompiledBlake2F/testVectors2bX_510              1     125               8                          1.25                  2.38029
PrecompiledBlake2F/testVectors2bX_580              1     131               7.63359                    1.31                  2.49454
```


## 著作権

著作権およびその関連権利は[CC0](../LICENSE.md)で放棄されています。