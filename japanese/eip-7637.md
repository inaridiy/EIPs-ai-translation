---
original: 8abb92509282cb55b0eb4c3dcde7dda3d6edcec3faccd3bba3208fe6db265e10
---

---
eip: 7637
title: EOA EXTCODEHASHの最適化
description: EOAアカウントのEXTCODEHASHの出力値を`0x`に変更する
author: Jame (@ZWJKFLC)
discussions-to: https://ethereum-magicians.org/t/eip-7637-extcodehash-optimize/18946
status: ドラフト
type: 標準トラック
category: コア
created: 2024-02-26
requires: 1052
---

## 要約

この提案は[EIP-1052](./eip-1052.md)の最適化です。
残高はあるがコードがないアドレスの場合、コードハッシュは引き続き`0x`であるべきです。

アドレス`add.code == 0x`かつ`add.balance != 0`の場合、`add.codehash==keccak256("")`ではなく`add.codehash==0`が必要です。

## 動機

EIP-1052はガス料金を節約するために提案されました。しかし、仕様の設定に一部の欠陥があるため、実際のアプリケーションでは安全性の懸念から実際には使用されません。EIP-1052を真に有用にするためには、最適化する必要があります。

EIP-1052の提案に基づいて使用し、`add.balance != 0`の場合の変更に気付かないと、セキュリティの問題が発生する可能性があります。

## 仕様

`EXTCODEHASH`の動作は以下のように変更されます：

1. `EXTCODEHASH`を呼び出す際、残高はあるがコードがないアドレスのコードハッシュは引き続き`0x`となります。

## 根拠

EIP-1052は`BALANCE`の機能を含めるために、残高のないアドレスの`EXTCODEHASH`を`0x`とし、残高のあるアドレスの`EXTCODEHASH`を`keccak256("")`としました。

コントラクトアドレスは事前に計算できます。`CREATE`または`CREATE2`のいずれの場合も、コントラクトが作成されていないが残高がある可能性があります。セキュリティのために、実際には`add.codehash == 0`の代わりに`keccak256(add.code) == keccak256("")`または`add.code.length ==0`のみを使用できます。これにより、EIP-1052の本来の意図が無意味になります。

例えば、Uniswap V2は保存されたアドレスを使用してコントラクトが存在するかどうかを判断します。この`EXTCODEHASH`が最適化されれば、大量のガスを節約できます。

誰かが`add.codehash==0`を使用してコントラクトが作成されたかどうかを判断する場合、直感的に、また多くの文書の詳細の欠如により、残高のあるアドレスのコードハッシュが`0x`から`keccak256("")`に変更されるとは考えないでしょう。この時に誰かが悪意を持って攻撃すると、いくつかの悪影響を引き起こす可能性があります。

## 後方互換性

<!-- TODO: -->
議論が必要です。
コードハッシュが実際にアドレスに残高があるかどうかを判断するために使用され、コードハッシュが`keccak256("")`である状況があるかどうかは不明です。

## 参照実装

execution-specsのコード参照

修正後

```python
def extcodehash(evm: Evm) -> None:
    address = to_address(pop(evm.stack))
    charge_gas(evm, GAS_CODE_HASH)
    account = get_account(evm.env.state, address)
    if account == EMPTY_ACCOUNT:
        codehash = U256(0)
    else:
	codehash = U256.from_be_bytes(keccak256(account.code))
	if codehash == U256(hexstr="c5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470"):
	    codehash = U256(0)
    push(evm.stack, codehash)
    evm.pc += 1
```

ソースコード

```python
def extcodehash(evm: Evm) -> None:
    address = to_address(pop(evm.stack))
    charge_gas(evm, GAS_CODE_HASH)
    account = get_account(evm.env.state, address)
    if account == EMPTY_ACCOUNT:
        codehash = U256(0)
    else:
        codehash = U256.from_be_bytes(keccak256(account.code))

    push(evm.stack, codehash)
    evm.pc += 1
```

## セキュリティに関する考慮事項

<!-- TODO: -->
議論が必要です。
コードハッシュが実際にアドレスに残高があるかどうかを判断するために使用され、コードハッシュが`keccak256("")`である状況があるかどうかは不明です。

## 著作権

Copyright and related rights waived via [CC0](../LICENSE.md).