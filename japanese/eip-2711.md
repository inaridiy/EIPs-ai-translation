---
original: d60d5b8e14e30ccaeddf2ab93b2de99e62d0a1ebe0c7c2c8a4a8292cdd51a329
---

---
eip: 2711
title: スポンサー付き、期限付き、バッチトランザクション
author: Micah Zoltu (@MicahZoltu)
discussions-to: https://ethereum-magicians.org/t/eip-2711-separate-gas-payer-from-msg-sender/4353
status: 取り下げられた
type: Standards Track
category: Core
created: 2020-06-11
requires: 2718
---

## 簡単な要約
スポンサー付きトランザクション(ガス支払者を送信者から分離)、バッチトランザクション(複数のトランザクションを順次実行)、期限付きトランザクション(一定の時間以降に無効になるトランザクション)をサポートする新しいトランザクションタイプを作成します。

## 概要
[EIP-2718](./eip-2718.md)のトランザクションタイプ番号 `2` は、以下をサポートする新しいタイプのトランザクションです:
1. **スポンサー付きトランザクション**: ガス支払者(`GAS_PAYER`)を特定できる追加の署名が含まれる
2. **バッチトランザクション**: 同一の送信者による複数のトランザクションを順次実行する
3. **期限付きトランザクション**: 一定の時間以降に無効になる `validUntil` フィールドが含まれる

## 動機
### スポンサー付きトランザクション
トークンや特に安定コインの登場により、ユーザーがETHを保有していない一方で、その口座に他の有価資産を保有しているケースが一般的になってきました。一部のユーザーはETHの変動性に晒されるのを好まず、他の資産を使ってトランザクションを行いたがっています。しかし、ガス代はETHで支払わなければならないため、ユーザーはまずETHを取得し、それを使ってガス代を支払わなければなりません。

このEIPでは、ガス代を誰かが代わりに支払うことで、ETHを保有しなくてもトランザクションを行えるようにする仕組みを提案しています。ガス代の支払いを可能にする取り決めの詳細はこのEIPの範囲外ですが、月額サブスクリプション、トランザクション送信時の支払い、受取人がガス代を負担する、企業が無料のサービスとして提供するなど、様々な方法が考えられます。

個別のコントラクトレベルでこのような仕組みを実装することは可能ですが、ほとんどすべてのコントラクトに統合する必要があり、ガス代が時間とともに安定していることを前提とする必要があります。そのため、プロトコルレベルで`GAS_PAYER`を`msg.sender`から分離することが有益であると考えられます。

### バッチトランザクション
EOAが一連のトランザクションを実行し、それらが順番に確実に実行されることを保証したい場合があります。例えば、トークンをコントラクトに送信した後、その宛先アドレスに対してコントラクトコールを行い、そのトークンを自分に登録させたいといったケースです。レイヤー1でトランザクションのバッチ処理をサポートすることで、署名時に強い横断的な原子性の保証を得ることができます。

### 期限付きトランザクション
* ダスト口座のクリーニングなどが導入された場合、[EIP-169](https://github.com/ethereum/EIPs/issues/169)のようなリプレイ保護が必要になります。時間ベースのリプレイ保護を導入すれば、ノンスの動作を変更する必要がなくなります。
* ICOなどの場合、ユーザーはトランザクションが数時間以内に含まれるか、まったく含まれないかを望むことが多いです。現在、トランザクションはキューに入り、数日後に実行される可能性があり、ユーザー(ガス代を無駄に支払う)とネットワーク(大量のトランザクションキューを処理する)の両方に負担がかかっています。
* ノード実装には、どのトランザクションを保持、破棄、または伝播するかについての共通の指標がありません。トランザクションにTTLを設けることで、システムから古いトランザクションを削除しやすくなります。

## 仕様
### 定義
**`TransactionType`** 2。[EIP-2718](./eip-2718.md)を参照してください。

**`TransactionSubtype`** は1、2、3、4のいずれかです。

**`ChainId`** このトランザクションは、この値が`0`であるか、この値と等しいチェーンIDのブロックに含まれる場合に有効です。

**`ValidUntil`** このトランザクションは、この値が`0`であるか、`timestamp`がこの値以下のブロックに含まれる場合に有効です。

**`YParity`** secp256k1署名のy値の奇偶性(偶数は0、奇数は1)。

**`ChildTransaction`** `[to, value, data]`から成る入れ子のトランザクション。

**`SenderPayload`** `TransactionSubtype`に応じて以下のように定義されます:
1. `[1, ChildTransaction[], nonce, ChainId, ValidUntil, gasLimit, gasPrice]`
2. `[2, ChildTransaction[], nonce, ChainId, ValidUntil, gasLimit, gasPrice]`
3. `[3, ChildTransaction[], nonce, ChainId, ValidUntil, gasLimit]`
4. `[4, ChildTransaction[], nonce, ChainId, ValidUntil]`

**`SenderSignature`** `secp256k1(keccak256(rlp([TransactionType, SenderPayload])))` の `[YParity, r, s]`

**`GasPayerPayload`** `TransactionSubtype`に応じて以下のように定義されます:
1. `[]`
2. `[]`
3. `[gasPrice]`
4. `[gasLimit, gasPrice]`

**`GasPayerSignature`** `TransactionSubType`が`1`の場合は`[]`、それ以外の場合は `secp256k1(keccak256(rlp([SenderPayload, SenderSignature, GasPayerPayload])))` の `[YParity, r, s]`

### 新しいトランザクションタイプ

`FORK_BLOCK_NUMBER`以降、[EIP-2718](./eip-2718.md)のトランザクションタイプ`2`の`Payload`は、RLPでエンコードされた以下のタプルとして解釈されます:
```
[...SenderPayload, ...SenderSignature, ...GasPayerPayload, ...GasPayerSignature]
```

`SenderSignature`から復元されるアドレスは、以下のものです:
1. トランザクションの最初のコールフレームで`CALLER`オペコード(0x33、`msg.sender`)が返すアドレス
2. `ORIGIN`オペコード(0x32、`tx.origin`)が返すアドレス
3. そのノンスが使用されるアドレス
4. トランザクションに値が添付されている場合、そのETHバランスが減額されるアドレス
5. `GasPayerSignature`が存在しない場合、ガス代が支払われるアドレス

`GasPayerSignature`が存在する場合、それから復元されるアドレスは、ガス代が支払われるアドレスです。

このタイプのトランザクションの基本ガス代は、`TRANSACTION_TYPE_2_BASE_GAS_PRICE` + `TRANSACTION_TYPE_2_CHILD_GAS_PRICE` * `n`となり、タイプ`0`やレガシートランザクションのコストとは異なります。

### 新しいトランザクションレシート

`FORK_BLOCK_NUMBER`以降、トランザクションタイプ`2`の[EIP-2718](./eip-2718.md)トランザクションレシートの`Payload`は、`rlp([status, cumulativeGasUsed, logsBloom, logs][])`として解釈されます。ここで、配列の各要素は、トランザクションタイプ2の`Payload`の対応するオフセットにある子トランザクションに対応します。

## 根拠
### 1つの包括的なEIP
このEIPは、サブタイプごとに1つずつ、およびメタタイプ用に1つに分割することもできます。あるいは、各サブタイプを固有の`TransactionType`とすることもできます。私たちが単一のEIPにサブタイプを含むことを選んだ理由は、これら4つのトランザクションにはかなりの共通点があり、個別のEIPにすると内容が重複してしまうためです。この場合、EIPを分割することによるメリットは小さいと判断しました。

### `v`にChainIDをエンコードしない
EIP-155のように、署名のy値のパリティとChain IDをまとめて1バイト保存することで、一般的なケースでデータサイズを1バイト削減できますが、署名ツールの複雑さが増すため、著者はトランザクション全体の大きさに比べてその価値は小さいと判断しました。

### ChainIDの任意性
時には、複数のチェーンでリプレイできるトランザクションが有用な場合があります。例えば、バニティ署名を持つトランザクションを構築し、その署名が復元するアドレスを`from`にする場合などです。ガス支払者(ガス上限とガス価格の両方を設定)を別に設定できることで、同じアドレスにコントラクトをデプロイできるようになります。これはCREATE2を使ったレガシートランザクションでも実現できますが、ここでは決定論的なトランザクションを簡単に実現できるようにするため、ChainIDを任意にすることにしました。

### ValidUntilの任意性
ユーザーは`ValidUntil`を非常に大きな値に設定することで、事実上期限切れにならないようにできます。`ValidUntil`を任意にすることで、このようなトランザクションではRLPのワイヤー上で1バイト(0の値)を節約できます。

### `SENDER`がガス上限とガス価格を設定
このタイプのトランザクションは、これらの値によってトランザクションの実行が異なる場合に有用です。`SENDER`が両方を設定することで、トランザクションの詳細を完全に制御できます。

### `SENDER`がガス上限を、`GAS_PAYER`がガス価格を設定
このタイプのトランザクションは、ガス使用量(ループの数など)によってトランザクションの実行が異なる場合に有用です。`SENDER`はガス上限を定義し、`GAS_PAYER`にガス価格の設定を任せることで、取り込まれる可能性を最大化できます。

### `GAS_PAYER`がガス上限とガス価格を設定
このタイプのトランザクションでは、`SENDER`が何をしたいかを定義し、ガスの心配は全て`GAS_PAYER`に任せられます。`SENDER`がガス使用量や支払価格を気にしない場合や、`GAS_PAYER`を不正ではないと信頼している(あるいは`SENDER`のノンスが増えることを気にしない)場合に有用です。このような状況では、セキュリティや複雑さの観点から、「何をするか」と「どのように取り込まれるか」を分離することが有益です。

### ノンス
内部トランザクションにはリプレイ攻撃を防ぐためのノンスが必要です。内部トランザクションにはノンスがあるため、外部トランザクションにもリプレイ保護が得られます。そのため、セキュリティ上、複数の当事者がノンスを提供する必要はありません。

`GAS_PAYER`に2つ目のノンスを提供させることもできますが、ペイロードサイズが増加し、`GAS_PAYER`がガス価格を上げるためにreplace-by-feeを行う必要があり(ゴシップに影響)、`SENDER`ノンスと`GAS_PAYER`ノンスの順序が一致しないとデッドロックが発生する可能性があります。また、トランザクションに2つのノンスがある場合、クライアントの複雑さが若干増加します。

### ValidUntil
ダスト口座のクリーニングのユースケースについて、
- このような変更は、コンセンサスエンジンへの影響が最小限に抑えられます。
  - 「最高知られているノンス」を維持したり、ブロック内の送信者あたりのトランザクション数を制限する必要がありません。
  - コンセンサスエンジンのトランザクション検証部分のみに影響します。
  - ノンスを使う他のスキームでは、意図しない副作用が発生する可能性があります。
    - 特定のアドレスでコントラクトを作成できなくなる
    - オフラインシグナーとの統合が難しくなる(ノンススキームがより複雑になる)
    - 「最高ノンス」のようなより複雑なスキームは、最高ノンスがコン
センサス構造となり、トランザクション実行時に増減し、巻き戻される可能性があるため、さらに1つ journalled フィールドが必要になり、非常に複雑になります。

### ブロック番号ではなくタイムスタンプとしてのValidUntil
- Unix時間はほとんどの環境で利用可能で、ブロック情報が利用できない状況でも、トランザクションに所望の特性を持たせることができます。
- ブロック番号とタイムの相関関係は固定されていません。13秒/ブロックが「望ましい」とされていますが、ネットワークのハッシュレートや難易度爆弾の進行により変動します。
- ブロック番号はテストネットやプライベートネットワークではさらに信頼性が低くなります。
- Unix時間の方が使いやすく、ユーザーは有効期限を合理的に設定しやすくなります。

## 下位互換性
既知の問題はありません。

## テストケース

## 実装

## セキュリティ上の考慮事項

## 著作権
著作権およびそれに関連する権利は[CC0](../LICENSE.md)で放棄されています。