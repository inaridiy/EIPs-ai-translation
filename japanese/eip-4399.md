---
original: 3cabb6092e244042e56e28b9ce3a2920d8244cf65299c5a99ed7c8e20aeccf60
---

---
eip: 4399
title: DIFFICULTY オペコードを PREVRANDAO に置き換える
description: ビーコンチェーンのランダム性をEVMで利用可能にするため、DIFFICULTY オペコードのセマンティクスを置き換える
author: Mikhail Kalinin (@mkalinin), Danny Ryan (@djrtwo)
discussions-to: https://ethereum-magicians.org/t/eip-4399-supplant-difficulty-opcode-with-random/7368
status: Final
type: Standards Track
category: Core
created: 2021-10-30
requires: 3675
---

## 概要

このEIPは、既存の `DIFFICULTY (0x44)` オペコードの返り値のセマンティクスを置き換え、オペコードの名称を `PREVRANDAO (0x44)` に変更します。

`DIFFICULTY (0x44)` 命令の返り値は、ビーコンチェーンによって提供されるランダム性ビーコンの出力になります。

## 動機

アプリケーションはビーコンチェーンによって蓄積されたランダム性を利用することで恩恵を受けられます。したがって、ビーコンチェーンによって生成されたランダム性出力をEVMで利用可能にする必要があります。

[EIP-3675](./eip-3675.md)で説明されている証明書付きステークホルダー(PoS)への移行の `TRANSITION_BLOCK` 時点以降、`difficulty` ブロックフィールドは**必ず** `0` になります。これは、もはやProof-of-Work(PoW)シールがブロックにないためです。つまり、`DIFFICULTY (0x44)` 命令は以前のセマンティクスを持たず、「正しい」値を返すこともできません。

`DIFFICULTY` の使用に関する過去の分析によると、命令の返り値を他の値と組み合わせてランダム性を得るのは一般的なパターンです。同じ番号のオペコードが、ビーコンチェーンのRANDAO実装の出力を返すようになれば、PoSへの移行に対して既存のスマートコントラクトが得ているランダム性の利用が下位互換性を持つことになります。

さらに、このEIPで提案された変更により、スマートコントラクトがPoSへの移行が既に行われたかどうかを判断できるようになります。これは、`DIFFICULTY` 命令の返り値を分析することで行えます。返り値が `2**64` を超えている場合、その取引がPoSブロックで実行されていることを示します。デコンパイラやその他の同様のツールも、対象のブロックに関するデータが利用可能であれば、この手法を使ってこの命令の新しいセマンティクスを見分けることができます。

## 仕様

### 定義

* **`TRANSITION_BLOCK`** この定義は、[EIP-3675](./eip-3675.md#definitions)の「定義」セクションにあります。

### ブロック構造

`TRANSITION_BLOCK` 以降、クライアントソフトウェアは**必ず**ブロックヘッダの `mixHash`、つまり0インデックスベースの13番目のフィールド、に前のブロックのポストビーコン状態の最新のRANDAOミックスを設定しなければなりません。

### EVM

`TRANSITION_BLOCK` 以降、`DIFFICULTY (0x44)` 命令は**必ず** `mixHash` フィールドの値を返さなければなりません。

*注意*: `DIFFICULTY (0x44)` オペコードのガスコストは変更されません。

### 名称変更

`mixHash` フィールドは**さらに** `prevRandao` に名称変更されるべきです。

`DIFFICULTY (0x44)` オペコードは**さらに** `PREVRANDAO (0x44)` に名称変更されるべきです。

## 根拠

### ブロックヘッダにRANDAO出力を含める

ブロックヘッダにRANDAO出力を含めることで、EVMコンテキストからそれにアクセスする簡単な方法を提供します。ブロックヘッダデータはEVMコンテキストですでに利用可能です。

さらに、これにより実行レイヤーがブロック単独で完全に実行できるようになり、PoSコンセンサスレイヤーからの追加の入力を必要としなくなります。

ブロックヘッダの他のフィールド値が別のブロックのヘッダと一致する場合、ランダム性をブロックハッシュにミックスすることで、ブロックの一意性に寄与する可能性があります。

### `difficulty` フィールドではなく `mixHash` フィールドを使用する

PoS移行後にフォークチョイスに関するバグが隠れるのを避けるため、`difficulty` ヘッダフィールドではなく `mixHash` を使用しています。

EIP-3675以前のロジックを実装したクライアントソフトウェアは、PoWフォークチョイスルールの基礎となる総難易度の計算に `difficulty` 値を大きく依存しています。PoS移行時に `difficulty` フィールドを `0` に設定することで、移行後の総難易度値の増加に関連するバグの表面を減らすことを目的としています。

さらに、PoS移行後の潜在的な総難易度の計算はオーバーフローしやすくなるため、ランダム性出力が `difficulty` フィールドの値を置き換えることになります。

### 新しいフィールドを追加するのではなく既存のフィールドを再利用する

`mixHash` フィールドはPoS移行時に非推奨化され、その後はゼロバイト配列に設定されます。既存のフィールドを使ってランダム性出力の場所とすることで、32バイトのブロックサイズの節約と、アップグレードによって誘発される1つのフィールドの非推奨化の解消が可能になります。

### 新しいオペコードを導入するのではなく `DIFFICULTY` オペコードを再利用する

[動機](#motivation)を参照してください。

### フィールドとオペコードの名称変更

名称変更は、フィールドとオペコードの名称を意味的に適切なものにするために行われます。

### ブロック番号やスロット番号ではなく `TRANSITION_BLOCK` を使用する

このEIPでは、[EIP-3675](./eip-3675.md)で定義されているPoS移行に密接に結び付けるため、この変更のトリガーとして `TRANSITION_BLOCK` を使用しています。

PoS移行に密接に結び付けることで、このオペコードのランダム性利用ユースケースに不連続性がないことを保証します。これは、新しいオペコードを作成するのではなく `DIFFICULTY` を再利用する[動機](#motivation)の主要なものです。

### `2**64` のしきい値を使ってPoSブロックを判別する

RANDAOの値が `0` から `2**64` の範囲に落ちる確率は非常に低いです。提案されたしきい値は、現在のイーサリアムメインネットの難易度値(約 `2**54`)に比べて十分な距離があるように見えないかもしれませんが、ハッシュレートが1000倍増加しない限り、このしきい値は安全だと考えられます。そのような大幅な増加は、今後の合意アップグレードが行われる前に起こるとは考えにくいです。

## 下位互換性

このEIPは、EVM状態遷移の実行と検証に下位互換性のない変更を導入します。このEIPは `TRANSITION_BLOCK` を利用しており、[EIP-3675](./eip-3675.md)で導入されたPoS移行に密接に結び付けられています。このEIPが採用される場合、EIP-3675と同時にスケジュールされる**必要があります**。

さらに、提案された変更は以下のカテゴリのアプリケーションに対して下位互換性がない可能性があります:
* `DIFFICULTY` オペコードの返り値をPoW `difficulty` パラメータとして使用しているアプリケーション
* `DIFFICULTY` オペコードの返り値が256ビットフィールドの相対的に小さい数値であることに依存しているロジックを持つアプリケーション

最初のカテゴリはコンセンサスメカニズムがPoSに切り替わることで既に影響を受けており、この仕様による追加の破壊的な変更はありません。

2番目のカテゴリは、`DIFFICULTY` オペコードの返り値を演算に使用しており、オーバーフローやアンダーフローのエラーが発生する可能性のあるアプリケーションで構成されています。理論的には、このオペコードの返り値の範囲の変化がセキュリティ上の脆弱性につながる可能性はありますが、その可能性は非常に低いと考えられます。

## テストケース

* `TRANSITION_BLOCK` の先祖の1つでコントラクトをデプロイし、`DIFFICULTY (0x44)` の返り値を状態に格納する
* `TRANSITION_BLOCK` の親で実行されるトランザクションの `DIFFICULTY (0x44)` の返り値が `difficulty` フィールドの値と等しいことを確認する
* `TRANSITION_BLOCK` で実行されるトランザクションの `PREVRANDAO (0x44)` の返り値が `prevRandao` フィールドの値と等しいことを確認する

## セキュリティ上の考慮事項

PoSイーサリアムの `PREVRANDAO (0x44)` オペコード(ビーコンチェーンのRANDAO実装に基づく)は、`BLOCKHASH (0x40)` や `DIFFICULTY (0x44)` オペコードによって供給されるランダム性とは異なるプロパティを持つランダム性のソースです。

### 偏りの可能性

ビーコンチェーンのRANDAO実装では、各ブロック提案者がスロットごとに1ビットの影響力を持ちます。提案者は、ビーコンチェーンのランダム性(RANDAOミックス)が特定のスロットで更新されるのを防ぐために、提案機会とトランザクション手数料の機会費用を払って意図的にブロックを提案しないことができます。

提案者の影響力の効果は時間的に限定されており、その後の最初の正直なRANDAO公開まで続きます。この制限は、連続する `n` 個のスロットの提案者が共謀して `n` ビットの影響力を得ようとする場合にも存在します。つまり、1つの正直なブロック提案で、RANDAOが数スロットにわたって偏っていたとしても、それを修正することができます。

さらに、`PREVRANDAO (0x44)` 命令のセマンティクスにより、提案者にはアプリケーションに対する1ビットの影響力を得る別の方法が与えられます。偏った提案者は、サイコロを振るトランザクションをセンサーして、次のブロックに含まれるよう強制し、事前に知っているRANDAOミックスを使わせることができます。この場合の機会費用は無視できるほど小さいでしょう。

### 予測可能性

明らかに、分散型オラクルによって提供される過去のランダム性は100%予測可能です。一方で、将来明らかにされるランダム性は、限定的な範囲でしか予測できません。

ビーコンチェーンの将来のランダム性に影響を与える入力のリストには以下のようなものが含まれますが、これらに限定されるわけではありません:
* **蓄積されたランダム性** エポック `N` の最後のスロットでビーコンチェーンが生成したRANDAOミックスは、エポック `N + MIN_SEED_LOOKAHEAD + 1` の各スロットのブロック提案者を定義する関数の主要な入力です。つまり、将来のRANDAO公開者を定義する主要な要因です。
* **アクティブバリデーターの数** エポック全体にわたるアクティブバリデーターの数は、ブロック提案者関数のもう1つの入力です。
* **有効残高** その他の条件が同じであれば、バリデーターの有効残高が低いほど、そのバリデーターがスロットの提案者に指定される確率が低くなります。
* **偶発的に見逃されたプロポーザル** ネットワーク状況やその他の要因により偶発的に見逃されたプロポーザルは、RANDAOミックスに大きな影響を与える高品質のエントロピーのソースです。メインネットでの通常の見逃し率は約 `1%` です。

これらの入力は短期的には予測可能で操作可能かもしれませんが、予測しようとする期間が長くなるほど、ビーコンチェーンによってより多くのエントロピーが蓄積されます。

### アプリケーション開発者向けのヒント

`PREVRANDAO (0x44)` によって返される乱数の予測可能性と偏りを低減するための以下のヒントを提案します:

1. アプリケーションが未来のランダム
性に合理的に高いルックアヘッドを持つようにしてください。例えば、アプリケーションがエポック `K` の終わりでの入札を受け付けを停止し、エポック `K + N + ε` のスロットで生成されたRANDAOミックスを使ってサイコロを振る、ここで `N` はエポックのルックアヘッド、`ε` は1エポック `N + 1` 後の数スロットです。

2. 少なくとも4エポックのルックアヘッドを設定すると以下の結果が得られます:
  * エポック `N + 1` のプロポーザーセットがエポック `K` の終わりには知られていないため、入札者とサイコロ振りの直接的な関係が断たれる
  * 各エポックの終わりにアクティブバリデーターの数が更新されるため、次のエポックのプロポーザーセットに影響を与え、サイコロ振りに使用されるRANDAOミックスにも影響する
  * メインネットの統計から、この期間中に提案が偶発的に見逃される確率が約 `100%` になるため、サイコロ振りに使用されるRANDAOミックスの予測可能性が低下する

3. `ε` を2スロットや4スロットといった小さな数に設定すると、第三者が将来のランダム性に影響力を得る時間が少し与えられます。この時間は `MIN_SEED_LOOKAHEAD` パラメータによって定義され、メインネットでは約6分です。

入札とサイコロ振りの間に十分な距離を置くことで、一部のバリデーターを支配する入札者が直接的に影響力を行使する可能性を低くすることを目指しています。最終的には、この可能性はゲームの種類とコントロールするバリデーターの数に依存します。例えば、単一のバリデーターが1回限りのゲームに影響を与える可能性は無視できますが、繰り返しゲームシナリオでは複数のバリデーターの場合にはより大きくなります。

## 著作権
著作権およびそれに関連する権利は[CC0](../LICENSE.md)によって放棄されています。