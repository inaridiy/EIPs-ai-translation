---
original: 8d8259af8d26b91ae9aca1e5156f30b3d3f09a6f215c758ee23f883a1203cc87
---

---
eip: 140
title: REVERT命令
author: Alex Beregszaszi (@axic), Nikolai Mushegian <nikolai@nexusdev.us>
type: Standards Track
category: Core
status: Final
created: 2017-02-06
---

## 簡単な概要

`REVERT`命令は、状態変更をロールバックしつつ、残りのガスを全て消費せずに実行を停止し、理由を返すことができる方法を提供します。

## 概要

`REVERT`命令は実行を停止し、これまでに行った全ての状態変更をロールバックします。さらに、エラーコードやメッセージとして解釈できるメモリ領域へのポインタを返します。この際、残りのガスを全て消費することはありません。

## 動機

現在のところ、これは不可能です。コントラクト内からトランザクションをリバートする実用的な方法は2つあります: ガス切れを引き起こすか、無効な命令を実行することです。どちらの場合も、残りのガスを全て消費してしまいます。さらに、EVM実行をリバートすると、LOGを含む全ての変更が失われ、EVM実行を中止する理由を伝える方法がありません。

## 仕様

`BYZANTIUM_FORK_BLKNUM`以降のブロックで、`0xfd`の`REVERT`命令が導入されます。スタックの一番上に`memory_offset`が、その次に`memory_length`が置かれています。実行を停止するため、スタック要素は生成しません。

メモリとメモリコストに関する`REVERT`の意味論は、`RETURN`と同じです。`memory_offset`と`memory_length`で指定されるバイト列は、以下では"エラーメッセージ"と呼びます。

`REVERT`の効果は、実行が中止され、失敗したとみなされ、状態変更がロールバックされることです。エラーメッセージは呼び出し側のreturndata バッファに利用可能となり、通常のリターンデータと同様に出力領域にもコピーされます。

`REVERT`命令のコストは`RETURN`命令と同じです。つまり、ロールバック自体はガスを消費しませんが、メモリコストは支払う必要があります。

`REVERT`を実行するのに十分なガスがない場合や、スタックアンダーフローが発生した場合、`REVERT`命令の効果は通常のガス切れ例外と同じになります。つまり、残りのガスを全て消費します。

他の失敗と同様に、呼び出し元のオペコードは`REVERT`オペコードの後に`0`をスタックに返します。

`REVERT`が`CREATE`または`CREATE2`呼び出しのコンテキストで使用された場合、コードはデプロイされず、スタックに`0`が置かれ、エラーメッセージはreturndata バッファに利用可能となります。

オプションで提供されるメモリ領域の内容は、このEIPでは定義されていませんが、別の情報提供EIPの候補となります。

## 下位互換性

過去に作成されたコントラクトには、`0xfd`が命令として含まれていない限り、この変更は影響しません。

## テストケース

```
6c726576657274656420646174616000557f726576657274206d657373616765000000000000000000000000000000000000600052600e6000fd
```

これは以下のようになるはずです:
- `0x726576657274206d657373616765`を`REVERT`データとして返す
- キー`0x0`の格納領域は未設定のままである
- 合計で20024ガスを消費する

## 著作権

[CC0](../LICENSE.md)によりライセンスされています。