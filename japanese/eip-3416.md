---
original: 181bd60bbfc5c360d48c202f0a9a04f7c56b276ed26d5b64158c884b776f54b6
---

---
eip: 3416
title: メディアンガスプレミアム
author: HexZorro (@hexzorro), Mojtaba Tefagh (@mtefagh)
discussions-to: https://ethereum-magicians.org/t/eip-3416-median-gas-premium/5755
status: 停滞
type: Standards Track
category: Core
created: 2021-03-18
---

## 簡単な要約

固定のブロックあたりネットワーク料金とメディアン包含料金の加算更新を持つトランザクション価格付けメカニズム。

## 概要

プロトコル内にはガスあたりの基本料金があり、これは各ブロックで最大1/8まで上下する可能性がある。ガスあたりの基本料金は、絶対的なガス使用量ではなく、ブロックあたりの平均ガス使用量をターゲットとするように、プロトコルによって調整される。ブロックがガス制限ターゲットを超えると基本料金が上がり、ガス制限ターゲットを下回ると下がる。トランザクション送信者は以下の1つの値を指定することで手数料を指定する:

* 手数料上限 - これは、トランザクションが含まれるようにするために送信者が支払う意思のある最大の合計料金(基本料金 + ガスプレミアム)を表す。これは現在の最大ガス価格の指定と似ているが、この提案のプロトコル変更では、ほとんどの場合、送信者が提案した最終ガス価格よりも低くなる。

次に、ガスプレミアムが(手数料上限 - 基本料金)の50%として直接計算される。このガスプレミアムが基本料金に加算されて、重み付きメディアン計算で使用されるガス価格が算出される。送信者が指定した手数料上限に応じて決まるこのガスプレミアムは、マイナーのおじいレート・リスクのみを補償するために低い値に設定したり、突発的な活動時に競争するために高い値に設定したりできる。ブロックに含めようとするすべてのトランザクションを使って、上位5%の外れ値ガス価格を除外して**重み付きメディアンガスプレミアム**が計算される。これにより、マイナーの操作に対してより堅牢になる。

## 動機

以下の目標を目指します:

* ガス価格のスパイクが数学的に滑らかになる。EIP1559はガスプレミアムの変動性とユーザー体験への対応が十分ではないようだ。
* ガス価格の優先順位を維持する。つまり、より高い手数料を支払う意思のあるトランザクション送信者は、メディアンを最大化することでマイナーの利益を最大化したいため、優先的に早期に含まれるようになる。
* 送信者が指定した最大ガス価格よりも、ほとんどの場合、最終的に支払うガス価格が小さくなる。
* ガス価格設定がより送信者操作やマイナー操作に強くなる。

現在、Ethereumはシンプルな入札メカニズムを使ってトランザクション手数料を価格付けしています。ユーザーがトランザクションに「ガス価格」の入札を送信し、マイナーがその中で最も高い入札を選択します。そして、含まれたトランザクションはユーザーが指定した入札価格を支払います。これには以下のような大きな非効率性がある:

* **現在の極端なガス価格の変動がユーザー体験を損なっている**: オンラインのガス価格指標を見ると、推奨ガス価格の現在の傾向は1分ごとに大幅に変化する可能性があり、ネットワークのユーザー体験がとても不便になっている。また、ガスの変動性はマイニングビジネスをより予測不可能で高コストにしている。なぜなら、マイナーはリスクをヘッジするために費用を使わなければならないからだ。
* **トランザクション手数料水準の変動と取引の社会的コストのミスマッチ**: 成熟したパブリックブロックチェーンでのトランザクションの含有入札は極端に変動する傾向にある。Ethereumでは、最小入札は1ナノETH(10^9ナノETH = 1 ETH)ですが、時には100ナノETHを超え、200ナノETHを超えることもある。これは明らかに多くの非効率性を生み出している。なぜなら、ブロックに1つのトランザクションを追加することで発生するネットワークのコストが、ガス価格が200ナノETHのときに1ナノETHのときの200倍も高いと主張するのは明らかに不合理だからだ。どちらの場合も、8百万ガスと8.02百万ガスの違いにすぎない。
* **ユーザーの不要な遅延**: ブロックあたりのガス制限と取引量の自然な変動性により、トランザクションはしばしば数ブロック待たされてから含まれるが、これは社会的に生産的ではない。1つのブロックが大きく、次のブロックが小さくなることで需要の日々の違いに対応できる「スラック」メカニズムがないことから誰も大きな利益を得ていない。
* **第一価格入札の非効率性**: 現在のアプローチでは、トランザクション送信者が最大料金の入札を公開し、マイナーが最高入札のトランザクションを選択し、すべてが入札した価格を支払う。これは、メカニズムデザインの文献では非常に非効率であることが知られており、複雑な手数料推定アルゴリズムが必要となる。しかし、これらのアルゴリズムでも十分に機能しないことが多く、頻繁な手数料の過払いにつながっている。プロトコル内部で計算される、より安定した手数料指標が必要である。

このEIPの提案は、ネットワークの混雑状況に応じてプロトコルが少しずつ上下させる基本料金額から始めるものです。ブロックがターゲットのガス使用量を超えると基本料金がわずかに上がり、容量が下回ると下がります。これらの基本料金の変化は制限されているため、ブロックごとの最大の差は予測可能になります。これにより、ウォレットが非常に確実にユーザーのガス料金を自動設定できるようになります。ほとんどのユーザーは、高いネットワーク活動期間でも手動でガス料金を調整する必要がなくなると期待されています。ほとんどのユーザーにとって、基本料金はウォレットによって推定され、トランザクションの緊急性と優先順位に応じて小さなガスプレミアムが追加されます。

## 仕様

### 定義

これは長期の移行期間を持たないクラシックなフォークです。

* `FORK_BLOCK_NUMBER`: 未定。EIP-3416トランザクションが有効になるブロック番号。
* `GAS_TARGET_MAX_CHANGE`: `1 // 1024`.
* `BLOCK_GAS_USED`: ブロックに含まれるトランザクションの合計ガス消費量。
* `PARENT_GAS_USED`: 親ブロックの `BLOCK_GAS_USED` と同じ。
* `CURRENT_BLOCK`: 現在処理中のブロック(検証中または生成中)。
* `BASE_FEE`: ブロックヘッダーの16番目のアイテム。トランザクションが1ガス単位使用するごとに焼却されるattoethの量を表す。
* `PARENT_BASE_FEE`: 親ブロックの `BASE_FEE` と同じ。
* `BASE_FEE_MAX_CHANGE`: `1 // 8`
* `INITIAL_BASE_FEE` : `FORK_BLOCK_NUMBER - 1`のメディアンガス価格。

### プロセス

* `block.number == FORK_BLOCK_NUMBER`の場合、`BASE_FEE = INITIAL_BASE_FEE`を設定する
* `FORK_BLOCK_NUMBER + 1`以降、`BASE_FEE`は以下のように設定される
  * `GAS_DELTA = (PARENT_GAS_USED - PARENT_GAS_TARGET) // PARENT_GAS_TARGET`(負の可能性あり)を計算する。
  * `BASE_FEE = PARENT_BASE_FEE + GSA_DELTA * BASE_FEE_MAX_CHANGE`を設定する
* `FORK_BLOCK_NUMBER`以降のトランザクションは、現在のものと同じようにエンコードされる `rlp([nonce, gasPrice, gasLimit, to, value, data, v, r, s])` ここで `v,r,s`は`rlp([nonce, gasPrice, gasLimit, to, value, data])`の署名であり、`gasPrice`は本提案の`FEE_CAP`である。
* `FORK_BLOCK_NUMBER`以降のトランザクションを生成するには、新しい`FEE_CAP`フィールド(トランザクションの`gasPrice`という従来の名称を維持)を以下のように設定する(そして`GAS_PREMIUM`は指定のように計算される):
  * `FEE_CAP`: `tx.gasPrice`は、トランザクション送信者が含まれるようにするために支払う意思のある最大の合計料金を表す。
  * `GAS_PREMIUM = (FEE_CAP - BASE_FEE) / 2`はマイナーに対する送信者の希望するメディアンプレミアムを表す。
  * `FEE_CAP < BASE_FEE`の場合、そのトランザクションは無効とみなされ、現在のブロックには含められないが、将来のブロックに含められる可能性がある。
* トランザクション実行時、EIP3416トランザクションについては、`tx.origin`への費用と`block.coinbase`への利益を以下のように計算する:
  * `GASPRICE = BASE_FEE + median((tx_i.gasPrice - BASE_FEE) / 2)` を計算する。ここで `tx_i` は同じブロックに含まれるすべてのトランザクションで、*ガス消費量で加重*され、上位5%の外れ値ガス価格は計算に含まれない。加重メディアンを上位5%の外れ値を除いて計算するとは、`BASE_FEE + tx.gasPrice / 2`に従ってガス単位が順序付けられ、下位95%を2つの部分に分ける値を選択することを意味する。
  * トランザクション実行/状態遷移中に使用されたガスを`GASUSED`とする。
  * `tx.origin`は当初`GASPRICE * tx.gasLimit`を支払い、`GASPRICE * (tx.gasLimit - GASUSED)`が払い戻される。

マイナーは依然として、`FEE_CAP`の大きい順にトランザクションを新しいブロックに追加する「貪欲」な戦略を使うことができる。これは現在のブロック生成と同様であり、`FEE_CAP`と`GAS_PREMIUM`が正の線形関数の関係にあるためである。

## 根拠

プレミアムが(手数料上限 - 基本料金)の50%であるのは、ある時点での平均的なネットワーク送信者の手数料上限が平均的であり、基本料金と手数料上限の間に送信者に特別な好みはないと仮定しているためである。つまり、送信者はブロックに何らかの形で含まれることさえできれば、この一様な範囲内のメディアンプレミアムで満足する。別の根拠としては、ユーザーも新しいブロック価格付けプロトコルがメディアンを使用することを知っているので、自分の優先範囲内でメディアンを適用するのが公平だと考えていると仮定できる。Ethereumのガスデータでのシミュレーション([ここ](https://hackmd.io/c6kyRNMuTnKf_SlolmevRg#An-improvement-for-the-premium))では、メディアンが最も堅牢な指標の1つであることが示されている。

上位5%の外れ値を除外して考慮しないのは、マイナーの操作に対してより堅牢にするためである。なぜなら、最近6ヶ月間のネットワーク利用率が97%前後で推移しているため、マイナーは自分のトランザクションを3%の空きスペースに含めることで、メディアン価格を操作して引き上げようとする可能性があるからだ(この操作の影響は最終価格にはごくわずかしかない)。

`BASE_FEE`更新式の根拠は、送信者がこの料金をゼロにするという攻撃を避けるために、加算版(`PARENT_BASE_FEE + GAS_DELTA * BASE_FEE_MAX_CHANGE`)を使用していることである。この攻撃は以前のバージョンで提案された乗算式(`PARENT_BASE_FEE + PARENT_BASE_FEE * GAS_DELTA * BASE_FEE_MAX_
CHANGE`)でシミュレーションされ、観察されていた。この攻撃とシミュレーションについての記事は[ここ](https://mtefagh.github.io/fee/)にある。

`BASE_FEE`更新式を加算版にする別の根拠は、[この論文](https://pdfs.semanticscholar.org/3d2d/773983c5201b58586af463f045befae5bbf2.pdf)によると、緊急性の低いトランザクションのバッチの最適な実行戦略(料金を少なくするためにブロードキャストをスケジューリングする)は、ブロックにトランザクションを分散させることであり、これがネットワークの混雑を回避し、変動性を低下させるのに役立つということである。乗算式の場合は、まさに逆で、スパイク(一度に全てのトランザクションをダンプする)が奨励されるという[ここ](https://ethresear.ch/t/path-dependence-of-eip-1559-and-the-simulation-of-the-resulting-permanent-loss/8964)で説明されている。

`BASE_FEE_MAX_CHANGE`が`1 // 8`である根拠は、`BASE_FEE`がブロック利用率の変化に非常に適応的に設計されているためである。

## 下位互換性

下位互換性は非常に簡単である。トランザクションに新しいフィールドが追加されていないためである。ブロックあたりのガス価格の設定は、マイナー/検証者側ではわずかに複雑になるが、依然として高速に計算できる。変更はマイナー/検証者にのみ影響する。ウォレットはこの提案の影響を受けない。

## テストケース

未定。

## セキュリティ上の考慮事項

* 送信者は最小料金を操作できない。なぜなら、`BASE_FEE`の最小値はマイナーによって小さな増減で制御されるためである。
* `BASE_FEE`を超える部分では、送信者が最終的に支払うガス価格を操作して下げる能力は非常に限られている。なぜなら、重み付きメディアンを`BASE_FEE`に近づける必要があり、これは非常に堅牢な統計量であるためである。
* マイナーが最終的な支払いガス価格を`BASE_FEE`以上に操作して引き上げる能力も非常に限られている。なぜなら、最終ガス価格に影響を与えるためには、ブロックの上位5%を超えるフェイクトランザクションを詰め込む必要があるためである。平均的に、現在ブロックの上位3%しか空いていないので、5%を埋めるためには、採算性の高いトランザクションを削除し始める必要がある。5%を超えてからメディアンをわずかに動かし始めることができるが、メディアンはまだ非常に堅牢な統計量で、簡単に操作されるものではない。

## 著作権

著作権およびそれに関連する権利は[CC0](../LICENSE.md)で放棄されています。