---
original: 88923ffbc2a937db0cdf44a0455d90295ed9cea851cbb5f4367deb13f4857fbc
---

---
eip: 758
title: 完了したトランザクションのサブスクリプションとフィルター
author: Jack Peterson <jack@tinybike.net>
type: Standards Track
category: Interface
status: Stagnant
created: 2017-11-09
requires: 1474
---

## 簡単な概要
外部のコールアウトに完了したトランザクションの通知を提供し、トランザクションがマイニングされたときに実行された関数の返り値にアクセスする方法を提供する。

## 概要
新しいトランザクションが Ethereum ノードに正常に送信されると、ノードはそのトランザクションのハッシュを返します。トランザクションが契約関数の実行を伴い、その関数が値を返す場合、その値は破棄されます。返り値が状態依存的である場合（一般的な場合）、コールアウトが返り値にアクセスまたは計算する方法はありません。このEIPでは、コールアウトが完了したトランザクションにサブスクライブ（またはポーリング）できるようにすることを提案しています。Ethereum ノードは、トランザクションがシールされたときに返り値をコールアウトに送信します。

## 動機
現在、外部のコールアウトには、`eth_sendTransaction` または `eth_sendRawTransaction` RPC リクエストを介して実行された関数の返り値にアクセスする方法がありません。関数の返り値にアクセスできることは多くの場合望ましい機能です。外部のコールアウトにも返り値を利用可能にすることで、内部のコールアウトが返り値にアクセスできるのに対し外部のコールアウトはアクセスできないという不整合も解消されます。現在の一般的な回避策は、返り値をログに記録することですが、これには次のような問題があります: チェーンの肥大化に寄与する、コールアウトに追加のガス代がかかる、内部関数呼び出しの返り値がログに記録される場合に使用されないログが書き込まれる可能性がある。この EIP の初期バージョンの実装中に、返り値がない場合でも（メソッドが値を返さない場合や、トランザクションが単なる価値の移転である場合）、外部のコールアウトに自分のトランザクションの完了を通知する機能を追加することにしました。

## 仕様

### サブスクリプション
自分のトランザクションの完了を通知してもらいたいコールアウトは、最初のパラメーターを `"completedTransaction"` とする `eth_subscribe` RPC リクエストを送信します:

```json
{"jsonrpc": "2.0", "id": 1, "method": "eth_subscribe", "params": ["completedTransaction", filter]}
```

`filter` パラメーターは、`from`、`to`、`hasReturnData` の3つのオプションの名前付き引数を含む辞書です。`from` と `to` は、それぞれ単一のアドレスまたはアドレスのリストにできます。これらは、`from` リストのアドレスから送信され、`to` リストのアドレスに送信されたトランザクションをフィルタリングするために使用されます。`hasReturnData` はブール値で、指定され `true` の場合、返り値を含むトランザクションの完了通知のみが受信されます。

例えば、2つのアドレス (0x3f7d39bDBf1f5cE649c194571aEd3D2BbB2F85ce または 0x7097f41F1C1847D52407C629d0E0ae0fDD24fd58) から送信された契約作成のみの結果に制限するには:

```json
filter = { "from" : ["0x3f7d39bDBf1f5cE649c194571aEd3D2BbB2F85ce",
                      "0x7097f41F1C1847D52407C629d0E0ae0fDD24fd58"],
           "to" : "0x0" 
         }
```

0xD9Cb531aB97A652c8fC60dcF6D263fcA2F5764e9 のコントラクトアドレスへのメソッド呼び出しの結果に制限するには:
```json
filter = { "to" : "0xD9Cb531aB97A652c8fC60dcF6D263fcA2F5764e9", "hasReturnData" : true }
```
または、このRPCクライアントが送信したすべてのトランザクションの完了を通知してもらうには (さらなる制限なし):
```json
filter = {}
```

リクエストを受け取ると、Ethereum ノードはサブスクリプション ID を返します:

```json
{"jsonrpc": "2.0", "id": 1, "result": "0x00000000000000000000000000000b0b"}
```

その後、コールアウトが `eth_sendTransaction` または `eth_sendRawTransaction` RPC リクエストを介してトランザクション (`"0x00000000000000000000000000000000000000000000000000000000deadbeef"` のトランザクションハッシュ) を送信したとします。トランザクションがシールされると (マイニングされると)、Ethereum ノードはコールアウトに通知を送信します。トランザクションが契約関数の呼び出しである場合、この通知には呼び出された関数の返り値 (例: `"0x000000000000000000000000000000000000000000000000000000000000002a"`) が含まれます:

```json
{
  "jsonrpc": "2.0",
  "method": "eth_subscription",
  "params": {
    "result": {
      "transactionHash": "0x00000000000000000000000000000000000000000000000000000000deadbeef",
      "returnData": "0x000000000000000000000000000000000000000000000000000000000000002a"
    },
    "subscription": "0x00000000000000000000000000000b0b"
  }
}
```

コールアウトは、2つのケースでトランザクションの通知を受け取ります: 最初にトランザクションがシールされたとき、そしてもう一度 (`"removed": true` フィールドが追加された) トランザクションがチェーン再編成の影響を受けた場合です。サブスクリプション後にシールされたクライアントから送信されたすべてのトランザクションについて、通知がクライアントに送信されます。`from`、`to`、または `hasReturnData` が指定されている場合は、フィルター条件に一致するトランザクションのみが通知を生成します。他のサブスクリプションと同様に、コールアウトは `eth_unsubscribe` RPC リクエストを送信してプッシュ通知の受信を停止できます:

```json
{"jsonrpc": "2.0", "id": 2, "method": "eth_unsubscribe", "params": ["0x00000000000000000000000000000b0b"]}
```

### ポーリング
プッシュ通知には全二重接続 (WebSocket または IPC) が必要です。サブスクリプションの代わりに、HTTP を使用するコールアウトは `eth_newCompletedTransactionFilter` リクエストを送信できます:

```json
{"jsonrpc": "2.0", "id": 1, "method": "eth_newCompletedTransactionFilter", "params": [filter] }
```

Ethereum ノードはフィルターID を返します:

```json
{"jsonrpc": "2.0", "id": 1, "result": "0x1"}
```

トランザクションが送信されると、Ethereum ノードはトランザクションの通知 (返り値を含む) をキューに入れ、コールアウトが `eth_getFilterChanges` を使ってポーリングするときに返します:

```json
{"jsonrpc": "2.0", "id": 2, "method": "eth_getFilterChanges", "params": ["0x1"]}
```

ノードは、計算された順序でトランザクションハッシュとその対応する返り値の配列を返します:

```json
{
  "jsonrpc": "2.0",
  "id": 2,
  "result": [{
    "transactionHash": "0x00000000000000000000000000000000000000000000000000000000deadbeef",
    "returnData": "0x000000000000000000000000000000000000000000000000000000000000002a"
  }]
}
```

初期の `eth_newCompletedTransactionFilter` リクエスト以降にシールされたすべてのトランザクションがこの配列に含まれます。ここでも、`filter` パラメーターが空でない辞書 (either `from`、`to`、または `hasReturnData` を含む) である場合は、フィルター条件に一致するトランザクションのみが通知を生成します。ポーリングの場合、Ethereum ノードがトランザクションを送信したRPCクライアントがフィルターを作成したクライアントと同じであることを確認する方法がないため、トランザクションの送信元に基づく制限はありません。

## 根拠
[EIP-658](./eip-658.md) は当初、トランザクションレシートに返り値を追加することを提案していました。ただし、返り値はブロックチェーンに保存されないため (コストがかからないため)、それをトランザクションレシートに追加するとDoSやスパムの機会につながる可能性がありました。代わりに、単純なブール値の `status` フィールドがトランザクションレシートに追加されました。この修正版のEIP 658はByzantiumハードフォークに含まれていました。`status` フィールドは有用ですが、アプリケーションはしばしば返り値も必要とします。

ここで概説した戦略の主な利点は効率性にあります: ブロックチェーンに余分なデータを保存する必要がなく、ノードに余分な計算負荷もかかりません。事後的な返り値の検索はサポートされませんが、これは一般的な返り値の使用法と一致しています。関数が返答するときにのみ返り値にアクセスでき、後で使用するために保存されることはありません。

## 著作権
著作権およびそれに関連する権利は [CC0](../LICENSE.md) で放棄されています。