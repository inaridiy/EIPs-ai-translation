---
original: 387dbfab6056f34fac5455d19605884da29a8b2a5e10c4d2a0190b5c60c61122
---

---
eip: 1344
title: ChainID オペコード
author: Richard Meissner (@rmeissner), Bryant Eisenbach (@fubuloubu)
discussions-to: https://ethereum-magicians.org/t/add-chain-id-opcode-for-replay-protection-when-handling-signed-messages-in-contracts/1131
category: Core
type: Standards Track
status: Final
created: 2018-08-22
requires: 155
---

## 概要
このEIPは、現在のチェーンのEIP-155固有の識別子を返すオペコードを追加します。

## 動機
[EIP-155](./eip-155.md)は、異なるチェーン間のリプレイ攻撃を防ぐためにチェーンIDを使用することを提案しています。特に[EIP-712](./eip-712.md)を使用するレイヤー2署名スキームを扱う際に、同様の機能をスマートコントラクト内で持つことは大変有益です。

## 仕様
新しいオペコード `CHAINID` を 0x46 に追加し、スタックに 0 個の引数を使用します。これにより、現在のチェーンIDがスタックにプッシュされます。チェーンIDは 256 ビットの値です。この操作の実行コストは `G_base` です。

現在のチェーンIDの値は、チェーンID構成から取得されます。これは、クライアントが着信トランザクションから受け入れるEIP-155固有の識別子と一致する必要があります。EIP-155によると、トランザクションにEIP-155固有の識別子を持つことは*必須*ではありませんが、その場合このオペコードは構成されたチェーンIDを返します。

## 根拠
EIP-712で提案されている現在のアプローチは、コンパイル時にチェーンIDを指定することです。このアプローチを使用すると、ハードフォーク後や人為的なエラーによって、署名メッセージの損失やリプレイ攻撃の問題が発生する可能性があります。
提案されたオペコードを追加することで、現在のチェーンIDにアクセスし、それに基づいて署名を検証することができます。

現時点では、特定のネットワークのチェーンIDの設定方法について明確な仕様はなく、クライアントの実装者とチェーンコミュニティの選択に依存しています。「分裂」と呼ばれる対立的な問題をめぐって、特定のチェーンIDの値を使用しているコミュニティが2つのチェーンに分かれる可能性があります。このシナリオが発生した場合、プロトコル内のトランザクション(EIP-155に従う)やL2および「メタトランザクション」(EIP-712に従う)の replay 保護のために、両方のチェーンでチェーンIDを同じ値に維持するのは安全ではありません。この状況に対する2つの潜在的な解決策は、1) 1つのチェーンがチェーンIDの値を変更する(もう1つのチェーンはそのままにする)、2) 両方のチェーンがチェーンIDの値を変更する、です。

この状況を緩和するために、提案された `CHAINID` オペコードのユーザーは、必要に応じてチェーンIDの値の更新に対応できるようにする必要があります。アプリケーションレベルの機能として、またはグローバルに標準化されたコントラクトとして参照される、チェーンIDの変更時刻をログに記録するトラストレスオラクルを実装することができます。この緩和策を提供しないと、以前に署名された off-chain メッセージの正当性が突然失われる可能性があり、これらのメッセージの決済期間や長期的な検証イベントで問題となる可能性があります。このオペコードのすべてのアプリケーションでこの状況への緩和策が必要というわけではありませんが、開発者はケースバイケースで理由を示す必要があります。

チェーンIDの更新に対するオペレーターの制御が許可されない Plasma L2 パラダイムは、このオペコードを活用する場合に考慮すべき1つの例です。Plasma パラダイムでは、オペレーターまたはオペレーターのグループがL2ネットワークからブロックを基本チェーン(この場合はイーサリアム)に送信し、そのチェーンで発生したトランザクションをまとめます。これらのブロックの送信は、チェーンIDの更新などの主要なイベントとは完全に一致しない可能性があり、プロトコルに重大な影響を与える可能性があります。オペレーターがチェーンIDの更新を制御できない場合、ブロックの送信と更新を完全に同期させることができず、過去のトランザクションの一部が更新に合わせて拒否される可能性があります。これは、チェーンIDの動作を過度に詳細に指定しようとすることの意図せざる結果の1つの例であり、最も最適なのは単純なオペコードアクセスであり、グローバルまたはローカルなチェーンID変更の処理は開発者に委ねるべきです。

この提案されたオペコードは、この機能を実装する最も単純な方法であり、開発者が必要に応じてチェーンID変更の処理を実装できるようにします。

## 下位互換性
このEIPは、EIP-155のチェーンIDドメイン区切り文字を使用してトランザクションに署名するすべてのチェーンと完全に下位互換性があります。

## 参考文献
これは以前、[EIP-901](https://github.com/ethereum/EIPs/issues/901)の一部として提案されていました。

## テストケース
テストケースは[ethereum/tests](https://github.com/ethereum/tests/pull/627)に追加されています。

## 実装
Trinity Python クライアントの参考実装は[こちら](https://github.com/ethereum/py-evm/pull/1803)にあります。

トラストレスなチェーンIDオラクルの例は[こちら](https://github.com/fubuloubu/chain-id-oracle/blob/master/ChainIdOracle.vy)に実装されています。

## 著作権
著作権およびその関連権利は[CC0](../LICENSE.md)で放棄されています。