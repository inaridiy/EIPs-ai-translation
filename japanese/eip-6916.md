---
original: d8dde71ed8a79d6406cb9fb65a40b276b81786fd032dcf2aa8f422f7378a61dd
---

---
eip: 6916
title: テストネットの自動リセット
description: ジェネシスに定期的にロールバックされるテストネットワーク
author: Mário Havel (@taxmeifyoucan), pk910 (@pk910), Rémy Roy (@remyroy), Holly Atkinson (@atkinsonholly), Tereza Burianova (@T-ess)
discussions-to: https://ethereum-magicians.org/t/automatically-reset-testnet/15825
status: レビュー
type: Standards Track
category: Core
created: 2023-04-10
---

## 概要

このEIPは、自動的にリセットされるテストネットの仕様を提案しています。これは、Ethereumクライアントの中で実装できる新しいアプローチのテストネットです。これにより、決定論的なパラメーターを持つ一時的なネットワークからなる単一のテスト基盤が可能になります。各ネットワークの反復は、決定論的にジェネシス状態を生成する指定された関数によって作成されます。

## 動機

自動的にリセットされるテストネットは、アプリケーション、バリデーター、およびクライアント実装の変更点のための短期的なテストの代替環境を提供できます。長期的に運用されているテストネットが抱える状態の肥大化、テストネット資金の不足、コンセンサスの問題などの問題を回避できます。定期的にネットワークをジェネシスにリセットすることで、バリデーターセットをクリーンにし、ファウセットに資金を返しつつ、ブートストラップが容易な程度の小さなネットワークを維持できます。

## 仕様

テストネットは、あらかじめ定められた期間ごとに必ずリセットされるように設定されます。リセットとは、次のジェネシスの生成、古いジェネシスの破棄、新しいネットワークの起動を意味します。これを可能にするために、ジェネシスの生成とクライアントのリセットの機能を導入します。

### ジェネシス

現在のネットワークインスタンスに接続するには、クライアントがジェネシス関数を実装する必要があります。この関数は、クライアントがテストネットに関する情報を保存し、現在のジェネシスを生成する方法を定義します。リセットごとに、ネットワークは新しいジェネシスから始まります。このジェネシスは、与えられたパラメーターに基づいて決定論的に構築され、ELクライアントとCLクライアントで一致する必要があります。

ネットワークは常に、最初のジェネシス「ジェネシス0」に基づいて決定論的に作成されたジェネシスから始まります。ジェネシス0の終了時間は、そのジェネシスの開始時間 `MIN_GENESIS_TIME` と、テストネットの寿命 `period` の合計です。ここで `period` は、単一の一時的なネットワークが実行される期間を定義する定数です。したがって、現在のスロットのタイムスタンプがその一時的なネットワークの終了時間に達すると、新しいジェネシスに切り替える必要があります。各新しいジェネシスの反復における主な変更点は、chainId、ジェネシスの時間、および最初のバリデーターの引出し資格情報です。

クライアントには、他のネットワークで事前に定義されているものと同様に、ハードコーディングされた `ジェネシス0` を含める必要があります。ただし、このジェネシスは、テストネットの存在の最初の反復、つまり `i` が `0` に等しい場合にのみ直接使用されます。その後、`i` が `1` 以上の場合、クライアントはこのジェネシスを初期化せず、それを使用して現在のジェネシスを派生させます。 `i>0` の場合、既知の `period` と現在のスロットタイムスタンプから、`ジェネシス0` からの反復の数を常に計算し、最新のパラメーターを使用して新しいジェネシスを作成します。

クライアントが一時的なテストネットのオプションで起動すると、ネットワークのジェネシスが存在するかどうかを確認します。存在しない場合、または現在のスロットタイムスタンプが `current_genesis.genesis_time + period` よりも古い場合は、新しいジェネシスの生成をトリガーします。この新しいジェネシスは `ジェネシス0` から派生し、データベースに書き込まれ、現在のネットワークの実行に使用されます。

#### 実行クライアント

ELクライアントには、現在のジェネシスを生成するための前提となる `ジェネシス0` がハードコーディングされています。変数の反復は次のように行われます:

* 反復の数:
  * `i` = `int((current_slot_timestamp` - `genesis_0.genesis_time) / period)`
* 現在のジェネシスの生成時間:
  * `current_genesis.genesis_time` = `period` * `i` + `genesis_0.genesis_time`
* 現在のELチェーンID:
  * `chainId` = `genesis_0.chainId` + `i`

#### コンセンサスクライアント

CLクライアントのジェネシス生成には、ELと同様の値の反復に加えて、更新されたジェネシス状態が必要です。SSZ形式の状態は、クライアントによって生成されるか、外部ソースからダウンロードされる可能性があります。これには、コミュニティ内の信頼できるエンティティによって作成されたバリデーターセットを使用して、マージされたネットワークを起動するための準備ができたデポジットを持つバリデーターが含まれます。

`MIN_GENESIS_TIME` は最新のジェネシス時間に設定され、現在の期間の開始時間を定義します。インフラストラクチャが新しいジェネシスで再起動する際の問題を避けるため、小さな `GENESIS_DELAY`（例えば15分）を追加することをお勧めします。

リセットを確実に行うには、`ForkDigest` を各反復で一意にする必要があります。ネットワークの `ForkVersions` を静的に保ち、ツールのサポートを向上させるために、バリデーターセットの最初のバリデーターの引出し資格情報を計算された値で上書きする必要があります。

* `genesis.validators[0].withdrawal_credentials` = `0x0100000000000000000000000000000000000000000000000000000000000000` + `i`
* `genesis.genesis_validators_root` =  `hash_tree_root(genesis.validators)`

`genesis.validators[0]` の更新により状態が変更されるため、クライアントは最新のジェネシス状態を生成またはダウンロードできる必要があります。ジェネシスのSSZ生成はクライアントの標準機能ではないため、これを追加することで、信頼できない方法でも最新のジェネシス状態を作成できるようになりますが、一定の複雑さが伴います。代替策は、サーバーからSSZファイルをダウンロードするか、ジェネシス状態を提供するエンドポイントを使用してチェックポイントの同期機能を使用して、サードパーティから取得することです。これは、Holeškyテストネットと既存の機能で受け入れられた慣行となっており、クライアントリリースを必要とせずにジェネシスバリデーターセットを更新できるようになります。推奨される方法の完全な実装は次のように動作する必要があります:

* テストネットのフラグが指定され、クライアントがジェネシスのチェックポイント同期をサポートしている場合、デフォルトのチェックポイントエンドポイントを使用して最新のジェネシス状態をダウンロードする
  * ユーザーがカスタムチェックポイント同期フラグを提供した場合は、デフォルトのオプションを上書きし、ユーザーが提供したエンドポイントを使用する
* 最新のテストネットリリースを指すパブリックに配布されたSSZファイルへのバックアップダウンロードオプションを含める。チェックポイント状態の同期に失敗した場合にこのオプションをトリガーするか、クライアントがジェネシスチェックポイント同期をサポートしていない場合はデフォルトにする
* クライアントにジェネシス生成機能が含まれている場合は、それを使用して、ダウンロードされた状態のパラメーターを検証し、値やチェックサムが対応していない場合はエラーを発行する

通常、`genesis_validators_root` はクライアントで事前に定義されていますが、この場合は事前に知られていないため、特定のアーキテクチャを破壊する可能性があることに注意が必要です。たとえば、ハードコーディングされた `genesis_validators_root` に依存しているライトクライアントは機能しなくなる可能性があります。

### リセット

リセット関数は、古いデータを破棄し、新しいジェネシスから始める自動プロセスを定義します。これは、クライアントが自動的に最新のネットワークの反復に従えるように、前述のジェネシス生成関数を実装する必要があります。

リセット関数には、`terminal_timestamp` 値を導入できます。これは、反復のネットワーク有効期限を定義します。これは、次のジェネシスの生成時間（ジェネシス遅延なし）と同じにできますし、単純に `terminal_timestamp = current_genesis.genesis_time + period` と計算することもできます。

ネットワークがタイムスタンプ `>= terminal_timestamp` のスロットに到達したら:

* クライアントは新しいブロックの受け入れ/作成を停止する
  * ネットワークを実行しているクライアントサービス（P2P通信、ビーコンサービス、実行環境など）をシャットダウンする
  * この機能は、さらなるリセット機能なしでも、基本的なサポートを常に安全に作成するために、ジェネシスと並行して実装する必要がある
* クライアントは、現在のジェネシスとすべてのチェーンまたはビーコンデータを破棄する関数を呼び出す
  * クライアントにはすでにデータベースを消去するためのDBツールが含まれており、ここで使用できる
  * `--retain-ephemeral-data` などの追加のフラグを含めると、既存のデータを標準形式でエクスポートしてから、データベースを削除するのが有益かもしれない
* クライアントはジェネシス関数（上記で定義）をトリガーする:
  * ジェネシスが存在しない場合の通常のクライアント起動と同様に動作する
  * 新しいジェネシスがデータベースに書き込まれ、初期化される
* メインネットワークサービスが新しいジェネシスを指して再起動される
* 新しいジェネシス時間に到達すると、ネットワークは新しいジェネシスから再び開始される

完全なリセット実装のために、クライアントは手動の再起動を必要とせずに上記のアクションを実行できる必要があります。つまり、ネットワークを完全に自立して運用し、ダウンタイムを最小限に抑えることが重要です。

ただし、クライアントのアーキテクチャによっては、このような内部リセットメカニズムを完全に実装することが現実的ではない場合があります。たとえば、クライアントが優雅なシャットダウンをサポートしていない場合などです。リセット機能は高度なレベルのサポートと見なされ、主にインフラストラクチャプロバイダーとジェネシスバリデーターが必要としています。クライアントがリセットを実装していない場合でも、高度なユーザーがシステムツールを使ってクライアントを処理することで、同様の動作を実現できるという前提があります。

## 根拠

決定論的なパラメーターを持つ一時的なテストネットは、従来のテストネットと同じインフラストラクチャを使用しながら、持続可能な代替手段を提供します。リセットごとに、バリデーターセットがクリアされ、ファウセットが再び満たされ、データベースが小さく保たれます。

リセット時にはすべての状態が消去されるため、一方では、ネットワークを小さく簡単にブートストラップできますが、長期的/高度なアプリケーションのテストに問題が生じます。ただし、各リセット後に任意のユーザーが自動的に基本的なコントラクトインフラストラクチャをデプロイできます。一般的に、ネットワークは短期的なテストに使用することをお勧めします。永続的なテストネットに残る必要のない「Hello World」タイプのコントラクトをデプロイするのに適しています。ただし、各リセット後に標準的なコ
ントラクトプリミティブを自動的にデプロイするオフチェーンのメカニズムがあれば、アプリケーション開発者もこのネットワークをより活用できます。

ジェネシスとリセットの2つのメカニズムを定義することで、このEIPにより、クライアント実装がテストネットをどのようにサポートするかの2つのレベルが可能になります。

* 基本的なサポートでは、クライアントが現在のネットワークの仕様を判断し、ネットワークに接続できるようにします。
  * これは上記で定義したジェネシスメカニズムのサポートを意味します
  * 短期的なテストのためにネットワークに参加するのに十分です
  * 最新の反復に従うには、ユーザーがクライアントを手動でシャットダウンしてデータベースを削除する必要があります
  * ネットワークの終了機能を追加することをお勧めします
* 完全なサポートでは、クライアントがリセットプロセスに従い、常に最新のチェーンの反復を同期できるようになります。
  * これには、クライアントが内部リセット機能を実装する必要があります
  * 永続的なインフラストラクチャ、ジェネシスバリデーター、ブートノードの実行に必要です
  * クライアントのアーキテクチャによっては、実装が複雑になる可能性があります

この設計は、外部ツールによって管理されるノードとも互換性があります。つまり、クライアントがこれらの機能を実装していなくても、スクリプトによって自動的にリセットされる他のノードと同じネットワークで実行できます。カスタムネットワークをサポートするクライアントであれば、このテストネットで使用できます。

### ネットワークパラメーター

テストネットの特性を定義する定数と変数は任意ですが、以下に示す一定の制限と安全性の要件を考慮して設計する必要があります。

#### リセット期間

`period` は、クライアントにハードコーディングされた定数で、ネットワークがリセットされる期間を定義します。

ユーザーのニーズに基づいて定義できますが、セキュリティ上の理由から、ジェネシスのバリデーター数にも依存します。バリデーターの活性化にかかる時間を考慮すると、悪意のあるアクターがネットワークを乗っ取れないように、十分に多くの信頼できるバリデーターが必要です。

```sh
ジェネシスバリデーター => 66%以下の過半数までのエポック
10k  => 1289 エポック (5.7日)
50k  => 6441 エポック (28.6日)
75k  => 9660 エポック (42.9日)
100k => 12877 エポック (57.2日)
150k => 19323 エポック (85.9日)
200k => 25764 エポック (114.5日)
```

#### ChainId

ChainIdは変数です。リプレイ攻撃を避けるために、各新しいジェネシスで変更する必要があるためです。新しいChainIdの値の関数は単純な増分（+1）です。`ジェネシス0`のChainIdはハードコーディングされた定数です。このConstantは、クライアントが各新しいジェネシスで使用して、そのネットワークの反復の新しいChainIdを派生させます。

新しいChainIdは、多くの反復後も他の既存の公開EVMチェーンと衝突しないようにする必要があります。したがって、低いChainId値は推奨されません。

## セキュリティ上の考慮事項

ネットワーク自体は、定期的なリセットによって安全な環境を提供しています。何らかの脆弱性が悪用されても、次のリセットで消去されます。これも、期間を比較的短く（月/年ではなく週/月）に保ち、正直な過半数を維持するのに十分な大きなジェネシスバリデーターセットを持つ理由です。

リセットネットワークの機能を実装することによるクライアントの変更は、標準的なセキュリティ手順と一緒に見直す必要があります。特に、リセットをトリガーするメカニズムは、一時的ではないネットワークから分離する必要があります。

## 著作権

著作権およびそれに関連する権利は[CC0](../LICENSE.md)によって放棄されています。