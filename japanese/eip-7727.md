---
original: 1dafecee79cbc44d494ce0f006f9a6bd934354f0bfbfefa026d7b5338798ae87
---

---
eip: 7727
title: EVM トランザクション・バンドル
description: メタトランザクションを可能にし、リバート保護なしで他のトランザクションを順序付けできるようにする。
author: Lily Johnson (@lilyjjo)
discussions-to: https://ethereum-magicians.org/t/eip-7727-evm-transaction-bundles/20322
status: Draft
type: Standards Track
category: Core
created: 2024-06-24
requires: 2718
---

## 概要

このEIPでは、2つの新しい[EIP-2718](./eip-2718.md)トランザクションタイプと1つの新しいオペコードを導入し、スマートコントラクトとトランザクションがオフチェーンのエンティティにローカルのシーケンシング権を委任できるようにします。これらの新しいトランザクションタイプは協力して、ビルダーがサーチャーに提供するProposer-Builder Separation (PBS)バンドルよりも弱いEVM ネイティブの「バンドル」を作成します。

1つのEIP-2718トランザクションは、以下をサポートする拡張された通常のトランザクションです:

- トランザクションをバンドルに配置できるエンティティの指定。
- オプションのブロック番号で、トランザクションの有効期限を指定できる。

もう1つのEIP-2718トランザクションは、実行に入らず、自身のタイプと他の新しいタイプのトランザクションを順序付けする「メタ」トランザクションです。「メタ」トランザクションでも、バンドルに含めることができるエンティティと有効なブロック番号を指定できます。

新しいオペコードは、トランザクションがバンドルに含まれている場合、そのトランザクションをバンドルに配置したエンティティをEVMに明らかにします。

## 動機

現在、単一のブロックビルダーが最終的なブロックトランザクションの順序付けを無制限に制御しています。これは問題となっています。なぜなら、順序付け - 特定の状態と順序でどのエンティティが相互作用できるかを選択すること - は、価値の流れに大きな影響を及ぼすからです。このEIPの目的は、EVMの内部でシーケンシングの概念を公開することで、より多くのパーティがシングルブロックの構築に参加できるようにすることです。この変更により、EVM アプリケーションは現在ブロックビルダーが独占している一部のシーケンシングの価値を取り戻し、アプリケーション自体に再び向けることができるようになります。

## 仕様

### 定数

| 名称 | 値 |
| --- | --- |
| DELEGATED_TX_TYPE | 0x05 |
| BUNDLE_TX_TYPE | 0x06 |
| BUNDLE_BASE_GAS_COST | TBD <!-- TODO --> |
| BUNDLE_SIGNER_OPCODE_NUMBER | TBD <!-- TODO --> |

### 新しいトランザクションペイロードタイプ

`DELEGATED_TX_TYPE`と`BUNDLE_TX_TYPE`の2つの新しい[EIP-2718](./eip-2718.md)トランザクション。

`DELEGATED_TX_TYPE`の場合、トランザクションペイロードは以下のように解釈されます:

```go
0x05 || rlp([
	bundleSigner,
	blockNumber,
	chainId, 
	nonce, 
	gasPrice, 
	gasLimit, 
	to, 
	value, 
	data, 
	signatureYParity, 
	signatureR, 
	signatureS
])
```

`DELEGATED_TX_TYPE`の`signatureYParity`、`signatureR`、`signatureS`要素は、以下のデータに対するsecp256k1署名を表します:

```go
keccak256(0x05 || rlp([bundleSigner, blockNumber, chain_id, nonce, gasPrice, gasLimit, to, value, data]))
```

`BUNDLE_TX_TYPE`の場合、トランザクションペイロードは以下のように解釈されます:

```go
0x06 || rlp([
	bundleSigner,
	blockNumber,
	chainId, 
	nonce, 
	gasPrice, 
	transactionList
	signatureYParity, 
	signatureR, 
	signatureS
])
```

ここで、`transactionList`要素は、`DELEGATED_TX_TYPE`または`BUNDLE_TX_TYPE`のいずれかの構文的に有効なトランザクションのリストです。リストには少なくとも1つのトランザクションが含まれている必要があります。

`transactionList`の例は以下のようになります:

```go
[
	DELEGATED_TX_TYPE.payload, 
	BUNDLE_TX_TYPE.payload, 
	DELEGATED_TX_TYPE.payload
]
```

`BUNDLE_TX_TYPE`の`signatureYParity`、`signatureR`、`signatureS`要素は、以下のデータに対するsecp256k1署名を表します:

```go
keccak256(0x06 || rlp([bundleSigner, blockNumber, chainId, nonce, gasPrice, transactionList]))
```

この署名によって解決されるアドレスを、バンドルトランザクションのサイナーと呼びます。

### `BUNDLE_SIGNER`オペコード

`BUNDLE_SIGNER`は、`BUNDLE_SIGNER_OPCODE_NUMBER`によって識別される新しいオペコードで、スタック引数はゼロです。

トランザクションタイプが`DELEGATED_TX_TYPE`の場合、このオペコードはトランザクションペイロードの`bundleSigner`をアドレスとしてスタックにプッシュします。トランザクションが別のタイプの場合は、ゼロアドレスを返します。

このオペコードのガスコストは、`GAS_VERY_LOW`ガス定数です。

### トランザクションの有効性ルール

`DELEGATED_TX_TYPE`が有効であるためには、以下が真でなければなりません:

- トランザクションは`BUNDLE_TX_TYPE`の`transactionList`に含まれている必要があります。
- トランザクションの指定した`bundleSigner`は、そのトランザクションを含む`BUNDLE_TX_TYPE`に署名したアドレスと等しくなければなりません。
- ペイロード変数`blockNumber`が0以外の場合、そのブロック番号でトランザクションが実行される必要があります。

`BUNDLE_TX_TYPE`が有効であるためには、以下が真でなければなりません:

- `transactionList`内のすべてのトランザクションが、`BUNDLE_TX_TYPE`のサイナーを`bundleSigner`として指定している必要があります。
- `bundleSigner`ペイロード変数がゼロアドレスでない場合、トランザクションは`BUNDLE_TX_TYPE`の`transactionList`に含まれている必要があります。
- ペイロード変数`blockNumber`が0以外の場合、そのブロック番号でトランザクションが実行される必要があります。

### ガスコスト

`BUNDLE_TX_TYPE`には、実行時に`transactionList`内のトランザクションが有効かどうかによって変化する新しいガスコスト式があります。

`transactionList`内のトランザクションが無効な場合、`BUNDLE_TX_TYPE`トランザクションは、無効なトランザクションのバイトが通常のトランザクションの`CALL_DATA`の一部であるかのようにチャージされます。内部トランザクションが有効な場合、リストに含まれることによる追加コストはありません。

式は以下のように計算されます:

```go
BUNDLE_BASE_GAS_COST +
    (CALL_DATA_TOKEN_COST * transaction_list_invalid_tx_byte_length)
```

処理の開始時に、`BUNDLE_TX_TYPE`のサイナーは、すべての内部トランザクションが無効であるかのようにチャージされ、各有効なトランザクションの実行が完了するときに、有効なトランザクションのガスが払い戻されます。

`DELEGATED_TX_TYPE`は、通常のガスコスト規則に従います。

### 実行

`DELEGATED_TX_TYPE`は通常通り実行され、`BUNDLE_SIGNER`オペコードはペイロード変数`bundleSigner`を返します。

`BUNDLE_TX_TYPE`は実行コンテキストを開始しません。`BUNDLE_TX_TYPE`の`NONCE`は、`transactionList`の実行を開始する前にインクリメントされる必要があります。

### ReceiptPayload定義

実行を開始できた`DELEGATED_TX_TYPE`トランザクションの[EIP-2718](./eip-2718.md)レシートペイロードは以下のように解釈されます:

```go
rlp([status, cumulativeGasUsed, logsBloom, logs])
```

無効な`DELEGATED_TX_TYPE`トランザクションにはトランザクションレシートが発行されません。

`BUNDLE_TX_TYPE`トランザクションの[EIP-2718](./eip-2718.md)レシートペイロードは以下のように解釈されます:

```go
rlp([statusArray, cumulativeGasUsed])
```

ここで、`statusArray`は、内部`transactionList`のトランザクションの状態結果のリストです。リストの長さは`transactionList`と同じで、同じ順序で状態を報告する必要があります。無効なトランザクションを報告するには、ステータスタイプ`0x3`を使用する必要があります。

`cumulateGasUsed`は、`CALLDATA`払い戻し後の`BUNDLE_TX_TYPE`トランザクションコストに使用されたガスの量です。

## 根拠

### `BUNDLE_TX_TYPE`の`transactionList`に無効なトランザクションを含めることを許可する

トランザクションがどのように実行されるかを知るには、トランザクションが適用される状態ルートを知る必要があります。`BUNDLE_TX_TYPE`トランザクションの作成者は前のブロックの状態ルートにしかアクセスできず、`BUNDLE_TX_TYPE`トランザクションの前に来るトランザクションの最終的な順序を予測することはできません。有効なトランザクションのみを許可すると、単一の内部トランザクションによるノンス or ガスの無効化によって、`BUNDLE_TX_TYPE`トランザクションリストが簡単に無効化される可能性があります。

### `BUNDLE_TX_TYPE`のサイナーに無効なトランザクションの`CALLDATA`ガスコストを課金する

ブロックチェーンはDDoS攻撃を防ぐためにノードが行う作業に対して課金する必要があります。`BUNDLE_TX_TYPE`トランザクションリストの無効なトランザクションは実行されませんが、ブロックスペースを占有するバイトとして存在するため、何らかのエンティティによって支払われる必要があります。`BUNDLE_TX_TYPE`の作成者は、前のブロックの状態をかなり正確にシミュレートでき、無効化コストを相殺できるだけの利益を得られる洗練されたエンティティであると想定されています。

`BUNDLE_BASE_GAS_COST`は、`BUNDLE_TX_TYPE`のサイナーが無効化を試みるよりも、無効なトランザクションのバイトを覆うコストの方が高くなるように設定する必要があります。

### `DELEGATED_TX_TYPE`タイプのトランザクションを`BUNDLE_TX_TYPE`の`transactionList`に含めることを要求する

`DELEGATED_TX_TYPE`トランザクションが`BUNDLE_TX_TYPE`トランザクションリスト外で実行できる場合、`BUNDLE_TX_TYPE`のサイナーと全体のブロックビルダーの間で、ローカルの順序付けを選択する権利をめぐる競争が生じる可能性があります。`DELEGATED_TX_TYPE`トランザクションのサイナーが、全体のブロックビルダーにローカルの順序付けを選択させたい場合、`DELEGATED_TX_TYPE`トランザクションタイプを使用すべきではありません。

同じ原則が`BUNDLE_TX_TYPE`トランザクションにも適用されます。`bundleSigner`を指定するものは`BUNDLE_TX_TYPE`リストにのみ含める必要があり、`bundleSigner`を指定しないものは、そのようなリストに含めてはいけません。

### `BUNDLE_TX_TYPE`の`transactionList`に他のトランザクションタイプを含めることを許可しない

この制限は予防措置として実装されたものであり、将来的に再考される可能性があります。`bundleSigner`を指定しない他のトランザクションタイプを`transactionList`に含めることを許可すると、同じトランザクションをバンドルに含めようとする複数のサーチャーが発生する可能性があり、ブロック内のスパムの原因となる可能性があります。

### PBS サーチャーバンドルとの違い

現在のPBSブロックビルダーは、リバースなしで全て実行されるか、ブロックに含まれないトランザクションリストという形で「バンドル」をサーチャーに提供しています。サーチャーは通常、特定の状態との最初の相互作用の権利を入札したり、非サーチャーエンティティが作成したトランザクションの前後にロジックを配置したりするために、これらのバンドル
を使用しています。これらのバンドルは、オーダーフローを獲得し、ブロックの価値を高めるためにPBSブロックビルダーが提供するサービスです。

`BUNDLE_TX_TYPE`トランザクションには2つの主な違いがあります:

1. リバート保護がない。
2. `bundleSigner`に明示的に委任したトランザクションのみをバンドル化できる。

これらの選択は、ビルダーに対するDDoS攻撃を防ぐため、およびPBS以外のブロックビルダーが他のアルゴリズムを実行できるように互換性を保つためになされました。

## 下位互換性

下位互換性の問題は見つかりませんでした。

## セキュリティ上の考慮事項

ブロックビルダーは、検閲や悪意のある順序付けを実行する能力のために問題となっています。これらの懸念は、シーケンシング権が特定のエンティティに委任された場合でも続きます。オフチェーンの順序付けを生成するコードは公開され、TEE (Trusted Execution Environment)やより高速なブロック時間のブロックチェーンなどの信頼最小化された方法で実行される必要があります。

同様に、特定の`BUNDLE_SIGNER`によって署名されたトランザクションのみを制限する機能を持つスマートコントラクトは、委任されたシーケンシングエンティティがオンラインであったり悪意のないことを前提とせずに、ユーザーが資金を引き出せるメカニズムを提供する必要があります。2段階の資金引き出しプロセスを実装して、バンドル構築およびシミュレーションロジックとの安全な相互作用を可能にすることができます。

## 著作権

著作権およびそれに関連する権利は[CC0](../LICENSE.md)によって放棄されています。