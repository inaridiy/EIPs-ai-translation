---
original: 7345c394b8726383a667b3e5114fa0916410c95de3c1a031663a8e07cbe40e03
---

---
eip: 3675
title: コンセンサスをプルーフ・オブ・ステークに移行する
description: イーサリアム・メインネットのコンセンサスメカニズムをプルーフ・オブ・ステークに移行する仕様
author: Mikhail Kalinin (@mkalinin)、Danny Ryan (@djrtwo)、Vitalik Buterin (@vbuterin)
discussions-to: https://ethereum-magicians.org/t/eip-3675-upgrade-consensus-to-proof-of-stake/6706
status: Final
type: Standards Track
category: Core
created: 2021-07-22
requires: 2124
---


## 概要

このEIPはプルーフ・オブ・ワーク(PoW)を非推奨とし、ビーコンチェーンによって駆動される新しいプルーフ・オブ・ステーク(PoS)コンセンサスメカニズムに置き換えます。新しいコンセンサスメカニズムのブートストラップに関する情報は[EIP-2982](./eip-2982.md)に記載されています。ビーコンチェーンの完全な仕様は`ethereum/consensus-specs`リポジトリにあります。

このドキュメントでは、コンセンサスアップグレードによって導入されるブロック構造、ブロック処理、フォークチョイスルール、ネットワークインターフェースの変更を詳しく説明します。


## 動機

ビーコンチェーンネットワークは2020年12月から稼働しています。この期間、安全性や活性の障害は検出されていません。この長期にわたる障害のない運用は、ビーコンチェーンシステムの持続可能性と、イーサリアム・メインネットのセキュリティプロバイダとしての準備ができていることを示しています。

プルーフ・オブ・ステークコンセンサスを導入する動機については、[EIP-2982](./eip-2982.md#motivation)の「動機」セクションを参照してください。


## 仕様

### 定義

* **PoWブロック**: 既存のプルーフ・オブ・ワーク機構によって構築および検証されたブロック。つまり、コンセンサスアップグレード前のイーサリアムネットワークのブロックです。
* **PoSブロック**: 新しいプルーフ・オブ・ステーク機構によって構築および検証されたブロック。
* **ターミナルPoWブロック**: 次の条件を満たすPoWブロック --
`pow_block.total_difficulty >= TERMINAL_TOTAL_DIFFICULTY` *かつ* `pow_block.parent_block.total_difficulty < TERMINAL_TOTAL_DIFFICULTY`。
ネットワーク上に複数のターミナルPoWブロックが存在する可能性があります(例: 同じ事前ターミナルブロックの子供たち)。
* **`TERMINAL_TOTAL_DIFFICULTY`** コンセンサスアップグレードをトリガーする総合難易度の値。イーサリアム・メインネットの設定では、この値を**`58750000000000000000000`**に設定する**必須**です。
* **`TRANSITION_BLOCK`** 正規チェーンの最初のPoSブロック、つまり最小のブロック高さを持つPoSブロック。
* **`POS_FORKCHOICE_UPDATED`** プルーフ・オブ・ステークのフォークチョイスの状態が更新されたときに発生するイベント。
* **`FORK_NEXT_VALUE`** 次のコンセンサスアップグレードの`FORK_NEXT`パラメータに設定される値。
* **`TERMINAL_BLOCK_HASH`** ターミナルPoWブロックのハッシュを指定します(設定されている場合)。`0x0000000000000000000000000000000000000000000000000000000000000000`がスタブ値です。
* **`TERMINAL_BLOCK_NUMBER`** `TERMINAL_BLOCK_HASH`が設定されている場合のターミナルPoWブロックの番号。

#### PoSイベント

`POS_`プレフィックスが付いたイベント(PoSイベント)は、新しいプルーフ・オブ・ステークコンセンサスメカニズムによって発行されます。これらのイベントは、指定されたブロックに関する対応する主張を示しています。PoSイベントの基礎となるロジックはビーコンチェーン仕様に記載されています。各PoSイベントの発生時に、このEIPで指定された対応する処理**必須**で行う必要があります。

以下の詳細を考慮する必要があります。
* PoSイベントに含まれるブロックへの参照は、特に指定がない限り、ブロックハッシュの形式で提供されます。
* `POS_FORKCHOICE_UPDATED`イベントには、正規チェーンのヘッドと最新の確定ブロックへの参照が含まれています。最初の確定ブロックが発生するまでは、このイベントによって提供される確定ブロックハッシュは`0x0000000000000000000000000000000000000000000000000000000000000000`でスタブされます。
* **`FIRST_FINALIZED_BLOCK`** `POS_FORKCHOICE_UPDATED`イベントによって指定され、スタブ値と異なるハッシュを持つ最初の確定ブロック。


### クライアントソフトウェアの設定

以下のパラメータセットはクライアントソフトウェアの設定の一部であり、バイナリ配布に**必須**で含める必要があります:
* `TERMINAL_TOTAL_DIFFICULTY`
* `FORK_NEXT_VALUE`
* `TERMINAL_BLOCK_HASH`
* `TERMINAL_BLOCK_NUMBER`

*注意*: `TERMINAL_BLOCK_HASH`が`0x0000000000000000000000000000000000000000000000000000000000000000`でスタブされている場合、`TERMINAL_BLOCK_HASH`と`TERMINAL_BLOCK_NUMBER`パラメータは**効果を持たない**必要があります。


### PoWブロック処理

ターミナルPoWブロックの子孫であるPoWブロックは**インポートしてはいけません**。これにより、ターミナルPoWブロックが正規チェーンの最後のPoWブロックになります。


### 定数

| 名称 | 値 |
|-|-|
| **`MAX_EXTRA_DATA_BYTES`** | `32` |

### ブロック構造

`TRANSITION_BLOCK`以降、以前は動的だったブロックフィールドの多くが非推奨となり、代わりに定数値が強制されます。以下のテーブルに示すブロックフィールドは、それぞれ対応する定数値に**置き換えられる必要**があります。

| フィールド | 定数値 | コメント |
|-|-|-|
| **`ommersHash`** | `0x1dcc4de8dec75d7aab85b567b6ccd41ad312451b948a7413f0a142fd40d49347` | `= Keccak256(RLP([]))` |
| **`difficulty`** | `0` |  |
| **`mixHash`** | `0x0000000000000000000000000000000000000000000000000000000000000000` |  |
| **`nonce`** | `0x0000000000000000` |  |
| **`ommers`** | `[]` | `RLP([]) = 0xc0`  |

`TRANSITION_BLOCK`以降、ブロックの**`extraData`**フィールドの検証が変更されます: ブロックの**`extraData`**の長さは**`MAX_EXTRA_DATA_BYTES`**バイト以下**でなければなりません**。

*注意*: ここで指定されていないブロックフィールドの論理と有効性条件**は変更されません**。さらに、全体的なブロック形式**も変更されません**。

*注意*: 後続のEIPでは、上記の定数値を上書きして追加の機能を提供する可能性があります。例として[EIP-4399](./eip-4399.md)を参照してください。


### ブロックの有効性

`TRANSITION_BLOCK`以降、ブロックの有効性条件は以下のように**変更される必要**があります:
* ブロックの**`difficulty`**値に関する難易度計算式の検証を削除する。
* ブロックの**`nonce`**と**`mixHash`**値に関するEthash関数の検証を削除する。
* オマーの一覧とその各メンバーに対して評価される全ての検証ルールを削除する。
* [ブロック構造](#ブロック構造)セクションで記載された項目の検証を追加する。

*注意*: 新しいルールのいずれかに失敗した場合、ブロックは**無効**とされる必要があります。

*注意*: 上記のリストに記載されていない有効性ルールは**変更されません**。

#### トランジションブロックの有効性

上記の条件を満たすことに加えて、`TRANSITION_BLOCK`は**ターミナルPoWブロックの子孫**でなければなりません。つまり、`TRANSITION_BLOCK`の親はターミナルPoWブロックの条件を満たす必要があります。


### ブロックとオマーの報酬

`TRANSITION_BLOCK`以降、ブロックとオマーの報酬は非推奨となります。具体的には、以下の処理を**行う必要**があります:
* ブロック報酬によってブロックの**`beneficiary`**アカウントの残高を増やすのを削除する。
* オマーの包含報酬によってブロックの**`beneficiary`**アカウントの残高を増やすのを削除する。
* オマーブロック報酬によってオマーの**`beneficiary`**アカウントの残高を増やすのを削除する。

*注意*: ブロックの`beneficiary`アカウントに影響する取引手数料のメカニズムは**変更されません**。


### フォークチョイスルール

`TERMINAL_BLOCK_HASH`パラメータが設定されている場合、PoWの最重要チェーンルールに以下のように影響します:
* 正規ブロックチェーンには、`TERMINAL_BLOCK_HASH`パラメータで定義されたハッシュを持つブロックが、`TERMINAL_BLOCK_NUMBER`パラメータで定義された高さに**含まれる必要**があります。

*注意*: このルールは、クライアントソフトウェアの実装に既に存在するブロックハッシュのホワイトリスト機能と同様のものです。

最初の`POS_FORKCHOICE_UPDATED`イベントが発生した時点で、フォークチョイスルールは以下のように**変更される必要**があります:
* 既存のPoWの最重要チェーンルールを削除する。
* 新しいPoS LMD-GHOSTルールに従う。

新しいPoS LMD-GHOSTフォークチョイスルールは以下のように指定されます。`POS_FORKCHOICE_UPDATED`イベントの発生ごと(最初のイベントを含む)に、以下の処理を**行う必要**があります:
* ジェネシスから始まり、イベントによって指定されたヘッドブロックで終わるチェーンを正規ブロックチェーンとして扱う。
* 正規ブロックチェーンのヘッドを、イベントによって指定されたブロックに設定する。
* `FIRST_FINALIZED_BLOCK`以降、最新の確定ブロックをイベントによって指定されたブロックに設定する。

上記の処理に関連するブロックツリーストアの変更は**原子的**に適用される必要があります。

*注意*: このルールは**厳密に**適用される必要があります。ヘッドに関する「楽観的」な更新は**行ってはいけません**。つまり -- 現在のヘッドブロックの上に新しいブロックが処理された場合、その新しいブロックがヘッドになるのは、対応する`POS_FORKCHOICE_UPDATED`イベントが発生した場合のみです。

### ネットワーク

#### フォーク識別子

[EIP-2124](./eip-2124.md)のフォーク識別子の目的で、このEIPを実装するノードは`FORK_NEXT`パラメータを`FORK_NEXT_VALUE`に設定**する必要**があります。

#### devp2p

ネットワーキングスタックは、ターミナルPoWブロックの子孫をアドバタイズする場合、以下のメッセージを**送信してはいけません**:
* `NewBlockHashes (0x01)`
* `NewBlock (0x07)`

`FIRST_FINALIZED_BLOCK`を受信した後、ネットワーキングスタックは以下の着信メッセージを**破棄する必要**があります:
* `NewBlockHashes (0x01)`
* `NewBlock (0x07)`

`FIRST_FINALIZED_BLOCK`の次の確定ブロックを受信した後、ネットワーキングスタックは以下のメッセージに対応するハンドラを**削除する必要**があります:
* `NewBlockHashes (0x01)`
* `NewBlock (0x07)`

ハンドラが削除された後もこれらのメッセージを送信し続けるピアは**切断される必要**があります。

*注意*: この節の影響を受けない
メッセージハンドラのロジックは**変更されません**。

## 根拠

このEIPで指定された変更は、既存のプルーフ・オブ・ワークコンセンサスアルゴリズムを、すでに稼働中のビーコンチェーンによって表されるプルーフ・オブ・ステークコンセンサスに安全に置き換えるために必要な最小限の要件となるよう設計されています。

このEIPは、イーサリアムネットワークの実稼働中のコンセンサスを安全に切り替えるための複雑さを最小限に抑えることを目的としています。安全性と製品化までの時間の両方が考慮されています。さらに、変更セットを最小限に抑えることで、ほとんどのスマートコントラクトやサービスが、移行中や移行後も、ほとんど介入なしに意図どおりに機能し続けることを助けます。

### アップグレードをトリガーする総合難易度

[セキュリティ上の考慮事項](#ターミナル総合難易度vs.ブロック番号)を参照してください。

### ターミナルブロックハッシュのパラメータ化

[セキュリティ上の考慮事項](#ターミナルpowブロックの上書き)を参照してください。

### PoWブロックのインポートの停止

[セキュリティ上の考慮事項](#powブロックのインポートの停止)を参照してください。

### ブロックフィールドを定数に置き換える

非推奨となったブロックフィールドは定数値に置き換えられ、ブロック形式の後方互換性が維持されます。ブロック形式を保持することで、このトランジション中や移行後も、スマートコントラクトやサービスが中断なく機能し続けることが支援されます。

特に、トランザクション/レシートの包含とステートのメルクルプルーフを検証するスマートコントラクトにとって重要です。これらのコントラクトは、外部から提供されたブロックヘッダのハッシュを`BLOCKHASH`演算によって返される対応する値と照合しています。

この変更により、非推奨となったブロックフィールドの置き換えを強制する追加の有効性ルールが導入されます。

### `difficulty`を`0`に置き換える

プルーフ・オブ・ワークが非推奨となった後、難易度の概念はもはや存在せず、ブロックヘッダの**`difficulty`**フィールドを`0`定数に置き換えるのは意味的に適切です。

### ブロックの有効性ルールの変更

PoW封印の有効性を強制するルールセットは、コンセンサスアップグレードに伴い、対応するPoSルールに置き換えられます。

ブロック形式の変更によって導入された非推奨ブロックフィールドのセットを検証するための追加のルールが必要です。

### ブロック報酬の削除

ブロックの生成と封印に対する既存の報酬は、PoW機構と共に非推奨となります。新しいPoSコンセンサスは、この仕様が有効になった時点で、ブロックの封印と報酬の発行の両方を担当するようになります。

### フォークチョイスルールの置換

PoWメカニズムのフォークチョイスルールは、アップグレード後は完全に無関係になり、新しいPoSコンセンサスメカニズムの対応するルールに置き換えられます。

### `POS_CONSENSUS_VALIDATED`の削除

このEIPの以前のドラフト版では、ブロックの検証条件として、追加のPOSイベント`POS_CONSENSUS_VALIDATED`が必要でした。このイベントは、ブロックをブロックツリーに完全に組み込むか、または除去するかの信号を与えていました。

このイベントは以下の2つの理由で削除されました:
1. このイベントは、「悪い」ブロックをブロックツリーから剪定できるようにするための不要な最適化でした。この最適化は不要でした。なぜなら、PoSコンセンサスは、そのような悪いブロックやその子孫に対して`POS_FORKCHOICE_UPDATED`を送信することはなく、最終的にはPoS確定性イベントの別のブランチでそのようなブロックを剪定できるようになるためです。
2. このイベントは、ある状況では危険でした。なぜなら、同じブロックが2つの*異なる*かつ矛盾するPoSブランチによって参照される可能性があったためです。したがって、同じブロックについて、ある場合は`POS_CONSENSUS_VALIDATED == TRUE`、別の場合は`POS_CONSENSUS_VALIDATED == FALSE`のイベントが送信される可能性があり、(1)の最適化を安全に実行する能力を完全に否定してしまいます。

### EIP-2124フォーク識別子

EIP-2124の`FORK_NEXT`の値は、ノードが知っている次のフォークのブロック番号を指し、`0`はそうでない場合を意味します。

`TRANSITION_BLOCK`の番号は、トランジションのトリガー条件の動的性質から事前に知ることはできません。ブロックは事前に知られていないため、ノードはその番号を`FORK_NEXT`に使用することはできず、この事実を踏まえて明示的に設定された`FORK_NEXT_VALUE`が使用されます。

### ブロックゴシップの削除

コンセンサスメカニズムのアップグレード後は、ビーコンチェーンネットワークのみがブロックを検証するのに十分な情報を持つようになります。したがって、`eth`ネットワークプロトコルによって提供されるブロックゴシップは安全ではなくなり、ビーコンチェーンネットワークに存在するブロックゴシップに代わって非推奨となります。

P2Pコンポーネントの処理負荷を軽減し、セキュリティプロパティが不明な環境での動作を停止するため、クライアントソフトウェアはターミナルPoWブロックの子孫を伝播**しないことが推奨**されます。

### `extraData`の長さの制限

`extraData`フィールドは、イエローペーパーで最大`32`バイトと定義されています。したがって、メインネットとほとんどのPoWテストネットでは、この値を`32`バイトに制限しています。`32`バイトを超える`extraData`フィールドは、クリークテストネットやその他のネットワークで、特別な署名/コンセンサススキームを運ぶために使用されています。このEIPでは、`extraData`の長さを`32`バイトに制限しています。これは、別のコンセンサスメカニズムからビーコンチェーンPoSコンセンサスメカニズムに移行するネットワークでは、拡張されたり無制限の`extraData`は不要になるためです。

## 後方互換性

このEIPは、ブロックの有効性、ブロック報酬、フォークチョイスルールに関して後方互換性を損なう変更を導入します。

このドキュメントで指定されたコンセンサスアップグレードの設計は、[EVM](#evm)セクションで説明されているものや、PoWコンセンサスに強く依存しているものを除いて、Ethereum上に構築されたアプリケーションやサービスに対して後方互換性の問題を導入しません。


### EVM

このEIPは明示的にEVMに変更を加えませんが、いくつかの点で既存のスマートコントラクトのロジックに影響を与える可能性があります。

#### DIFFICULTY

`DIFFICULTY`演算は、このEIPが有効になり**`difficulty`**フィールドが`0`定数に置き換えられた後、常に`0`を返します。

*注意*: ビーコンチェーンによって蓄積されたランダム性を返すように`DIFFICULTY`のセマンティクスを変更することが検討されていますが、これは別のEIPで導入されます。

#### BLOCKHASH

`BLOCKHASH`演算の出力として得られる擬似乱数は、このEIPが有効になり、PoW機構(ブロックハッシュの可変性を低下させる)がPoSに置き換わった後、より安全性が低下します。


## テストケース

* ブロックの有効性
	* `TRANSITION_BLOCK`以降、以下のいずれかが true の場合、ブロックは無効とされる:
		* `ommersHash != Keccak256(RLP([]))`
		* `difficulty != 0`
		* `nonce != 0x0000000000000000`
		* `len(extraData) > MAX_EXTRA_DATA_BYTES`
  * `TRANSITION_BLOCK`以降、ブロック報酬は`beneficiary`アカウントに加算されない
* クライアントソフトウェアはPoS LMD-GHOSTルールに従う
  * ヘッドと確定ブロックは、最新の`POS_FORKCHOICE_UPDATED`イベントに従って設定される
  * `POS_FORKCHOICE_UPDATED`イベントを受信しない限り、フォークチョイスの状態は更新されない
* トランジションプロセス
  * クライアントソフトウェアはターミナルPoWブロックを超えるPoWブロックを処理しない
  * `TRANSITION_BLOCK`以降、クライアントソフトウェアは新しいブロックの有効性ルールを適用する
  * 最初の`POS_FORKCHOICE_UPDATED`以降、クライアントソフトウェアはフォークチョイスルールをPoS LMD-GHOSTに切り替える
  * `TRANSITION_BLOCK`はターミナルPoWブロックの子孫でなければならない
  * `FIRST_FINALIZED_BLOCK`を受信した後、`NewBlockHashes (0x01)`と`NewBlock (0x07)`のネットワークメッセージは破棄される


## セキュリティ上の考慮事項

### ビーコンチェーン

[EIP-2982](./eip-2982.md#security-considerations)のセキュリティ上の考慮事項を参照してください。

### トランジションプロセス

この仕様を有効にするためのトランジションプロセスは、ハードフォークよりも洗練されたバージョンです - Ethereumネットワークで後方互換性のない変更を適用する通常の手順です。このプロセスには複数の連続するステップがあり、単純なハードフォークのブロック高さ条件とは異なります。

このアップグレードプロセスの複雑さは、コンセンサスメカニズムの基盤ではなく実行レイヤーをターゲットにしているためです。可能な限り単純さを追求していますが、このトランジション中の安全性と活性が最優先事項となっています。

#### ターミナル総合難易度vs.ブロック番号

ハードフォークのブロック番号を事前に定義するのは、このコンテキストでは安全ではありません。これは、トランジション中にPoSフォークチョイスが優先されるためです。

攻撃者は、マイノリティのハッシュパワーを使って悪意のあるチェーンフォークを構築し、ブロック高さの要件を満たす可能性があります。その後、この敵対的なフォークのPoWブロックの上に最初のPoSブロックが悪意を持って提案され、ヘッドになり、トランジションのセキュリティを損なう可能性があります。

このような攻撃シナリオからネットワークを保護するために、チェーンによって蓄積された難易度(総合難易度)がアップグレードのトリガーとして使用されます。

#### 複数のターミナルPoWブロック間の移動

ターミナルPoWブロックが、ネットワーク参加者の過半数によって観測されない場合があります(一時的なネットワークパーティショニングなど)。そのような場合、このマイノリティはターミナルPoWブロックが異なるPoSルールに基づいて自身のフォークチョイスに切り替えることになります。

トランジションプロセスでは、(a)これらのブロックがターミナルPoWブロックの条件を満たし、(b)`FIRST_FINALIZED_BLOCK`がまだ受信されていない限り、異なるターミナルPoWブロックを持つフォーク間で再編成することができます。これにより、トランジションプロセス中の悪影響なネットワーク状況に対する回復力が提供され、修復不可能なフォークやパーティションを防ぐことができます。

#### powブロックのインポートの停止

ビーコンチェーンネットワークに接続されたクライアントソフトウェアの一部が、Ethereumネットワークが`TERMINAL_TOTAL_DIFFICULTY`に到達する前にオフラインになり、この閾値に達している間オフラインのままだとします。このような事象により、クライアントソフトウェアがPoSに切り替えることができず、ターミナルPoWブロックを超えてPoWチェー
ンを続けて追跡し続けることができます。オフラインだった期間によっては、以下のような悪影響が生じる可能性があります:
* クライアントにはターミナルPoWブロックの事後状態がない(状態が剪定されている)ため、PoSチェーンへの再編成ができず、最初から同期するしかない。
* アプリケーション、ユーザー、サービスが間違ったフォーク(継続して構築されているPoWチェーン)からデータを使用するため、セキュリティ上の問題が発生する。

ターミナルPoWブロックを超えるPoWブロックをインポートしないことで、ソフトウェアやコンフィギュレーションの障害時の安全性/再編成に対する悪影響を防ぐことができ、代わりに活性の障害を選択することができます。

#### ターミナルPoWブロックの上書き

緊急時にコンセンサスアップグレードを加速するためのメカニズムが考慮されています。
このEIPでは、以下のような緊急ケースシナリオでの加速を検討しています:
* ネットワークのハッシュレートの低下によってアップグレードが大幅に遅延する場合。
* アップグレード前のPoWネットワークに対する攻撃の場合。

最初のケースは、以下のパラメータを更新することで安全に加速できます:
* `TERMINAL_TOTAL_DIFFICULTY` -- 元の値よりも近い時間になるように再設定する。
* `FORK_NEXT_VALUE` -- 適切に調整する。

2つ目の、より深刻な攻撃シナリオでは、より侵襲的な上書きが必要です:
* `TERMINAL_BLOCK_HASH` -- ターミナルPoWブロックとなるべきブロックのハッシュに設定する。
* `TERMINAL_BLOCK_NUMBER` -- `TERMINAL_BLOCK_HASH`で指定されたブロックの番号に設定する。
* `TERMINAL_TOTAL_DIFFICULTY` -- `TERMINAL_BLOCK_HASH`で指定されたブロックの総合難易度に設定する。
* `FORK_NEXT_VALUE` -- 適切に調整する。

*注意*: 2つ目のケースでの加速は、イーサリアム・メインネットで非trivialな活性の障害を引き起こすため、最も極端なシナリオに対してのみ検討されます。

### 古いブロックはネットワークのセキュリティに不要になる

PoWネットワークでは、ジェネシスからの全履歴ブロックを保持することが不可欠です。特定のチェーンの有効性を、PoW封印に関して正当化するには、そのチェーンに属するすべてのブロックのヘッダが必要です。

新しいPoSメカニズムでは、ブロック全履歴の検証は必要ありません。代わりに、PoSネットワークのsync プロセスは、ピアによって共有される弱い主観性チェックポイントと呼ばれる履歴スナップショットに依存しています。つまり、弱い主観性チェックポイントを超えた過去のブロックは、正規ブロックチェーンを決定するために必要ではなくなります。

弱い主観性チェックポイントの仕様は、`ethereum/consensus-specs`リポジトリに記載されています。


## 著作権
著作権およびそれに関連する権利は[CC0](../LICENSE.md)によって放棄されています。