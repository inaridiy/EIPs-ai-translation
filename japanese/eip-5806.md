---
original: cfb2ef120ca86200bd1c6c34dda97ce7ff63b6a9d4784c29256a1ef8752edefd
---

---
eip: 5806
title: デリゲート取引
description: EOAが委任呼び出しのメカニズムを使って任意のコードを実行できるようにする新しい取引タイプを追加する
author: Hadrien Croubois (@Amxx)
discussions-to: https://ethereum-magicians.org/t/eip-5806-delegate-transaction/11409
status: Draft
type: Standards Track
category: Core
created: 2022-10-20
requires: 2718, 2930
---

## 概要

このEIPは、EOAが委任呼び出しのようなメカニズムを使って任意のコードを実行できるようにする新しい取引タイプを追加します。

## 動機

EOAは最も広く使われているアカウントタイプですが、その操作能力は契約のデプロイと「call」取引の送信に限られています。現在、EOAが任意のコードを実行することはできません。これにより、ユーザーがブロックチェーンと対話できる範囲が大幅に制限されています。アカウントアブストラクションについては広く議論されていますが、メインストリームでの採用への道のりはまだ不明確です。[ERC-4337](./eip-4337.md)のようなアプローチは、スマートウォレットのサポートの問題に取り組むことなく、スマートウォレットの使いやすさを改善しようとしています。

スマートコントラクトウォレットはUXの面で多くのものを提供していますが、関連するコストや一部のEOAが譲渡不可能な資産の保管を行っているという事実から、すべてのユーザーが近いうちに移行するとは考えにくいです。

このEIPは、EOAが任意のコードを実行できるようにするアプローチを提案しています。これは、EVMに対する最小限の変更で行い、ユーザーが慣れ親しんでいるセキュリティモデルを使用します。EOAがコントラクトに対して委任呼び出しを行えるようにすることで(同様に[EIP-7](./eip-7.md)でコントラクトが他のコントラクトに対して委任呼び出しを行えるように)、EOAはより多くの操作を実行したいものを制御できるようになります。この提案の目的は、アカウントアブストラクションのプリミティブを提供することではありません。

マルチコールコントラクト(例えば`0xcA11bde05977b3631167028862bE2a173976CA11`にデプロイされたもの)に対して委任呼び出しを行うことで、EOAは複数の取引をバッチ処理できるようになります(すべてのサブコールの`msg.sender`になります)。これにより、プロトコルとの対話に対するユーザーエクスペリエンスが向上し(複数の取引、ガス価格の変動、21kガスのオーバーヘッドが不要になる)、そのような対話の安全性も向上します(不安全なトークンの承認が`approval`と後続の`transferFrom`の間で悪用されるのを避けられる)。

その他の予期せぬロジックをスマートコントラクトに実装し、EOAが使えるようにすることもできます。これにはイベントの発行などが含まれます。

このEIPは他のアカウントアブストラクションの提案を置き換えることを目的としていません。近い将来、EOAの所有者のユーザーエクスペリエンスを大幅に改善できる、簡単に実装できる代替案を提供することを目的としています。

## 仕様

このドキュメントの「MUST」、「MUST NOT」、「REQUIRED」、「SHALL」、「SHALL NOT」、「SHOULD」、「SHOULD NOT」、「RECOMMENDED」、「MAY」、「OPTIONAL」というキーワードは、RFC 2119に記載されているように解釈されるものとします。

### パラメータ

- `FORK_BLKNUM` = `TBD`
- `TX_TYPE` = TBD, > 0x03 ([EIP-4844](./eip-4844.md))

`FORK_BLOCK_NUMBER`以降、新しい[EIP-2718](./eip-2718.md)取引が導入され、`TransactionType` = `TX_TYPE(TBD)`となります。

新しい取引の固有コストは[EIP-2930](./eip-2930.md)から継承され、具体的には`21000 + 16 * 非ゼロのコールデータバイト数 + 4 * ゼロのコールデータバイト数 + 1900 * アクセスリストのストレージキー数 + 2400 * アクセスリストのアドレス数`となります。

この取引の[EIP-2718](./eip-2718.md) `TransactionPayload`は以下のようになります:

```
rlp([chain_id, nonce, max_priority_fee_per_gas, max_fee_per_gas, gas_limit, destination, data, access_list, signature_y_parity, signature_r, signature_s])
```

すべてのフィールドの定義は[EIP-1559](./eip-1559.md)と同じセマンティクスに従います。ただし、`amount`フィールドはこの取引には含まれていないことに注意してください。

`to`フィールドは少し異なるセマンティクスを持ちますが、nilであってはならず、常に20バイトのアドレスを表す必要があります。つまり、デリゲート取引はcreate取引の形式を取ることはできません。

この取引の`signature_y_parity, signature_r, signature_s`要素は、`keccak256(TX_TYPE || rlp([chain_id, nonce, max_priority_fee_per_gas, max_fee_per_gas, gas_limit, destination, data, access_list]))`に対するsecp256k1署名を表します。

この取引の[EIP-2718](./eip-2718.md) `ReceiptPayload`は`rlp([status, cumulative_transaction_gas_used, logs_bloom, logs])`です。

この新しい取引タイプの実行は、[EIP-7](./eip-7.md)で導入された委任呼び出しメカニズムと同等ですが、EOAによって実行されます。つまり、`destination`にあるコード(存在する場合)は、送信者のコンテキストで実行されるはずです。その結果、そのような取引はEOAからイベントを発行したり、EOAをクリエイターとして`Create2`を使ったりすることができます。ただし、この取引にはいくつかの制限があります。

### オペコードの制限

セキュリティ上の理由から、EOAの文脈で実行されるべきではないいくつかのオペコードがあります:

- `SSTORE` (0x55): EOAの下でストレージを設定することは多くの前提を破ります。特に、デリゲート取引を通じて設定されたストレージは、[EIP-7377](./eip-7377.md)や同様のものを使ってアカウントが「移行」する場合に問題を引き起こす可能性があります。さらに、ストレージはEOAがデリゲート取引を使ってターゲットとするコードがそのアカウントの下でストレージレイアウトを異なる方法で解釈する場合の競合の源となる可能性があります。これらすべての理由から、EOAがデリゲート取引の文脈で`SSTORE`を実行することは禁止されるべきです。デリゲート取引が`CALL`を実行する場合、呼び出し先は通常どおりストレージを操作できます。

- `CREATE` (0xF0)、`CREATE2` (0xF5)、`SELFDESTRUCT` (0xFF): 特定の送信者からの取引にはコンセキュティブなnonceが期待されるという前提があります。EOAがnonce を変更する操作を1つ以上実行できる場合、この前提が破られる可能性があります。したがって、デリゲート取引を実行するEOAは、`CREATE`、`CREATE2`、`SELFDESTRUCT`オペコードを使用することはできません。デリゲート取引が`CALL`を実行する場合、呼び出し先は通常どおりコントラクトを作成できます。

これらの制限されたオペレーションのいずれかを実行しようとすると、例外がスローされます。

## 根拠

EOAは最も広く使われているウォレットタイプです。

このEIPは、[EIP-7](./eip-7.md)で導入された既存の委任メカニズムを使用することで、EOAがスマートコントラクトと対話する能力を大幅に拡張し、EVMに新しい複雑さを追加することなく実現します。

## 下位互換性

[EIP-2718](./eip-2718.md)の取引エンベロープのおかげで、既知の下位互換性の問題はありません。

包含ロジックとガスコストがタイプ2取引と似ているため、この新しい取引タイプを同じメンプールに含めることが可能です。

## セキュリティ上の考慮事項

既存の取引タイプで使用されているnonce機構により、リプレイ攻撃が防止されます。既存の取引タイプと同様に、デリゲート取引はより多くのフィーを支払う偽の取引に置き換えることで取り消すことができます。

ウォレットによって署名されるオブジェクトが取引であり、[EIP-3074](./eip-3074.md)のように多様な方法で処理される可能性のある署名ではないため、署名の誤用に関連するリスクが低減されます。ウォレットはこのデリゲート取引の実行をシミュレーションし、ユーザーが署名する操作が操作されないことを保証できます。

このメカニズムを通じて呼び出されるコントラクトは、署名者に代わってあらゆる操作を実行できます。他の取引タイプと同様に、署名者はデリゲート取引に署名する際に非常に慎重でなければなりません。

## 著作権

著作権およびそれに関連する権利は[CC0](../LICENSE.md)によって放棄されています。