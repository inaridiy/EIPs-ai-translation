---
original: e9a9e81bf08ca5f3e41cd34be22af0115bb62706e8d72c4ae65fb5d6e22a1596
---

---
eip: 2982
title: Serenity Phase 0
description: Serenity、Ethereumのスケーラブルで証明可能な持分証明(PoS)コンセンサスへの一連のアップグレードの第0フェーズ
author: Danny Ryan (@djrtwo)、Vitalik Buterin (@vbuterin)
discussions-to: https://ethereum-magicians.org/t/serenity-phase-0-eip/4621
status: Final
type: Informational
created: 2020-09-15
---

## 概要

このEIPは、Ethereum メインネットのコンセンサスメカニズムへのアップグレードである Serenity (eth2) の第0フェーズを規定しています。第0フェーズでは、既存のPoWチェーンとメカニズムは完全に影響を受けることなく、PoSチェーン (ビーコンチェーン) が並行して構築され、アップグレードされたコンセンサスの中核として機能します。後続のフェーズでは、ビーコンチェーンが並行するシャードチェーンのコンセンサスをサポートし、セキュリティを高め、最終的には現在のEthereum メインネットをその1つのシャードとして組み込みます。

ビーコンチェーンの中核には、Casper the Friendly Finality Gadget (FFG) と呼ばれる持分証明コンセンサスメカニズムと、Latest Message Driven Greedy Heaviest Observed Sub-Tree (LMD-GHOST) と呼ばれるフォークチョイスルールがあります。第0フェーズは主にこれらのアルゴリズムを実行するバリデーターの仕組みと動機付けに焦点を当てています。eth2の詳細な仕様は、このEIPとは別のリポジトリに含まれており、安全性と活性化の証明は[Combining GHOST and Casper](../assets/eip-2982/arxiv-2003.03052-Combining-GHOST-and-Casper.pdf)論文で見つかります。重複を避けるため、このEIPでは関連する仕様ファイルとリリースを参照するだけです。

eth2の初期フェーズは、現在のEthereum メインネットでの合意変更を伴わずに実行されます。このEIPは、このコンセンサスメカニズムの立ち上げを文書化し、eth2がEthereum の現在の証明可能な仕事量(PoW)コンセンサスを置き換える道筋を示します。

## 動機

eth2は、高い暗号経済的セキュリティと分散化を維持しつつ、効率的で世界規模の汎用トランザクションプラットフォームをサポートするというEthereum の本来の構想を実現することを目指しています。

現在、Ethereumブロックは増加する分散型アプリケーションの需要により常に満杯状態です。2017年 (CryptoKitties) 以来の最初の深刻な利用の急増以来、Ethereumコミュニティは一貫して、そして強く、スケーリングソリューションを求め続けてきました。

Ethereumの創設以来、スケーリングソリューションの調査と期待は2つの側面 - レイヤー1のアップグレードとレイヤー2の採用 - から成ってきました。このEIPは、前者の多段階展開の開始を表しています。

### シャーディングによるスケーリング

過去5年間、Ethereumネットワークとその上に構築されたアプリケーションの利用が増加するにつれ、ブロックは定期的に満杯になり、ガス価格市場が継続的に上昇しています。現在のEthereum チェーンのブロックガスリミットの単純な増加では、システムの持続可能性の高い資源負荷 (帯域幅、計算、ディスクリソース) を引き起こすことなく、需要の増加に対応することはできません。分散性を維持しつつEthereum ネットワークをスケールアップするには、別のアプローチを取る必要があります。

Ethereumのスケーリングを提供するために、eth2は「シャーディング」と呼ばれる手法を導入します。ここでは、現在のEthereum メインネットと同程度の容量を持つ複数のブロックチェーンシャードが、統一されたコンセンサスメカニズムの下で並行して実行されます。コア コンセンサス (ビーコンチェーン) とごく少数のこれらのシャードは単一のコンシューママシンで処理できますが、システム全体の集計容量は大幅に高くなります。

### 分散化と経済的確定性のための持分証明

Ethereumの初期から、持分証明(PoS)は以下の点で長年の目標でした:
* コア コンセンサスへの参加の障壁と技術要件を引き下げることによる、コアコンセンサスの分散化の向上
* 不正行為に対するプロトコル内のペナルティと経済的確定性の追加による、暗号経済的セキュリティの向上
* 現在のPoWコンセンサスメカニズムのエネルギー消費の排除

上記に加えて、PoSはシャーディングスケーリングソリューションと相乗効果を発揮します。シャーディングの要件であるランダムサンプリングのため、PoSはPoWよりも「アクティブバリデーターセット」への直接アクセスを提供し、よりダイレクトなシャーディングプロトコルの構築を可能にします。

## 仕様

第0フェーズは、既存のEthereum メインネットへの合意変更を_必要としません_。代わりに、PoSコンセンサスの新しい立ち上げが行われ、安定化した後にPoWコンセンサスに取って代わることができます。

第0フェーズの仕様は、このEIPとは独立したリポジトリで管理されています。`SPEC_RELEASE_VERSION`リリースの仕様は、このEIPの正式な第0フェーズ仕様とみなされます。

このEIPでは、Ethereum メインネットに関連する (例えばデポジットコントラクト) およびユーザーに関連する (例えばバリデーターの仕組みとeth2の発行) 第0フェーズのメカニズムの概要を提供します。詳細と低レベルの詳細は、`consensus-specs`リポジトリに記載されています。

### パラメーター

| パラメーター | 値 |
| - | - |
| `SPEC_RELEASE_VERSION` | `v1.0.0` |
| `SPEC_RELEASE_COMMIT` | `579da6d2dc734b269dbf67aa1004b54bb9449784` |
| `DEPOSIT_CONTRACT_ADDRESS` | `0x00000000219ab540356cBB839Cbe05303d7705Fa` |
| `MIN_GENESIS_TIME` | `1606824000` |
| `BASE_REWARD_FACTOR` | `2**6` (64) |
| `INACTIVITY_PENALTY_QUOTIENT` | `2**26` (67,108,864) |
| `PROPORTIONAL_SLASHING_MULTIPLIER` | `1` |
| `MIN_SLASHING_PENALTY_QUOTIENT` | `2**7` (128) |

_注:_ eth2にはさらに多くの第0フェーズ設定パラメーターがありますが、ほとんどは簡潔さのためにこのEIPから省略されています。

### バリデーターデポジットコントラクト

第0フェーズでは、eth2はEthereum メインネットにデプロイされたコントラクト - デポジットコントラクト - を使用して、PoSコンセンサスのビーコンチェーンにバリデーターを導入します。

PoSコンセンサスに参加するには、ユーザーがデポジットコントラクトにバリデーターデポジットを送信します。ビーコンチェーンはこのコントラクトの状態に合意し、新しいバリデーターデポジットを処理します。この一方向のデポジットメカニズムは、第0フェーズにおける2つのシステムコンポーネント (Ethereum メインネットとビーコンチェーン) の唯一の技術的リンクです。

### ビーコンチェーンとバリデーターの仕組み

PoSコンセンサスに参加することを選択したユーザーは、ETHの担保をデポジットコントラクトに預け入れ、ビーコンチェーンのバリデーターセットに組み込まれます。その後、これらのバリデーターは**ビーコンチェーン** (PoSにおける合意参加者はPoWのマイナーに相当) の構築に責任を負います。

ビーコンチェーンは純粋なPoSチェーンで、第0フェーズでは主に自身のコンセンサスを維持し、バリデーターレジストリを管理することに専念しています。コンセンサスルールは、バリデーターが参加することが期待される_役割_ (例: ブロック提案、ブロック証明) を定義しており、バリデーターが役割を適切に果たせば報酬を受け、適切に果たせなければペナルティを受けます。第0フェーズにはまだETH転送、シャーディング、スマートコントラクト/VM実行機能は含まれていません。

後続のフェーズでは、並行するシャードチェーンのコンセンサスを管理するためのメカニズムとバリデーターの責任が追加されます ("第1フェーズ")、既存のEthereum システムを統合します ("第1.5フェーズ")、そしてシャーディングされたスマートコントラクト実行の完全なサポートが追加されます ("第2フェーズ")。

### 発行

ETHの担保を預けてeth2コンセンサスに参加するバリデーターを動機付けるために、EthereumのネイティブアセットであるETHの定期的な報酬 (発行) を提案しています。eth2ビーコンチェーンが初期フェーズでPoWチェーンと並行して動作するため、この発行は既存のチェーンのPoW報酬に加えて行われます。

ビーコンチェーンのバリデーターに発行されるETHの量は、預けられたETHの合計の平方根に比例します。この発行曲線は、2つの明白な代替案 - 固定の総発行量と固定の1ETHあたりの発行量 - よりも安定的で持続可能な曲線として選択されました。この選択の詳細な議論は[こちら](../assets/eip-2982/ef-Discouragement-Attacks.pdf)を参照してください。

eth2では、このカーブは`BASE_REWARD_FACTOR`というパラメーターで表されます。以下は預けられたETHに対する発行曲線と、例示のための表です。すべての数値は年率換算です。

![](../assets/eip-2982/2982-issuance.png)

| アクティブデポジット | 最大年間バリデーター報酬\* | 最大年間ETH発行\* |
| -------- | -------: | --------: |
| 0.5M ETH | 23.50%   | 117,527   |
| 1M ETH   | 16.60%   | 166,208   |
| 2M ETH   | 11.75%   | 235,052   |
| 4M ETH   |  8.31%   | 332,411   |
| 8M ETH   |  5.88%   | 470,104   |
| 16M ETH  |  4.16%   | 664,801   |
| 32M ETH  |  2.94%   | 940,167   |
| 64M ETH  |  2.08%   | 1,329,603 |
| 128M ETH |  1.47%   | 1,880,334 |

_\*バリデーターが100%オンラインで最適に動作していることを前提としています。最適でない動作はバリデーターの報酬の減少や、ペナルティによる総発行量の減少につながります。_

### 初期のペナルティパラメーター

PoSプロトコルが暗号経済的に安全であるためには、プロトコル内のペナルティが必要です。小さなオフラインペナルティはバリデーターの活性化を奨励し、(潜在的に)はるかに大きなペナルティはテールリスクシナリオでプロトコルのセキュリティを提供します。

具体的には、以下の重大なペナルティが存在します:
* **非活性リーク**: 長期にわたる確定性の欠如 (例えば3分の1以上がオフラインまたはカノニカルチェーンにいない場合) の際に適用される、エポックごとに増加するオフラインペナルティ。これにより、カタストロフィックな条件下でも最終的にチェーンが確定性を取り戻すことができます。
* **スラッシング**: 2つの対立するチェーンの構築と確定化につながる可能性のある_明示的に悪意のある_メッセージに署名したバリデーターに適用されるペナルティ。このペナルティは、同じ期間にスラッシングされたバリデ
ーターの割合に比例して増加するように設計されており、重要な数のスラッシングが発生した場合、バリデーターは_最大限_罰せられます。

第0フェーズの初期立ち上げでは、これらのペナルティの大きさを定義するパラメーター - `INACTIVITY_PENALTY_QUOTIENT`、`PROPORTIONAL_SLASHING_MULTIPLIER`、`MIN_SLASHING_PENALTY_QUOTIENT` - は、最終的な意図値よりも低く設定されています。これにより、初期の高い技術リスクの段階で、バリデーションを奨励するためのより寛容な環境が提供されます。

_`INACTIVITY_PENALTY_QUOTIENT`は当初の4倍に設定されています_。これにより、非確定性の際のリークが遅くなり、チェーンがそのような事態に対してあまり反応的ではなくなります。eth2の初期数か月間に非確定性の長期化があった場合、それはクライアントソフトウェアの技術的な問題によるものである可能性が高いです。

_`PROPORTIONAL_SLASHING_MULTIPLIER`は当初の3分の1に設定されています_。これにより、攻撃が発生した場合の説明責任の安全余裕が低くなります。eth2の初期数か月間にバリデーターがスラッシングされた場合、それはユーザーによるキーの管理ミスや、クライアントソフトウェアの問題によるものである可能性が高いです。

_`MIN_SLASHING_PENALTY_QUOTIENT`は当初の4倍に設定されています_。これにより、スラッシング可能な違反に対する最低保証ペナルティが低くなり、個々のバリデーターのシステムを安全に保つ基本的なペナルティのインセンティブが減少します。`PROPORTIONAL_SLASHING_MULTIPLIER`と同様に、eth2の初期数か月間のスラッシングは、組織的な攻撃ではなく、ユーザーの管理ミスやクライアントソフトウェアの問題によるものである可能性が高いです。

## 根拠

### 原則

* **簡素さ**: 特に暗号経済的な持分証明とクアドラティックシャーディングは本質的に複雑であるため、可能な限り最大の簡素さを追求する必要があります。これは重要です。なぜなら、(i) 開発コストを最小限に抑え、(ii) 予期せぬセキュリティ問題のリスクを減らし、(iii) プロトコル設計者がパラメーター選択の正当性をユーザーに説得しやすくするためです。複雑さが避けられない場合は、それがどこに存在するべきかの優先順位は、レイヤー2プロトコル > クライアント実装 > プロトコル仕様の順です。
* **長期的な安定性**: プロトコルの低レベルは、10年以上変更する必要がないように構築されるべきで、必要な革新はより高いレベル (クライアント実装やレイヤー2プロトコル) で行うべきです。
* **十分性**: できるだけ多くのアプリケーションクラスをプロトコルの上に構築できるようにする必要があります。
* **深層防御**: プロトコルは、ネットワーク遅延、障害数、ユーザーの動機付けなどの様々なセキュリティ前提の下でも可能な限り適切に機能し続けるべきです。
* **完全なライトクライアント検証可能性**: 一部の前提 (ネットワーク遅延、攻撃者予算の制限、1-of-Nまたは少数のホネストマイノリティ) の下で、小さな固定量のデータ (理想的にはビーコンチェーンのみ) を検証するクライアントが、51%攻撃の下でも、フルシステムのデータが利用可能かつ有効であることを間接的に保証できるようにする必要があります (これは深層防御の一形態ですが、重要性が高いため別扱いにしています)。

### レイヤー1 vs レイヤー2のトレードオフ

Ethereumロードマップは、レイヤー1/レイヤー2のミックスアプローチを使用しています。レイヤー1の安全性を継承し、汎用アプリケーションのスケーリングを提供する唯一のレイヤー2であるロールアップに焦点を当てています。ただし、ロールアップにはコストがかかります。トランザクションごとにオンチェーンデータが必要であり、高容量のロールアップを持つブロックチェーンは依然として非常に高い帯域幅を処理できる必要があります。そのため、データ可用性サンプリングなどのスケーラブルなデータレイヤー技術を実装しています。

ピュアレイヤー2アプローチを取らない理由は、ピュアレイヤー2スケーリングは信頼ベースのソリューション (望ましくない)、またはチャネルやプラズマ (固有の制限があり、完全なEVMをサポートできない) でしか行えないためです。

ピュアレイヤー1アプローチを取らない理由は、実行レイヤーでの実験の余地を設けるため、ベースプロトコルをより単純にし、ガバナンスの負荷を軽減するためです。

### なぜ持分証明か

要約すると:

* ブロックチェーンのセキュリティを確保するために大量の電力を消費する必要がない (例えば、ビットコインとEthereum は1日あたり100万ドル以上の電力とハードウェアコストを費やしていると推定されています)。
* 電力消費が高くないため、ネットワークに参加し続けるユーザーを動機付けるために多くの新しいコインを発行する必要がありません。理論的には、トランザクション手数料の一部を「バーン」し、供給量が時間とともに減少する可能性さえあります。
* 持分証明は、中央集権的なカルテルの形成を抑制し、形成された場合でもネットワークに有害な方法で行動することを阻止するためのより多様な技術的メカニズムデザインテクニックを開く扉を開きます (例えば、証明可能な仕事のセルフィッシュマイニングなど)。
* 規模の経済が大きな問題ではないため、集中化リスクが低減されます。10万ドルの硬貨は1万ドルの硬貨の10倍の収益を得られますが、より大きな生産設備を購入できるというような、追加の不釣り合いな利益はありません。
* 経済的ペナルティを使用して、51%攻撃などのさまざまな形態の攻撃をはるかに高価なものにすることができます - Vlad Zamfirの言葉を借りれば、「ASICファームが燃え尽きたかのように」です。

### なぜCasperか

現在、主要な持分証明コンセンサスアルゴリズムには3つの学派があります:

* **Nakamoto風** (Peercoin、NXT、Ouroboros...)
* **PBFT風** (Tendermint、Casper FFG、Hotstuff...)
* **CBC Casper**

後者の2つのキャンプでは、セキュリティデポジットとスラッシング (Nakamoto風アルゴリズムは非自明なスラッシングと両立できません) の使用の有無も問題になります。これらはすべてPoWよりも優れていますが、独自のアプローチを擁護したいと思います。

#### スラッシング

Ethereum 2.0は、検出された不正行為に対してバリデーターを罰するスラッシングメカニズムを使用しています。最良の場合は約1%、最悪の場合はデポジット全額までのペナルティが課されます。

スラッシングの使用を以下のように擁護します:

1. **攻撃コストの引き上げ**: 持分証明ブロックチェーンに対する51%攻撃には、非常に大額の出費 (数億ドル相当の硬貨) を強いられ、それらが焼失されるという強い主張ができるようにしたいと考えています。これにより、攻撃/防御のバランスが攻撃者にとって非常に不利になり、実際には攻撃が逆効果になる可能性があります。なぜなら、サービスの混乱がレジティメートなコイン保有者への価格上昇によって相殺されるためです。
2. **バリデーターのジレンマの克服**: 即座の逸脱行動の最も現実的な形態は_怠慢_ (つまり、検証すべきものを検証しないこと、万が一のために全てに署名すること)です。[バリデーターのジレンマ論文](../assets/eip-2982/iacr-2015-702-Demystifying-Incentives-in-the-Consensus-Computer.pdf) (Luu et al., CC BY) で理論的な議論が、ビットコインのSPVマイニングフォークで実際の事例が示されています。自己矛盾する署名や誤った署名に対する非常に大きなペナルティにより、この問題を軽減することができます。

より微妙な(2)の例は以下のようなものです。2019年7月、Cosmosのバリデーターが2つの矛盾するブロックに署名したためスラッシングされました。調査の結果、これは、そのバリデーターが報酬を確実に得るために、プライマリとバックアップのノードを同時に稼働させていたためであることが明らかになりました。

プライマリとバックアップのノードを持つことが標準的な慣行になった場合、攻撃者がネットワークを分断し、すべてのバリデーターのプライマリとバックアップに異なるブロックにコミットさせ、2つの矛盾するブロックが確定化されるという事態が起こる可能性があります。スラッシングペナルティはこのような慣行を強く抑止し、そのようなシナリオが発生するリスクを減らします。

#### コンセンサスアルゴリズムの選択

BFT風とCBC学派のコンセンサスアルゴリズムのみが確定性の概念を持っています。つまり、ブロックが確定される際に、大部分 (BFT風では3分の1、CBCでは4分の1) のバリデーターが不正行為をしない限り、そのブロックが矛盾するブロックに取って代わられることはありません。Nakamoto風 (つまり最長チェーンルール) のコンセンサスアルゴリズムには、この意味での確定性はありません。

確定性には、オンラインの(超)多数のバリデーターが必要ですが、これはシャーディングメカニズムの要件でもあります。なぜなら、クロスリンクを受け入れるためには、ランダムに選ばれたバリデーターコミティの3分の2以上の署名が必要だからです。

[Casper FFG](../assets/eip-2982/arxiv-1710.09437-Casper-the-Friendly-Finality-Gadget.pdf)を選択したのは、その時点で利用可能な最も単純なアルゴリズムであったためです。詳細はまだ長期的な変更の対象です。特に、1スロットの確定性を達成する解決策を積極的に探索しています。

### シャーディング - なぜスーパーノードが嫌いなのか

シャーディングに対する主要な代替案は、スーパーノードの使用です。つまり、すべてのコンセンサスノードに強力なサーバーを要求し、すべてのトランザクションを個別に処理できるようにすることです。スーパーノードベースのスケーリングは実装が簡単であるため便利です。現在のブロックチェーンと同じように動作しますが、より並列化可能な方法でソフトウェアエンジニアリングを行う必要があります。

この方法に対する主な異論は以下の通りです:

* **プールの集中化リスク**: スーパーノードベースのシステムでは、ノードの運用コストが高いため、参加できるユーザーが非常に少なくなります。これに対する反論として「PoWやPoSの大半のコンセンサスはいずれにしろ5-20のプールで支配されており、プールであれば問題ない」というものがありますが、これは無視しています。プールの間でも集中化圧力が存在するリスクを。デポジットサイズに対する報酬が固定コストに対して大きい場合、より大きなプールは小さなプールよりも手数料を低く提供できるため、小さなプールが排除されるか、合併を余儀なくされる可能性があります。一方、シャーディングシステムでは、より多くのETHを保有するバリデーターはより多くのトランザクションを検証する必要があるため、コストは固定ではありません。

**AWSの集中化リスク**: スーパーノードベースのシステムでは、ホームステーキングが不可能であり、ほとんどのステーキングがクラウドコンピューティング環境で行われる可能性が高くなります。これらのオプションは限られているため、単一障害点が生まれます。
* **検閲耐性の低下**: コンセンサスへの参加に高い計算能力と帯域幅が必要不可欠であるため、バリデーターの検出と検閲が容易になります。
* **スケーラビリティ**: トランザクスループットが増加するにつれ、スーパーノードベースのシステムでは上記のリスクが増大しますが、シャーディングシステムはより容易に増加した負荷に対応できます。

これらの集中化リスクが、超低遅延 (<1秒) のブロックチェーンを目指さない理由でもあります。代わりに、比較的保守的な数値を選択しています。

代わりに、Ethereumは各バリデーターが全データの一部のみを処理するアプローチを取っています。数万ETH以上を預けているバリデーターのみが、チェーン全体のデータを処理する必要があります。

ただし、ブロック_生成_は集中化されるが、(i) ブロック_検証_は分散化され、(ii) ユーザーがトランザクションを送信できる「バイパスチャネル」が存在し、ブロック生成者はそれらを含めざるを得ないという、シャーディング設計の中間的な選択肢もあります。私たちは、スケーリングをより早く展開できるよう、この方向に少し傾いたシャーディング設計を積極的に検討していますが、必要に応じて、そこでさえ分散型のビルダーを実行し、集中化を回避することも可能です。

### セキュリティモデル

ブロックチェーンは「過半数が正直」という前提に依存していると一般的に考えられています。つまり、参加者の50%以上が、自身の利益を犠牲にしてでも指定されたプロトコルに忠実に従うということです。実際には、(i) 正直な過半数モデルは非現実的で、参加者は「怠慢」になり、検証せずにブロックに署名するのが一般的な逸脱形態ですが (「バリデーターのジレンマ論文」と、ビットコインのSPVマイニングフォークを参照)、(ii) ブロックチェーンはより過酷なモデルの下でも多くまたはすべてのセキュリティ特性を維持するため、これらの追加の保証を維持することが非常に重要です。

一般的により過酷なモデルは_非協調的な合理的多数_モデルで、参加者が自己利益に従って行動しますが、協力しているのは全体の23.21%以下であるというものです。さらに過酷なモデルは、50%以上のハッシュパワーまたは持分を1つのアクターが制御する最悪のケースモデルで、問題は以下のようになります:

* そのようなシナリオの下でも、攻撃者に非常に高いコストを負担させることができるか?
* 無条件に維持できる保証は何か?

持分証明のスラッシングは最初の目的を達成します。シャーディングされていないチェーンでは、すべてのノードがすべてのブロックを検証することで、(i) 最長チェーンが有効であること、(ii) 最長チェーンが_利用可能_であることの2つの保証を無条件に維持できます。

シャーディングの主要な課題は、すべてのノードがフルチェーンを検証することなく、同じ2つの特性を得ることです。ランダムコミティサンプリング、保管の証明、不正検知プルーフ、[データ可用性サンプリング (DAS)](../assets/eip-2982/arxiv-1809.09044-Fraud-and-Data-Availability-Proofs--Maximising-Light-Client-Security-and-Scaling-Blockchains-with-Dishonest-Majorities.pdf)、そしてやがてはZK-SNARKsを組み合わせた深層防御アプローチにより、クライアントが全データをダウンロードおよび検証することなく、不正または利用不可能なチェーンを検出および拒否できるようになります。

トランザクションの検閲は、コンセンサスを保持しつつクライアントによって検出される可能性がありますが、この研究はまだEthereumロードマップに組み込まれていません。

現在期待されるセキュリティ特性を表にまとめると以下のようになります:

| | ネットワーク遅延 <3秒 |ネットワーク遅延 3秒 - 6分|ネットワーク遅延 > 6分|
|---|---|---|---|
|バリデーターの2/3以上が正直|完全な動作|不完全だが許容できる動作。活性化の厳密な証明はないが、実際には活性化が期待される。|活性化の断続的な失敗の可能性、安全性の失敗はない|
|バリデーターの2/3以上が合理的、1/3未満が協調|完全な動作|不完全だが許容できる動作、集中化リスクの高まり|活性化の断続的な失敗の可能性、安全性の失敗はない、集中化リスクが非常に高い|
|51%攻撃者|確定性を巻き戻したり検閲したりできるが、高コストがかかる; 無効または利用不可能なチェーンを強制できない|確定性を巻き戻したり検閲したりできるが、高コストがかかる; 無効または利用不可能なチェーンを強制できない|確定性を巻き戻したり検閲したりできる; 無効または利用不可能なチェーンを強制できない|

### Casperのインセンティブはなぜこのように設定されているのか

#### ベース報酬

各エポックの間、すべてのバリデーターは「アテステーション」と呼ばれる署名を行うことが期待されています。これは、そのバリデーターのチェーンヘッドに対する意見を表明するものです。アテステーションが含まれることに対する報酬には4つの要素 (「義務」と呼ばれる) があります:

1. アテステーションが含まれることに対する報酬
2. アテステーションが正しいエポックチェックポイントを指定していることに対する報酬
3. アテステーションが正しいチェーンヘッドを指定していることに対する報酬
4. 同期委員会署名に正しく参加していることに対する報酬

また、これらの義務には適時性の要件が組み込まれています。つまり、報酬の対象となるためには、アテステーションが一定の時間内にインクルードされる必要があり、「正しいヘッド」の義務の場合はそのタイムリミットは1スロットです。

各義務に対する実際の報酬は以下のように計算されます。

* $R = B * \frac{nom}{den}$ は、その特定の義務に対応する分数 $\frac{nom}{den}$ を基本報酬 $B$ に乗じたものに等しい
* $P$ は、所望の行動をした割合

そして:

* その義務を果たしたバリデーターは $R * P$ の報酬を受け取る
* その義務を果たさなかったバリデーターは $-R$ のペナルティを受ける

「集合的報酬」方式では、誰かが良い成績を収めれば、みんなが良い成績を収めるという仕組みになっています。これは、グリーフィング要因を抑えるためです (グリーフィング要因とその重要性については[この論文](../assets/eip-2982/ef-Discouragement-Attacks.pdf)を参照)。

ベース報酬 $B$ 自体は $k * \frac{D_i}{\sqrt{\sum_{j=1}^{n} D_j}}$ と計算されます。ここで $D_1 ... D_n$ はデポジットサイズ、$k$ は定数です。これは、(i) 固定報酬率 (つまり $k * D_i$) と、(ii) 固定総報酬 (つまり $k * \frac{D_i}{\sum_{j=1}^{n} D_j}$) の中間的な妥協案です。

(i)に反対する主な論点は、ネットワークに2つの種類の不確実性 - 総発行量の不確実性と、デポジット量の不確実性 - を課すことです。報酬率が低すぎると参加者がほとんどいなくなり、ネットワークが危機に瀕し、高すぎると予想外の高い発行量につながります。(ii)に反対する主な論点は、[グリーフィング攻撃論文](../assets/eip-2982/ef-Discouragement-Attacks.pdf)で説明されているように、より攻撃に脆弱であることです。逆二乗根アプローチは両者のトレードオフを図り、それぞれの最悪の側面を回避しています。

アテステーションに報酬が付与される際、提案者はその報酬の一部を受け取ります。これは、提案者にメッセージを良く聞いて可能な限り多くを受け入れるよう動機付けるためです。

また、報酬は、オフラインの時間が長いバリデーターに対しても寛容に設計されています。オフラインが1%の時間しかない場合でも、報酬は約1.6%しか失われません。これは、分散化を促進するためです。分散化されたシステムの目標は、信頼できない部品から信頼できる全体を作り出すことですから、個々のノードが極端に信頼できるようにする必要はありません。

#### 非活性リーク

チェーンが $tsf > 4$ エポック ($tsf$ = "確定性なし時間") にわたって確定化に失敗した場合、最大報酬が0になるペナルティが加えられ、さらに $tsf$ に比例したペナルティ成分が追加されます (つまり、チェーンが確定化されていない期間が長いほど、オフラインのバリデーターに対する_エポックあたり_のペナルティが高くなります)。これにより、3分の1以上のバリデーターがオフラインになった場合、オフラインのバリデーターにはるかに重いペナルティが課され、合計ペナルティが時間とともに二次関数的に増加します。

これには3つの効果があります:

* 確定性が失われている際のオフラインペナルティを大幅に重くする
* 反相関ペナルティの目的に役立つ (下記参照)
* 3分の1以上がオフラインになった場合でも、最終的にはオンラインの割合が3分の2に回復するようにする

現在のパラメータ設定では、ブロックの確定化が停止した場合、バリデーターは2.6日後に1%、8.4日後に10%、21日後に50%の預金を失います。つまり、50%のバリデーターがオフラインになった場合、21日後にブロックの確定化が再開されます。

#### スラッシングと反相関ペナルティ

バリデーターがCasper FFGのスラッシング条件に違反した場合、同時期 (具体的には自身がスラッシングされる18日前から自身が出金される頃まで) にスラッシングされたバリデーターの割合の3倍に相当するデポジットの一部がペナルティとして課されます。これには以下のような目的があります:

* バリデーターが不正行為をするのは、多数のバリデーターと同時に行った場合にのみ本当に有害であるため、その場合により厳しくペナルティを課す
* 実際の攻撃には重大なペナルティを課すが、単独の誤りには軽微なペナルティしか課さない
* 小規模なバリデーターがより少ないリスクを負うようにする (通常の場合、大規模なバリデーターが自身と同時に失敗する唯一のものになるため)
* 最大のプールに誰もが参加するインセンティブを減らす

### BLS署名

BLS署名は、集約性に優れているため使用されています。メッセージ $M$ に対して鍵 $k_1$ と $k_2$ (対応する公開鍵 $K_1 = G * k_1$ と $K_2 = G * k_2$ ここで $G$ は楕円曲線のジェネレーター) で署名された $S_1$ と $S_2$ は、単純に楕円曲線の加算 $S_1 + S_2$ で集約できます。これにより、数千の署名を集約できるようになり、1つの署名の限界コストは1ビットのデータ (特定の公開鍵が集約署名に含まれていることを表す) と1つの楕円曲線加算の計算
だけです。

ただし、この形式のBLS署名は_ローグキー攻撃_に脆弱です。つまり、他のバリデーターが既に公開鍵 $K_1 ... K_n$ を公開していることを見つけた場合、秘密鍵 $r$ を生成し、公開鍵を $G * r - K_1 - ... - K_n$ とすることで、自分だけで集約公開鍵 $G * r$ に対する署名を作成できてしまいます。これを防ぐには、_所有証明_と呼ばれる仕組みが必要です。具体的には、公開鍵自体に依存するメッセージ (通常は署名されないもの) に対する署名を要求し、それが公開鍵自体で検証できるようにするというものです (つまり、秘密鍵 $k$ と公開鍵 $K$ に対して $sign(message=H'(K), key=k)$ を計算し、$H'$ はハッシュ関数)。

デポジットメッセージ (署名鍵に加えて、引き出し鍵などの重要なデータも指定する) の署名を所有証明として使用しています。

### なぜ32ETHのバリデーターサイズなのか

説明責任のある過失耐性を持つ (つまり、2つの矛盾するブロックが確定化された場合、責任のある3分の1のノードを特定できる) BFTコンセンサスアルゴリズムでは、すべてのバリデーターが参加する必要があり、さらに技術的な理由から、メッセージを確定化するには2ラウンドのバリデーター参加が必要です。

これにより、分散化 / 確定時間 / オーバーヘッドのトレードオフが生まれます。つまり、$n$をネットワーク内のバリデーター数、$f$をブロックの確定時間、$\omega$をメッセージ/秒のオーバーヘッドとすると、

$\omega \ge \frac{2 * n}{f}$

という関係があります。

例えば、オーバーヘッドを10メッセージ/秒以内に抑えたい場合、10,000ノードのネットワークでは確定時間が少なくとも2,000秒 (~33分) 以上必要になります。

Ethereumの場合、総ETH供給が $\approx 2^{27}$ ETHだと仮定すると、32ETHのデポジットサイズでは最大 $2^{22}$ バリデーターが存在します (しかも、すべてが検証する場合の最大値です。実際には、検証するETHは全体の約10分の1程度と見られます)。確定時間が2エポック (2 * 32 * 12 = 768秒) の場合、最大オーバーヘッドは $\frac{2^{22}}{768} \approx 5461$ メッセージ/秒になります。BLS集約により、各署名のマージナルサイズが1ビット、マージナル検証複雑度が1つの楕円曲線加算になるため、このようなハイオーバーヘッドでも許容できます。

32スロットは、別の理由でも最小限の安全な数値です。攻撃者が提案者選択に使用される乱数を操作した場合でも、この数値は各エポックに少なくとも1人の正直な提案者が存在することを保証します。これは、ブロックが確定し続けるために十分です。現在のオーバーヘッドレベルは許容可能ですが、それ以上になるとノードの運用が非常に困難になります。最後に、バリデーターのデポジットサイズは、シャード間リンクに理想的です。

### ランダムサンプリング

#### シード選択

ブロックごとに更新されるシードは、提案者が明らかにしなければならない値を「混ぜ合わせる」(つまり `seed <- xor(seed, new_data)`) ことで更新されます。バリデーターがデポジットした時点で、すべてのサブキーが決まっており、第三者はサブキーを計算できませんが、自発的に明らかにされたサブキーを検証できます (このメカニズムはときにRANDAOと呼ばれます)。

これにより、各提案者は「1ビットの操作」権を持っています。つまり、ブロックを作成するか作成しないかを選択できます。ブロックを作成しないのは高コストですが、多くの報酬を逸失するためです。さらに、永続的なコミティとビーコンコミティのサイズ (下記参照) が大きいため、乱数操作によって少数派の攻撃者が3分の2以上のコミティを得ることはほぼ不可能です。

将来的には、乱数シードのロバスト性をさらに高めるために、検証可能遅延関数 (VDF) を使用する予定です。

#### シャッフル

バリデーターセットをシャッフルし、各エポックの責任を割り当てるために、Viet Tung Hoang、Ben Morris、Phillip Rogawayが記述したスワップまたは非スワップシャッフルアルゴリズムを使用しています。このアルゴリズムにより以下が保証されます:

* シャッフルは置換なので、各バリデーターは各エポックで正確に1つのコミティのメンバーに割り当てられる (負荷が安定し、乱数操作の利益を得られる可能性を減らす)
* 順方向の点評価可能性により、バリデーターは自身の責任を O(1) 時間で特定できる
* 逆方向の点評価可能性により、特定のコミティのメンバーや特定のブロックの提案者を O(1) 時間で計算できる

#### スロットごとのシャッフル

1エポックには32スロットあり、各スロットのアテステーションを行うバリデーターはシャッフルによって選択されます。これにより、総持分の一部しか持たない攻撃者が特定のスロットを乗っ取り、短期的な再編を引き起こすことができないようになります。

#### ビーコンコミティ

各スロットのコミティはさらに複数の_ビーコンコミティ_に分割されます。現在 (2022年1月) では、これにより異なるサブセットのアテステーションを別々のサブネットでアグリゲートでき、P2Pネットワークをより効率的にすることができます。ただし、コンセンサスに関連する他の有用な役割は果たしていません。

元のシャーディング設計では、各ビーコンコミティが特定のシャードの検証を担当するつもりでした。しかし、単一提案者モデルに切り替えた場合、このアプローチは恐らく廃止されるでしょう。したがって、より細かいビーコンコミティは単に遺物として残っているだけで、アテステーション集約を容易にするために別の方法で再構成されるか、完全に削除される可能性があります。

#### 同期コミティ

約27時間に1回、512人のバリデーターで構成される同期コミティが選択され、ブロックに署名します。この委員会の公開鍵は簡単にアクセスできるリストに保存されるため、超軽量クライアントでも署名を簡単に検証できます。

### LMD GHOST フォークチョイスルール

ビーコンチェーンはLMD GHOST フォークチョイスルールを使用しています。

LMD GHOST フォークチョイスルールは、数百人のバリデーターからの情報を組み合わせるため、通常の場合、1つのブロックさえ巻き戻されることはほとんどありません。フォークチョイスがすべてのバリデーターに依存しているため、攻撃者が全体の50%近くを制御しない限り、ブロックを巻き戻すことはできません。乱数操作によって大きな利点を得ることもできません。

### 保管の証明ゲーム

各9日間の期間について、各バリデーターは秘密裏に「期間サブキー」を生成する能力を持っています。バリデーターの公開鍵は各期間のサブキーを一意に決定するため、一度デポジットすれば、自分のサブキーを選択する自由はありません。他者はバリデーター自身以外にそのサブキーを計算できませんが、バリデーターが自発的にサブキーを明らかにすれば、誰でも正しいことを検証できます (これはすべてBLSの魔法で行われ、将来的に量子安全性が必要になった場合はハッシュベースのコミットメントを使用できます)。

期間 $j$ のデータ $D$ とルート $R$ にサインする際、そのバリデーターの期間 $j$ の秘密 $s$ を使って、以下のようにビットフィールド $M$ を計算します:

* $D$ を512バイトのチャンク $D[0] ... D[n-1]$ に分割
* $M$ のi番目のビットを $M[i] = mix(s, D[i])$ に設定

これらの署名の一部として、`get_chunk_bits_root(M)` (これを**保管ビット**と呼びます) を含めます。`mix`と`get_chunk_bits_root`は両方とも1ビットを出力するハッシュ関数のようなものですが、マルチパーティ計算に適するよう設計されています。

クロスリンクに複数のブロック $B_1 ... B_n$ が含まれ、バリデーターが $c_1 ... c_n$ の保管ビットを計算した場合、バリデーターは $(B_i, c_i, i)$ のタプルすべてに署名し、それらを集約します。この非常に特殊な自己集約は、異なるバリデーターによって署名される異なるメッセージの数を $2n$ に制限し、検証に必要なペアリング演算の数を減らすために使用されます。

バリデーターが期間 $j$ のサブキーを期間 $j$ 中または以前に公開した場合、他のバリデーターはチェーン上でそのサブキーの知識証明を公開できます。これにより、そのバリデーターがペナルティを受けます。知識証明はどのバリデーターが作成したかも証明するため (これもまたBLSの魔法で行われ、量子安全性が必要な場合はSTARKsを使用できます)、ブロック提案者が「通報の報酬を盗もう」とするのを防ぎます。この仕組みの目的は、計算を外部委託することを危険にすることです。

バリデーターがサブキーを公開した後、他の人がそのバリデーターの作業を確認できます。署名したブロックで保管ビットが正しくないことを発見した場合、オンチェーンでこれに異議を唱え、そのバリデーターをスラッシングできます。一般的に、ランダムな推測 (または $D$ 全体を使わない任意の手順) では正解率は50%しかなく、ブロックごとに50%のスラッシングリスクがあります。

このメカニズムの目的は、[バリデーターのジレンマ](../assets/eip-2982/iacr-2015-702-Demystifying-Incentives-in-the-Consensus-Computer.pdf)問題を軽減することです。つまり、バリデーターには自分で検証せずにデータにただ乗っかるというインセンティブがあり、これが「コモンズの悲劇」につながる可能性があります。この方式では、検証していないデータにコミットしようとすると、$M$ を計算できないため、対話型の異議申し立てゲームに負けてしまいます。

### SSZ

SimpleSerializeスイートには以下のアルゴリズムが含まれています:

* シリアライゼーションアルゴリズム
* ハッシング アルゴリズム (「SSZツリーハッシュ」または「hash_tree_root」と呼ばれる)
* 一般化されたマーケルプルーフアルゴリズム (「SSZパーシャル」と呼ばれる)。複数の値のプルーフを扱え、マーケルツリーの姉妹ノードの重複を最適化できる。

シリアライゼーションアルゴリズムには以下の設計目標があります:

* 単純性 (例えば、RLPのように長さ/位置レコードサイズに応じて3つの節がある必要はない)
* 完全に固定サイズのオブジェクトの場合、単純な連結と等価であること
* コンセンサスレイヤーのシリアライゼーションアルゴリズムと、アプリケーションレイヤーのABIの両方で使用できること

SSZシリアライゼーション仕様は、Ethereum 1.0 ABIとよく似ていますが、主な違いは (i) 基本データ型が異なること、(ii) 32バイトの長さ/位置レコードサイズを4バイ
トのサイズに置き換えたことです。

ハッシングアルゴリズムには以下の設計目標があります:

* オブジェクトの更新時の効率的なハッシュ計算、特に非常に大きかつ複雑なオブジェクトで変更が比較的小さい場合
* 大規模または複雑なオブジェクトの特定のフィールドの値を証明する際の効率性 (検証の複雑さと証拠のサイズの両方)

これらの要件から、マーケルツリー構造が明らかな選択肢となります。

#### 一般化されたインデックス

一般化されたインデックスの説明は https://github.com/ethereum/eth2.0-specs/blob/dev/ssz/merkle-proofs.md を参照してください。これにより、整数やビットフィールドで表されるパスを使って、大規模または複雑なオブジェクトの任意の位置の値を非常に簡単に検証できるようになります。

### バリデーターのライフサイクル

#### デポジット

バリデーターはeth1チェーンのデポジットコントラクトの関数を呼び出すトランザクションを送信することでデポジットします (最終的には、eth2内からデポジットする方法も追加される予定です)。デポジットには以下が指定されます:

* メッセージに署名するために使用される秘密鍵に対応する公開鍵
* 引き出し時に使用される公開鍵のハッシュ (引き出し資格情報)
* デポジット額

これらの値はすべて署名鍵で署名されます。署名鍵と引き出し鍵を別にする目的は、より危険な引き出し鍵を安全に保管 (オフライン、ステーキングプールと共有しない、など) し、署名鍵を積極的な署名に使用できるようにすることです。

デポジットコントラクトは、これまでに行われたすべてのデポジットのマーケルルートを維持しています。マーケルルートにデポジットが含まれると、eth2ブロック提案者がマーケルプルーフを提出してデポジットプロセスを開始できます。

#### アクティベーション

バリデーターはすぐにバリデーターレジストリに参加しますが、最初は非アクティブです。バリデーターは $N \ge 4$ エポック後にアクティブになります。最小の4は、RANDAOが操作できないようにするためで、$N$ は4を超える可能性があります。バリデーターの総数が $|V|$ の場合、1エポックあたりの最大参加数は $max(4, \frac{|V|}{65536})$ です。それ以上のバリデーターが参加しようとすると、待機列に入れられ、可能な限り早く処理されます。

#### 退出

バリデーターが退出する (自発的な退出メッセージを公開するか、スラッシングされた場合)、同様に退出待機列に入れられ、同じ最大スループットで処理されます。

入退出待機列の制限の理由は、任意の2時点間でバリデーターセットが変化しすぎないようにすることです。これにより、バリデーターが十分な頻度 (約1-2か月に1回、$|V| \ge 262144$ の場合) でログオンしていれば、2つのチェーン間の確定性保証が維持されます。待機時間ではなく制限を使う理由については、[こちら](https://ethresear.ch/t/rate-limiting-entry-exits-not-withdrawals/4942)を、オフラインの期間に対する安全余裕の計算については[こちら](https://ethresear.ch/t/weak-subjectivity-under-the-exit-queue-model/5187)を参照してください。

#### 引き出し

バリデーターが退出待機列から出た後、約27時間の期間を経てから引き出しができるようになります。この期間には以下の機能があります:

* バリデーターが不正行為をした場合、その誤りを検出し、スラッシングできる期間を確保する
* 最後のシャード報酬を含めるための時間を確保する
* 保管の証明に対する異議申し立ての時間を確保する

バリデーターがスラッシングされた場合、さらに約36日の遅延が課されます。これにより、より大きなペナルティを課すことができ (悪意のあるバリデーターにとってはより大きな影響)、他のスラッシングされたバリデーターの数を計算する期間も確保できます。

第0フェーズでは、「引き出し済み」のバリデーターは実際に引き出せるようになっていません。唯一の違いは、バリデーターペナルティから保護され、責任を持たないことです。後続のフェーズでは、引き出し済みのバリデータースロットから実行環境に資金を移動する機能が追加される予定です。

#### 実効残高

ほとんどの計算は、バリデーターの「実効残高」に基づいて行われます。例外は、バリデーターの残高を増減させる計算です。バリデーターの残高 $B$ が $EB$ を下回るか、$EB + 1.5$ を上回る場合にのみ、$EB$ を $floor(B)$ に調整します。これは、実効残高の変更を最小限に抑え、エポックごとの状態再計算のハッシュ量を減らすためです。残高はすべて専用のベクトルに格納されているため、残高配列を再計算するには $2 * \frac{N * 8}{32} = \frac{N}{2}$ ハッシュが必要ですが、実効残高はバリデーターレコードオブジェクトに格納されているため、1バリデーターあたり少なくとも $5N$ ハッシュが必要です。さらに、$EB$ はCompactValidatorオブジェクトに1バイトで圧縮できます。

### フォークメカニズム

`Fork`データ構造には、(i)現在の「フォークID」、(ii)前のフォークID、(iii)スイッチオーバースロットが含まれています。現在の高さでのフォークIDは、すべてのメッセージの有効な署名に影響します。つまり、ある
フォークIDで署名されたメッセージは、別のフォークIDを使用する検証関数では無効になります。

フォークは、ある「フォークスロット」$n$でステート遷移を追加することで行われます。これにより、前のフォークIDが現在のフォークIDに、現在のフォークIDが新しい値に、スイッチオーバースロットが$n$に設定されます。署名検証関数は、メッセージが作成されたスロットのフォークIDを使用して検証します (例えば、遅延を経てインクルードされたアテステーションの場合、フォークスロット以前のフォークIDが使用される可能性があります)。

フォークに参加したくない場合、フォークスロットでフォークIDが変更されないチェーンを単に続行できます。2つのチェーンは並行して進行し、バリデーターは両方を検証できます。

## 下位互換性

このEIPは現在のEthereum メインネットに即時の変更を導入しませんが、eth2コンセンサスメカニズムの導入を通じて、将来の下位互換性のない変更への道筋を示しています。このメカニズムのセキュリティを確保するため、ユーザーはETHをビーコンチェーンに移動し、追加のETHが発行されます。このEIPは、このパスが正式なものであり、Ethereum メインネットの将来とロードマップを直接的に通知するコミットメントです。

## セキュリティ上の考慮事項

eth2は、PoWからPoSへのEthereum のコアコンセンサスの大幅な刷新です。この移行には固有のリスクがありますが、セキュリティとトレードオフを分析した研究文献が豊富にあります。_以下は、利用可能なリソースの中から選択したものです:_

* [Casper FFG](../assets/eip-2982/arxiv-1710.09437-Casper-the-Friendly-Finality-Gadget.pdf)
* [Combining GHOST and Casper](../assets/eip-2982/arxiv-2003.03052-Combining-GHOST-and-Casper.pdf)

この道筋を支持する研究に加えて、仕様、暗号、クライアント実装の監査と形式検証も多数行われています。_多くのクライアントおよびユーティリティライブラリの監査が現在進行中であり、完了次第ここに追加されます。_

## 著作権
著作権およびその関連権利は[CC0](../LICENSE.md)で放棄されています。