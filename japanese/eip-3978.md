---
original: 1bc3433e4517965842eb28f7adb3984a07e0df88320e49dde01b08256d7a4354
---

---
eip: 3978
title: ガス払い戻しによる巻き戻し
description: 巻き戻されたSSTORE/CREATE/SELFDESTRUCT/LOGX操作のガスを、ガス払い戻しメカニズムを介して再価格付けする
author: Anton Bukov (@k06a), Mikhail Melnik (@ZumZoom)
discussions-to: https://ethereum-magicians.org/t/eip-3978-gas-refunds-on-reverts/7071/
status: 停滞
type: Standards Track
category: Core
created: 2021-09-16
updated: 2022-02-14
requires: 2929
---

## 概要

巻き戻された状態変更操作について、アクセスコストは維持するが、変更コストは払い戻す。

## 動機

トランザクションまたはその副呼び出しを巻き戻すと、内部で発生した状態変更はすべて破棄されます。
しかし現在、ユーザーは永続化したかのようにこれらの変更に対してコストを支払っています。

[EIP-3298](./eip-3298.md)以降、ガス払い戻しメカニズムは同一トランザクション内の格納領域の復元にのみ機能します。しかし巻き戻しの際、ガス払い戻しは増加せず、完全に消去されてしまいます。
トランザクションの最後にトークンを転送する方が、巻き戻すよりも安くなる可能性があります。
これは変更されるべきです。

- 巻き戻されたSSTOREは、SLOADガス (100ガス) に再価格付けされるべきです
- 巻き戻されたLOG0、LOG1、LOG2、LOG3、LOG4は100ガスに再価格付けされるべきです
- 値付きのCAll (positive_value_cost = 9,000ガス) の巻き戻しは100ガスに再価格付けされるべきです
- 値付きのCREATE (value_to_empty_account_cost = 25,000ガス) の巻き戻しは100ガスに再価格付けされるべきです
- 巻き戻されたCREATE and CREATE2 (32,000ガス) は100ガスに再価格付けされるべきです
- 巻き戻されたSELFDESTRUCT (5,000ガスまたは25,000ガス) は100ガスに再価格付けされるべきです

さらに、返されたバイトコードが空でない場合にのみ、CREATE and CREATE2操作に32,000ガスの固定価格を課すのが公平だと思われます。

## 仕様
各呼び出しフレームについて、`revert_gas_refund`を追跡し、初期値は0とする。

`revert_gas_refund`を変更する操作は以下の通りです:
- SSTORE
- LOG0、LOG1、LOG2、LOG3、LOG4
- CALL
- CREATE、CREATE2
- SELFDESTRUCT

これらは以下のように`revert_gas_refund`を増加させます:
```javascript
call.revert_gas_refund += operation.gas - WARM_STORAGE_READ_COST
```

そして巻き戻しの場合は、単に`gas_refund`を消去するのではなく、この値を使用します:
```javascript
if (call.reverted) {
    // 既存の動作
    tx.gas_refund -= call.gas_refund;
    
    // EIP-3978に従って追加された新しい動作
    tx.gas_refund += call.revert_gas_refund;
}
```

## 根拠

ガスは使用コストを反映するべきです。
巻き戻しコストは実行中のアクセスコストを反映しますが、変更コストは反映していません。

## 下位互換性

既知の下位互換性の問題はありません。

## テストケース

TBD

## 参考実装

TBD

## セキュリティ上の考慮事項

TBD

## 著作権
著作権およびその関連権利は[CC0](../LICENSE.md)により放棄されています。