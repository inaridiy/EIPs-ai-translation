---
original: d1d25357676b461d8d64e6acddad747ad01a3b23b83f3306b8744f9426b043bf
---

---
eip: 4396
title: 時間認識ベースフィー計算
description: ブロックタイムをベースフィー計算に組み込み、ブロックではなく時間単位の安定したスループットを目指す。
author: Ansgar Dietrichs (@adietrichs)
discussions-to: https://ethereum-magicians.org/t/eip-4396-time-aware-base-fee-calculation/7363
status: 停滞
type: Standards Track
category: Core
created: 2021-10-28
---

## 概要
このEIPは、ベースフィー計算に時間を組み込むことで、ブロックではなく時間単位の安定したスループットを目指すことを提案しています。計算方法への変更は最小限に抑えており、ブロックガスターゲットを時間に比例して変更するのみです。このEIPは、Proof-of-WorkチェーンでもProof-of-Stakeチェーンでも適用できますが、Proof-of-Workの場合のセキュリティへの影響は未探索です。

## 動機

現在のベースフィー計算では、ブロックのガス使用量を信号として使用し、ブロック空間の需要が低すぎる場合はベースフィーを下げ、需要が高すぎる場合はベースフィーを上げるようにしています。この信号の選択は単純ですが、欠点もあります。それは、ブロック時間を考慮していないことです。需要が比較的一定であると仮定すると、20秒後にブロックを提案するプロポーザーは、10秒後にブロックを提案するプロポーザーの2倍のガスを持つトランザクションを利用できます。両者に同じガスターゲットを使うのは最適ではありません。実際には、この不適切な信号には以下のような好ましくない結果がありました:

### Proof-of-Workでのベースフィー変動

Proof-of-Work (PoW)では、ブロック時間はランダムであり、ブロック時間のばらつきが大きくなります。このばらつきがベースフィーの変動に寄与し、需要が完全に安定していても、ベースフィーは均衡値の周りで振動することが予想されます。

### スロットの欠落

Proof-of-Stake (PoS)では、ブロック時間は理想的に一定(常に12秒)ですが、スロットの欠落により、個々のブロックでブロック時間が増加する(24秒、36秒、...)ことがあります。このようなスロットの欠落により、次のブロックが過剰になり、現在の更新ルールでは需要のスパイクを示すことになり、小さな不要なベースフィーのスパイクが発生します。

さらに重要なのは、これらのスロットの欠落が、実行チェーンの全体的なスループットを1ブロックのガスターゲット分だけ直接的に減少させることです。次のブロックには「遅延」したトランザクションが含まれることが期待されますが、その結果のベースフィーのスパイクにより、いくつかの空きブロックが発生します。結局のところ、欠落したスロットのブロック空間がチェーンに失われてしまいます。

これは特に問題となるのは、ブロックプロポーザーに対する拒否サービス (DoS) 攻撃がスロットの欠落を引き起こし、全体的なチェーンのパフォーマンスを損なうからです。

### コンセンサスの問題によるスループットの劣化

個々のスロットの欠落よりも深刻な状況は、コンセンサスの問題により、多数のブロックプロポーザーが継続してブロックを作成できなくなる場合です。これは、ブロックプロポーザーがフォークオフしてそれぞれ自分のフォークでブロックを作成したり、他の理由で現在のチェーンヘッドに追いつけなかったり、単に有効なブロックを作成できなくなったりする場合などが考えられます。

これらのすべての状況で、平均ブロック時間が大幅に増加し、その分チェーンのスループットが低下します。この影響はPoWでも既に存在しますが、難易度調整による自己修復メカニズムが比較的迅速に機能するため、通常のブロック時間に戻ります。一方、PoSでは自動的な自己修復メカニズムが極端に遅い可能性があります。スロットの3分の1以上が欠落した場合、数か月かかる可能性があり、3分の1以上が欠落した場合でも数週間かかる可能性があります。

これらの理由から、ブロック時間を考慮してベースフィー計算を行い、時間単位の安定したスループットを目指すことが望ましいと考えられます。

マージフォークに含まれる可能性を最大限高めるため、この EIP では変更を最小限に抑えており、より複雑な変更については考察セクションで議論しています。

## 仕様
[EIP-1559](./eip-1559.md)のプソードコード言語を使って、更新されたベースフィー計算は以下のようになります:

```python
...

BASE_FEE_MAX_CHANGE_DENOMINATOR = 8
BLOCK_TIME_TARGET = 12
MAX_GAS_TARGET_PERCENT = 95

class World(ABC):
    def validate_block(self, block: Block) -> None:
        parent_gas_limit = self.parent(block).gas_limit
        parent_block_time = self.parent(block).timestamp - self.parent(self.parent(block)).timestamp
        parent_base_gas_target = parent_gas_limit // ELASTICITY_MULTIPLIER
        parent_adjusted_gas_target = min(parent_base_gas_target * parent_block_time // BLOCK_TIME_TARGET, parent_gas_limit * MAX_GAS_TARGET_PERCENT // 100)
        parent_base_fee_per_gas = self.parent(block).base_fee_per_gas
        parent_gas_used = self.parent(block).gas_used

        ...

        if parent_gas_used == parent_adjusted_gas_target:
            expected_base_fee_per_gas = parent_base_fee_per_gas
        elif parent_gas_used > parent_adjusted_gas_target:
            gas_used_delta = parent_gas_used - parent_adjusted_gas_target
            base_fee_per_gas_delta = max(parent_base_fee_per_gas * gas_used_delta // parent_base_gas_target // BASE_FEE_MAX_CHANGE_DENOMINATOR, 1)
            expected_base_fee_per_gas = parent_base_fee_per_gas + base_fee_per_gas_delta
        else:
            gas_used_delta = parent_adjusted_gas_target - parent_gas_used
            base_fee_per_gas_delta = parent_base_fee_per_gas * gas_used_delta // parent_base_gas_target // BASE_FEE_MAX_CHANGE_DENOMINATOR
            expected_base_fee_per_gas = parent_base_fee_per_gas - base_fee_per_gas_delta
        
        ...

    ...
```

## 考察

### メカニズム

提案された新しいベースフィー計算では、ブロック時間に応じてブロックガスターゲットを調整するのみです。ただし、全体のブロックガス制限の最大割合までに制限されます:

#### 現在のベースフィー計算

![](../assets/eip-4396/old_formula.png)

#### 提案されるベースフィー計算

![](../assets/eip-4396/new_formula.png)

この新しい計算では、ブロックではなく時間単位の安定したスループットを目指します。

### 制限事項

PoSでは、ブロック時間の増加は常に完全なブロックの倍数で発生します(例えば、1つのスロットの欠落 = 12秒ではなく24秒のブロック時間)。これを考慮するには、単一のスロットの欠落でも既にブロックガスターゲットを2倍にする必要があります。しかし、現在のブロック弾力性が2に設定されているため、このターゲットはブロックガス制限と等しくなります。ターゲットがガス制限以上になるのは好ましくありません。なぜなら、それ以上のターゲットを達成することができず、ベースフィーはスロットの欠落後常に減少するためです。

そのため、`MAX_GAS_TARGET_PERCENT`パラメーターを導入し、ターゲットをガス制限の最大95%に制限しています。この理由は2つあります:

- 信号の意味を保つこと: ターゲットがガス制限以上だと、それ以上のガス使用量を検知できず、ベースフィーを下げる以外の選択肢がなくなります。
- 本当の需要の増加にもベースフィーが反応できるようにすること: 多くのブロックプロポーザーがオフラインになり(したがって多くのスロットが欠落した)場合でも、本当の需要の増加がベースフィーの上昇につながるようにする必要があります。そうしないと、最終的には第一価格オークションに退行してしまいます。

しかし、これは単一のスロットの欠落でさえ完全に補償できないことを意味します。さらに、2つ目以降の連続するスロットの欠落は全く補償できません。なぜなら、ガスターゲットはすでに最大値に達しているためです。オフラインのバリデーターの割合が増えるほど、この影響が顕著になります:

![](../assets/eip-4396/degradation.png)

このように、このEIPはオフラインのバリデーターの場合のネットワークスループットの堅牢性を高めますが、完全ではありません。さらに、`MAX_GAS_TARGET_PERCENT`パラメーターによるトレードオフがあり、この値を高くすると堅牢性は高くなりますが、頻繁にスロットが欠落する場合のベースフィー調整メカニズムが損なわれます。

### 可能な拡張

これらの制限は、マージに含まれる可能性を最大限高めるという設計目標から直接的に生じています。オフラインのバリデーターをより効果的に処理するには、さらに大きな変更が必要ですが、自然な拡張方法があります:

#### 永続的なマルチスロットバッファ

複数の連続したスロットの欠落を補償できるよう、ガスバッファを導入することができます。これにより、ブロック弾力性を超えるガスを将来のブロックに繰り越すことができます。長期的なバッファの蓄積を避けるため、バッファにキャップを設けます。比較的小さなバッファキャップでも、スループートの堅牢性は大幅に向上します:

![](../assets/eip-4396/degradation_buffers.png)

弾力性が2のままでは、オフラインのブロックプロポーザーが50%を超えると最終的に機能が破綻してしまいます。

この手法の主な実装の複雑さは、バッファという新しい永続フィールドを導入することです。ヘッダーのみでベースフィーを計算できるようにするには、バッファをブロックヘッダーに追加する必要があります。

#### ブロック弾力性の増加

バッファの導入に加えて、ブロック弾力性を高めることも堅牢性を高める手段の1つです。以下の図は、弾力性レベルの違いによる影響を示しています(バッファの有無も含む):

![](../assets/eip-4396/degradation_elasticity.png)

こちらでも明確な改善効果が見られます。

ここでの主な追加の複雑さは、複数の連続した過剰なブロックによる最大負荷(ネットワーク、計算、ディスクアクセス)の増加です。ただし、PoSでは最小ブロック時間が12秒であるため、PoWに比べて最悪のケースのピーク負荷は大幅に軽減されます。

## 下位互換性

このEIPは下位互換性への影響は最小限で、既存のベースフィー計算ツールの更新のみが必要です。

## テストケース
tbd

## 参考実装
tbd

## セキュリティ上の考慮事項

### タイムスタンプ操作

PoWでは、マイナーがブロックのタイムスタンプフィールドを制御できます。有効なタイムスタンプに対する制限はいくつかありますが、タイムスタンプ操作の影響は複雑であり、このEIPについては未探索のままです。

PoSでは、各スロットに[固定のタイムスタンプが割り当てられている](https://github.com/ethereum/consensus-specs/blob/v1.1.3/specs/merge/beacon-chain.md#process_execution_payload)ため、ブロックプロポーザーによるタイムスタンプ操作は不可能です。

### ベースフィーの上昇の抑制
考察で述べたように、多くのブロックプロポーザーがオフラインの際に `MAX_GAS_TARGET_PERCENT` の値が高いと、本当の需要の増加によるベースフィーの上昇に対する信号スペースが小さくなります。これにより、ベース
フィーの上昇を抑制するコストが低下し、代わりに第一価格優先手数料オークションに退行させる誘因が高まります。

EIP-1559のベースフィー抑制に関する誘因非整合性の議論はここでも当てはまりますが、この個人的に合理的でない行動のコストが低下するため、心理的要因が優先される可能性が高くなります。

そのような場合でも、システムの劣化は優雅なものになります。ベースフィーの焼却が一時的に停止されるだけです。欠落していたブロックプロポーザーが再び参加すれば、システムは通常のEIP-1559の均衡状態に戻ります。

## 著作権
著作権およびそれに関連する権利は[CC0](../LICENSE.md)で放棄されています。