---
original: c4d74510c645c13d8f3daace25f3bfa061e5f906bd088d14faf735327b6a4a0b
---

---
eip: 5656
title: MCOPY - メモリコピー命令
description: メモリ領域をコピーするための効率的なEVM命令
author: Alex Beregszaszi (@axic)、Paul Dworzanski (@poemm)、Jared Wasinger (@jwasinger)、Casey Detrio (@cdetrio)、Pawel Bylica (@chfast)、Charles Cooper (@charles-cooper)
discussions-to: https://ethereum-magicians.org/t/eip-5656-mcopy-instruction/10890
status: 最終
type: Standards Track
category: Core
created: 2021-02-01
---

## 概要

メモリ領域をコピーするための効率的なEVM命令を提供する。

## 動機

メモリコピーは基本的な操作ですが、EVMで実装するには過剰なオーバーヘッドがかかります。

これは早期に認識され、「identity」プリコンパイルの導入によって軽減されました。これは`CALL`の入力メモリオフセットと出力メモリオフセットを使ってメモリコピーを行います。そのコストは`15 + 3 * (length / 32)` gas、さらにCALLのオーバーヘッドがかかります。[EIP-2929](./eip-2929.md)によって`CALL`のコストが700から100に下がったため、identity プリコンパイルがやや経済的になりました。

正確な単語のコピーは`<offset> MLOAD <offset> MSTORE`または`<offset> DUP1 MLOAD DUP2 MSTORE`で行えますが、これは単語あたり少なくとも12 gasかかります。オフセットが事前に分かっていて、コピーを展開できる場合は比較的効率的です。オフセットが実行時に任意の場合、制御フローのオーバーヘッドに加えて、オフセットを`32 ADD`で増やす必要があり、単語あたり少なくとも6 gasかかります。

正確でない単語のコピーはより複雑で、最後の部分単語の場合、ソースとデスティネーションの両方をロード、マスク、OR、ストアする必要があり、オーバーヘッドが大きくなります。ただし、最後の「部分単語」が1バイトの場合は、`MSTORE8`を使って効率的にストアできます。

例として、256バイトをコピーする場合:

- EIP-2929 前は identity プリコンパイルを使って少なくとも757 gasかかります
- EIP-2929 後は identity プリコンパイルを使って少なくとも157 gasかかります
- `MLOAD`/`MSTORE`命令を展開して少なくとも96 gasかかります
- このEIPを使って27 gasで済みます

ブロック10537502から10538702の分析によると、メモリコピーの約10.5%が`MCOPY`命令の利用により性能向上すると見られます。

メモリコピーは Solidity や Vyper などの言語で使われており、このEIPによって効率的なデータ構造の構築、メモリオブジェクトのスライスアクセスやコピーが可能になると期待されます。`MCOPY`命令を持つことで、`CALL`命令の将来的なガスコスト変更に対する前方保護も得られます。

`MCOPY`命令を持つことで、静的解析ツールや最適化ツールの仕事が容易になります。一般的な`CALL`の影響を制限する必要がなくなり、`MCOPY`命令はメモリ効果のみを持つことが分かるためです。プリコンパイルの特別ケースが追加されても、将来のハードフォークで`CALL`の影響が変わる可能性があり、identity プリコンパイルを使うコードの解析は特定のブロック範囲でしか有効ではありません。

最後に、メモリコピーは EVM384 などの計算量の多い操作に非常に有用であり、そこでの大きなオーバーヘッドとして識別されています。

## 仕様

`MCOPY`命令が`0x5E`で導入されます。

### スタックの入力

| スタック | 値 |
|-------|-------|
| 上から0番目 | `dst` |
| 上から1番目 | `src` |
| 上から2番目 | `length` |

この順序は`CALLDATACOPY`、`RETURNDATACOPY`などの他のコピー命令と一致しています。

### ガスコスト

イエローペーパーの用語では、`W_copy`グループの命令の一部と見なされ、イエローペーパーの`W_copy`のガス計算に従います。イエローペーパーの計算が最終的な決まりとされますが、現時点での参考として、以下のようになります:

```
words_copied = (length + 31) // 32
g_verylow    = 3
g_copy       = 3 * words_copied + memory_expansion_cost
gas_cost     = g_verylow + g_copy
```

### スタックの出力

この命令はスタック項目を返しません。

### 意味論

`length`バイトを`src`のオフセットから`dst`のオフセットにメモリにコピーします。
中間バッファを使用するかのようにコピーが行われるため、宛先とソースが重複していても問題ありません。

`length > 0`かつ(`src + length`または`dst + length`)が現在のメモリ長を超える場合、メモリが拡張され、それに応じたガスコストが適用されます。

この命令のガスコストは他の`Wcopy`命令と同様で、`Gverylow + Gcopy * ceil(length / 32)`です。

## 根拠

正確な単語のメモリコピーと部分単語のメモリコピーの実装例は、Solidity、Vyper、Feコンパイラにあります。

[EIP-2929](./eip-2929.md)により、identity プリコンパイルを使うときのCALLオーバーヘッドが700から100 gasに減りました。しかし、これでもプリコンパイルを合理的な代替手段にするには十分ではありません。

## 下位互換性

このEIPは新しい命令を導入するものです。既に展開されたコントラクトがこの命令を使っている場合、このEIPの後に動作が変わる可能性があります。

## テストケース

`MCOPY 0 32 32` - オフセット32から32バイトをオフセット0にコピーする。

事前:

```
0000000000000000000000000000000000000000000000000000000000000000 000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f
```

事後:

```
000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f 000102030405060708090a0b0c0d0e0f101112131415161718191a1b1c1d1e1f
```

使用ガス: 6

`MCOPY 0 0 32` - オフセット0から32バイトをオフセット0にコピーする。

事前:

```
0101010101010101010101010101010101010101010101010101010101010101
```

事後:

```
0101010101010101010101010101010101010101010101010101010101010101
```

使用ガス: 6

`MCOPY 0 1 8` - オフセット1から8バイトをオフセット0にコピーする(重複あり)。

事前(8バイト目にスペース):

```
0001020304050607 080000000000000000000000000000000000000000000000
```

事後:

```
0102030405060708 080000000000000000000000000000000000000000000000
```

使用ガス: 6

`MCOPY 1 0 8` - オフセット0から8バイトをオフセット1にコピーする(重複あり)。

事前(8バイト目にスペース):

```
0001020304050607 080000000000000000000000000000000000000000000000
```

事後:

```
0000010203040506 070000000000000000000000000000000000000000000000
```

使用ガス: 6

### 完全なテストスイート

完全なテストスイートは実行仕様テストにあります: [MCOPYスイート](https://github.com/ethereum/execution-spec-tests/tree/c0065176a79f89d93f4c326186fc257ec5b8d5f1/tests/cancun/eip5656_mcopy)。

## セキュリティ上の考慮事項

クライアントは、中間バッファを使わない実装を取るよう注意する必要があります(Cのstdlib関数`memmove`がこれに該当します)。これはサービス拒否(DoS)の攻撃ベクターになる可能性があります。ほとんどの言語の組み込み関数/標準ライブラリ関数は、ここでの適切なパフォーマンス特性を持っています。

これ以外は、メモリに触れる他の命令と同様に、サービス拒否(DoS)やメモリ枯渇攻撃の分析が適用されます。メモリ拡張はすべて同じ価格付けルールに従います。

## 著作権

著作権およびそれに関連する権利は[CC0](../LICENSE.md)で放棄されています。