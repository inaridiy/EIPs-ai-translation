---
original: 40f6eaf431a135e6a5f3902a9ea9a1f87991f0b86b1d9b9eb2886c9df5447fa6
---

---
eip: 7039
title: ウォレットのスキームハンドラー検出オプション
description: ウェブページとウォレット間の接続を開始するためのカスタムプロトコルハンドラーの使用。
author: Sam Wilson (@SamWilsn)
discussions-to: https://ethereum-magicians.org/t/shadow-a-scheme-handler-discovery-option-for-wallets/14330
status: Draft
type: Standards Track
category: Interface
created: 2023-05-15
requires: 1193
---

## 概要

この提案(愛称SHADOW)は、特別な権限を必要としないウェブブラウザでのウォレット検出の[EIP-1193](./eip-1193.md)の代替案です。ウォレットへの接続を開こうとするウェブページは、よく知られたスキームを指すiframeタグを挿入します。ページとウォレット間の通信には`postMessage`APIを使用します。

## 動機

現在のウォレット検出方法(例えば`window.ethereum`)は、一度に1つのアクティブなウォレットしかサポートしておらず、ウェブページを変更するための広範な権限を要求するブラウザ拡張機能を必要とします。

理想的には、ユーザーが複数のウォレットをアクティブにし、実行時に選択できるようにすべきです。これにより、ユーザーがブラウザ拡張機能を1つしか同時にインストールできなくなるという障壁が減るため、ユーザーエクスペリエンスが向上します。

SHADOWでは、他の最近の提案とは異なり、ブラウザ拡張機能に`content_scripts`や`permissions`は必要ありません。さらに、ウェブページ(ブラウザ拡張機能だけでなく)がプロトコルのハンドラーを登録できるため、純粋なウェブウォレット、ネイティブ実行可能ウォレット、ハードウェアウォレットなどのより良いサポートが可能になります。ウォレットがページを安全に提供できれば、ハンドラーとして登録できます。

## 仕様

この文書の「MUST」、「MUST NOT」、「REQUIRED」、「SHALL」、「SHALL NOT」、「SHOULD」、「SHOULD NOT」、「RECOMMENDED」、「NOT RECOMMENDED」、「MAY」、「OPTIONAL」というキーワードは、RFC 2119およびRFC 8174に記載されているように解釈されるものとします。

### 接続の開始

プロバイダへの接続を開始するには、ウェブページは以下を行う必要があります:

1. `window`に`"message"`イベントのイベントリスナーを追加する(または`window.onmessage`を設定する)。
2. `src`属性値が`web+evm://`のiframeタグを作成する。
3. iframeをDOMに追加する。
4. `source`が`iframe`の`contentWindow`と等しい`"message"`イベントを待つ。
5. さらなる通信に使用する最初のポートをイベントから保存する。これを「プライマリポート」と呼びます。

ステップ4で受信したイベントには、プロバイダに関する追加情報が含まれる場合があります。存在する場合、イベントデータは以下のTypeScriptインターフェイスを満たすものとします:

```typescript
interface ProviderInfo {
    name: string;
    icon: string;
}
```

ここで:

 - **`name`**はプロバイダの人間可読名称です。
 - **`icon`**は画像を指すURIです。[アイコン画像](#アイコン画像)を参照してください。

### 確立された接続での通信

ウェブページとウォレットは互いに要求を行うことができます。要求を行う側を「要求者」、応答する側を「応答者」と呼びます。

要求者は、プライマリポートを使ってメッセージ(`postMessage`を使用)を送信することで、応答者に要求を行うことができます。メッセージには、応答を受け取るための`MessagePort`を最初の転送アイテムとして含めることができます。このポートを「返信ポート」と呼びます。メッセージのデータは[EIP-1193](./eip-1193.md)の`RequestArguments`インターフェイスを満たし、そこで説明されているように解釈されるものとします。

応答者は、返信ポートが転送された場合、返信ポートにメッセージを1つ投稿することで応答します。メッセージのデータは以下のTypeScriptインターフェイスを満たすものとします。ここで`ProviderRpcError`はEIP-1193で定義されています:

```typescript
interface Response {
    result?: unknown;
    error?: ProviderRpcError;
}
```

`result`と`error`のいずれか1つのみが存在するものとします。

存在する場合、`result`は名前付きのJSON-RPCメソッドの応答の`result`フィールドと等価であるものとします。

エラーオブジェクトは、EIP-1193で推奨されている事項に従うべきです。

返信ポートが転送されていない要求は、応答が送られるはずだった場合でも、エラーとは見なされません。

### アイコン画像

<!-- TODO -->

## 根拠

SHADOWでは、`iframe.contentWindow`のメッセージポートを直接使うのではなく、最初のメッセージでメッセージポートを転送します。これにより、`iframe`が特定のシナリオでは通信を完全に引き継ぐことができ、ウェブページとプロバイダが`iframe`を介さずに直接通信できるようになります。

## 下位互換性

EIP-1193との下位互換性はありませんが、この提案は非常に似たデータ構造を使用しているため、移行は可能な限り簡単になります。

この提案を使ってEIP-1193互換のプロバイダを実装することができます:

<!-- TODO: Show example of implementing EIP-1193 provider on top of this proposal. -->

## セキュリティ上の考慮事項

<!-- TODO: Needs more discussion. -->

プロバイダとウェブページの両方が、メッセージの発信元を検証する必要があります。

## 著作権

著作権およびそれに関連する権利は[CC0](../LICENSE.md)で放棄されています。