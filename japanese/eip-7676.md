---
original: f93008f9163f83ea18563578c0159e37a2dc4eb0c92ae2ea54f16114b7654e21
---

---
eip: 7676
title: EOF - アドレス空間拡張の準備
description: アドレスがトリミングされずに実行されるように、EOF オペコードを更新する
author: Danno Ferrin (@shemnon)
discussions-to: https://ethereum-magicians.org/t/eof-prepare-for-address-space-extension/19537
status: Draft
type: Standards Track
category: Core
created: 2024-04-03
requires: 3540, 3670, 7069
---

## 概要

Legacy EVM のオペレーションでは、アドレスオペランドの上位 12 バイトがトリミングされてから評価されます。このEIPでは、EOF 内のそれらのオペコードの処理を変更し、トリミングが行われず、上位 12 バイトがゼロでない場合は例外的な停止が発生するようにします。

## 動機

Ethereum アドレスを 160 ビットから 256 ビットに拡張する提案がありました(例えば、Ethereum Magicians フォーラムの "Increasing the address size from 20 to 32 bytes" トピック)。しかし、EVM オペコードがアドレスを受け取る際に下位 20 バイトしか使用しないため、この提案は頓挫しました。EVM リファレンステストの 'stBadOpcode/invalidAddr.json' テストでは、このアドレスマスキング動作が確認されています。

EVM オブジェクトフォーマット(EOF)は、この問題を下位互換性を維持したまま解決する機会を提供します。

ほとんどの作業はすでに行われています。`EXTCODESIZE`、`EXTCODECOPY`、`EXTCODEHASH`、`CALLCODE`、`SELFDESTRUCT` の 5 つのオペレーションは既に EOF から禁止されています。`CALL`、`DELEGATECALL`、`STATICCALL` の 3 つのコールオペレーションは [EIP-7069](./eip-7069.md) で改訂されています。残るのは `BALANCE` オペレーションのみです。

将来のアドレス空間拡張の仕様化に合わせて、例外的な停止動作が変更されることが期待されます。

## 仕様

新しいインストラクション `EXTBALANCE` (`tbd`) を導入します。引数は `(target_address)` で、戻り値は `balance` です。

`EXTBALANCE` はスタックからアドレスを1つポップし、そのアカウントまたはコントラクトの残高をスタックにプッシュします。

`EXTBALANCE` を呼び出す際に、`target_address` の上位 12 バイトのいずれかが非ゼロの場合、例外的な停止が発生します。失敗した場合、現在のフレームのすべてのガスが消費されますが、ガススケジュールの変更は必要ありません。

`EXTBALANCE` のガストは、[EIP-2929](./eip-2929.md) で指定された `BALANCE` オペレーションのガスコストに従って課金されます。つまり、アカウントが `accessed_addresses` にない場合は 2600 ガスが課金され、`accessed_addresses` に追加されます。アカウントが `accessed_addresses` にある場合は 100 ガスが課金されます。`accessed_addresses` は [EIP-2929](./eip-2929.md) で説明されているすべてのオペランドで共有されます。

また、`EXTCALL`、`EXTDELEGATECALL`、`EXTSTATICCALL` オペレーションでは、メモリ拡張チェックの直前に新しいステップが追加されます。`target_address` の上位 96 ビットのいずれかが設定されている場合は、例外的な失敗で停止します。

将来の EIP で、例外的な停止を引き起こさない方法で動作が変更されることが予想されます。コントラクト実装者は、例外的な停止に依存しないでください。

## 根拠

### 新しいオペコード

`BALANCE` オペコードを禁止する必要はありません。EOF コンテナ内では問題を引き起こしません。新しいオペコードを追加することで、既存のオペコードが EOF とレガシーコードで同じ動作をするため、エンドユーザーの混乱やバグの発生を減らすことができます。

### 無効なアドレスでの巻き戻し

無効なアカウントの扱いには2つの代替案がありました。仕様では例外的な停止を呼び出しますが、代替案は「空のアカウント」として扱うことでした。「空のアカウント」アプローチが却下された理由は2つあります:

- 無効なアドレスにアクセスする場合、`accessed_addresses` リストが 256 ビットアカウントを追跡する必要があります。
- `EXTCALL` 系列のインストラクションでは、そのようなアドレスにバランスを送信できるため、アクセスできないバランスがメルクルツリーに反映される必要があります。

### ガスコストの変更なし

`BALANCE` オペレーションは既に `accessed_addresses` をチェックする必要があるため、オペレーションを処理するための相当な量の処理が必要です。したがって、濫用を防ぐためにガススケジュールを変更する必要はありません。そのような増分コストは、無効なアカウントに対するリバートやアドレスチェックに関連するコストに比べて支配的になるでしょう。

## 下位互換性

アドレス空間拡張の準備は明示的に EOF の範囲内で行われるため、古いコントラクトに変更を加える必要はありませんが、古いコントラクトは拡張されたアドレス空間を使用できない可能性があります。

新しいオペレーションにアドレスオペランドやパラメーターを追加する際は、今後の EIP の作成者は EOF およびレガシーコントラクトとの相互作用に注意を払う必要があります。そのような追加は、このEIPと調和するようにする必要があります。

## テストケース

標準リファレンステストの `invalidAddr.json` テストと同様のテストケースを、EOF テストに書く必要があります。ただし、それらはインバリッドアドレスでの停止をチェックするものです。

## 参考実装

TBD <!-- TODO -->

## セキュリティ上の考慮事項

このEIPは、以前トリミングされたアドレスに対する巻き戻し動作のみを定義しています。コンパイラは、呼び出しデータから来るアドレスをマスクする必要があることを認識する必要があります。これは既存の Solidity ABI 標準にも一部存在しますが、`EXTBALANCE` の周りのフローや `EXTCALL` オペレーションのコードを慎重に調べ、コンパイルされたコードが上位バイトをトリミングするようにする必要があります。

## 著作権

著作権およびそれに関連する権利は [CC0](../LICENSE.md) で放棄されています。