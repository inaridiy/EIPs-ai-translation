---
original: ba967f7874c3a1425eca787acf28198a4567ec7e41e36b51804a5751dbaa6238
---

---
eip: 3155
title: EVM トレース仕様
author: Martin Holst Swende (@holiman), Marius van der Wijden (@MariusVanDerWijden)
discussions-to: https://ethereum-magicians.org/t/eip-3155-create-evm-trace-specification/5007
status: 停滞
type: Standards Track
category: Interface
created: 2020-12-07
---


## 簡単な要約
EVM (Ethereum Virtual Machine) の実行中のステートテストのための新しいJSONスタンダードを導入する。

## 動機
Ethereumバーチャルマシンは、Ethereumのすべてのスマートコントラクトコードを実行します。
スマートコントラクトとステートテストをデバッグするために、EVMの実行ステップをログに記録する共通フォーマットが導入されました。
このフォーマットはgo-ethereum、parity、nethermindおよびBesuによって実装されています。
共通フォーマットが十分に定義されていなかったため、実装が若干異なり、適切なツールの開発が困難になり、トレースの有用性が大幅に低下していました。

このEIPには以下の目的があります:
- 仕様をより目立つ場所に移動して、新しいクライアントの実装を奨励する
- 以前のバージョンで対処されていなかったコーナーケースを厳密に定義する
- 実行中に新しいフィールドが導入された場合の仕様の更新を可能にする
- サンプル出力を提供する

このEIPをすべての主要なクライアントに実装することで、メインネットおよびすべての今後のハードフォークに対するEVM実装を比較するための意味のある差分ファジングを作成できます。
また、チェーンスプリットの場合に実行の違いを迅速に見つけるのにも役立ちます。

このEIPにより、ユーザーは主要なEthereum クライアントのEVM実装を相互に比較するための優れた差分ファジングインフラストラクチャを作成できるようになります。
これにより、現在クライアントの実装に存在するバグを見つけることができます。

## 仕様
クライアントは、単純なトランザクションやコードを実行し、トレースを返すことができなければなりません。以下では、これをCUT (テスト対象クライアント) と呼び、go-ethereumの `evm` バイナリを使用してコード例を示します。

### データ型

| 型  | 説明  | 例 |
|---|---|---|
| 数値 | 単純なJSONの数値 | "pc":0 |
| 16進数 | 16進数でエンコードされた数値 | "gas":"0x2540be400" |
| 文字列 | 単純な文字列 | "opName":"PUSH1" |
| 16進数文字列 | 16進数でエンコードされた文字列 |  |
| x の配列 | xでエンコードされた値の配列 |  |
| キー値 | 16進数文字列でエンコードされたキーと値の構造体 |  |
| ブール値 | JSONのブール値は true または false | "pass": true |

### 出力

CUTは、各操作について `json` オブジェクトを出力しなければなりません。

必須フィールド:

| 名前  | 型  | 説明  |
|---|---|---|
| `pc`  | 数値  | プログラムカウンター  |
| `op`  | 数値  | オペコード  |
| `gas` | 16進数  | この操作を実行する前の残りガス  |
| `gasCost` | 16進数  |  この操作のガスコスト |
| `stack`  | 16進数の配列  | スタック上のすべての値の配列  |
|  `depth` | 数値  | コールスタックの深さ  |
| `returnData`  | 16進数文字列  | 関数呼び出しによって返されたデータ  |
| `refund`  | 16進数  | **グローバル**ガス払い戻し額  |
| `memSize`  | 数値  | メモリ配列のサイズ  |

オプションのフィールド:

| 名前  | 型  | 説明  |
|---|---|---|
| `opName` | 文字列  | 操作の名前  |
| `error`  | 16進数文字列  | エラーの説明 (サポートされている場合はrevert理由を含む)  |
| `memory` | 16進数文字列の配列  | 割り当てられたすべての値の配列  |
| `storage` |  キー値 |  格納されたすべての値の配列 |
| `returnStack`  | 16進数の配列  | 呼び出された関数のスタックの値の配列  |

*例:* 
```
{"pc":0,"op":96,"gas":"0x2540be400","gasCost":"0x3","memory":"0x","memSize":0,"stack":[],"depth":1,"error":null,"opName":"PUSH1"}
```

`stack`、`memory`、`memSize`は、オペレーションの実行前の値です。
すべての配列属性(`stack`、`returnStack`、`memory`)は、null ではなく空の配列("stack":[],)で初期化する必要があります。
CUTが `memory` または `storage` の値を出力しない場合、`memory` および `storage` フィールドは省略されます。
これは、CUTがこれらのフィールドのトレースをサポートしていないか、トレースしないように構成されている場合に発生する可能性があります。
`memSize` フィールドは、`memory` サポートの有無にかかわらず存在する必要があります。
クライアントは、ステートルートにすべてのストレージの更新が含まれているため、ストレージの記録を無効にする方法を実装する必要があります。
クライアントは、このEIPに記載されている順序でフィールドを出力する必要があります。

CUTは、エラーが発生した場合、`STOP` 操作の行を出力してはいけません:
*例:* 
```
{"pc":2,"op":0,"gas":"0x2540be3fd","gasCost":"0x0","memory":"0x","memSize":0,"stack":["0x40"],"depth":1,"error":null,"opName":"STOP"}
```

### 要約とエラー処理

実行の終了時に、CUTは一部の情報を出力する必要があります。この情報には、以下のフィールドが含まれている必要があります。
要約は単一の `jsonl` オブジェクトである必要があります。

必須フィールド:

| 名前  | 型  | 説明  |
|---|---|---|
| `stateRoot` | 16進数文字列  | トランザクションの実行後のステートトライのルート  |
| `output` |   | 関数の戻り値  |
| `gasUsed` | 16進数  | トランザクションで使用されたすべてのガス  |
| `pass` | ブール値  | トランザクションが正常に実行されたかどうかを示すフラグ |

オプションのフィールド:

| 名前  | 型  | 説明  |
|---|---|---|
| `time` |  数値 | トランザクションの実行に必要な時間(ナノ秒)  |
| `fork` | 文字列  | 実行に使用されたフォークルール名  |
```
{"stateRoot":"0xd4c577737f5d20207d338c360c42d3af78de54812720e3339f7b27293ef195b7","output":"","gasUsed":"0x3","successful":"true","time":141485}
```

## 根拠
このEIPは、以前の非公式なEVMトレースのドキュメントに大きく依存しています。
クライアントの完全な互換性を可能にするために、可能な限り多くのコーナーケースをカバーしようとしています。
データ型とオプションのフィールドの選択は、現在の実装と可能な限り互換性があるように選択されています。

## 下位互換性
このEIPは、クライアントが任意でトレースインフラストラクチャを実装するというオプションを導入するだけなので、Ethereumとの完全な下位互換性があります。

### クライアント
このEIPはgo-ethereumと完全に下位互換性があります。OpenEthereum、Besu、Nethermindクライアントは、新しい厳密な仕様に合わせて、`openethereum-evm`、`evmtool`、`nethtest`のJSONの出力を若干変更する必要があります。新しいクライアントは、差分ファジンググループの一部になりたい場合、この変更を実装する必要があります。

## テストケース

```bash
 ~/go/src/github.com/ethereum/go-ethereum/build/bin/evm --code 604080536040604055604060006040600060025afa6040f3 --json run
{"pc":0,"op":96,"gas":"0x2540be400","gasCost":"0x3","memory":"0x","memSize":0,"stack":[],"returnStack":[],"returnData":"0x","depth":1,"refund":0,"opName":"PUSH1","error":""}
{"pc":2,"op":128,"gas":"0x2540be3fd","gasCost":"0x3","memory":"0x","memSize":0,"stack":["0x40"],"returnStack":[],"returnData":"0x","depth":1,"refund":0,"opName":"DUP1","error":""}
{"pc":3,"op":83,"gas":"0x2540be3fa","gasCost":"0xc","memory":"0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","memSize":96,"stack":["0x40","0x40"],"returnStack":[],"returnData":"0x","depth":1,"refund":0,"opName":"MSTORE8","error":""}
{"pc":4,"op":96,"gas":"0x2540be3ee","gasCost":"0x3","memory":"0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000","memSize":96,"stack":[],"returnStack":[],"returnData":"0x","depth":1,"refund":0,"opName":"PUSH1","error":""}
{"pc":6,"op":96,"gas":"0x2540be3eb","gasCost":"0x3","memory":"0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000","memSize":96,"stack":["0x40"],"returnStack":[],"returnData":"0x","depth":1,"refund":0,"opName":"PUSH1","error":""}
{"pc":8,"op":85,"gas":"0x2540be3e8","gasCost":"0x4e20","memory":"0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000","memSize":96,"stack":["0x40","0x40"],"returnStack":[],"returnData":"0x","depth":1,"refund":0,"opName":"SSTORE","error":""}
{"pc":9,"op":96,"gas":"0x2540b95c8","gasCost":"0x3","memory":"0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000","memSize":96,"stack":[],"returnStack":[],"returnData":"0x","depth":1,"refund":0,"opName":"PUSH1","error":""}
{"pc":11,"op":96,"gas":"0x2540b95c5","gasCost":"0x3","memory":"0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000","memSize":96,"stack":["0x40"],"returnStack":[],"returnData":"0x","depth":1,"refund":0,"opName":"PUSH1","error":""}
{"pc":13,"op":96,"gas":"0x2540b95c2","gasCost":"0x3","memory":"0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000","memSize":96,"stack":["0x40","0x0"],"returnStack":[],"returnData":"0x","depth":1,"refund":0,"opName":"PUSH1","error":""}
{"pc":15,"op":96,"gas":"0x2540b95bf","gasCost":"0x3","memory":"0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000","memSize":96,"stack":["0x40","0x0","0x40"],"returnStack":[],"returnData":"0x","depth":1,"refund":0,"opName":"PUSH1","error":""}
{"pc":17,"op":96,"gas":"0x2540b95bc","gasCost":"0x3","memory":"0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000","memSize":96,"stack":["0x
40","0x0","0x40","0x0"],"returnStack":[],"returnData":"0x","depth":1,"refund":0,"opName":"PUSH1","error":""}
{"pc":19,"op":90,"gas":"0x2540b95b9","gasCost":"0x2","memory":"0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000","memSize":96,"stack":["0x40","0x0","0x40","0x0","0x2"],"returnStack":[],"returnData":"0x","depth":1,"refund":0,"opName":"GAS","error":""}
{"pc":20,"op":250,"gas":"0x2540b95b7","gasCost":"0x24abb676c","memory":"0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000","memSize":96,"stack":["0x40","0x0","0x40","0x0","0x2","0x2540b95b7"],"returnStack":[],"returnData":"0x","depth":1,"refund":0,"opName":"STATICCALL","error":""}
{"pc":21,"op":96,"gas":"0x2540b92a7","gasCost":"0x3","memory":"0xf5a5fd42d16a20302798ef6ed309979b43003d2320d9f0e8ea9831a92759fb4b00000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000","memSize":96,"stack":["0x1"],"returnStack":[],"returnData":"0xf5a5fd42d16a20302798ef6ed309979b43003d2320d9f0e8ea9831a92759fb4b","depth":1,"refund":0,"opName":"PUSH1","error":""}
{"pc":23,"op":243,"gas":"0x2540b92a4","gasCost":"0x0","memory":"0xf5a5fd42d16a20302798ef6ed309979b43003d2320d9f0e8ea9831a92759fb4b00000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000","memSize":96,"stack":["0x1","0x40"],"returnStack":[],"returnData":"0xf5a5fd42d16a20302798ef6ed309979b43003d2320d9f0e8ea9831a92759fb4b","depth":1,"refund":0,"opName":"RETURN","error":""}
{"stateRoot":"2eef130ec61805516c1f050720b520619787704a5dd826a39aeefb850f83acfd", "output":"40","gasUsed":"0x515c","time":350855}