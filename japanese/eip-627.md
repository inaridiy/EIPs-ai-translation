---
original: 84c18fcf72050f00c05643cc6ecb4509a592c2f2d362321a5d1f575a3f6533f0
---

---
eip: 627
title: Whisper仕様
author: Vlad Gluhovsky <gluk256@gmail.com>
type: Standards Track
category: Networking
status: Final
created: 2017-05-05
---

## 概要

このEIPはÐΞVp2pワイヤープロトコル内のWhisperメッセージのフォーマットを説明しています。
このEIPは[既存の仕様](https://github.com/ethereum/wiki/wiki/Whisper-Wire-Protocol)に取って代わるべきものです。
Whisperに関するより詳細なドキュメントは[こちら](https://github.com/ethereum/go-ethereum/wiki/Whisper)にあります。

## 動機

Whisperメッセージの標準を定めることで、さまざまなWhisperクライアントの互換性を確保することが必要です。

## 仕様

ÐΞVp2pワイヤープロトコルのパケットとして送信されるすべてのWhisperメッセージは、整数のパケットコードと別のオブジェクト(パケットコードによって型が異なる)を含むRLP-エンコードされた配列データです。

Whisperノードがある特定のパケットコードをサポートしていない場合、エラーを生成せずにそのパケットを無視する必要があります。

### パケットコード

Whisperプロトコルに予約されているメッセージコード: 0 - 127。
不明なコードのメッセージは無視する必要があり、将来のバージョンとの互換性を確保するためです。

Whisperサブプロトコルでは以下のパケットコードをサポートする必要があります:

| EIP   | 名称                       | 整数値 |
|-------|----------------------------|-----------|
|       | ステータス                     |     0     |
|       | メッセージ                   |     1     |
|       | PoW要件            |     2     |
|       | ブルームフィルター               |     3     |
|-------|----------------------------|-----------|


以下のメッセージコードはオプションですが、特定の目的のために予約されています。

| EIP   | 名称                       | 整数値 |
|-------|----------------------------|-----------|
|       | P2Pリクエスト                |    126    |
|       | P2Pメッセージ                |    127    |
|-------|----------------------------|-----------|

### パケットフォーマットと使用法

**ステータス** [`0`]

このパケットには2つのオブジェクトが含まれています: 整数のメッセージコード(0x00)と、バージョンの整数、PoW要件の浮動小数点数、オプションのブルームフィルターからなるリストです。ブルームフィルターのパラメータが欠落しているか、nilの場合、そのノードはフルノード(つまり、すべてのメッセージを受け入れる)と見なされます。PoWとブルームフィルターのフォーマットについては、以下のメッセージコード2と3を参照してください。

ステータスメッセージは、初期ハンドシェイク後、他のメッセージを送信する前に送信する必要があります。

**メッセージ** [`1`, `whisper_envelopes`]

このパケットには2つのオブジェクトが含まれています: 整数のメッセージコード(0x01)と、(空の可能性がある)Whisperエンベロープのリスト。

このパケットは、標準的なWhisperエンベロープを送信するために使用されます。

**PoW要件** [`2`, `PoW`]

このパケットには2つのオブジェクトが含まれています: 整数のメッセージコード(0x02)と、単一の浮動小数点値としてのPoW。この値はIEEE 754 2進表現の64ビット浮動小数点数です。qNAN、sNAN、INF、-INFの値は許可されません。負の値も許可されません。

このパケットは、Whisperノードが個別のPoW要件を動的に調整するために使用されます。このメッセージの受信者は、指定されたPoW以下のメッセージをもはや配信してはいけません。

PoWは、現在のBestBit(ハッシュの先頭ゼロビット数)を見つけるために必要な平均反復回数を、メッセージサイズとTTLで割ったものと定義されます:

	PoW = (2**BestBit) / (size * TTL)

PoWの計算:

	fn short_rlp(envelope) = envelopeのenv_nonce以外のRLP.
	fn pow_hash(envelope, env_nonce) = sha3(short_rlp(envelope) ++ env_nonce)
	fn pow(pow_hash, size, ttl) = 2**leading_zeros(pow_hash) / (size * ttl)

ここでsizeは完全なRLP-エンコードされたエンベロープのサイズです。

**ブルームフィルター** [`3`, `bytes`]

このパケットには2つのオブジェクトが含まれています: 整数のメッセージコード(0x03)と、任意のサイズのバイト配列。

このパケットは、Whisperノードが特定のトピックに関心を持っていることを共有するために使用されます。

ブルームフィルターは、プライバシーを過度に侵害することなく、関心のあるトピックの数を識別するために使用されます。ビットの追加によって、情報コンテンツ(およびフィルターの効率)に対する精密な制御を維持できます。

ブルームは、複数のブルームトピックに対するビット単位のOR演算によって形成されます。ブルーム関数は、トピックを512ビットスライスにプロジェクションします。各ブルームトピックに対して最大3ビットがマークされます。

プロジェクション関数は、4バイトスライスSを512ビットスライスDにマッピングする関数として定義されます。説明の便宜上、Sはバイトとして、Dはビットとして参照されます。

	D[*] = 0 とする
	i = 0, 1, 2 の各iについて
	LET n = S[i]
	IF S[3] & (2 ** i) THEN n += 256
	D[n] = 1
	END FOR


オプション

**P2Pリクエスト** [`126`, `whisper_envelope`]

このパケットには2つのオブジェクトが含まれています: 整数のメッセージコード(0x7E)と、単一のWhisperエンベロープ。

このパケットは、Whisper Mail ClientがWhisper Mail Serverから古いメッセージを要求するなど、Dアプリレベルのピアツーピアリクエストを送信するために使用されます。

**P2Pメッセージ** [`127`, `whisper_envelope`]

このパケットには2つのオブジェクトが含まれています: 整数のメッセージコード(0x7F)と、単一のWhisperエンベロープ。

このパケットは、ピアツーピアメッセージを送信するために使用されます。これらのメッセージはさらに転送されるべきではありません。たとえば、Whisper Mail Serverが古い(期限切れの)メッセージを配信するために使用される可能性があります。

### Whisperエンベロープ

エンベロープはRLP-エンコードされた以下のフォーマットの構造体です:

	[ 有効期限, TTL, トピック, データ, ノンス ]
	
`有効期限`: 4バイト(秒単位のUNIXタイム)。

`TTL`: 4バイト(秒単位の存続時間)。

`トピック`: 任意のデータの4バイト。

`データ`: 任意のサイズのバイト配列(暗号化されたメッセージを含む)。

`ノンス`: 任意のデータの8バイト(PoW計算に使用)。

### メッセージのデータフィールドの内容(オプション)

このセクションでは、例を示すためにデータフィールドの任意の説明を概説しています。後にこれが別のEIPに移動される可能性があります。

着信メッセージを復号化したい場合にのみ関連しますが、メッセージを送信するだけの場合は、他のフォーマットでも完全に有効であり、ピアに転送する必要があります。

データフィールドには、エンベロープの暗号化されたメッセージが含まれています。対称暗号化の場合、Saltと呼ばれる12バイトのAESノンスも含まれます。平文(暗号化されていない)ペイロードは、以下の連結フィールドで構成されます: フラグ、補助フィールド、ペイロード、パディング、署名(この順序)。

	フラグ: 1バイト; 最初の2ビットは補助フィールドのサイズ、3番目のビットは署名の有無を示します。
	
	補助フィールド: 最大4バイト; ペイロードのサイズを含みます。

	ペイロード: 任意のサイズのバイト配列(ゼロの可能性あり)。

	パディング: 任意のサイズのバイト配列(ゼロの可能性あり)。

	署名: 65バイト、存在する場合(暗号化されていない場合)。

	Salt: 12バイト、存在する場合(対称暗号化の場合)。

メッセージデータを復号化できないユーザーは、署名にもアクセスできません。署名(存在する場合)は、発信者のアイデンティティの秘密鍵を使用してKeccak-256ハッシュした平文データのECDSA署名です。署名はR、S、Vパラメータの連結として直列化されます。RとSは両方とも大エンディアンエンコードされた固定幅256ビットの符号なし整数です。Vは8ビットの大エンディアンエンコードされた正規化されていない値で、27または28のいずれかです。

パディングフィールドは、メッセージサイズ単独では重要なメタ情報を明らかにする可能性があるため、メッセージサイズを整列させるために導入されました。パディングは任意のサイズでかまいませんが、暗号化前の(つまり平文の)データフィールドのサイズ(Saltを除く)が256バイトの倍数になることが推奨されます。

### ペイロードの暗号化

非対称暗号化では、SECP-256k1公開鍵を使用した標準的なElliptic Curve Integrated Encryption Schemeを使用します。

対称暗号化では、ランダムな96ビットのノンスを使用したAES GCMアルゴリズムを使用します。

## 根拠

パケットコード0x00と0x01はすべてのWhisperバージョンですでに使用されています。

パケットコード0x02は、Whisperの将来の発展に必要になるでしょう。これにより、PoW要件をリアルタイムで調整する可能性が提供されます。特定の最小PoW要件をハードコーディングするよりも、ネットワーク自体が自己管理できるようにするのが良いでしょう。

パケットコード0x03は、ネットワークのスケーラビリティに必要になるでしょう。トラフィックが多すぎる場合、ノードは自分に興味のあるメッセージのみをリクエストして受信できるようになります。

パケットコード0x7Eと0x7Fは、Whisper Mail ServerとClientを実装するために使用できます。P2Pメッセージがなければ、期限切れとして認識されるため、古いメッセージを配信することはできません。PoWをかけるための時間がない場合(たとえば、株式取引所が最新の取引情報をライブで提供したい場合)など、他の目的にも役立つかもしれません。

## 下位互換性

このEIPはWhisper version 6と互換性があります。特定のパケットコードを実装していないクライアントは、それらのコードのパケットを優雅に無視する必要があります。これにより、前方互換性が確保されます。

## 実装

Whisperのgolang実装(v.6)は既にパケットコード0x00 - 0x03を使用しています。Parityの v.6の実装でも0x00 - 0x03を使用します。0x7Eと0x7Fのコードは予約されていますが、まだ使用されておらず、Whisper Mail Serverの独自実装のために残されています。

## 著作権

著作権およびそれに関連する権利は[CC0](../LICENSE.md)によって放棄されています。