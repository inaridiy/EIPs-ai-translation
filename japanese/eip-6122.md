---
original: 431f1dd965ac42ca44a52d7afbfeff96e174c5a048836e99e51f71e97c75ce3f
---

---
eip: 6122
title: タイムスタンプに基づくforkidチェック
description: forkidチェックをタイムスタンプとブロック番号で動作するように変更する
author: Marius van der Wijden (@MariusVanDerWijden)
discussions-to: https://ethereum-magicians.org/t/eip-6122-forkid-checks-based-on-timestamps/12130
status: Final
type: Standards Track
category: Networking
created: 2022-12-13
requires: 2124
---

## 概要

[EIP-2124](./eip-2124.md)は、forkidパラメータを使ってP2Pネットワーク上のノードのチェーン構成を識別する方法を提案しました。
これにより、互換性のないノードを迅速に切断できるため、P2Pネットワークの信頼性が向上します。
マージ後、フォークはブロック番号ではなくブロック時間でスケジュールされます。このEIPはforkidの計算をブロック時間に合わせて更新します。

## 動機

proof-of-workでは、フォークはブロック番号によってスケジュールされていましたが、proof-of-stake合意レイヤーではスロット番号によってフォークがスケジュールされます。スロット番号は時間ベースの測定値です。合意レイヤーと実行レイヤーでフォークを同時にスケジュールするために、実行レイヤーはマージ後にもタイムスタンプでフォークをスケジュールする必要があります。

forkidの計算により、ピアは迅速にピアの構成を判断し、誤設定または他のネットワーク用に設定されたピアを切断できます。

## 仕様

各ノードは以下の値を維持します:

- **`FORK_HASH`**: ジェネシスハッシュとすでに経過したフォークブロック番号またはタイムスタンプのIEEE CRC32チェックサム(`[4]byte`)
  - フォークブロック番号またはタイムスタンプは昇順でCRC32チェックサムに入力されます。
  - 同じブロックまたは時間に複数のフォークが適用される場合、ブロック番号またはタイムスタンプはチェックサムに1回のみ組み込まれます。
  - ブロック番号は`uint64`整数として扱われ、ビッグエンディアン形式でチェックサムに組み込まれます。
  - ブロックタイムスタンプは`uint64`整数として扱われ、ビッグエンディアン形式でチェックサムに組み込まれます。
  - チェーンがフロンティア以外のルールセットでジェネシスから始まる場合、それはフォークとは見なされません。
- **`FORK_NEXT`**: 次の予定されているフォークのブロック番号またはタイムスタンプ(`uint64`)、または次のフォークが不明な場合は`0`
  - `FORK_NEXT`でブロックかタイムスタンプを区別する必要はありません。

ホームステッドの上に`1668000000`でタイムスタンプベースのフォークがある場合の`FORK_HASH`は:

- forkhash₁ = `0xcb37b2ee` (ホームステッド+架空のフォーク) = `CRC32(<genesis-hash> || uint64(1150000) || uint64(1668000000))`

### 追加ルール

以下の追加ルールが適用されます:

- タイムスタンプによるフォークは、ブロックによるフォークと同時かそれ以降にスケジュールされる必要があります(メインネットおよびプライベートネットワークで)。
- リモートピアのforkidの検証を実装する際は、まずブロックベースのフォークをフィルタリングし、次にタイムスタンプベースのフォークをフィルタリングする必要があります。

## 根拠

シャンハイはタイムスタンプでスケジュールされるため、forkidの計算をタイムスタンプとブロックに対応させる必要があります。
ブロック番号ベースのすべてのフォークがタイムスタンプベースのフォークよりも前に来るため、ノードはタイムスタンプベースのフォークの前にブロックベースのフォークをチェックする必要があります。

## 下位互換性

この変更はforkid計算を若干修正します。
その結果、この変更を適用したノードは、タイムスタンプスケジュールのフォークが発生した時点で、この変更を適用していないピアを切断します。
これは期待された動作であり、forkidの目的そのものです。

## テストケース

メインネット構成で、`1668000000`時にウィズドロー機能が有効化され、マージのネットスプリットブロックが`18000000`ブロックの場合のテストスイート

```go
type testcase struct {
	head uint64
	want ID
}
tests := []struct {
	config  *params.ChainConfig
	genesis common.Hash
	cases   []testcase
}{
	// ウィズドロー テストケース
	&withdrawalConfig,
	params.MainnetGenesisHash,
	[]testcase{
		{0, 0, ID{Hash: checksumToBytes(0xfc64ec04), Next: 1150000}},           // 同期していない
		{1149999, 0, ID{Hash: checksumToBytes(0xfc64ec04), Next: 1150000}},     // 最後のフロンティアブロック
		{1150000, 0, ID{Hash: checksumToBytes(0x97c2c34c), Next: 1920000}},     // 最初のホームステッドブロック
		{1919999, 0, ID{Hash: checksumToBytes(0x97c2c34c), Next: 1920000}},     // 最後のホームステッドブロック
		{1920000, 0, ID{Hash: checksumToBytes(0x91d1f948), Next: 2463000}},     // 最初のDAOブロック
		{2462999, 0, ID{Hash: checksumToBytes(0x91d1f948), Next: 2463000}},     // 最後のDAOブロック
		{2463000, 0, ID{Hash: checksumToBytes(0x7a64da13), Next: 2675000}},     // 最初のタンジェリンブロック
		{2674999, 0, ID{Hash: checksumToBytes(0x7a64da13), Next: 2675000}},     // 最後のタンジェリンブロック
		{2675000, 0, ID{Hash: checksumToBytes(0x3edd5b10), Next: 4370000}},     // 最初のスプーリアスブロック
		{4369999, 0, ID{Hash: checksumToBytes(0x3edd5b10), Next: 4370000}},     // 最後のスプーリアスブロック
		{4370000, 0, ID{Hash: checksumToBytes(0xa00bc324), Next: 7280000}},     // 最初のビザンチウムブロック
		{7279999, 0, ID{Hash: checksumToBytes(0xa00bc324), Next: 7280000}},     // 最後のビザンチウムブロック
		{7280000, 0, ID{Hash: checksumToBytes(0x668db0af), Next: 9069000}},     // 最初と最後のコンスタンティノープル、最初のペテルブルクブロック
		{9068999, 0, ID{Hash: checksumToBytes(0x668db0af), Next: 9069000}},     // 最後のペテルブルクブロック
		{9069000, 0, ID{Hash: checksumToBytes(0x879d6e30), Next: 9200000}},     // 最初のイスタンブールと最初のミュアグレイシャーブロック
		{9199999, 0, ID{Hash: checksumToBytes(0x879d6e30), Next: 9200000}},     // 最後のイスタンブールと最初のミュアグレイシャーブロック
		{9200000, 0, ID{Hash: checksumToBytes(0xe029e991), Next: 12244000}},    // 最初のミュアグレイシャーブロック
		{12243999, 0, ID{Hash: checksumToBytes(0xe029e991), Next: 12244000}},   // 最後のミュアグレイシャーブロック
		{12244000, 0, ID{Hash: checksumToBytes(0x0eb440f6), Next: 12965000}},   // 最初のベルリンブロック
		{12964999, 0, ID{Hash: checksumToBytes(0x0eb440f6), Next: 12965000}},   // 最後のベルリンブロック
		{12965000, 0, ID{Hash: checksumToBytes(0xb715077d), Next: 13773000}},   // 最初のロンドンブロック
		{13772999, 0, ID{Hash: checksumToBytes(0xb715077d), Next: 13773000}},   // 最後のロンドンブロック
		{13773000, 0, ID{Hash: checksumToBytes(0x20c327fc), Next: 15050000}},   // 最初のアロー・グレイシャーブロック
		{15049999, 0, ID{Hash: checksumToBytes(0x20c327fc), Next: 15050000}},   // 最後のアロー・グレイシャーブロック
		{15050000, 0, ID{Hash: checksumToBytes(0xf0afd0e3), Next: 18000000}},   // 最初のグレー・グレイシャーブロック
		{18000000, 0, ID{Hash: checksumToBytes(0x4fb8a872), Next: 1668000000}}, // 最初のマージ開始ブロック
		{20000000, 0, ID{Hash: checksumToBytes(0x4fb8a872), Next: 1668000000}}, // 最後のマージ開始ブロック
		{20000000, 1668000000, ID{Hash: checksumToBytes(0xc1fdf181), Next: 0}}, // 最初のシャンハイブロック
		{20100000, 2669000000, ID{Hash: checksumToBytes(0xc1fdf181), Next: 0}}, // 未来のシャンハイブロック
	},
}
```

メインネットノードが持ち得る異なる状態と、検証および受け入れ/拒否が必要となる可能性のある異なるリモートフォークIDのテストスイート:

```go
tests := []struct {
	head uint64
	id   ID
	err  error
}{
	/// ローカルはメインネットウィズドロー、リモートも同じを発表。次のフォークは発表されていない。
	{20000000, 1668000001, ID{Hash: checksumToBytes(0xc1fdf181), Next: 0}, nil},

	// ローカルはメインネットウィズドロー、リモートも同じを発表し、次のフォークを0xffffffffブロック/時間で発表しているが、それは不確定。
	{20000000, 1668000001, ID{Hash: checksumToBytes(0xc1fdf181), Next: math.MaxUint64}, nil},

	// ローカルはメインネットでビザンチウムのみ(したがってペテルブルクとウィズドローを認識している)、リモートもビザンチウムを発表しているが、ペテルブルクはまだ認識していない(たとえばフォーク前に更新されていないノード)。
	// この場合、ペテルブルクがすでに通過したかどうかはわかりません。
	{7279999, 1667999999, ID{Hash: checksumToBytes(0xa00bc324), Next: 0}, nil},

	// ローカルはメインネットでビザンチウムのみ(したがってペテルブルクとウィズドローを認識している)、リモートもビザンチウムを発表し、ペテルブルクも認識している(たとえばフォーク前に更新されたノード)。ペテルブルクがすでに通過したか(通過する)かどうかはわかりません。
	{7279999, 1667999999, ID{Hash: checksumToBytes(0xa00bc324), Next: 7280000}, nil},

	// ローカルはメインネットでビザンチウムのみ(したがってペテルブルクとウィズドローを認識している)、リモートもビザンチウムを発表し、ランダムなフォーク(たとえば誤設定されたペテルブルク)も認識している。どちらのフォークも通過していないため、ミスマッチする可能性がありますが、とりあえず接続します。
	{7279999, 1667999999, ID{Hash: checksumToBytes(0xa00bc324), Next: math.MaxUint64}, nil},

	// ローカルはメインネットでちょうどウィズドローにいる、リモートはビザンチウムとペテルブルクの情報を持っている。リモートは単に同期が遅れているだけ、受け入れる。
	{20000000, 1668000000, ID{Hash: checksumToBytes(0xa00bc324), Next: 7280000}, nil},

	// ローカルはメインネットウィズドロー、リモートはビザンチウムとペテルブルクの情報を持っている。リモートは単に同期が遅れているだけ、受け入れる。
	{20000000, 1668000001, ID{Hash: checksumToBytes(0xa00bc324), Next: 7280000}, nil},

	// ローカルはメインネットウィズドロー、リモートはスプーリアスとビザンチウムの情
報を持っている。リモートは明らかに同期が遅れている。ペテルブルクの更新が必要かどうかはまだわかりません。
	{20000000, 1668000001, ID{Hash: checksumToBytes(0x3edd5b10), Next: 4370000}, nil},

	// ローカルはメインネットビザンチウム&ウィズドロー前、リモートはペテルブルクを発表している。ローカルは同期が遅れているだけ、受け入れる。
	{7279999, 1667999999, ID{Hash: checksumToBytes(0x668db0af), Next: 0}, nil},

	// ローカルはメインネットスプーリアス、リモートはビザンチウムを発表しているが、ペテルブルクは認識していない。ローカルは同期が遅れている。ローカルも将来のフォークを知っているが、それはまだ不確定。
	{4369999, 1667999999, ID{Hash: checksumToBytes(0xa00bc324), Next: 0}, nil},

	// ローカルはメインネットウィズドロー。リモートはビザンチウムを発表しているが、それ以降のフォークは認識していない。
	// リモートはソフトウェアの更新が必要。
	{20000000, 1668000001, ID{Hash: checksumToBytes(0xa00bc324), Next: 0}, ErrRemoteStale},

	// ローカルはメインネットウィズドロー、それ以降のフォークは認識していない。リモートはペテルブルク + 0xffffffffを発表している。
	// ローカルはソフトウェアの更新が必要、拒否する。
	{20000000, 1668000001, ID{Hash: checksumToBytes(0x5cddc0e1), Next: 0}, ErrLocalIncompatibleOrStale},

	// ローカルはメインネットウィズドロー、ペテルブルクを認識している。リモートはペテルブルク + 0xffffffffを発表している。
	// ローカルはソフトウェアの更新が必要、拒否する。
	{20000000, 1668000001, ID{Hash: checksumToBytes(0x5cddc0e1), Next: 0}, ErrLocalIncompatibleOrStale},

	// ローカルはメインネットウィズドロー、リモートはRinkebyのペテルブルク。
	{20000000, 1668000001, ID{Hash: checksumToBytes(0xafec6b27), Next: 0}, ErrLocalIncompatibleOrStale},

	// ローカルはメインネットウィズドロー、遥か未来。リモートはGopherium(存在しないフォーク)を88888888の未来のブロックで発表しているが、ローカルにとっては過去のブロック。ローカルは互換性がない。
	//
	// このケースは、アップグレードされていないノードがマジョリティのハッシュパワーを持つ場合(典型的なRopsten問題)を検出します。
	{88888888, 1668000001, ID{Hash: checksumToBytes(0xf0afd0e3), Next: 88888888}, ErrRemoteStale},

	// ローカルはメインネットウィズドロー。リモートはビザンチウムにいるが、ペテルブルク前の7279999ブロックでGopherium(存在しないフォーク)を発表している。ローカルは互換性がない。
	{20000000, 1668000001, ID{Hash: checksumToBytes(0xa00bc324), Next: 7279999}, ErrRemoteStale},
```

## セキュリティ上の考慮事項

既知のセキュリティリスクはない

## 著作権

著作権およびその関連権利は[CC0](../LICENSE.md)によって放棄されています。