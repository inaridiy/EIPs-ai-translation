---
original: 62a591c0e4912879e522b3493dc4847c4bb9d69aebd11fa776989adeaec6e031
---

---
eip: 7609
title: TLOAD/TSTORE のベースコストの削減
description: TLOAD/TSTORE の効率を向上させるため、ベースコストを削減し、スーパーリニアな価格モデルを導入する。
author: Charles Cooper (@charles-cooper), James Prestwich (@prestwich), brockelmore (@brockelmore)
discussions-to: https://ethereum-magicians.org/t/eip-7609-reduce-transient-storage-pricing/18435
status: Draft
type: Standards Track
category: Core
created: 2024-02-01
requires: 1153
---

## 概要

TLOAD/TSTORE のベースコストを削減し、スーパーリニアな価格モデルを導入する。これにより、一般的な使用例の TLOAD/TSTORE の効率が向上し、DoS攻撃ベクトルを防ぐ価格モデルが提供される。

## 動機

[EIP-1153](./eip-1153.md)は新しいストレージ領域「transient storage」を導入した。これはストレージのように単語単位でアドレス指定でき、呼び出しフレーム間で永続化されるが、トランザクション終了時に消去される。EIP-1153の開発中、価格設定は warm storage の読み書きと同じにされた。これには2つの理由がある: EIPの概念的な単純さ、そして2つの関連するDoS攻撃ベクトルへの対処(transient storageの過剰割り当て、リバートによる状態ロールバックのコスト)。

EIP-1153が可能にする最も重要な使用例の1つは、安価なリエントラント保護である。実際、最初の数スロットのtransient storageが十分に安価であれば、ユーザーへの負担を最小限に抑えつつ、最大かつ最も高価なスマートコントラクト脆弱性クラスを防ぐことができる。

さらに、transient storageの価格設定は根本的に過剰であると考えられる。価格設定はリファンドと相互作用せず、コントラクトロード時の新しい割り当てのみを必要とし(メモリとは対照的)、物理データベースとの相互作用もない。

このEIPは、割り当てごとに追加ガスを請求する価格モデルを提案する。これにより、一般的な使用例(コントラクトあたり約95スロット未満の書き込み)では安価になる一方で、transient storageを使ったDoS攻撃を非常に高価にする。

## 仕様

この文書の「MUST」、「MUST NOT」、「REQUIRED」、「SHALL」、「SHALL NOT」、「SHOULD」、「SHOULD NOT」、「RECOMMENDED」、「NOT RECOMMENDED」、「MAY」、「OPTIONAL」というキーワードは、RFC 2119およびRFC 8174に記載されているように解釈されるものとする。

`TLOAD`のガスコストは5ガスと提案される。`TSTORE`のガスコストは8ガス + `expansion_cost`と提案される。ここで`expansion_cost`は、キーがtransient storageマッピングにまだ存在しない場合は`1 gas * transient storage mappingの長さ`、それ以外は0ガスと計算される。

疑似コードで表すと:

```python
G_LOW = 5
G_MID = 8

SLOPE = 1

def gas_tload(_key):
    return G_LOW

def gas_tstore(key, transient_mapping):
    cost = G_MID
    if key not in transient_mapping:
        cost += SLOPE * transient_mapping.size()
    return cost
```

## 根拠

### ガス

ベンチマークの結果、`TLOAD`は`MUL`と同程度のCPU時間を消費し、`TSTORE`は約1.5倍であることが分かった。そのため、`TLOAD`と`TSTORE`にそれぞれ`G_low`と`G_mid`の値が選択された。

## 下位互換性

下位互換性の問題はない。

## セキュリティ上の考慮事項

30m ガスで割り当てできる最大のtransient スロット数は約7,739 (方程式 `x(x-1)/2*1 + 8*x = 30_000_000`の解) で、合計で248KBになる。

`TSTORE`のコストが新しいコールドコントラクトを呼び出すコスト(2600ガス)を上回った場合の、トランザクションあたりに割り当てられるtransient スロットの最大数は、以下のように解くことができる:

```
SLOPE * <num slots> == 2600 を解くと、num_slots == 2600
contract_gas_used = 2600 + SLOPE * num_slots * (num_slots - 1) / 2 + G_MID * num_slots == 3402100
block_gas_limit = 30_000_000
txn_per_block = block_gas_limit // contract_gas_used ~= 8.8
max_transient_slots = txn_per_block * num_slots == 22927
```

つまり、1つのトランザクションで割り当てられるtransient スロットの最大数は約23,000、合計736KBである。現在のガススケジュール(約9.6MBのメモリを割り当てられる)と比べると、クライアントでtransient storageを使って割り当てられるリソースの総量が減少している。比較のため、`SSTORE`によって1つのトランザクションで割り当てられるメモリの総量は`30_000_000 / 20_000 * 32`、つまり48KBである。

ガス制限の増加に伴って、この上限も線形に拡大するという性質は有用である。

## 著作権

著作権およびそれに関連する権利は[CC0](../LICENSE.md)によって放棄されています。