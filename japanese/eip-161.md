---
original: 45f6beabbf885e3f95199a7ec763a9483d6de61ad689e00fd8e6121c136e991f
---

---
eip: 161
title: ステートトライクリアリング (不変性保持型の代替案)
author: Gavin Wood (@gavofyork)
type: Standards Track
category: Core
status: Final
created: 2016-10-24
---

### ハードフォーク
[Spurious Dragon](./eip-607.md)

### パラメータ
- `FORK_BLKNUM`: 2,675,000
- `CHAIN_ID`: 1 (メインネット)

### 仕様

a. アカウント作成トランザクションと `CREATE` 操作は、初期化コードの実行前に、通常の開始値よりも **1** 増加した **ノンス** を **インクリメントする** ものとする (通常のネットワークでは単に 1 になりますが、非ゼロのデフォルトの開始ノンスを持つテストネットは異なります)。

b. `CALL` と `SUICIDE` は、宛先が存在しない場合に 25,000 ガスを請求していましたが、これからは **ゼロ以外の値** が転送され、宛先アカウントが _死亡_ している場合にのみ請求されるものとする。

c. いかなるアカウントも、存在しない状態から _空の_ 状態に変化することはできない。そのような操作を行おうとした場合、そのアカウントは代わりに存在しないままとする。

d. _トランザクション終了時_、そのトランザクションの実行によって _触れられた_ 任意のアカウントが _空_ になっている場合は、代わりに存在しないものとする (つまり **削除される**)。

ここで:

アカウントが _触れられた_ と見なされるのは、潜在的な _状態変更_ 操作に関与した場合です。これには、**ゼロ値の転送** の受信も含まれます。

アカウントが _空_ と見なされるのは、**コードがなく**、**ノンスがゼロ**、**残高がゼロ** の場合です。

アカウントが _死亡_ と見なされるのは、存在しないか _空_ の場合です。

_トランザクション終了時_ とは、自殺リストの実行直後、領収書の状態トライ根の決定前のことです。

アカウントが _状態を変化_ させるのは以下の場合です:
- `SUICIDE` 操作の対象または返金先で、**ゼロ以上の** 値を持つ場合;
- `CALL` 操作またはメッセージコールトランザクションの送信先または宛先で、**ゼロ以上の** 値を転送する場合;
- `CREATE` 操作または契約作成トランザクションの送信元または作成元で、**ゼロ以上の** 値を供与する場合;
- ブロック作成者 ("マイナー") として、ブロック報酬またはトランザクション手数料の **ゼロ以上の** 値を受け取る場合。

#### 注記

現在のイーサリアムプロトコルでは、トランザクションの実行後にアカウントが空になるような状態変化はほとんど発生しません。実際に現在の実装で追跡する必要があるのは以下の4つのコンテキストだけです:
- `CALL` を通じてゼロ値が転送されたEmpty アカウント;
- `SUICIDE` を通じてゼロ値が転送されたEmpty アカウント;
- メッセージコールトランザクションを通じてゼロ値が転送されたEmpty アカウント;
- ゼロガス価格の手数料転送を通じてゼロ値が転送されたEmpty アカウント。

### 根拠

#158 と同様ですが、不変量を破壊しないため、いくつかのエッジケースが回避されています:
- ~~トランザクションの実行中にアカウントがコードやストレージを持つ状態から持たない状態に変化すること;~~ [修正済み]
- 新規作成されたアカウントが展開される前に削除されること。

`CREATE` では、ノンスをゼロにしないことで、`CREATE`d アカウントが作成途中で刈り取られるという奇妙な状況を避けています。

### 付録 (2017-08-15)

2016年11月24日に、状態の巻き戻しの際の実装間の動作の違いによるコンセンサスバグが発生しました[3]。仕様は、空アカウントの削除は状態の巻き戻しの際に巻き戻されることを明確にするよう修正されました。

### 参考文献

1. EIP-158 の問題と議論: https://github.com/ethereum/EIPs/issues/158
2. EIP-161 の問題と議論: https://github.com/ethereum/EIPs/issues/161
3. https://blog.ethereum.org/2016/11/25/security-alert-11242016-consensus-bug-geth-v1-4-19-v1-5-2/
> 詳細: Gethは、トランザクションが ガス切れ例外で終了した際に、空アカウントの削除を巻き戻していませんでした。Parityでも、プリコンパイルドコントラクトへのガス切れコールの一部のコンテキストで、空アカウントの削除を誤って巻き戻していないことが見つかりました。新しいGethの動作はParityと一致し、空アカウントは一週間以内に状態クリアプロセスが完了すれば、一般的な懸念事項ではなくなるでしょう。