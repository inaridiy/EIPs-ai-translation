---
original: 510cf045b1994562ffd8838bdcdbdf999e3f981bebed7019e774cf020b19f3c7
---

---
eip: 2464
title: "eth/65: トランザクションの通知と取得"
description: `NewPooledTransactionHashes`、`GetPooledTransactions`、`PooledTransactions`の導入
author: Péter Szilágyi <peterke@gmail.com>、Péter Szilágyi (@karalabe)、Gary Rong <garyrong0905@gmail.com>、Tim Beiko (@timbeiko)
discussions-to: https://github.com/ethereum/EIPs/issues/2465
status: Final
type: Standards Track
category: Networking
created: 2020-01-13
requires: 2364
---

## 概要

このEIPは、`eth`プロトコルに3つの新しいメッセージタイプ(`eth/65`)を導入します: `NewPooledTransactionHashes (0x08)`はトランザクションのコンテンツを伝えずにトランザクションのセットを通知し、`GetPooledTransactions (0x09)`はハッシュによってトランザクションのバッチを要求し、`PooledTransactions (0x0a)`はトランザクション要求に応答します。これにより、トランザクションの伝播に使用されるバンド幅を、ピア数の線形複雑性から平方根に削減でき、初期トランザクション交換を10s-100s MBから`len(pool) * 32B ~= 128KB`に削減できます。

## 動機

`eth`ネットワークプロトコルには、新しくマイニングされたブロックを伝播する2つの方法があります: 完全なブロックを(`eth/64`以前の`NewBlock (0x07)`経由で)ブロードキャストするか、ブロックのハッシュのみを(`NewBlockHashes (0x01)`経由で)アナウンスするかです。この二重性により、ノードは平方根数のピアに対して高帯域幅のブロードキャスト(10s-100s KB)を、残りの線形数のピアに対して低帯域幅のアナウンス(10s-100s B)を行うことができます。平方根のブロードキャストは、よく接続されたノードすべてに到達するのに十分ですが、退化したトポロジーを横断するためにはリニアなアナウンスが必要です。これは上手く機能します。

しかし、`eth`プロトコルにはトランザクションを伝播するための同様の二重メカニズムがないため、ノードは`Transactions (0x02)`によるブロードキャストに頼らざるを得ません。退化したトポロジーに対応するため、トランザクションはスクエアルートでブロードキャストできず、すべてのピアにリニアに転送する必要があります。N個のピアがいる場合、各ノードは同じトランザクションをN回転送する(両方向を数えると)のに対し、完全な世界では1回で十分です。これは大きな無駄です。

新しいネットワーク接続が2つのノード間で確立された場合にも同様の問題が生じます。トランザクションプールを同期する必要がありますが、プールはただのぶら下がったトランザクションの集まりにすぎません。リモートでトランザクションを重複排除する方法がないため、各ノードは自分のトランザクションリストを相手に無駄に転送する必要があります。プールに数千のトランザクションが含まれている場合、単純な転送では10s-100s MBにもなり、ほとんどが無駄です。しかし、これ以外に方法はありません。

このEIPは、`eth`プロトコルに3つの新しいメッセージタイプ(`eth/65`)を導入します: `NewPooledTransactionHashes (0x08)`はトランザクションのコンテンツを伝えずにトランザクションのセットを通知し、`GetPooledTransactions (0x09)`はハッシュによってトランザクションのバッチを要求し、`PooledTransactions (0x0a)`はトランザクション要求に応答します。これにより、トランザクションの伝播に使用されるバンド幅を、ピア数の線形複雑性から平方根に削減でき、初期トランザクション交換を10s-100s MBから`len(pool) * 32B ~= 128KB`に削減できます。

トランザクスループット(とサイズ)がEthereumで増加しているため、トランザクションの伝播が現在使用されるネットワークリソースの主要な構成要素となっています。しかし、`eth`プロトコルにはリモートでトランザクションを重複排除する仕組みがないため、同じデータがすべてのネットワーク接続を介して繰り返し転送されるため、これらのリソースの大部分は無駄になっています。

このEIPは`eth`プロトコルに小さな拡張を提案し、ネットワーク接続間でトランザクションの転送前に転送すべきトランザクションのセットに合意できるようにします。これにより、Ethereumネットワークの全体的な(運用)帯域幅使用量を少なくとも1桁削減できるはずです。

## 仕様

`eth`プロトコルに3つの新しいメッセージタイプを追加します:
 * `NewPooledTransactionHashes (0x08): [hash_0: B_32, hash_1: B_32, ...]`
   * ネットワークに現れたトランザクションのうち、**まだブロックに含まれていないもの**を1つ以上指定します。可能な限り有益であるため、ピアが認識していない可能性のあるすべてのトランザクションを通知すべきです。
   * トランザクションのハッシュを通知する数に**プロトコル違反の上限はありません**(10MB `devp2p`ネットワークパケット制限を除く)が、4096個(128KB)が適切な塊サイズと考えられます。
   * リモートピアが知らない可能性のあるトランザクションのハッシュのみを通知すべきですが、プールにノンスの欠落があるよりも過剰に通知する方が良いでしょう。
 * `GetPooledTransactions (0x09): [hash_0: B_32, hash_1: B_32, ...]`
   * **トランザクションプール**から1つ以上のトランザクションを取得するよう指定します。
   * リクエストできるトランザクションの数に**プロトコル違反の上限はありません**(10MB `devp2p`ネットワークパケット制限を除く)が、応答側は任意の上限(サイズまたは処理時間)を設けることができ、**プロトコル違反とはみなされません**。無駄なバンド幅を抑えるため(応答されないハッシュ)、256個が適切な上限と考えられます。
 * `PooledTransactions (0x0a): [[nonce: P, receivingAddress: B_20, value: P, ...], ...]`
   * `GetPooledTransactions (0x09)`メッセージによって要求されたリモートノードの**ローカルトランザクションプール**のトランザクションを指定します。リストの各アイテムは、メインのEthereum仕様で説明されているトランザクションの形式です。
   * トランザクションは要求と同じ順序で**なければならない**が、利用可能でないトランザクションはスキップしてかまいません。これにより、応答サイズ制限に達した場合、リクエスターは最後に返されたトランザクションから先のハッシュを再度リクエストし、それ以前のギャップは利用不可能と見なすことができます。
   * ピアのプールにいずれのハッシュにも一致するトランザクションがない場合、空の応答を返すことが**許可されます**。ブロックに含まれる前に自身のプールに追加されたトランザクションを通知することも許可されます。

## 根拠

**Q: なぜ`GetPooledTransactions (0x09)`をプールからのアイテム取得に制限するのですか?**

トランザクションプール以外では、トランザクションはブロック本体の中で数百まとめて転送されます。個別のトランザクションへのアクセスを許可すると、データベースの読み取りコストが露呈してしまいます。

トランザクションの伝播の目的では、ディスクへのアクセスを許可する必要はありません。ディスクに確定したトランザクションは、いずれにしろブロックの中で転送されるため、せいぜい数百ミリ秒の遅延しか発生しません。

ブロックの伝播は、含まれるトランザクションを必要に応じてオンデマンドで転送することで最適化できますが、それ自体が別のEIPの話題です。要件が明確になるまでは、プロトコルを緩めておくのが賢明でしょう。最近のブロックに含まれるトランザクションのセットをメモリ上に維持するだけで十分かもしれません。

**Q: `NewPooledTransactionHashes (0x08)`はディスクから重複排除すべきですか?**

`GetPooledTransactions (0x09)`と同様に、`NewPooledTransactionHashes (0x08)`もトランザクションプールのみを対象とし、ディスクは無視すべきです。健全なネットワーク状況では、トランザクションがブロックに含まれるよりもはるかに速く伝播するため、新しく通知されたトランザクションがすでにディスクにあるというケースはほとんどないはずです。ディスクの重複排除を避けることで、リモートのトランザクション通知によるDoS攻撃を回避できます。

本当に正確になりたい場合は、上述した最近含まれたトランザクションのテクニックを使って、期限切れの通知を破棄することもできます。

**Q: なぜ既存の`Transaction (0x02)`を再利用せず、新しい`PooledTransactions (0x0a)`を使うのですか?**

当初このEIPは、`GetPooledTransactions (0x09)`要求の応答として既存の`Transaction (0x02)`メッセージを再利用していました。しかし、ノードが`Transaction (0x02)`メッセージをブロードキャストとしてお互いにゴシップしているため、要求への応答がどのメッセージなのかを照合するのが難しくなります。

`Transaction (0x02)`と`PooledTransactions (0x0a)`を別のメッセージとして維持することで、将来の最適化(リクエストIDの追加など、ブロードキャストには意味がないもの)に対してプロトコルをより柔軟に保つことができます。

## 下位互換性

このEIPは`eth`プロトコルを下位互換性のない方法で拡張し、新しいバージョン`eth/65`のリリースを必要とします。ただし、`devp2p`は同じワイヤープロトコルの複数バージョンを並行して実行できるため、`eth/65`のロールアウトにはクライアントの調整は必要ありません。既に更新されていないクライアントは`eth/64`を継続して使用できます。

このEIPはコンセンサスエンジンを変更しないため、ハードフォークは**必要ありません**。

## セキュリティ上の考慮事項

なし。

## 著作権

著作権およびそれに関連する権利は[CC0](../LICENSE.md)によって放棄されています。