---
original: 5fbfb5c1b5800913cdf28c332eb8724793be7958952ecc133cb10bd12b2ec6c4
---

---
eip: 2542
title: 新しいオペコード TXGASLIMIT と CALLGASLIMIT
author: Alex Forshtat <forshtat1@gmail.com>
discussions-to: https://ethereum-magicians.org/t/eip-2542-add-txgaslimit-callgaslimit-txgasrefund-opcodes
status: 停滞
type: Standards Track
category: Core
created: 2020-02-29
---

## 簡単な要約
現在のトランザクションとエグゼキューションフレームのガス制限に関する情報にアクセスできるメカニズム。

## 概要
現在、`0x45 GASLIMIT`というオペコードが存在し、ブロックガス制限にアクセスできます。この情報は一部の場合に有用かもしれませんが、スマートコントラクト開発者が気にかけるような値ではないかもしれません。`0x5a GAS`オペコードは残りのガスを提供しますが、初期のガスではありません。また、既存の`0x32 ORIGIN`、`0x33 CALLER`、`0x34 CALLVALUE`、`0x3a GASPRICE`オペコードが、トランザクションと現在のエグゼキューションフレームの状態の両方にアクセスできるパターンを設定していることにも注目する必要があります。
TBD: 0x30オペコード範囲が使い尽くされた場合、提案されたオペコードを0x50範囲に追加するか、新しい範囲を追加することができます。

## 動機
リレー、メタトランザクション、ガス料金、アカウントアブストラクションの概念が人気を集めるにつれ、一部のコントラクトがガス消費を絶対的な精度で追跡できるようになることが重要になってきています。EVM レベルでこのデータにアクセスできないと、そのようなコントラクトは近似値を使用したり、EVM ロジックをオンチェーンでミミックしたりしなければならず、一部のユースケースが実現不可能になる可能性があります。

## 仕様
block.number >= TBD の場合、3つの新しいオペコードを追加します:

TXGASLIMIT: 0x5c

スタックにトランザクション全体のガス制限を押し込みます。これは外部所有アカウントによって署名された 'startgas' パラメータの値です。
ガスコスト: 2 (GASLIMIT と同じ)

CALLGASLIMIT: 0x5d

現在のエグゼキューションフレームのガス制限をスタックにプッシュします。これは EIP-150 の "64分の1" ルールを適用した後に得られる 'callGas' 値です。
ガスコスト: 2 (GASLIMIT と同じ)

また、混同を避けるため、`0x45 GASLIMIT`を`BLOCKGASLIMIT`に名称変更することも検討してください。

## 根拠
トランザクション全体または一部が消費したガスを知りたいソリディティスマートコントラクトを考えてみましょう。現在のEVMでは完全にはできません。提案された変更を使えば、疑似ソリディティ構文で簡単に入手できます:
```
function keepTrackOfGas(string memory message, uint256 number) public {
    ...
    uint gasUsed = msg.gasLimit - gasleft();
}
```
これは非常に一般的なユースケースで、多くの実装では考慮されていない費用を考慮していません。 `gasUsed`問題の最先端の解決策は、スマートコントラクトの最初の行で `gasleft()`にアクセスすることです。
トランザクション入力サイズが可変であるため、トランザクションで使用されるガスは入力の0バイトと非0バイトの数、および `GTXDATANONZERO` に依存することに注意してください。もう1つの問題は、ソリディティが `public` メソッドを処理する際に、予測不可能な量のガスを消費して `calldata` 全体を `memory` にロードすることです。

別のアプリケーションは、メソッドに渡されるガス制限の要件があることです。このような状況は、メタトランザクションの文脈で非常によく発生します。ここでは、msg.senderのアカウントホルダーは内部トランザクションの成功にそれほど関心がない可能性があります。誇張された疑似コード:

```
function verifyGasLimit(uint256 desiredGasLimit, bytes memory signature, address signer, bytes memory someOtherData) public {
    require(ecrecover(abi.encodePacked(desiredGasLimit, someOtherData), signature) == signer, "Signature does not match");
    require(tx.gasLimit == desiredGasLimit, "Transaction limit does not match the signed value. The signer did not authorize that.");
    ...
}
```
この状況では、オペコードとコールデータの価格に依存し、署名できない `gasleft()` の値に頼ることはできません。

## 下位互換性
この提案では2つの新しいオペコードを導入し、既存のものを名称変更しますが、それ以外は完全に下位互換性があります。

## 上位互換性
この提案の主要な検討事項の1つは、EVMへの将来の変更との整合性です:

1. EIP-2489 GAS オペコードの非推奨化
 スマートコントラクトが "ガス内部観察" を行うことで、オペコードの価格に依存するようになるという意見があります。
 この誤解を批判することは本EIPの範囲を超えますが、既存の `0x5a GAS` オペコードの動作を破壊的に変更する必要がある場合、同じ考慮事項が提案されたオペコードにも適用されます。つまり、このEIPはEVMの進化に新しい制約を追加するものではありません。

2. Stateless Ethereum
 UNGAS提案は、進行中のStateless Ethereumプロジェクトに関連していると言われています。Stateless Ethereumに厳密に必要なわけではありませんが、ガススケジュールへの将来の破壊的変更をより簡単にする方法の1つです。
 'ガス制限'の概念がEVMの一部である限り、提案されたオペコードがStateless Ethereumと矛盾するとは考えられません。ガススケジュールはこの提案では公開されません。

3. 他の物議を醸す可能性のあるオペコードとの比較
 非推奨化の対象とされていないが批判を受けているオペコードもあります。例えば、`0x32 ORIGIN`がスマートコントラクト開発者に誤用されたり、`0x46 CHAINID`がスマートコントラクトを "フォーク不可能" にしたりするものです。
 この EIP は、悪いセキュリティ慣行を奨励したり可能にしたりするものではなく、EVM にとって新しい概念を導入するものでもありません。

## セキュリティ上の考慮事項
この変更による既存のスマートコントラクトへの影響はありません。
提案されたオペコードを使用するスマートコントラクトは、セキュリティ機能の中核には使用せず、実行環境に関する情報源としてのみ使用する必要があります。

## 実装
EIPが "Final" のステータスを得るには実装が完了している必要がありますが、EIPが受け入れられる前に完了している必要はありません。仕様と根拠に合意に達してからコードを書くアプローチには価値がありますが、多くの API の詳細に関する議論を解決する際には、"ラフなコンセンサスと動作するコード" のアプローチも有用です。

## 著作権
著作権およびそれに関連する権利は[CC0](../LICENSE.md)で放棄されています。