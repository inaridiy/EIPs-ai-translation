---
original: 3a9688ffffd055290f4016f4194492319f6caa1ec51a94afd73464fa7433db0d
---

---
eip: 7212
title: secp256r1曲線サポートのプリコンパイル
description: "secp256r1"楕円曲線での署名検証を行うプリコンパイルドコントラクトを追加する提案。
author: Ulaş Erdoğan (@ulerdogan), Doğan Alpaslan (@doganalpaslan), DC Posch (@dcposch), Nalin Bhardwaj (@nalinbhardwaj)
discussions-to: https://ethereum-magicians.org/t/eip-7212-precompiled-for-secp256r1-curve-support/14789
status: Review
type: Standards Track
category: Core
created: 2023-06-22
---

## 概要

この提案では、メッセージハッシュ、署名の`r`と`s`コンポーネント、公開鍵の`x`と`y`座標を入力パラメータとして、"secp256r1"楕円曲線での署名検証を行うプリコンパイルドコントラクトを作成します。これにより、Ethereumロールアップを含むあらゆるEVMチェーンがこのプリコンパイルドコントラクトを簡単に統合できるようになります。

## 動機

"secp256r1"楕円曲線は、NISTによって標準化された曲線で、"ecrecover"プリコンパイルドコントラクトで使用されている"secp256k1"楕円曲線と同様の計算を行います。組み合わせ攻撃のコストと安全性条件はほぼ同じです。"ecrecover"に似たプリコンパイルドコントラクトを追加することで、"secp256r1"楕円曲線を使用した署名検証をスマートコントラクトで行うことができ、多くの利点が得られます。重要な要因の1つは、この曲線がAppleのSecure Enclave、Webauthn、AndroidKeyChainなどの多くの最新デバイスでサポートされており、ユーザーの採用が進んでいることです。さらに、このプリコンパイルドコントラクトの導入により、アカウントアブストラクションで有益な機能を実現できる可能性があり、モバイルデバイスでのトランザクション署名による効率的で柔軟なアカウント管理が可能になります。

ほとんどの最新デバイスやアプリケーションが"secp256r1"楕円曲線を使用しています。このプリコンパイルドコントラクトの追加により、デバイスネイティブのトランザクション署名メカニズムの検証が可能になります。例えば:

1. **Apple Secure Enclave:** Appleのハードウェアには、バイオメトリック認証でのみアクセスできる別の"Trusted Execution Environment"があり、任意のメッセージに署名できます。
2. **Webauthn:** Web Authentication (WebAuthn)は、World Wide Web Consortium (W3C)によって公開されたWebの標準です。WebAuthnは、公開鍵暗号を使用してWebベースのアプリケーションやサービスにユーザーを認証するインターフェイスの標準化を目指しています。ほとんどすべての最新Webブラウザで使用されています。
3. **Android Keystore:** Android KeystoreはAPIで、プライベートキーと署名方法を管理します。プライベートキーはKeystore使用時に処理されず、マイクロチップの"Trusted Execution Environment"で行うこともできます。
4. **Passkeys:** Passkeysは、FIDO Alliance とW3Cの標準を利用しています。パスワードを暗号化キーペアに置き換え、楕円曲線暗号にも使用できます。

最新のデバイスにはこれらの署名メカニズムが搭載されており、より安全に設計されています。トランザクションデータに署名できますが、現在のウォレットではこれらの署名メカニズムを活用していません。提案のプリコンパイルドコントラクトにより、これらの安全な署名方法をネイティブにデバイスから使用できるようになり、キー管理にも活用できます。この提案は、最大限のセキュリティと利便性を持つキー管理を目指しています。

## 仕様

この文書の中の "MUST"、"MUST NOT"、"REQUIRED"、"SHALL"、"SHALL NOT"、"SHOULD"、"SHOULD NOT"、"RECOMMENDED"、"NOT RECOMMENDED"、"MAY"、"OPTIONAL" は、RFC 2119およびRFC 8174に記載されている通りに解釈されるものとします。

統合されたEVMチェーンの `FORK_TIMESTAMP` 以降、`PRECOMPILED_ADDRESS` の `0x0b` アドレスに、"secp256r1"楕円曲線での署名検証を行う `P256VERIFY` プリコンパイルドコントラクトを追加します。

### 楕円曲線情報

"secp256r1"は、"P-256"や"prime256v1"としても知られる特定の楕円曲線です。この曲線は以下の方程式とドメインパラメータで定義されます:

```
# 曲線: 短いワイエルシュトラス形式
y^2 ≡ x^3 + ax + b

# p: 曲線の素数体のモジュラス
0xffffffff00000001000000000000000000000000ffffffffffffffffffffffff

# a: 楕円曲線の短いワイエルシュトラス形式の最初の係数
0xffffffff00000001000000000000000000000000fffffffffffffffffffffffc

# b: 楕円曲線の短いワイエルシュトラス形式の2番目の係数
0x5ac635d8aa3a93e7b3ebbd55769886bc651d06b0cc53b0f63bce3c3e27d2604b

# G: サブグループの基点
(0x6b17d1f2e12c4247f8bce6e563a440f277037d812deb33a0f4a13945d898c296,
 0x4fe342e2fe1a7f9b8ee7eb4a7c0f9e162bce33576b315ececbb6406837bf51f5)

# n: サブグループの位数(点の数)
0xffffffff00000000ffffffffffffffffbce6faada7179e84f3b9cac2fc632551

# h: サブグループの余因子
0x1

```

### 楕円曲線署名検証の手順

署名検証アルゴリズムは、署名されたメッセージハッシュ、"secp256r1"曲線アルゴリズムによって提供された署名コンポーネント、および署名者の秘密鍵から派生した公開鍵を入力として取ります。検証は以下の手順で行うことができます:

```
# h (メッセージハッシュ)
# pubKey = (署名者の秘密鍵から派生した公開鍵)

# 署名の証明の逆数を計算する:
s1 = s^(−1) (mod n)

# 署名時に使用されたランダムな点を復元する:
R' = (h * s1) * G + (r * s1) * pubKey

# R'のx座標を取得する:
r' = R'.x

# 以下を比較することで署名の検証結果を計算する:
r' == r

```

### 検証で必要なチェック

プリコンパイルドコントラクトは以下の要件を**必ず**チェックして、署名コンポーネントが有効であることを確認する必要があります:

- `r`と`s`の値が`(0, n)`の範囲(排他的)にあることを確認する。ここで`n`はサブグループの位数です。
- `(x, y)`で表される点が曲線上にあり、`x`と`y`が`[0, p)`の範囲(包括的0、排他的p)にあることを確認する。ここで`p`は素数体のモジュラスです。多くの実装では`(0, 0)`を無限遠点の参照点として使用しますが、これは曲線上にはないため、拒否する必要があります。

### プリコンパイルドコントラクトの仕様

提案の`P256VERIFY`プリコンパイルドコントラクトは、以下の入力と出力を持ちます。これらはすべてビッグエンディアンの値です:

- **入力データ:** 160バイトのデータ:
    - 署名されたデータ`hash`の32バイト
    - 署名の`r`コンポーネントの32バイト
    - 署名の`s`コンポーネントの32バイト
    - 公開鍵の`x`座標の32バイト
    - 公開鍵の`y`座標の32バイト
- **出力データ:** 32バイトの結果データとエラー
    - 署名検証プロセスが成功した場合、32バイトの形式で1を返します。

### プリコンパイルドコントラクトのガス使用量

`P256VERIFY`による署名検証のコストは`3450`ガスです。理由と計算については[根拠](#根拠)と[テストケース](#テストケース)のセクションで説明しています。

## 根拠

"secp256r1" ECDSA署名は、`v`、`r`、`s`の3つのコンポーネントで構成されます。`v`値は署名者の公開鍵を復元できますが、`r`と`s`があれば検証に十分なため、ほとんどの署名者は`v`コンポーネントを生成しません。正確で互換性の高い実装を提供するため、プリコンパイルではリカバリーではなく検証を選択しました。

既存のP256実装は`(x, y, r, s)`を直接検証します。ここでもこのスタイルに合わせました。これにより1. NIST仕様(NIST FIPS 186-5 Digital Signature Standard (DSS)で定義)に準拠し、2. (大規模な)P256エコシステムの残りの部分と一致し、最も重要なのは3. 実行クライアントが既存の十分に検証されたバリデーター実装とテストベクトルを使用できるようになります。

もう1つの重要な違いは、NIST FIPS 186-5仕様にはマレアビリティチェックが含まれていないことです。ここではNIST P-256エコシステムとの最大限の互換性を確保するため、それに合わせています。

ラッパーライブラリは**必ず**デフォルトでマレアビリティチェックを追加し、生のプリコンパイル呼び出し(NIST FIPS 186-5仕様、マレアビリティチェックなし)をラップする関数を明確に識別する必要があります。例えば、`P256.verifySignature`と`P256.verifySignatureWithoutMalleabilityCheck`です。マレアビリティチェックの追加は簡単で、ガス代もわずかです。

`PRECOMPILED_ADDRESS`は、プリコンパイルドアドレスセットの次の空きアドレスである`0x0b`に選択されました。

ガスコストは、`ECRECOVER`プリコンパイルドコントラクト(EVM上のアドレス`0x01`に実装)と`P256VERIFY`の性能を比較して提案しました。"secp256r1"署名検証は"secp256k1"署名リカバリーよりも約15%遅いことがわかったため(「[テストケース](#テストケース)」で詳述)、同様の"mgas/op"値を生成する`3450`ガスを提案しました。

## 下位互換性

プリコンパイルドコントラクトは、プリコンパイルドアドレスセットの次の空きアドレスに追加されるため、下位互換性の問題はありません。

## テストケース

[リファレンス実装](#リファレンス実装)の`P256VERIFY`プリコンパイルドコントラクトで、複数のケースの機能テストを実行し、成功しています。また、事前に計算されたデータと署名を使用して、"go-ethereum"のプリコンパイル・テスト構造でベンチマークテストも実行し、[リファレンス実装](#リファレンス実装)で実装された"secp256r1"署名検証のためのガスコストを提案しました。アセットのベンチマークテスト結果は以下のとおりです:

- [P256Verify ベンチマークテスト結果](../assets/eip-7212/p256Verify_benchmark_test)
- [Ecrecover ベンチマークテスト結果](../assets/eip-7212/ecrecover_benchmark_test)

```
# gethのベンチマークテスト結果
# ECRECOVER と P256VERIFY (リファレンス実装)
# benchstatツールによる

goos: darwin
goarch: arm64
pkg: github.com/ethereum/go-ethereum/core/vm
                                            │ compare_p256Verify │ compare_ecrecover  │
                                            │       sec/op       │   sec/op           │
PrecompiledP256Verify/p256Verify-Gas=3450-8          57.75µ ± 1%
PrecompiledEcrecover/-Gas=3000-8                                   50.48µ ± 1%
geomean                                              57.75µ        50.48µ

                                            │ compare_p256Verify │ compare_ecrecover  │
                                            │       gas/op       │   gas/op           │
PrecompiledP256
Verify/p256Verify-Gas=3450-8          3.450k ± 0%
PrecompiledEcrecover/-Gas=3000-8                                   3.000k ± 0%
geomean                                              3.450k        3.000k

                                            │ compare_p256Verify │ compare_ecrecover │
                                            │       mgas/s       │   mgas/s          │
PrecompiledP256Verify/p256Verify-Gas=3450-8           59.73 ± 1%
PrecompiledEcrecover/-Gas=3000-8                                   59.42 ± 1%
geomean                                               59.73        59.42

                                            │ compare_p256Verify │ compare_ecrecover │
                                            │        B/op        │    B/op           │
PrecompiledP256Verify/p256Verify-Gas=3450-8         1.523Ki ± 0%
PrecompiledEcrecover/-Gas=3000-8                                   800.0 ± 0%
geomean                                             1.523Ki        800.0

                                            │ compare_p256Verify │ compare_ecrecover │
                                            │     allocs/op      │ allocs/op         │
PrecompiledP256Verify/p256Verify-Gas=3450-8           33.00 ± 0%
PrecompiledEcrecover/-Gas=3000-8                                   7.000 ± 0%
geomean                                               33.00        7.000

```

## リファレンス実装

`P256VERIFY`プリコンパイルドコントラクトの実装は、go-ethereumクライアントに適用してリファレンスを作成しました。また、Besuネイティブライブラリにも"secp256r1"パッケージが含まれており、Besuクライアントで使用されています。その他のクライアント実装は今後の課題です。

## セキュリティ上の考慮事項

変更はプロトコルのセキュリティに直接影響するものではなく、`P256VERIFY`を署名検証に使用するアプリケーションに関連しています。"secp256r1"曲線は他の多くのプロトコルやサービスでも使用されており、過去にセキュリティ上の問題はありません。

## 著作権

著作権およびその関連権利は[CC0](../LICENSE.md)によって放棄されています。