---
original: 6324c6a709528776e07e17655d6c66349152b19c4094ff1c304397e0487cd3b2
---

---
eip: 3298
title: リファンドの削除
author: Vitalik Buterin (@vbuterin), Martin Swende (@holiman)
discussions-to: https://ethereum-magicians.org/t/eip-3298-removal-of-refunds/5430
status: 停滞
type: Standards Track
category: Core
created: 2021-02-26
---

## 簡単な要約

SSTORE と SELFDESTRUCT のガスリファンドを削除する。

## 動機

SSTORE と SELFDESTRUCT のガスリファンドは元々、アプリケーション開発者に「良好な状態の衛生」を実践するよう動機付けるために導入されました。つまり、不要になったストレージスロットやコントラクトをクリアすることです。しかし、この目的のために広く使われているわけではなく、状態の衛生不良が依然として一般的です。状態の成長に対する唯一の解決策は、何らかの形の[ステートレス化またはステート期限切れ](https://hackmd.io/@HWeNw8hNRimMm2m2GH56Cw/state_size_management)であると広く認められています。そのような解決策が実装されれば、使われなくなったストレージスロットやコントラクトは自動的に無視されるようになるでしょう。

ガスリファンドにはさらに、複数の有害な結果もあります:

* リファンドは [GasToken](https://gastoken.io/) の発生につながります。GasToken には低料金期間から高料金期間にガス容量を移動する利点がありますが、ネットワークにも弊害があります。特に状態サイズの悪化(状態スロットが「バッテリー」として使われ、非効率的にブロックチェーンのガス使用量を詰まらせる)に拍車をかけます。
* リファンドはブロックサイズのばらつきを増大させます。実際に消費されるガスの理論上の最大量は、オンペーパーのガスリミットのほぼ2倍になります(リファンドにより、ブロック内の後続のトランザクションにガス容量が追加されるためです。ただし、リファンドは取引のガス使用量の50%が上限です)。これは[致命的ではありません](https://notes.ethereum.org/@vbuterin/eip_1559_spikes)が、望ましくありません。特に、リファンドを使えば EIP 1559 よりも長期にわたって2倍の使用量のスパイクを維持できるためです。

## 仕様

### パラメータ

| 定数 | 値 |
| - | - |
| `FORK_BLOCK` | 未定 |

`block.number >= FORK_BLOCK` のブロックについては、以下の変更が適用されます。

`refund` は適用されません。 

上記の説明で変更内容は十分に説明できますが、明確にするために、現在ガスリファンドが使用されているすべての箇所と、ノード実装内で削除すべき/できるものを列挙します。

1. [EIP 2200](https://eips.ethereum.org/EIPS/eip-2200)で定義されている SSTORE ガス会計における「refund カウンター」の使用をすべて削除します。特に:

    * ストレージスロットが変更され、_現在の値_が_元の値_と等しいが_新しい値_と等しくない場合、`SSTORE_RESET_GAS`が差し引かれますが(さらに[EIP 2929のルールに従って](https://eips.ethereum.org/EIPS/eip-2929#sstore-changes)`COLD_SLOAD_COST`が加算される)、refund カウンターへの変更は行いません。
    * ストレージスロットが変更され、_現在の値_が_新しい値_でも_元の値_でもない場合(後者2つが等しいかどうかに関わらず)、`SLOAD_GAS`が差し引かれますが(さらに[EIP 2929のルールに従って](https://eips.ethereum.org/EIPS/eip-2929#sstore-changes)`COLD_SLOAD_COST`が加算される)、refund カウンターへの変更は行いません。

2. `SELFDESTRUCT` リファンドを削除します。

## 根拠

リファンドの完全な削除が、この問題を最も単純に解決する方法です。リファンド機構の一部を保持することによる利点は、イーサリアムプロトコルに残る複雑さに見合うものではありません。

## 下位互換性

現在、リファンドはトランザクション実行の_後_にのみ適用されるため、特定のコールフレームの実行中に利用可能なガス量に影響を与えることはありません。したがって、それらを削除しても、コードの実行能力は損なわれませんが、一部のアプリケーションが経済的に成り立たなくなるでしょう。

特に[GasToken](https://gastoken.io/)は無価値になります。DeFiのアービトラージボットは、これらの機能しなくなったガス保管メカニズムへの呼び出しを削除するようにコードを書き換える必要があるでしょう。

## 実装

実装例は以下にあります: https://gist.github.com/holiman/460f952716a74eeb9ab358bb1836d821#gistcomment-3642048

## テストケースの変更

* 「original」、「1st」、「2nd」、「3rd」の各列は、実行前後のストレージスロット0の値を示しています。
* 「Berlin (cold)」の列は、ストレージスロットがまだアクセスされていないと仮定した場合のポスト・Berlin (EIP 2929) ガスコストを示しています。
* 「Berlin (hot)」の列は、ストレージスロットがすでにアクセスされていると仮定した場合のポスト・Berlinガスコストを示しています。
* 「Berlin (hot) + norefund」の列は、ストレージスロットがすでにアクセスされていると仮定し、**さらにこのEIPが実装されていると仮定した**ポスト・Berlinガスコストを示しています。

ガスコストはリファンドを差し引いた値で示されています。数値がマイナスの場合は、リファンドがガスコストを上回っていることを意味します(50%のリファンド上限は適用されていません)。

リファンドが削除された場合の比較表は以下のようになります。

| コード | Original | 1st | 2nd | 3rd |  Istanbul | Berlin (cold) | Berlin (hot)| Berlin (hot)+norefund |
| -- | -- | -- | -- | -- |  -- | -- | -- | -- | 
| `0x60006000556000600055` | 0 |  0 |  0 |  |  1612 | 2312 | 212 | 212 |
| `0x60006000556001600055` | 0 |  0 |  1 |  |  20812 | 22212 | 20112 | 20112 |
| `0x60016000556000600055` | 0 |  1 |  0 |  |  1612 | 2312 | 212 | 20112 |
| `0x60016000556002600055` | 0 |  1 |  2 |  |  20812 | 22212 | 20112 | 20112 |
| `0x60016000556001600055` | 0 |  1 |  1 |  |  20812 | 22212 | 20112 | 20112 |
| `0x60006000556000600055` | 1 |  0 |  0 |  |  -9188 | -9888 | -11988 | 3012 |
| `0x60006000556001600055` | 1 |  0 |  1 |  |  1612 | 2312 | 212 | 3012 |
| `0x60006000556002600055` | 1 |  0 |  2 |  |  5812 | 5112 | 3012 | 3012 |
| `0x60026000556000600055` | 1 |  2 |  0 |  |  -9188 | -9888 | -11988 | 3012 |
| `0x60026000556003600055` | 1 |  2 |  3 |  |  5812 | 5112 | 3012 | 3012 |
| `0x60026000556001600055` | 1 |  2 |  1 |  |  1612 | 2312 | 212 | 3012 |
| `0x60026000556002600055` | 1 |  2 |  2 |  |  5812 | 5112 | 3012 | 3012 |
| `0x60016000556000600055` | 1 |  1 |  0 |  |  -9188 | -9888 | -11988 | 3012 |
| `0x60016000556002600055` | 1 |  1 |  2 |  |  5812 | 5112 | 3012 | 3012 |
| `0x60016000556001600055` | 1 |  1 |  1 |  |  1612 | 2312 | 212 | 212 |
| `0x600160005560006000556001600055` | 0 |  1 |  0 |  1 |  21618 | 22318 | 20218 | 40118 |
| `0x600060005560016000556000600055` | 1 |  0 |  1 |  0 |  -8382 | -9782 | -11882 | 5918 |

## セキュリティ上の考慮事項

未定

## 著作権
[CC0](../LICENSE.md)によりコピーライトおよび関連権利が放棄されています。