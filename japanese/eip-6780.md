---
original: 3941eed8379cc93abb7342c5b186bd883e8b1518b0025d94a49be068f8ea2101
---

---
eip: 6780
title: SELFDESTRUCT は同一トランザクション内でのみ
description: SELFDESTRUCT は全ての資金をターゲットに回収しますが、同一トランザクション内での作成時を除いてアカウントを削除しません
author: Guillaume Ballet (@gballet), Vitalik Buterin (@vbuterin), Dankrad Feist (@dankrad)
discussions-to: https://ethereum-magicians.org/t/deactivate-selfdestruct-except-where-it-occurs-in-the-same-transaction-in-which-a-contract-was-created/13539
status: Final
type: Standards Track
category: Core
created: 2023-03-25
requires: 2681, 2929, 3529
---

## 概要

このEIPは、`SELFDESTRUCT`オペコードの機能を変更します。新しい機能は、アカウントにある全てのイーサを送金することのみとなりますが、`SELFDESTRUCT`が同一トランザクション内でコントラクトが作成された際に呼び出された場合は、従来の動作が維持されます。

## 動機

`SELFDESTRUCT`オペコードは、アカウントの状態に大きな変更を加えます。特に、全てのコードとストレージを削除します。これは、Verkleツリーの将来的な実装では不可能になるでしょう: 各アカウントは多数の異なるアカウントキーに格納されるため、ルートアカウントとの明確な関連付けができなくなります。

このEIPはこの変更を実装します。`SELFDESTRUCT`を資金回収のみに使用するアプリケーションは引き続き動作します。`SELFDESTRUCT`をコントラクト作成と同一トランザクション内でのみ使用するアプリケーションも、変更なしに動作し続けます。

## 仕様

`SELFDESTRUCT`の動作は以下のように変更されます:

1. `SELFDESTRUCT`が、コントラクトの作成と同一トランザクション内で実行されない場合:

   - 現在の実行フレームが停止します。
   - `SELFDESTRUCT`はデータ(ストレージキー、コード、アカウント自体を含む)を削除しません。
   - `SELFDESTRUCT`は、アカウントの全ての残高をターゲットに送金します。
   - ターゲットがSELFDESTRUCTを呼び出すコントラクトと同じ場合、残高に純粋な変化はありません。以前の仕様とは異なり、イーサは焼却されません。
   - [EIP-3529](./eip-3529.md)により、リファンドは付与されません。
   - [EIP-2929](./eip-2929.md)の`SELFDESTRUCT`に関する規則は変更されません。
  
2. `SELFDESTRUCT`がコントラクト作成と同一トランザクション内で実行された場合:

   - `SELFDESTRUCT`は、このEIP以前の動作を継続します。これには以下の行動が含まれます:
     - 現在の実行フレームが停止します。
     - `SELFDESTRUCT`は以前指定されていた通りにデータを削除します。
     - `SELFDESTRUCT`は、アカウントの全ての残高をターゲットに送金します。
     - `SELFDESTRUCT`を呼び出したコントラクトのアカウント残高は0に設定されます。
   - ターゲットが`SELFDESTRUCT`を呼び出すコントラクトと同じ場合、イーサが焼却されます。
   - [EIP-3529](./eip-3529.md)により、リファンドは付与されません。
   - [EIP-2929](./eip-2929.md)の`SELFDESTRUCT`に関する規則は変更されません。

コントラクトは、create トランザクションの開始時、またはCREATE、CREATE2、将来的に登場するコントラクトをデプロイするその他の操作の実行開始時に作成されたと見なされます。新しいアドレスにすでに残高がある場合も、コントラクト作成と見なされます。

`SELFDESTRUCT`オペコードは、[EIP-6049](./eip-6049.md)で指定されているように非推奨のままです。新しくデプロイされるコントラクトでの使用は強く推奨されません。将来的なEVMの変更により、オペコードの機能がさらに制限される可能性があります。

## 根拠

`SELFDESTRUCT`オペコードの廃止が過去に検討されており、現時点では強い理由がありません。このEIPは、EVM実装に必要な変更の複雑さを軽減しつつ、`SELFDESTRUCT`の一般的な使用例の一部を機能させるための動作を実装します。

アカウントの作成とコントラクトの作成を明確に区別することは、カウンターファクチュアルアカウントのようなユースケースに必要です。コントラクト作成時に`SELFDESTRUCT`でアカウントを削除できるようにすることで、コントラクト作成前にオンチェーンの状態を持たない(ただし残高のみを持つ)カウンターファクチュアルにインスタンス化されたコントラクトのスタブが残らなくなります。これらのアカウントには決してストレージがなく、アカウントノードの削除のみが必要となるため、通常のイーサ送金と同等の影響となります。

## 後方互換性

このEIPはコンセンサスルールを変更するため、ハードフォークが必要です。

`CREATE2`を使ってSELFDESTRUCTの後に同じアドレスにコントラクトを再デプロイしていたアプリケーションは、作成トランザクション内で`SELFDESTRUCT`を呼び出さない限り、正しく機能しなくなります。

以前は、`SELFDESTRUCT`の受取人をコントラクト自身に指定することで、イーサを焼却できました。コントラクトがトランザクション前に存在していた場合、イーサは焼却されません。コントラクトがトランザクション内で新規作成された場合のみ、以前と同様にイーサが焼却されます。

## テストケース

このEIPのテストケースは、Execution Spec Tests suiteの [`eip6780_selfdestruct`](https://github.com/ethereum/execution-spec-tests/tree/1983444bbe1a471886ef7c0e82253ffe2a4053e1/tests/cancun/eip6780_selfdestruct)にあります。

## セキュリティ上の考慮事項

以下のような`SELFDESTRUCT`の使用方法は破壊され、これらを使用するアプリケーションは安全ではなくなります:

1. `CREATE2`を使ってコントラクトを同じ場所に再デプロイし、コントラクトをアップグレード可能にする場合。これはサポートされなくなり、代わりに[ERC-2535](./eip-2535.md)やその他のプロキシコントラクトを使用する必要があります。

2. コントラクト自身を受取人としてSELFDESTRUCTを呼び出すことでイーサを焼却していたコントラクト。同一トランザクション内で作成されていないコントラクトでは、これはサポートされなくなります。

## 著作権

著作権およびそれに関連する権利は[CC0](../LICENSE.md)で放棄されています。