---
original: 332d4fb34ab7005ed5ea9dd8c05366d46702729b06a4d0ddf34f8ad79ea0cd07
---

---
eip: 5027
title: コントラクトコードサイズの制限の撤廃
description: コントラクトサイズの制限を24576から無制限に変更する
author: Qi Zhou (@qizhou)
discussions-to: https://ethereum-magicians.org/t/eip-5027-unlimit-contract-code-size/9010
status: 停滞
type: Standards Track
category: Core
created: 2022-04-21
requires: 170, 2929, 2930
---


## 概要

コントラクトコードサイズの制限を撤廃し、ブロックガス制限のみでコントラクトコードサイズを制限する。既存のコードに最小限の変更を加え、潜在的な攻撃を回避するためのガスメーターの調整を行う。


## 動機

動機は、ユーザーが大規模なコントラクトをサブコントラクトに分割することなく展開できるように、コードサイズの制限を撤廃することです。

dアプリケーションの急速な成長に伴い、スマートコントラクトの機能がますます複雑になり、新しく開発されたコントラクトのサイズも着実に増加しています。その結果、24576バイトのコントラクトサイズ制限に関する問題に直面しています。大規模なコントラクトを複数のサブコントラクトに分割するなどの手法で問題を緩和することができますが、これらの手法はスマートコントラクトの開発、展開、メンテナンスの負担を増やします。

本提案は、既存の24576バイトのコードサイズ制限を撤廃するソリューションを実装します。さらに、
- `CODESIZE (0x38)/CODECOPY (0x39)/EXTCODESIZE (0x3B)/EXTCODECOPY (0x3C)/EXTCODEHASH (0x3F)/DELEGATECALL (0xF4)/CALL (0xF1)/CALLCODE (0xF2)/STATICCALL (0xFA)/CREATE (0xF0)/CREATE2 (0xF5)` などのコントラクト関連のオペコードに適切なガスメーターを設定して、ノードリソースの濫用を回避し、
- 既存のイーサリアムステートの構造に変更を加えないことを目的としています。


## 仕様

### パラメータ

| 定数                      | 値              |
| ------------------------- | ---------------- |
| `FORK_BLKNUM`             | 未定             |
| `CODE_SIZE_UNIT`          | 24576            |
| `COLD_ACCOUNT_CODE_ACCESS_COST_PER_UNIT`  | 2600             |
| `CREATE_DATA_GAS`         | 200              |

`block.number >= FORK_BLKNUM`の場合、コントラクト作成の初期化では任意の長さのデータを返すことができますが、コントラクト関連のオペコードには以下のように追加のガスが必要になります:

- `CODESIZE/CODECOPY/EXTCODESIZE/EXTCODEHASH`のガスは変更されません。

- `CREATE/CREATE2`の場合、新しく作成されたコントラクトのサイズが`CODE_SIZE_UNIT`を超える場合、オペコードには以下の追加の書き込みガスが必要になります:

`(CODE_SIZE - CODE_SIZE_UNIT) * CREATE_DATA_GAS`.

- `EXTCODECOPY/CALL/CALLCODE/DELEGATECALL/STATICCALL`の場合、コントラクトコードサイズが`CODE_SIZE_UNIT`を超える場合、オペコードには以下の追加のガスが必要になります:

```
(CODE_SIZE - 1) // CODE_SIZE_UNIT * COLD_ACCOUNT_CODE_ACCESS_COST_PER_UNIT
```

ただし、コントラクトが`accessed_code_in_addresses`に含まれる場合は0になります。ここで`//`は整数除算演算子で、`accessed_code_in_addresses: Set[Address]`はトランザクションコンテキスト全体で共有される`access_addresses`と`accessed_storage_keys`に似たセットです。

トランザクション実行の開始時に、`accessed_code_in_addresses`には`tx.sender`、`tx.to`、およびすべてのプリコンパイルが含まれます。

`CREATE/CREATE2/EXTCODECOPY/CALL/CALLCODE/DELEGATECALL/STATICCALL`が呼び出されたら、即座にそのアドレスを`accessed_code_in_addresses`に追加します。

## 根拠

### ガスメーター
目的は、既存のガスメーターを再利用して、コントラクトの読み書き操作のCPU/IOコストを測定し、リソースの濫用を防ぐことです。

- コードサイズ関連のオペコード(`CODESIZE`/`EXTCODESIZE`)では、クライアントがコードのハッシュからサイズへのマッピングを実装しているため、大規模なコントラクトのコードサイズを読み取るのはO(1)になると期待されます。

- `CODECOPY`の場合、データはすでに`CALL/CALLCODE/DELEGATECALL/STATICCALL`の一部としてメモリにロードされているため、追加のガスは必要ありません。

- `EXTCODEHASH`の場合、値はすでにアカウントに存在するため、追加のガスは必要ありません。

- `EXTCODECOPY/CALL/CALLCODE/DELEGATECALL/STATICCALL`の場合、データベースから追加のデータを読み取るため、`COLD_ACCOUNT_CODE_ACCESS_COST_PER_UNIT`を`CODE_SIZE_UNIT`ごとに追加で請求します。

- `CREATE/CREATE2`の場合、データベースに追加のデータを作成するため、`CREATE_DATA_GAS`を追加のバイト数ごとに請求します。


## 下位互換性

既存のすべてのコントラクトには本提案の影響はありません。

[EIP-170](./eip-170.md)以前にデプロイされたコントラクトのみが現在の最大コードサイズを超える可能性がありますが、リファレンス実装はそれらのブロックをすべて正常にインポートできました。

## リファレンス実装

Gethのリファレンス実装は[0001-unlimit-code-size.patch](../assets/eip-5027/0001-unlimit-code-size.patch)にあります。

## セキュリティ上の考慮事項
未定

## 著作権
[CC0](../LICENSE.md)によりすべての著作権およびそれに関連する権利が放棄されています。