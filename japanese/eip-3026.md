---
original: 55db19eaf3a114ddfeae34028d2641d3658e15da69d852f263360a5f39d352fe
---

---
eip: 3026
title: BW6-761曲線演算
description: BW6-761曲線演算のプリコンパイル
author: Youssef El Housni (@yelhousni)、Michael Connor (@iAmMichaelConnor)、Aurore Guillevic <aurore.guillevic@inria.fr>、hujw77 (@hujw77)
discussions-to: https://ethereum-magicians.org/t/eip-3026-bw6-761-curve-operations/4790
status: 停滞
type: Standards Track
category: Core
created: 2020-10-05
requires: 2539
---

## 概要

このプリコンパイルは、EY/Inria研究論文「Optimized and secure pairing-friendly elliptic curves suitable for one layer proof composition」で紹介されているBW6-761曲線の演算をプリコンパイルとして追加します。これは、1層構成のzkSNARKs証明の検証を効率的に行うために必要な一連の演算を提供します。
`block.number >= X`の場合、以下の7つのプリコンパイルを導入します(アドレスは後で決定されます):

- BW6_G1_ADD - 素数体上の曲線上の点加算を実行する
- BW6_G1_MUL - 素数体上の曲線上の点乗算を実行する
- BW6_G1_MULTIEXP - 素数体上の曲線上の多重指数計算を実行する
- BW6_G2_ADD - 素数体の基底上の曲線の双対上の点加算を実行する
- BW6_G2_MUL - 素数体の基底上の曲線の双対上の点乗算を実行する
- BW6_G2_MULTIEXP - 素数体の基底上の曲線の双対上の多重指数計算を実行する
- BW6_PAIRING - (G1, G2)点の組のペアリング演算を実行する

多重指数計算は点乗算の一般化ですが、単一のMULをMULTIEXPで実行するよりも20%高コストになるため、別のプリコンパイルを提案しています。

## 動機

このEIPはmatter-labsの提案を置き換えるものですが、大幅なパフォーマンス向上が見込めます。ほとんどのアプリケーションでは、BW6-761がBLS12-377([EIP-2539](./eip-2539.md)で検討)の外側の曲線として使用されます。
このプリコンパイルの動機は、SNARK証明の1層構成を効率的に行えるようにすることです。現在これはZexeがBLS12-377/CP6-782曲線ペアを使って行っています。このプリコンパイルはCP6-782をBW6-761に置き換えることを提案しており、これにより非常に高速な演算が可能になります。例えば、Groth16証明をBW6-761で検証するのはCP6-782の30倍速いことが示されています。

### 提案されるアドレステーブル

| プリコンパイル | アドレス |
| -------------- | ------- |
| BW6_G1_ADD     | 0x1e    |
| BW6_G1_MUL     | 0x1f    |
| BW6_G1_MULTIEXP| 0x20    |
| BW6_G2_ADD     | 0x21    |
| BW6_G2_MUL     | 0x22    |
| BW6_G2_MULTIEXP| 0x23    |
| BW6_PAIRING    | 0x24    |

## 仕様

曲線パラメータ:

BW6-761 `y^2=x^3-1`曲線は以下のパラメータで完全に定義されます:

```
基底体のモジュラス = 0x122e824fb83ce0ad187c94004faff3eb926186a81d14688528275ef8087be41707ba638e584e91903cebaff25b423048689c8ed12f9fd9071dcd3dc73ebff2e98a116c25667a8f8160cf8aeeaf0a437e6913e6870000082f49d00000000008b
A係数 = 0x0
B係数 = 0x122e824fb83ce0ad187c94004faff3eb926186a81d14688528275ef8087be41707ba638e584e91903cebaff25b423048689c8ed12f9fd9071dcd3dc73ebff2e98a116c25667a8f8160cf8aeeaf0a437e6913e6870000082f49d00000000008a
主部分群位数 = 0x1ae3a4617c510eac63b05c06ca1493b1a22d9f300f5138f1ef3622fba094800170b5d44300000008508c00000000001
拡張タワー:
Fp3の構成: (Fp3 = Fp[u]/u^3+4)
Fp3の3次非剰余元 = 0x122e824fb83ce0ad187c94004faff3eb926186a81d14688528275ef8087be41707ba638e584e91903cebaff25b423048689c8ed12f9fd9071dcd3dc73ebff2e98a116c25667a8f8160cf8aeeaf0a437e6913e6870000082f49d000000000087
双対曲線パラメータ:
双対曲線の種類: M
双対曲線のA係数 c0 = 0x0
                 c1 = 0x0
双対曲線のB係数 c0 = 0x4
                 c1 = 0x0
ジェネレータ:
G1:
X = 0x1075b020ea190c8b277ce98a477beaee6a0cfb7551b27f0ee05c54b85f56fc779017ffac15520ac11dbfcd294c2e746a17a54ce47729b905bd71fa0c9ea097103758f9a280ca27f6750dd0356133e82055928aca6af603f4088f3af66e5b43d
Y = 0x58b84e0a6fc574e6fd637b45cc2a420f952589884c9ec61a7348d2a2e573a3265909f1af7e0dbac5b8fa1771b5b806cc685d31717a4c55be3fb90b6fc2cdd49f9df141b3053253b2b08119cad0fb93ad1cb2be0b20d2a1bafc8f2db4e95363
G2:
X = 0x110133241d9b816c852a82e69d660f9d61053aac5a7115f4c06201013890f6d26b41c5dab3da268734ec3f1f09feb58c5bbcae9ac70e7c7963317a300e1b6bace6948cb3cd208d700e96efbc2ad54b06410cf4fe1bf995ba830c194cd025f1c
Y = 0x17c3357761369f8179eb10e4b6d2dc26b7cf9acec2181c81a78e2753ffe3160a1d86c80b95a59c94c97eb733293fef64f293dbd2c712b88906c170ffa823003ea96fcd504affc758aa2d3a3c5a02a591ec0594f9eac689eb70a16728c73b61
ペアリングパラメータ:
e(P,Q)=(ML1(P,Q)*ML2(P,Q)^q)^FE
|loop_count_1| (第1ミラーループML1のカウント) = 0x8508c00000000002
|loop_count_2| (第2ミラーループML2のカウント) = 0x23ed1347970dec008a442f991fffffffffffffffffffffff
loop_count_1は負ではない
loop_count_2は負ではない
```

### エンコーディング

#### 体要素のエンコーディング:

演算に関与する点をエンコードするには、基底体の要素のみをエンコードする必要があります。

基底体要素(Fp)は、対応する(符号なし)整数のビッグエンディアン符号化により96バイトでエンコードされます。対応する整数は**必ず**基底体のモジュラスより小さくなければなりません。

エンコーディングがどこかでこの仕様に従っていない場合、プリコンパイルは"エンコーディングエラー"でリバートしなければなりません。

#### 非圧縮点のエンコーディング:

G1およびG2の点は、アフィン座標`(x, y)`で表現できます。ここで`x`と`y`は基底体の要素です。
したがって、G1およびG2の点は、アフィン座標`x`と`y`の体要素エンコーディングを連結したものでエンコードされます。G1/G2点の総エンコーディング長は192バイトです。

#### 無限遠点のエンコーディング:

"ゼロ点"とも呼ばれます。BW6-761(`y^2=x^3-1`)およびそのM双対曲線(`y^3=x^3+4`)では、座標`(0, 0)`(Fpの形式的ゼロ)は曲線上にはなく、`(0, 0)`のエンコーディングは無限遠点をエンコードするための規約として使用されます。

#### 乗算および多重指数計算演算のスカラーのエンコーディング:

乗算および多重指数計算演算では、スカラーは対応する(符号なし)整数のビッグエンディアン符号化により64バイトでエンコードされます。

BW6-761の主部分群位数は実際には377ビット(48バイト)しかありませんが、32バイトアラインのABI(例えば`bytes32[2]`や`uint256[2]`で表現可能)を持つために64バイトのエンコーディングが選択されています。

対応する整数は**かもしれない**主部分群位数を超えることがあります。

### 演算のABI

#### G1加算のABI

G1加算呼び出しでは、384バイトの入力を受け取り、それはG1点のエンコーディング(それぞれ192バイト)の連結として解釈されます。出力は加算演算の結果のポイントエンコーディングです。

エラーケース:

- 点のいずれかが曲線上にない
- 入力長が無効
- 体要素エンコーディングルールが適用される(当然)

#### G1乗算のABI

G1乗算呼び出しでは、256バイトの入力を受け取り、それはG1点のエンコーディング(192バイト)とスカラー値のエンコーディング(64バイト)の連結として解釈されます。出力は乗算演算の結果のポイントエンコーディングです。

エラーケース:

- 点が曲線上にない
- 入力長が無効
- 体要素エンコーディングルールが適用される(当然)
- スカラーエンコーディングルールが適用される(当然)

#### G1多重指数計算のABI

G1多重指数計算呼び出しでは、256*kバイトの入力を受け取り、それはk個のスライスの連結として解釈されます。各スライスはG1点のエンコーディング(192バイト)とスカラー値のエンコーディング(64バイト)の連結です。出力は多重指数計算演算の結果のエンコーディングです。

エラーケース:

- G1点のいずれかが曲線上にない
- 入力長が無効
- 体要素エンコーディングルールが適用される(当然)
- スカラーエンコーディングルールが適用される(当然)

#### G2加算のABI

G2加算呼び出しでは、384バイトの入力を受け取り、それはG2点のエンコーディング(それぞれ192バイト)の連結として解釈されます。出力は加算演算の結果のポイントエンコーディングです。

エラーケース:

- 点のいずれかが曲線上にない
- 入力長が無効
- 体要素エンコーディングルールが適用される(当然)

#### G2乗算のABI

G2乗算呼び出しでは、256バイトの入力を受け取り、それはG2点のエンコーディング(192バイト)とスカラー値のエンコーディング(64バイト)の連結として解釈されます。出力は乗算演算の結果のエンコーディングです。

エラーケース:

- 点が曲線上にないとエラーになる
- 体要素エンコーディングルールが適用される(当然)
- 入力長が無効

#### G2多重指数計算のABI

G2多重指数計算呼び出しでは、240*kバイトの入力を受け取り、それはG2点のエンコーディング(192バイト)とスカラー値のエンコーディング(48バイト)の連結であるkスライスの連結として解釈されます。出力は多重指数計算演算の結果のエンコーディングです。

エラーケース:

- G2点のいずれかが曲線上にないとエラーになる
- 体要素エンコーディングルールが適用される(当然)
- 入力長が無効

#### ペアリングのABI

ペアリング呼び出しでは、384*kバイトの入力を受け取り、それはkスライスの連結として解釈されます。各スライスは以下の構造を持ちます:

- 192バイトのG1点エンコーディング
- 192バイトのG2点エンコーディング


出力は32バイトの真偽値:

- ペアリング結果がペアリング目標体の乗法単位元と等しい場合は`0x0000000000000000000000000000000000000000000000000000000000000001`
- そうでない場合は`0x0000000000000000000000000000000000000000000000000000000000000000`

エラーケース:

- G1またはG2点のいずれかが曲線上にない
- G1またはG2点のいずれかが正しい部分群にない
- 入力長が無効
- 体要素エンコーディングルールが適用される(当然)

### エラー処理によるDDoS攻撃の防止

このプリコンパイルは大規模な計算を行うため、実行中にエラーが発生した場合は**必ず**対応する操作のガススケジュールからすべてのガスを消費しなければなりません。

### ガススケジュール

#### G1加算

180ガス

#### G1乗算

64000ガス

#### G2加算

180ガス

#### G2乗算

64000ガス

#### G1/G2多重指数計算

ディスカウントテーブルは`[k, discount]`のペアのベクトルです:

```
[[1, 1266], [2, 733], [3, 561], [4, 474], [5, 422], [6, 387], [7, 362], [8, 344], [9, 329], [10, 318], [11, 308], [12, 300], [13, 296], [14, 289], [15, 283], [16, 279], [17, 275], [18, 272], [19, 269], [20, 266], [21, 265], [22, 260], [23, 259], [24, 256], [25, 255], [26, 254], [27, 252], [28, 251], [29, 250], [30, 249], [31, 249], [32, 220], [33, 228], [34, 225], [35, 223], [36, 219], [37, 216], [38, 214], [39, 212], [40, 209], [41, 209], [42, 205], [43, 203], [44, 202], [45, 200], [46, 198], [47, 196], [48, 199], [49, 195], [50, 192], [51, 192], [52, 191], [53, 190], [54, 187], [55, 186], [56, 185], [57, 184], [58, 184], [59, 181], [60, 181], [61, 181], [62, 180], [63, 178], [64, 179], [65, 176], [66, 177], [67, 176], [68, 175], [69, 174], [70, 173], [71, 171], [72, 171], [73, 170], [74, 170], [75, 169], [76, 168], [77, 168], [78, 167], [79, 167], [80, 166], [81, 165], [82, 167], [83, 166], [84, 166], [85, 165], [86, 165], [87, 164], [88, 164], [89, 163], [90, 163], [91, 162], [92, 162], [93, 160], [94, 163], [95, 159], [96, 162], [97, 159], [98, 160], [99, 159], [100, 159], [101, 158], [102, 158], [103, 158], [104, 158], [105, 157], [106, 157], [107, 156], [108, 155], [109, 155], [110, 156], [111, 155], [112, 155], [113, 154], [114, 155], [115, 154], [116, 153], [117, 153], [118, 153], [119, 152], [120, 152], [121, 152], [122, 152], [123, 151], [124, 151], [125, 151], [126, 151], [127, 151], [128, 150]]
```

`max_discount = 150`

#### ペアリング演算

ペアリング演算の基本コストは`120000*k + 320000`で、`k`はペアの数です。

## 根拠

ガスコストは[EIP-1962](./eip-1962.md)の推定戦略に基づいていますが(まだABIの解析、結果のデコーディングとエンコーディングを完全に含んでいません)。

### ガス見積もり戦略

ガスコストは、同じ操作の異なる実装の平均タイミングを取り、`30 MGas/second`の一定値を仮定して導出されています。実行時間はマシン依存なので、この一定値は*ECRECOVER*と*BNPAIR*プリコンパイルの実行時間と提案されたガス価格(`43.5 MGas/s`for ECRECOVER、`16.5 MGas/s`for BNPAIR)に基づいて決定されています。プリコンパイル操作のタイミング測定方法は以下の通りです:

- G1加算: 1000個のランダムサンプルの平均タイミング
- G1乗算: 最悪ケースのランダムサンプル(最大ビット長、最大ハミング重み、ランダムG1基底点)の1000個の平均タイミング
- G2加算: 1000個のランダムサンプルの平均タイミング
- G2乗算: 最悪ケースのランダムサンプル(最大ビット長、最大ハミング重み、ランダムG2基底点)の1000個の平均タイミング
- G1およびG2多重指数計算: ペッピンガーアルゴリズムを使用すると予想されます。`k <= 128`の場合の割引テーブルを準備し、`k > 128`の場合の割引上限を`max_discount`とします。非整数演算を避けるため、呼び出しコストは`k * 乗算コスト * 割引 / 乗数`で計算されます。ここで`乗数 = 1000`、`k`は(スカラー、点)ペアの数、`乗算コスト`は対応するG1/G2の単一乗算呼び出しコストです。
- ペアリング: 線形リフティングを使った1000個のランダムサンプル(G1とG2のランダムな点)の平均タイミング。ペアの数は異なる。

### 多重指数計算を別の呼び出しとして

(ペッピンガーアルゴリズムを使う)多重指数計算の明示的な別呼び出しにより、実行時間(つまりガス)を節約できます。さらに、Ethereumの`CALL`操作が高コストであることを忘れがちですが(現時点で)、100点の多重指数計算を100回の乗算プリコンパイルと99回の加算で行うよりも(約138600ガスを節約できます)。

### 明示的な部分群チェック

G2部分群チェックはG1部分群チェックと同じコストです。エンドモルフィズムを利用して最適化できます。

## 下位互換性

下位互換性の問題はありません。

## テストケース

広大なテストパラメータ空間のため、まず様々な操作が満たすべき性質を示します。点演算には加法記法を使い、点には大文字(`P`、`Q`)、スカラーには小文字(`a`、`b`)を使います。G1のジェネレータは`G`、G2のジェネレータは`H`、それ以外はランダムな曲線上の点とします。`0`はスカラーゼロまたは無限遠点、`1`はスカラー1または乗法単位元を意味します。`group_order`は主部分群位数です。`e(P, Q)`はPがG1、QがG2の点のペアリング演算を意味します。

基本演算(加算/乗算)に必要な性質:

- 可換性: `P + Q = Q + P`
- 加法逆元: `P + (-P) = 0`
- 倍加: `P + P = 2*P`
- 部分群チェック: `group_order * P = 0`
- 単位乗算チェック: `1 * P = P`
- ゼロ乗算: `0 * P = 0`
- 正規化されていないスカラーによる乗算: `(scalar + group_order) * P = scalar * P`

ペアリング演算に必要な性質:

- 縮退性: `e(P, 0*Q) = e(0*P, Q) = 1`
- 双線形性: `e(a*P, b*Q) = e(a*b*P, Q) = e(P, a*b*Q)`(内部テスト、ABIからは見えない)

## 参考実装

いくつかの選択肢があります:

**ライブラリ:**

- Rust実装(EY/Zexe): github.com/yelhousni/zexe/tree/youssef/BW6-761-Fq-ABLR-2ML-M
- C++実装(EY/libff): github.com/EYBlockchain/zk-swap-libff
- Go実装(Consensys/gurvy): github.com/ConsenSys/gurvy

**スタンドアロン実装:**

- Intel アセンブリ付きGo実装(Onur Kilic): github.com/kilic/bw6

**プリコンパイル:**

- OpenEthereum(EY/Parity): github.com/EYBlockchain/solidity-elliptic-curves
- Frontier(Parity): github.com/paritytech/frontier/pull/1049/files

**スクリプト:**

- SageMathとMagmaスクリプト: gitlab.inria.fr/zk-curves/bw6-761/

## セキュリティ上の考慮事項

仕様を厳密に従えば、BN254プリコンパイルとは対照的に、セキュリティ上の影響や合意上の影響はありません。

重要なトピックは、実行された操作の"一定時間"特性です。このプリコンパイルは**一定時間アルゴリズムを使用する必要はありません**と明示的に述べています。

## 著作権

著作権およびそれに関連する権利は[CC0](../LICENSE.md)で放棄されています。