---
original: dff418f1ed441352ee656eb5ba1d96c12acdefc788251e4d63149cfb442fba07
---

---
eip: 3541
title: 0xEFバイトで始まる新しいコントラクトコードの拒否
author: Alex Beregszaszi (@axic)、Paweł Bylica (@chfast)、Andrei Maiboroda (@gumb0)、Alexey Akhunov (@AlexeyAkhunov)、Christian Reitwiessner (@chriseth)、Martin Swende (@holiman)
discussions-to: https://ethereum-magicians.org/t/evm-object-format-eof/5727
status: 最終
type: 標準トラック
category: コア
created: 2021-03-16
---

## 概要

`0xEF`バイトで始まる新しいコードの展開を禁止する。アカウントトライに既に存在する`0xEF`バイトで始まるコードはこの変更の影響を受けない。

## 動機

EVM Object Format (EOF)に準拠するコントラクトは、展開時に検証されます。状態内のすべてのEOF形式のコントラクトが有効であることを保証するために、すでに展開されている(検証されていない)コントラクトがそのフォーマットとして認識されるのを防ぐ必要があります。これは、*マジック*のバイトシーケンスを、すでに展開されているコントラクトに存在しないものを選択することで実現されます。検索スペースの成長を防ぎ、この fork 以前に存在するコントラクトのみを分析の対象とするために、フォーマットの先頭バイト(マジックの最初のバイト)の展開を禁止します。

将来EVM Object Formatの提案が展開されない場合、*マジック*は他のバージョン管理に依存する機能によって使用される可能性があります。バージョン管理が時代遅れになった場合、`0xEF`バイトで始まるコントラクトの展開を再び許可することで簡単にロールバックできます。

## 仕様

`block.number == HF_BLOCK`以降、新しいコントラクトの作成(create transaction、`CREATE`または`CREATE2`命令を介して)は、_code_の最初のバイトが`0xEF`の場合、例外的な中断が発生します。

### 備考

*initcode*は、*create*トランザクション、`CREATE`、または`CREATE2`命令のコンテキストで実行されるコードです。*initcode*は*code*(`RETURN`命令を介して)を返し、それがアカウントに挿入されます。詳細については、イエローペーパーのセクション7(「コントラクトの作成」)を参照してください。

オペコード`0xEF`は現在未定義の命令であるため、*It pops no stack items and pushes no stack items, and it causes an exceptional abort when executed.*つまり、*initcode*または既に展開された*code*がこの命令で始まる場合、実行が中断されます。

`0xEF`で始まる*code*による例外的な中断は、*initcode*実行中に発生する可能性のある他の例外的な中断と全く同じ動作をします。つまり、中断が発生した場合、`CREATE*`または create transactionに提供されたガス全体が消費されます。

## 根拠

`0xEF`バイトは**E**xecutable **F**ormatを連想させるため選択されました。

未割り当てのオペコードを使用するコントラクトは、一般的にセマンティクスが変更される可能性があると理解されています。したがって、`0xFD`(`REVERT`)、`0xFE`(`INVALID`)、または`0xFF`(`SELFDESTRUCT`)などの割り当てられたオペコードを選択するよりも、未割り当ての`0xEF`を使用する方が影響が小さいと考えられます。そのようなコントラクトは非常に有用ではない可能性がありますが、有効なオペコードを使用しています。

2021年5月の分析では、状態内の`18084433`個のコントラクトのうち、`0xEF`バイトで始まるコントラクトは0個であるのに対し、`0xFD`、`0xFE`、`0xFF`で始まるコントラクトはそれぞれ1個、4個、12個ありました。

## テストケース

以下の各テストケースは、3つの異なるコンテキストで実行できます:
- create transaction (アカウントコードなし)
- `CREATE`、アカウントコード: `0x6000356000523660006000f0151560165760006000fd5b` (Yulコード: `mstore(0, calldataload(0)) if iszero(create(0, 0, calldatasize())) { revert(0, 0) }`)
- `CREATE2`、アカウントコード: `0x60003560005260003660006000f5151560185760006000fd5b` (Yulコード: `mstore(0, calldataload(0)) if iszero(create2(0, 0, calldatasize(), 0)) { revert(0, 0) }`)

| ケース | コールデータ | 期待される結果 |
| -------- | -------- | -------- |
| 1バイトの`ef`をデプロイ | `0x60ef60005360016000f3` | 新しいコントラクトはデプロイされず、トランザクションが失敗 |
| 2バイトの`ef00`をデプロイ | `0x60ef60005360026000f3` | 新しいコントラクトはデプロイされず、トランザクションが失敗 |
| 3バイトの`ef0000`をデプロイ | `0x60ef60005360036000f3` | 新しいコントラクトはデプロイされず、トランザクションが失敗 |
| 32バイトの`ef00...00`をデプロイ | `0x60ef60005360206000f3` | 新しいコントラクトはデプロイされず、トランザクションが失敗 |
| 1バイトの`fe`をデプロイ | `0x60fe60005360016000f3` | 新しいコントラクトがデプロイされ、トランザクションが成功 |

## 下位互換性

これは破壊的な変更です。`0xEF`バイトで始まる新しいコードのデプロイが許可されず、コントラクトの作成が失敗します。ただし、バイトコードは最初のバイトから実行されるため、`0xEF`を先頭バイトとして展開されたコードは実行できません。

つまり、現在実行可能なコントラクトには影響がありませんが、`0xEF`バイトで始まる新しいデータコントラクトのデプロイが拒否されます。

## セキュリティ上の考慮事項

著者は、この変更によるセキュリティまたはDoS上のリスクは認識していません。

## 著作権

著作権およびそれに関連する権利は[CC0](../LICENSE.md)で放棄されています。