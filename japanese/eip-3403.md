---
original: 6b92d3bb760423d8e659a6d9066c54c502837c5a064161065dbc68046ce00679
---

---
eip: 3403
title: 払い戻しの部分的な削除
author: Vitalik Buterin (@vbuterin), Martin Swende (@holiman)
discussions-to: https://ethereum-magicians.org/t/eip-3298-removal-of-refunds/5430
status: 停滞
type: Standards Track
category: Core
created: 2021-03-16
---

## 簡単な要約

SELFDESTRUCT のガス払い戻しを削除し、SSTORE のガス払い戻しを特定のケースに制限する。

## 動機

SSTORE と SELFDESTRUCT のガス払い戻しは元々、アプリケーション開発者に「良好な状態衛生」を実践するよう動機付けるために導入されました。つまり、不要になったストレージスロットやコントラクトをクリアすることです。しかし、この目的のために広く使用されているわけではなく、状態の悪い衛生状態が依然として一般的です。状態の成長に対する唯一の解決策は何らかの形の無状態性または状態の期限切れであり、そのような解決策が実装されれば、使用されていないストレージスロットやコントラクトは自動的に無視されるようになるのが広く認められています。

ガス払い戻しにはさらに複数の有害な結果があります:

* 払い戻しにより GasToken が生み出される。GasToken には低料金期間から高料金期間にガス容量を移動するメリットがありますが、ネットワークにも欠点があり、特に状態サイズの悪化(状態スロットが「バッテリー」として効果的に使用されるため)や非効率的なブロックチェーンガス使用の詰まりが挙げられます。
* 払い戻しはブロックサイズのばらつきを増大させる。実際に消費されるガスの理論上の最大量は、オンペーパーのガスリミットのほぼ2倍になります(払い戻しにより、ブロック内の後続のトランザクションのためのガス容量が追加されるためですが、払い戻しは取引のガス使用量の50%までに制限されます)。これは致命的ではありませんが、EIP 1559 では長期的に2倍の使用量のスパイクを維持できないという点で望ましくありません。

### ミューテックスのユースケース

ミューテックスを実装する典型的な2つの方法は、'0-1-0' と '1-2-1' です。それらの違いを見てみましょう。

- '0-1-0':
  - Istanbul: 1612
  - Berlin: 212
  - NoRefund: 20112
  - EIP-3403: 1112
- '1-2-1':
  - Istanbul: 1612
  - Berlin: 212
  - NoRefund: 3012
  - EIP-3403: 3012


**注意**: 実際には、払い戻しは0.5 * gasUsedを上限としているため、ガス代が負の値になることはありません。
しかし、これらの表では負の値を示しています。なぜなら、より現実的なシナリオでは、余分なガスを他の操作に費やすことが考えられるためです。

## 仕様

### パラメータ

| 定数 | 値 |
| - | - |
| `FORK_BLOCK` | 未定 |
| `SSTORE_REFUND_GAS` | 19000 |

`block.number >= FORK_BLOCK`のブロックについて、以下の変更が適用されます。

1. `SELFDESTRUCT`の払い戻しを削除する。
2. 1つの特定のケースを除いて、`SSTORE`の払い戻しを削除する: 新しい値と元の値が両方とも0であるが、現在の値が0ではない場合(これらの用語は[EIP-1283](https://eips.ethereum.org/EIPS/eip-1283)で定義されています)、`SSTORE_REFUND_GAS`ガスを払い戻す。

## 根拠

`new = original = 0 != current`の場合の払い戻しを保持することで、特に以下のようないくつかの重要なユースケースが引き続き有利なガス代扱いを受けられるようになります:

* 再入力ロック(通常、子呼び出しが始まる直前に0から1にフリップされ、子呼び出しが終了するときに0に戻される)
* ERC20の承認と送信(トークン転送が承認されると、承認された値が0から非0に変わり、トークン転送が処理されると0に戻る)

また、EIP 3298の2つの重要な目標も維持されます:

1. ガストークンは引き続き実用的ではなくなります。なぜなら、19000ガスの払い戻しは、同じトランザクション内で0から非0にフリップするために支払われた19000ガス余分分だけ可能になるからです。つまり、ある一部のストレージスロットをクリアしてそのガスを他のスロットに充填することはできません。
2. 実行に使用されるガスの総量は、ガスリミットを超えることはありません。0から0にフリップするためのすべての19000ガスの払い戻しは、同じトランザクション内で0から非0にフリップするために支払われた19000ガス余分分だけ可能になります。つまり、その余分なガスはメルクルツリーに適用されることはなく、リスクにも寄与しません。

## 下位互換性

現在、払い戻しはトランザクション実行の_後_にのみ適用されるため、特定のコールフレームで利用可能なガス量に影響を与えることはありません。したがって、払い戻しを削除しても、コードの実行能力は損なわれませんが、一部のアプリケーションが経済的に実行不可能になる可能性があります。

特にガストークンは無価値になります。DeFiのアービトラージボットは、今日しばしば既存のガストークンスキームやカスタムの代替手段を使ってオンチェーンコストを削減していますが、これらの機能しなくなる機能を削除するようにコードを書き換える必要があります。

## テストケース

### 2929ガスコスト

注意: 'hot'と'cold'のストレージスロットの違いがあります。この表は[EIP-2929](./eip-2929.md)時点の値を示しており、すべての触れられたストレージスロットが既に'hot'であると仮定しています(違いは一回限りの`2100`ガスコストです)。

| コード | 使用ガス | 払い戻し | 元の値 | 1回目 | 2回目 | 3回目 | 実効ガス(払い戻し後)
| -- | -- | -- | -- | -- | -- | -- | -- | 
| `0x60006000556000600055` | 212 | 0| 0 | 0 |  0 |  |  212 |
| `0x60006000556001600055` | 20112 | 0| 0 | 0 |  1 |  |  20112 |
| `0x60016000556000600055` | 20112 | 19900| 0 | 1 |  0 |  |  212 |
| `0x60016000556002600055` | 20112 | 0| 0 | 1 |  2 |  |  20112 |
| `0x60016000556001600055` | 20112 | 0| 0 | 1 |  1 |  |  20112 |
| `0x60006000556000600055` | 3012 | 15000| 1 | 0 |  0 |  |  -11988 |
| `0x60006000556001600055` | 3012 | 2800| 1 | 0 |  1 |  |  212 |
| `0x60006000556002600055` | 3012 | 0| 1 | 0 |  2 |  |  3012 |
| `0x60026000556000600055` | 3012 | 15000| 1 | 2 |  0 |  |  -11988 |
| `0x60026000556003600055` | 3012 | 0| 1 | 2 |  3 |  |  3012 |
| `0x60026000556001600055` | 3012 | 2800| 1 | 2 |  1 |  |  212 |
| `0x60026000556002600055` | 3012 | 0| 1 | 2 |  2 |  |  3012 |
| `0x60016000556000600055` | 3012 | 15000| 1 | 1 |  0 |  |  -11988 |
| `0x60016000556002600055` | 3012 | 0| 1 | 1 |  2 |  |  3012 |
| `0x60016000556001600055` | 212 | 0| 1 | 1 |  1 |  |  212 |
| `0x600160005560006000556001600055` | 40118 | 19900| 0 | 1 |  0 |  1 |  20218 |
| `0x600060005560016000556000600055` | 5918 | 17800| 1 | 0 |  1 |  0 |  -11882 |

### EIP-3403部分払い戻しの場合

払い戻しが部分的に削除された場合、以下の比較表になります。**この表も、触れられたストレージスロットが既に'hot'であると仮定しています**。

| コード | 使用ガス | 払い戻し | 元の値 | 1回目 | 2回目 | 3回目 | 実効ガス(払い戻し後)
| -- | -- | -- | -- | -- | -- | -- | -- | 
| `0x60006000556000600055` | 212 | 0| 0 | 0 |  0 |  |  212 |
| `0x60006000556001600055` | 20112 | 0| 0 | 0 |  1 |  |  20112 |
| `0x60016000556000600055` | 20112 | 19000| 0 | 1 |  0 |  |  1112 |
| `0x60016000556002600055` | 20112 | 0| 0 | 1 |  2 |  |  20112 |
| `0x60016000556001600055` | 20112 | 0| 0 | 1 |  1 |  |  20112 |
| `0x60006000556000600055` | 3012 | 0| 1 | 0 |  0 |  |  3012 |
| `0x60006000556001600055` | 3012 | 0| 1 | 0 |  1 |  |  3012 |
| `0x60006000556002600055` | 3012 | 0| 1 | 0 |  2 |  |  3012 |
| `0x60026000556000600055` | 3012 | 0| 1 | 2 |  0 |  |  3012 |
| `0x60026000556003600055` | 3012 | 0| 1 | 2 |  3 |  |  3012 |
| `0x60026000556001600055` | 3012 | 0| 1 | 2 |  1 |  |  3012 |
| `0x60026000556002600055` | 3012 | 0| 1 | 2 |  2 |  |  3012 |
| `0x60016000556000600055` | 3012 | 0| 1 | 1 |  0 |  |  3012 |
| `0x60016000556002600055` | 3012 | 0| 1 | 1 |  2 |  |  3012 |
| `0x60016000556001600055` | 212 | 0| 1 | 1 |  1 |  |  212 |
| `0x600160005560006000556001600055` | 40118 | 19000| 0 | 1 |  0 |  1 |  21118 |
| `0x600060005560016000556000600055` | 5918 | 0| 1 | 0 |  1 |  0 |  5918 |

## セキュリティ上の考慮事項

払い戻しはトランザクション実行には見えないため、トランザクション実行ロジックに影響を与えるはずはありません。

ブロック内の実行に使用できるガスの最大量は、ガスリミットに制限されています。ただし、後に0に戻された0から非0への SSTORE は数えません。それらを数えないのは問題ありません。なぜなら、そのような SSTORE が0に戻された場合、ストレージは拡張されず、クライアントはメルクルツリーを調整する必要がないためです。ガス消費は払い戻されますが、通常それらのオペコードを処理するために必要な労力も取り消されます。**クライアントは、`new_value = original_value`の場合、ストレージ書き込みを行わないようにする必要があります。これはイーサリアムの初期から賢明な最適化でしたが、今では更に重要になっています。**

## 著作権
[CC0](../LICENSE.md)によりすべての著作権およびそれに関連する権利が放棄されています。