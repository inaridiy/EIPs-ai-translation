---
original: b0ce6d76257e9f3517fe9f7738c01c939e8cf764803e1ef8f4093241580a9361
---

---
eip: 1898
title: `blockHash`をdefaultBlock メソッドに追加する
description: JSON-RPCメソッドに現在サポートされているdefaultBlockパラメーターに`blockHash`オプションを追加する。
author: Charles Cooper (@charles-cooper)
discussions-to: https://ethereum-magicians.org/t/eip-1898-add-blockhash-option-to-json-rpc-methods-that-currently-support-defaultblock-parameter/11757
status: 停滞中
type: Standards Track
category: Interface
created: 2019-04-01
requires: 234
---

## 概要

現在デフォルトのブロックパラメーターを受け入れるJSON-RPCメソッドに、ブロックハッシュパラメーターを追加する。

このEIPは[EIP-234](./eip-234.md)の一般化と見なすことができます。これにより、クライアントは正規のチェーンにない特定のブロックの状態を明確に指定できるようになります。これにより、クライアントはリオーガニゼーションの影響を受けずに、ノードとの永続的な接続や特定のクライアントの状態を保持することなく、関心のあるブロックチェーンの状態を一貫して把握できるようになります。

## 仕様

以下のJSON-RPCメソッドが影響を受けます:

- `eth_getBalance`
- `eth_getStorageAt`
- `eth_getTransactionCount`
- `eth_getCode`
- `eth_call`
- `eth_getProof`

Ethereum JSON-RPCの仕様から引用すると、現在defaultBlockパラメーターに使用できるオプションは以下の通りです:

> - 16進数文字列 - ブロック番号
> - 文字列 "earliest" - 最初/ジェネシスブロック
> - 文字列 "latest" - 最新の正規ブロック
> - 文字列 "pending" - 保留中の状態/トランザクション
> - 文字列 "safe" - 最新の安全ブロック
> - 文字列 "finalized" - 最新の確定ブロック

DATAパラメーターとQUANTITYパラメーターを明確に区別する方法がないため、このEIPでは新しいブロックパラメータースキームを提案します。以下のオプションが追加で許可されます:

- オブジェクト
  - `blockNumber`: QUANTITY - ブロック番号
  - `blockHash`: DATA - ブロックハッシュ

ブロックが見つからない場合、呼び出し側は JSON-RPCエラーを発生させるべきです (推奨されるエラーコードは `-32001: リソースが見つかりません`)。

`blockHash`タグの場合、ブロックパラメーターに追加のブール値フィールド `requireCanonical` を指定できます。これはデフォルトで `false` であり、ブロックが呼び出し側の正規チェーンに存在する必要があるかどうかを定義します。 `requireCanonical` が `false` の場合、ブロックが見つからない場合のみエラーを発生させます (上記のように)。 `requireCanonical` が `true` の場合、ブロックが正規チェーンにない場合にも JSON-RPCエラーを発生させる必要があります (推奨されるエラーコードは `-32000: 無効な入力` で、ブロックが見つからない場合のエラーコードとは異なる必要があります)。ブロックが見つからないかどうかのチェックは、ブロックが正規チェーンにあるかどうかのチェックよりも優先されるべきです。

下位互換性を維持するため、ブロック番号は16進数文字列または新しいブロックパラメータースキームのいずれかで指定できます。つまり、以下は defaultBlockパラメーターとして等価です:

- `"earliest"`
- `"0x0"`
- `{ "blockNumber": "0x0" }`
- `{ "blockHash": "0xd4e56740f876aef8c010b86a40d5f56745a118d0906a34e69aec8c0db1cb8fa3" }` (Ethereumメインチェーンのジェネシスブロックのハッシュ)
- `{ "blockHash": "0xd4e56740f876aef8c010b86a40d5f56745a118d0906a34e69aec8c0db1cb8fa3", "requireCanonical": true }`
- `{ "blockHash": "0xd4e56740f876aef8c010b86a40d5f56745a118d0906a34e69aec8c0db1cb8fa3", "requireCanonical": false }`

## 根拠

現在、上記の状態照会JSON-RPCメソッドには、照会するブロックを明確に指定する方法がありません。これにより、RPCに複数の呼び出しを行う必要があるアプリケーションに問題が発生する可能性があります。例えば、送金を実行したばかりのウォレットが送信者と受信者の両方の残高を表示したい場合、`eth_getBalance`を呼び出す間にリオーガニゼーションが発生すると、残高が一致しなくなる可能性があります。より複雑な例として、オンチェーンのオーダーを保持するデセントラライズド取引所のUIが、各オーダーのデータを取得するために `eth_call` を呼び出してリストをウォークスルーする場合があります。別の使用例は、2つのNFTの同時所有権に基づいた支払いなど、複数の状態に基づいて決定を下す必要があるアプリケーションです。

状態の一貫性を確保するために (つまり、すべての `eth_call` が正確に同じブロックで呼び出された)、アプリケーションは現在いくつかの戦略を使用できます:

- 使用するブロック番号を決定する (例: アプリケーションが知っている最新のブロック番号)。各 `eth_call` の後に、同じブロック番号で `eth_getBlockByNumber` を呼び出す。ブロックハッシュが一致しない場合は、現在の処理をロールバックして最初から再試行する。これにより、ベースラインのオーバーヘッドが `O(n)` 呼び出しになり、再試行ごとに別の `O(n)` 呼び出しが必要になります。さらに、関連するブロックが `eth_call` の前にリオーガニゼーションされ、その後 `eth_getBlockByNumber` の前に再度リオーガニゼーションされた場合を検出する方法はありません。
- ログに依存することができます。ログは `blockHash` パラメーターを使って明確に照会できます。ただし、これにはスマートコントラクトからのイベントのセマンティックサポートが必要です。適切なイベントが発行されない場合、クライアントは関心のある特定の状態を再構築できません。
- `parity_subscribe` などの非標準的な拡張機能に依存する。これにはクライアントとノード間の永続的な接続 (IPC または WebSocket) が必要で、クライアントとノードの結合が高くなり、`eth_call` の呼び出しに依存関係がある場合 (例: 連結リストのウォークスルー) には対応できません。

`eth_call` などのメソッドに照会するブロックを明確に指定できるようにすることで、アプリケーション開発者は、ブロックチェーンの状態に関する一貫性のある表示を維持するための堅牢で直感的な方法を得られます。複数の順次クエリは同じ状態を照会するため、アプリケーション開発者はブロックチェーンの状態に関する不整合を気にする必要がなくなります。

## 下位互換性

下位互換性があります。

## テストケース

- `eth_getStorageAt [ "0x<address>", { "blockNumber": "0x0" }` -> ジェネシスブロックの指定アドレスのストレージを返す
- `eth_getStorageAt [ "0x<address>", { "blockHash": "0xd4e56740f876aef8c010b86a40d5f56745a118d0906a34e69aec8c0db1cb8fa3" }` -> ジェネシスブロックの指定アドレスのストレージを返す
- `eth_getStorageAt [ "0x<address>", { "blockHash": "0xd4e56740f876aef8c010b86a40d5f56745a118d0906a34e69aec8c0db1cb8fa3", "requireCanonical": false }` -> ジェネシスブロックの指定アドレスのストレージを返す
- `eth_getStorageAt [ "0x<address>", { "blockHash": "0xd4e56740f876aef8c010b86a40d5f56745a118d0906a34e69aec8c0db1cb8fa3", "requireCanonical": true }` -> ジェネシスブロックの指定アドレスのストレージを返す
- `eth_getStorageAt [ "0x<address>", { "blockHash": "0x<non-existent-block-hash>" }` -> ブロックが見つからないエラーを発生させる
- `eth_getStorageAt [ "0x<address>", { "blockHash": "0x<non-existent-block-hash>", "requireCanonical": false }` -> ブロックが見つからないエラーを発生させる
- `eth_getStorageAt [ "0x<address>", { "blockHash": "0x<non-existent-block-hash>", "requireCanonical": true }` -> ブロックが見つからないエラーを発生させる
- `eth_getStorageAt [ "0x<address>", { "blockHash": "0x<non-canonical-block-hash>" }` -> 指定ブロックの指定アドレスのストレージを返す
- `eth_getStorageAt [ "0x<address>", { "blockHash": "0x<non-canonical-block-hash>", "requireCanonical": false }` -> 指定ブロックの指定アドレスのストレージを返す
- `eth_getStorageAt [ "0x<address>", { "blockHash": "0x<non-canonical-block-hash>", "requireCanonical": true }` -> ブロックが正規チェーンにないエラーを発生させる

## セキュリティ上の考慮事項

なし

## 著作権

著作権およびその関連権利は[CC0](../LICENSE.md)で放棄されています。