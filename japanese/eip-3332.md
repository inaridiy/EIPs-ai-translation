---
original: 021a95f890213b8db2115e43fe47605b06be9fc1dc78c84a2468b6265b08d4c3
---

---
eip: 3332
title: MEDGASPRICE オペコード
author: Justice Hudson (@jchancehud)
discussions-to: https://ethereum-magicians.org/t/medgasprice-opcode-eip/5480
status: 取り下げられた
type: Standards Track
category: Core
created: 2021-03-05
---

## 簡単な要約

親ブロックのメディアンガス価格を取得するためのオペコード。

## 概要

`MEDGASPRICE (0x46)` オペコードを追加し、親ブロックのメディアンガス価格を返します。

## 動機

Ethereum のスケーリングにおいて、ロールアップが中心的な仕組みとなる中で、フロントランニングの対象となる一般的なトランザクションが存在します。楽観的ロールアップは、不正証明の提出によってシステムの完全性を維持しています。その結果、不正証明を提出するアクターは、それを行うための金銭的報酬を受け取ります。これにより、メンプールの不正証明の提出を監視し、より高いガス価格でそのようなトランザクションをコピーして報酬を得るというきわめて単純なフロントランニング戦略が生まれます。このようなフロントランナーは独立した検証を行わず、他者による検証を阻害します。トランザクションのガス価格の上限を強制する仕組みを設けることで、このようなフロントランニング攻撃に対する効果的な防御策となる可能性があります。

先着順のメカニズムを実装したいスマートコントラクトを考えてみましょう。このようなメカニズムは、ガス価格市場の本質的な「金で勝つ」性質を打ち破る必要があります。トランザクションの最大ガス価格を強制することは、同じガス価格のトランザクションが一般的にEthereum マイナーによって先着順で処理されるという事実に依存しています。現在、コントラクトには最大ガス価格を設定する選択肢がいくつかあります:

- 現在のガス価格を考慮して、妥当な料金の定数値を設定する
- 個人または一群の個人が最大ガス価格を随時調整できるようにする

より複雑なスキームも考えられますが、いずれにしろオンチェーンでガス価格情報を保持する必要があり、トランザクション数の増加とEtherの消費につながります。

メディアンガス価格オペコードがあれば、コントラクトは前回のブロックのガス価格を基に最大ガス価格を設定することができます。以下のような戦略を簡単に実装できます:

```
// block.medgasprice が MEDGASPRICE (0x46) にバインドされていると仮定

function submitFraudProof(bytes calldata proof) public {
  require(tx.gasprice <= maxGasPrice());
  // 不正証明を処理し、報酬を提供する(有効な場合)
}

function maxGasPrice() public view returns (uint) {
  return 3 * block.medgasprice;
}
```

上記のコントラクト実装では、クライアントは `maxGasPrice` を呼び出して、不正証明の提出に使用するガス価格を決定することができます。この特定の実装では、前回のブロックのメディアンガス価格の最大3倍までが使用できます。

### 前方互換性

[EIP-1559](https://eips.ethereum.org/EIPS/eip-1559) は、手数料市場を多数の方法で変更する予定です。最も重要なのは、ベースフィーが焼却されるようになることです。この文脈では、「インクルージョンフィー」が依然として総手数料の一部として存在します。以下の2つのケースを考えてみましょう:

#### ブロックサイズが増加している(利用可能なガスがすべて消費されている)

この場合、インクルージョンフィーをめぐる入札競争が発生し、マイナーにトランザクションを含めるインセンティブが生まれます。メディアンガス価格オペレーターは、攻撃者がインクルージョンフィーを高く設定してホネストなトランザクションをバンプする可能性があるため、依然として役立つでしょう。

#### ブロックサイズが減少している(余剰ガスがある)

この場合、攻撃者はインクルージョンフィーを高く設定してマイナーにトランザクションを早期にブロックに含めるよう誘導できます。マイナーにとっては、高価なトランザクションを最初に含めることで、リバートと部分的な払い戻しのリスクを減らすインセンティブがあります。

これら2つのケースを考えると、EIP-1559 の文脈でもこのEIPが関連性を持つと考えられます。

EIP-1559 以降、`MEDGASPRICE (0x46)` は前回のブロックの `effective_gas_price` のメディアンを返すべきです。

[EIP-3198](https://eips.ethereum.org/EIPS/eip-3198) を含めることで、上記の戦略を実装できます。`BASEFEE (0x48)` の導入により、コントラクトは `base_fee_per_gas` を `effective_gas_price` から引くことで、トランザクションに対して支払われているインクルージョンフィーを決定し、上限を実装できます。

## 仕様

`block.number >= TBD` の場合、新しいオペコード `MEDGASPRICE (0x46)` を追加します:

親ブロックのメディアンガス価格をスタックにプッシュします。

|  Op  	| Input 	| Output 	| Cost 	|
|:----:	|:-----:	|:------:	|:----:	|
| 0x46 	|   0   	|    1   	|   8  	|

## 根拠

ネットワークの現在のガス価格経済にアクセスできることで、許容可能なトランザクションガス価格に関する、より堅牢で自動化された論理を実装できます。

### 命名に関する注記

`MEDGASPRICE` という名称を選んだのは、ネットワークのメディアンガス価格は最新の完全なブロックからしか計算できないためです。したがって、実行中のトランザクションは、メディアンガス価格が前回のブロックから計算されることを期待する必要があります。

## 下位互換性

既知の下位互換性の問題はありません。

## セキュリティ上の考慮事項

トランザクションのガス価格の上限を設定することで、フロントランニングを防ぐ戦略には、いくつかの留意点があります:

1. マイナーの公平性に依存している。同じガス価格のトランザクションを並べ替えるのは、この戦略を簡単に打ち破る手段である。
2. `MEDGASPRICE (0x46)` が返す値は、ブロック間で急激に変動する可能性がある。トランザクションが即座に含まれない場合、ガス価格が下がればトランザクションが失敗し、ガス価格が上がればフロントランニングの対象になる可能性がある。

## 著作権

著作権およびその関連権利は [CC0](../LICENSE.md) により放棄されています。