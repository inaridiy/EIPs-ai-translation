---
original: 57ecf5a2875c894d088692437cc4ff49a310241178d07a6edd1a22028bdd6194
---

---
eip: 2045
title: EVMオペコードのパーティクルガスコスト
author: Casey Detrio (@cdetrio), Alex Beregszaszi (@axic)
discussions-to: https://ethereum-magicians.org/t/eip-2045-fractional-gas-costs/3311
status: Stagnant
type: Standards Track
category: Core
created: 2019-05-17
---

## 概要
最近のベンチマークによると、計算用のEVMオペコード(`ADD`、`SUB`、`MUL`など)は、ストレージI/O用のオペコード(`SLOAD`、`SSTORE`など)に比べて一般的に過剰に価格設定されています。現在の最小ガスコストは1(つまり1ユニットのガス)で、ほとんどの計算用オペコードのコストが1に近い(例えば3、5、または8)ため、コスト削減の可能性は限られています。「パーティクル」と呼ばれる新しい最小ガスユニットを導入すれば、ガスコストの範囲が広がり、現在の最小値を下回るコスト削減が可能になります。

## 動機
イーサリアムブロックのトランザクション容量は、トランザクションのガスコストとブロックガス制限の関係によって決まります。トランザクション容量を高めるには、ブロックガス制限を引き上げる方法があります。しかし、ブロックガス制限を引き上げると、同時にストレージ拡張用オペコード(`SSTORE`、`CREATE`など)のコストも同じ割合で引き上げる必要があり、これにはマイナスの影響がある可能性があります。ストレージオペコードのコストを引き上げると、デプロイ済みのコントラクトのガス料金の経済的前提が変わったり、現在のコントラクト実行の不変条件が破られる可能性があります([EIP-2035](./eip-2035.md)<sup>[1](#eip2035)</sup>を参照、ストレージオペコードのコスト引き上げの影響については、さらなる研究が必要です)。

もう一つの方法は、トランザクションのガスコストを下げることです。計算用オペコードのガスコストを下げつつ、ストレージオペコードのコストを同じに保つことは、ブロックガス制限を引き上げてストレージオペコードのコストを同時に引き上げるのと同等の効果があります。ただし、計算用オペコードのコスト引き下げなら、ストレージオペコードのコスト引き上げによるマイナスの影響を避けられる可能性があります(この点についても、さらなる研究が必要です)。

現在、計算用オペコードのコストは1ガスという最小単位に近すぎるため、最適化されたEVM実装の性能に合わせてオペコードのガスコストを調整するには、最近のベンチマーク<sup>[2](#evmbenchmarks)</sup>が示唆する程度の大幅なコスト削減は難しい状況です。1ガスの分数(または細分)である「パーティクル」という新しい最小単位を導入すれば、大幅なコスト削減が可能になります。

## 仕様
EVMに新しいガスカウンター`particlesUsed`が追加され、既存のガスカウンター`gasUsed`とは別に管理されます。1ガスは10000パーティクル(`PARTICLES_PER_GAS`)に等しくなります。`particlesUsed`カウンターは、パーティクル単位でコスト設定されたオペコードの実行時にのみ増加します。`particlesUsed`の増加によって1ガスを超過した場合は、1ガスが`gasUsed`に加算され(同時に`particlesUsed`から減算される)ます。

現在のガスロジックは以下のようになっています:
```python
def vm_execute(ext, msg, code):
    # スタック、メモリ、プログラムカウンターなどを初期化
    compustate = Compustate(gas=msg.gas)
    codelen = len(code)

    while compustate.pc < codelen:
        opcode = code[compustate.pc]
        compustate.pc += 1

        compustate.gasUsed += opcode.gas_fee

        # ガス不足エラー
        if compustate.gasUsed > compustate.gasLimit:
            return vm_exception('OUT OF GAS')

        if op == 'STOP':
            return peaceful_exit()
        elif op == 'ADD':
            stk.append(stk.pop() + stk.pop())
        elif op == 'SUB':
            stk.append(stk.pop() - stk.pop())
        elif op == 'MUL':
            stk.append(stk.pop() * stk.pop())

.....
```

パーティクルを使ったガスロジックは以下のようになります:
```python
PARTICLES_PER_GAS = 10000

def vm_execute(ext, msg, code):
    # スタック、メモリ、プログラムカウンターなどを初期化
    compustate = Compustate(gas=msg.gas)
    codelen = len(code)

    while compustate.pc < codelen:
        opcode = code[compustate.pc]
        compustate.pc += 1

        if opcode.gas_fee:
            compustate.gasUsed += opcode.gas_fee
        elif opcode.particle_fee:
            compustate.particlesUsed += opcode.particle_fee
            if compustate.particlesUsed >= PARTICLES_PER_GAS:
                # particlesUsedは1ガスと2ガスの間(10000以上20000未満)になる
                compustate.gasUsed += 1
                # 残りはパーティクルカウンターに残す
                compustate.particlesUsed = compustate.particlesUsed % PARTICLES_PER_GAS

        # ガス不足エラー
        if compustate.gasUsed > compustate.gasLimit:
            return vm_exception('OUT OF GAS')

        if op == 'STOP':
            return peaceful_exit()
        elif op == 'ADD':
            stk.append(stk.pop() + stk.pop())
        elif op == 'SUB':
            stk.append(stk.pop() - stk.pop())
        elif op == 'MUL':
            stk.append(stk.pop() * stk.pop())

.....
```

上記の疑似コードは可読性のために書かれています。より高パフォーマンスな実装では、オペコードのガスコストを10000倍し、`gasLimit`も10000倍して単一の`particlesUsed`カウンターを維持し、実行終了時に`ceil(particlesUsed / PARTICLES_PER_GAS)`でガスに変換するのが良いかもしれません。また、`PARTICLES_PER_GAS`の比率を2のべき乗(8192や16384など)にするほうが、パフォーマンスが良くなる可能性があります。上記の仕様は草案であり、フィードバックに応じて更新される予定です。

#### オペコードコストの変更
多くの計算用オペコードのコストが削減されます。ベンチマーク分析に基づいて新しいコストが提案されています。例えば、`DUP`と`SWAP`のコストは3ガスから3000パーティクル(0.3ガス)に、`ADD`と`SUB`のコストは3ガスから6000パーティクル(0.6ガス)に、`MUL`のコストは5ガスから5000パーティクル(0.5ガス)に削減されます。

## 根拠
分数ガスコストの採用は、EVMの内部実装の詳細にすぎず、現在のユーザー体験であるトランザクションガス制限やブロックガス制限に影響を与えるべきではありません。「パーティクル」の概念は、イーサリアムユーザーや大半のコントラクト作成者には公開する必要はなく、EVM実装者やガス使用の最適化に関心のあるコントラクト開発者にのみ公開すればよいでしょう。また、オペコード実行時のガス課金ロジックのみが影響を受けるべきで、ブロックヘッダーやトランザクション形式などのガスやガス制限に関連するその他のコンテキストは影響を受けるべきではありません。

### Ewasm
「パーティクル」という用語は、Ewasm<sup>[3](#particle)</sup>で最初に導入されました。Ewasm命令の低コストなガス会計を可能にしつつ、EVMのガスコストとの互換性を維持するためです。このEIPでは、EVMオペコードの新しい最小ガス単位としてパーティクルを導入することを提案しており、Ewasm とは関係ありません。

## 下位互換性
この変更は下位互換性がなく、ハードフォークによってアクティベートする必要があります。

## テストケース
TODO

## 実装
TODO

## 参考文献
<a name="eip2035">1</a>. [EIP-2035](./eip-2035.md): Stateless Clients - Repricing SLOAD and SSTORE to pay for block proofs

<a name="evmbenchmarks">2</a>. https://github.com/ewasm/benchmarking

<a name="particle">3</a>. 「パーティクル」という用語は、[Ewasm ガスコストの提案](https://github.com/ewasm/design/blob/e77d8e3de42784f40a803a23f58ef06881142d9f/determining_wasm_gas_costs.md)に由来します。

## 著作権
著作権およびそれに関連する権利は[CC0](../LICENSE.md)によって放棄されています。