---
original: d5aad406944b05d698cec41e6b3850af3650a1311f4d427260ff88d2dad1a7ed
---

---
eip: 2935
title: 状態からの過去のブロックハッシュの提供
description: ステートレスな実行を可能にするため、システムコントラクトのストレージスロットに最後の8192ブロックハッシュを保存して提供する
author: Vitalik Buterin (@vbuterin), Tomasz Stanczak (@tkstanczak), Guillaume Ballet (@gballet), Gajinder Singh (@g11tech), Tanishq Jasoria (@tanishqjasoria), Ignacio Hagopian (@jsign), Jochem Brouwer (@jochem-brouwer)
discussions-to: https://ethereum-magicians.org/t/eip-2935-save-historical-block-hashes-in-state/4565
status: Review
type: Standards Track
category: Core
created: 2020-09-03
---

## 概要

ブロック処理ロジックの一部として、システムコントラクトのストレージに最後の `HISTORY_SERVE_WINDOW` 個の過去のブロックハッシュを保存する。さらに、このEIPは `BLOCKHASH` 解決メカニズム(範囲やコストなど)に影響を与えない。

## 動機

EVMは暗黙的に、クライアントが最近のブロック(ハッシュ)を手元に持っていることを前提としている。これは、ステートレスクライアントの登場を考えると、将来的に問題になる可能性がある。ブロックハッシュを状態に含めることで、ステートレスクライアントに提供するwitness(証明)にこれらのハッシュを含めることができるようになる。これはすでにMPTで可能であり、Verkle以降はより効率的になる。

`BLOCKHASH`が提供できるブロックの範囲(`BLOCKHASH_SERVE_WINDOW`)を拡張することは、セマンティクスの変更になる。このコントラクトのストレージを使ってそれを拡張すれば、ソフトトランジションが可能になる。Rollupは、このコントラクトを直接クエリすることで、より長い履歴ウィンドウから恩恵を受けることができる。

このアプローチのサイドベネフィットとして、最後の `HISTORY_SERVE_WINDOW` 個の先祖に関する証明を、現在の状態に対して直接構築/検証できるようになることが挙げられる。

## 仕様

| パラメータ | 値 |
| - | - |
| `FORK_TIMESTAMP` | 未定 |
| `BLOCKHASH_SERVE_WINDOW` | `256` |
| `HISTORY_SERVE_WINDOW` | `8192` |
| `SYSTEM_ADDRESS` | `0xfffffffffffffffffffffffffffffffffffffffe` |
| `HISTORY_STORAGE_ADDRESS` | `0x0aae40965e6800cd9b1f4b05ff21581047e3f91e`|

このEIPでは、最後の `HISTORY_SERVE_WINDOW` 個のブロックハッシュをリングバッファ型のストレージに保存することを規定している。なお、`HISTORY_SERVE_WINDOW` は `BLOCKHASH_SERVE_WINDOW` (変更なし)よりも大きい。

`block.timestamp >= FORK_TIMESTAMP` (つまり、トランザクション処理の前)の任意のブロックの処理の開始時に、以下のように状態を直接更新する:

```python
def process_block_hash_history(block: Block, state: State):
    if block.timestamp >= FORK_TIMESTAMP:
        state.insert_slot(HISTORY_STORAGE_ADDRESS, (block.number-1) % HISTORY_SERVE_WINDOW , block.parent.hash)
```

あるいは、クライアントはシステムコントラクトの `set` メカニズムを使ってシステムアップデートを行うこともできる(後述)。

`FORK_TIMESTAMP` 以降、`HISTORY_SERVE_WINDOW` ブロックが経過するまでは、リングバッファは完全に埋まらない。コントラクトには、フォークブロックの親ハッシュしか含まれず、それ以前のハッシュは含まれない。

前述のとおり、`BLOCKHASH` オペコードのセマンティクスは変更されない。ただし、状態からの履歴を活用したいクライアントは、クエリが `BLOCKHASH_SERVE_WINDOW` の範囲内にあり、コントラクトに存在することを確認する必要がある。

### コントラクト実装

履歴コントラクトに使用できるEVMアセンブリ:

```
// システムコールの場合は set 操作にジャンプ
caller
push20 0xfffffffffffffffffffffffffffffffffffffffe
eq
push1 0x57
jumpi

// 入力が8バイト以上かどうかチェックし、そうでない場合はrevert
// 最大8バイトの数値と、32バイトにパディングされた呼び出しデータを比較することで、チェックを行う
push8 0xffffffffffffffff
push0
calldataload
gt
push1 0x53
jumpi

// 入力 > ブロック番号 - 1 の場合は 0 を返す
push1 0x1
number
sub
push0
calldataload
gt
push1 0x4b
jumpi

// ブロック番号 > 入力 + 8192 の場合は 0 を返す(入力が8バイト未満なので、オーバーフローは起こらない)
push0
calldataload
push2 0x2000
add
number
gt
push1 0x4b
jumpi

// 8192で剰余を取り、sload
push2 0x1fff
push0
calldataload
and
sload

// メモリにロードして32バイト返す
push0
mstore
push1 0x20
push0
return

// 0x4b: 0 を返す
jumpdest
push0
push0
mstore
push1 0x20
push0
return

// 0x53: revert
jumpdest
push0
push0
revert

// 0x57: set op - ブロック番号 - 1 を 8192で剰余して sstore
jumpdest
push0
calldataload
push2 0x1fff
push1 0x1
number
sub
and
sstore

stop
```

対応するバイトコード:
`0x3373fffffffffffffffffffffffffffffffffffffffe1460575767ffffffffffffffff5f3511605357600143035f3511604b575f35612000014311604b57611fff5f3516545f5260205ff35b5f5f5260205ff35b5f5ffd5b5f35611fff60014303165500`

#### コントラクトの `get` と `set` メカニズム

更新メカニズムは [EIP-4788](./eip-4788.md) と同じである。システムコントラクトの実行は将来的に望ましくないが、この更新方法は、Verkleフォークまでは推奨される。

#### デプロイ

目的のデプロイトランザクションから逆算して、特殊な合成アドレスを生成する:

```json
{
  "type": "0x0",
  "nonce": "0x0",
  "to": null,
  "gas": "0x3d090",
  "gasPrice": "0xe8d4a51000",
  "maxPriorityFeePerGas": null,
  "maxFeePerGas": null,
  "value": "0x0",
  "input": "0x60648060095f395ff33373fffffffffffffffffffffffffffffffffffffffe1460575767ffffffffffffffff5f3511605357600143035f3511604b575f35612000014311604b57611fff5f3516545f5260205ff35b5f5f5260205ff35b5f5ffd5b5f35611fff60014303165500",
  "v": "0x1b",
  "r": "0x539",
  "s": "0x1b9b6eb1f0",
  "hash": "0x3c769a03d6e2212f1d26ab59ba797dce0900df29ffd23c1dd391fd6b217973ad",
}
```

注意: トランザクションの入力には、目的のランタイムコードの前にシンプルなコンストラクタがある。

トランザクションの送信者は `0xe473f7e92ba2490e9fcbbe8bb9c3be3adbb74efc` と計算できる。最初のコントラクトがデプロイされるアカウントのアドレスは `rlp([sender, 0])` で、これが `0x0aae40965e6800cd9b1f4b05ff21581047e3f91e` となる。これが `HISTORY_STORAGE_ADDRESS` の決定方法である。このようなコントラクト作成スタイルは、create2のようなspecific initcodeには縛られないが、トランザクションの入力データ(initcodeなど)に暗号的に結び付けられている。

いくつかのアクティベーションシナリオ:

 * ジェネシスでフォークをアクティベートする場合、ジェネシス状態にはヒストリーは書き込まれず、ブロック `1` の開始時にジェネシスハッシュが通常の操作として書き込まれる。
 * ブロック `1` でアクティベートする場合、スロット `0` にジェネシスハッシュのみが書き込まれる。
 * ブロック `32` でアクティベートする場合、ブロック `31` のハッシュがスロット `31` に書き込まれる。その他のスロットは `0` になる。

### [EIP-161](./eip-161.md) の扱い

上記のバイトコードは [EIP-4788](./eip-4788.md) のようにデプロイされる。そのため、`HISTORY_STORAGE_ADDRESS` のアカウントにはコードとノンスが1があり、EIP-161のクリーンアップの対象外となる。

### ガスコスト

ブロックの開始時の状態更新、つまり `process_block_hash_history` (またはシステムアドレス `SYSTEM_ADDRESS` からのシステムコールによる更新)は、[EIP-2929](./eip-2929.md) のルールに従って、`HISTORY_STORAGE_ADDRESS` アカウントやそのストレージスロットをウォームアップしない。したがって、コントラクトへの最初の呼び出しでは、アカウントとアクセスするストレージスロットのウォームアップ代を支払う必要がある。さらに、`HISTORY_STORAGE_ADDRESS` へのコントラクト呼び出しは、通常のEVM実行セマンティクスに従う。

`BLOCKHASH` のセマンティクスは変更されないため、このEIPは `BLOCKHASH` メカニズムやコストに影響を与えない。

## 根拠

非常によく似たアイデアが以前から提案されていた。このEIPは、以下の2つの不要な複雑さを排除した簡略化版である:

1. 複数のレイヤーを持つツリー構造ではなく、単一のリストとすること
2. EVMコードでEIPを記述すること
3. ハッシュの無制限シリアル保存ではなく、必要な `HISTORY_SERVE_WINDOW` のみのリングバッファ

ただし、長所短所を検討した結果、[EIP-4788](./eip-4788.md)やビーコン状態アキュムレーターが(少し複雑ではあるが)マージ以降の任意の先祖に対する証明を可能にするため、限定的なリングバッファで十分だと判断した。

2つ目の懸念は、フォーク後の `BLOCKHASH` 解決ロジックの移行方法についてで、以下の2つの選択肢があった:

1. `HISTORY_SERVE_WINDOW` ブロック待ちで、関連する履歴全体が保持されるのを待つ
2. フォークブロックで、最後の `HISTORY_SERVE_WINDOW` ブロックハッシュをすべて保存する

前者を選択した。これは大幅に簡単化できる。およそ1日でコントラクトのブートストラップが完了する。現在のユーザーアクティビティや体験に何も影響がないことから、この折衷案が好ましいと判断した。

## 下位互換性

このEIPは、ブロック検証ルールセットに下位互換性のない変更を導入する。しかし、これらの変更のいずれも、現在のユーザーアクティビティや体験に関連するものではない。

## テストケース

TBD

## セキュリティ上の考慮事項

ホットアップデートパス(ブランチ)を持つコントラクト(システムまたはその他)には、攻撃者がこれらのホットパス(ブランチ)に些細な額のETHを撒き散らす「ブランチ毒殺」攻撃のリスクがある。しかし、攻撃コストが大幅に高騰して、状態ルートの更新に意味のある遅延を引き起こすことは難しいと判断された。

## 著作権

著作権およびそれに関連する権利は [CC0](../LICENSE.md) で放棄されています。