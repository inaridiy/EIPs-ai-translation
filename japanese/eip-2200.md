---
original: 822d65ac70a94a41b43fe07edfe63ced75bd23b2f803e0feffab543441272762
---

---
eip: 2200
title: ネットガスメーターの構造化された定義
author: Wei Tang (@sorpaas)
discussions-to: https://github.com/sorpaas/EIPs/issues/1
status: Final
type: Standards Track
category: Core
created: 2019-07-18
---

## 簡単な要約

これは、ネットガスメーターを実装するEIPです。[EIP-1283]と[EIP-1706]の統合版で、[EIP-1884]などの他のガス変更と相互運用可能になるよう構造化された定義になっています。

## 概要

このEIPは、`SSTORE`オペコードのネットガスメーターの変更に関する構造化された定義を提供し、コントラクトストレージの新しい用途を可能にし、ほとんどの実装で一致しないガスコストの過剰な部分を削減します。

これは[EIP-1283]と[EIP-1706]の組み合わせです。

## 動機

このEIPは、ほとんどの実装で利用可能な情報を使用し、実装構造の変更を最小限に抑えながら、`SSTORE`のガスメーターを提案しています。

* ストレージスロットの元の値
* ストレージスロットの現在の値
* リファンドカウンター

このEIPのガス削減スキームから恩恵を受けるユースケースには以下が含まれます:

* 同一呼び出しフレーム内の後続のストレージ書き込み操作。これにはリエントリロック、同一コントラクトのマルチセンド等が含まれます。
* サブコールフレームと親コールフレーム間のストレージ情報の交換。これにはサブフレームのエラーコードやメッセージ受け渡しなどが含まれます。

EIP-1283の元の定義は、Solidityがデフォルトで単純な転送呼び出しに2300ガスの「スティペンド」を与えるため、既存のコントラクトに新しいタイプのリエントラント攻撃の危険性を生み出しました。この危険性は、`SSTORE`が低いガス残量の状態で許可されないようにすれば、簡単に軽減できます。これは、EIP-1283の後方互換性と本来の意図を損なうことはありません。

このEIPは、将来の変更をより簡単に定義できるよう、EIP-1283のガスの値定義をパラメーターに置き換えています。

## 仕様

`SLOAD_GAS`、`SSTORE_SET_GAS`、`SSTORE_RESET_GAS`、`SSTORE_CLEARS_SCHEDULE`の変数を定義します。これらの変数の古い値と新しい値は以下の通りです:

* `SLOAD_GAS`: `200`から`800`に変更。
* `SSTORE_SET_GAS`: `20000`、変更なし。
* `SSTORE_RESET_GAS`: `5000`、変更なし。
* `SSTORE_CLEARS_SCHEDULE`: `15000`、変更なし。

これらの変数を使って、EIP-1283の定義を変更します。EIP-1283とEIP-1706を組み合わせた新しい仕様は以下の通りです。*元の値*、*現在の値*、*新しい値*の用語はEIP-1283で定義されています。

`SSTORE`オペコードのガストコスト計算(リファンドを含む)を以下のロジックに置き換えます:

* `gasleft`がガススティペンド以下の場合、現在のコールフレームを'out of gas'例外で失敗させる。
* *現在の値*が*新しい値*と等しい場合(これはno-opです)、`SLOAD_GAS`が差し引かれる。
* *現在の値*が*新しい値*と等しくない場合
  * *元の値*が*現在の値*と等しい(このストレージスロットは現在の実行コンテキストで変更されていない)
    * *元の値*が0の場合、`SSTORE_SET_GAS`が差し引かれる。
    * それ以外の場合、`SSTORE_RESET_GAS`ガスが差し引かれる。*新しい値*が0の場合、リファンドカウンターに`SSTORE_CLEARS_SCHEDULE`ガスを加える。
  * *元の値*が*現在の値*と等しくない(このストレージスロットは汚れている)、`SLOAD_GAS`ガスが差し引かれる。以下の2つのクローズも適用する。
    * *元の値*が0でない場合
      * *現在の値*が0の場合(つまり*新しい値*も0でない)、リファンドカウンターから`SSTORE_CLEARS_SCHEDULE`ガスを減らす。
      * *新しい値*が0の場合(つまり*現在の値*も0でない)、リファンドカウンターに`SSTORE_CLEARS_SCHEDULE`ガスを加える。
    * *元の値*が*新しい値*と等しい(このストレージスロットはリセットされている)
      * *元の値*が0の場合、リファンドカウンターに`SSTORE_SET_GAS - SLOAD_GAS`を加える。
      * それ以外の場合、リファンドカウンターに`SSTORE_RESET_GAS - SLOAD_GAS`ガスを加える。

実装では、上記の定義により、実装がコールフレームのリファンドカウンターを使用する場合、カウンターがマイナスになる可能性があることに注意する必要があります。トランザクションベースのリファンドカウンターを使用する場合、カウンターは常にプラスの値を保ちます。

## 根拠

このEIPは主に[EIP-1087]と[EIP-1153]が目指す一時的なストレージを実現しますが、「汚れたマップ」や余分なストレージ構造の概念を導入する複雑さはありません。

* EIP-1087の最適化の制限から免れます。EIP-1087は汚れたマップを維持する必要があり、暗黙的にトランザクションのストレージ変更がトランザクション終了時にストレージトライに反映されるという仮定を行います。これは一部の実装には適していますが、他の実装には適していません。[EIP-658]以降、効率的なストレージキャッシュ実装では、RLPエンコーディング/デコーディングを使わずにメモリ内のトライ(または他の不変データ構造)を使ってストレージ変更を追跡し、ブロック終了時にのみ変更をコミットするでしょう。そのような実装では、ストレージの元の値と現在の値を知ることはできますが、すべてのストレージ変更を反復することなく追跡することはできません。
* 現在のスキームよりもガスが増えることはありません。
* 一時的なストレージのすべての用途をカバーしています。EIP-1087を簡単に実装できるクライアントは、この仕様も簡単に実装できるでしょう。他のクライアントではこの仕様の実装にはいくらかの追加の再構築が必要かもしれませんが、実行時に余分なメモリやプロセッシングコストは必要ありません。

`SSTORE`のガストコストとリファンドについては、付録の性質証明を参照してください。

* *絶対ガス使用量*(つまり実際の*ガス使用量*からリファンドを引いた値)については、このEIPはすべての場合でEIP-1087と同等です。
* ある特定のケースで、ストレージスロットが変更され、元の値にリセットされ、再び変更された場合、EIP-1283はEIP-1087よりもリファンドカウンターにより多くのガスを移動します。

EIP-1087の動機に示された例を検討してください(`SLOAD_GAS`が`200`の場合):

* 空のストレージを持つコントラクトがスロット0を1に設定し、その後0に戻す場合、`20000 + 200 - 19800 = 400`ガスが請求されます。
* 空のストレージを持つコントラクトがスロット0を5回インクリメントする場合、`20000 + 5 * 200 = 21000`ガスが請求されます。
* アカウントAからBへの残高転送、続いてBからCへの転送で、すべてのアカウントが0以外の開始値と終了値を持つ場合、`5000 * 3 + 200 - 4800 = 10400`ガスが請求されます。

既存のコントラクトの暗黙的なリエントラント保護を維持するために、トランザクションがトランスファー/送信にガススティペンドを与えられる残りのガスよりも少ない場合、状態を変更することを許可してはいけません。これらは他の提案された修正と反対意見です:

* EIP-1283を削除し、`SSTORE`コストの変更を控える
  * EIP-1283は重要な更新
  * テストネットワークやクライアントで受け入れられ、実装されている
* 状態変更を許可するが、LOGオペコードのみを許可する新しいコールコンテキストを追加する
  * 既存の通常/staticコールに加えて別のコールタイプを追加する
* 汚れたスロットへの`SSTORE`コストを2300ガス以上に引き上げる
  * ネットガスメーターをはるかに使いづらくする
* ガススティペンドを引き下げる
  * ほとんど使い物にならなくなる
* 汚れたスロットへの書き込みコストを元の5000ガスに戻すが、4800ガスをリファンドカウンターに追加する
  * 不変条件を明示的に示すことはできない
  * 呼び出し側にはリファンドされるだけ多くのガスを供給する必要がある
* コントラクトのメタデータにEVMバージョンを指定し、新しいバージョンでデプロイされたコントラクトにのみ`SSTORE`の変更を適用する

## 後方互換性

このEIPを実装するにはハードフォークが必要です。ガストコストの増加は予想されず、多くのコントラクトでガス削減が見られます。

`SSTORE`を実行するには5000ガス未満では不可能だったため、イーサリアムメインネットとの非互換性は導入されません。ガス見積もりはこの要件を考慮する必要があります。

## テストケース

| コード                               | 使用ガス | リファンド | 元の値 | 1回目 | 2回目 | 3回目 |
|------------------------------------|----------|------------|--------|-------|-------|-------|
| `0x60006000556000600055`           | 1612     | 0          | 0      | 0     | 0     |       |
| `0x60006000556001600055`           | 20812    | 0          | 0      | 0     | 1     |       |
| `0x60016000556000600055`           | 20812    | 19200      | 0      | 1     | 0     |       |
| `0x60016000556002600055`           | 20812    | 0          | 0      | 1     | 2     |       |
| `0x60016000556001600055`           | 20812    | 0          | 0      | 1     | 1     |       |
| `0x60006000556000600055`           | 5812     | 15000      | 1      | 0     | 0     |       |
| `0x60006000556001600055`           | 5812     | 4200       | 1      | 0     | 1     |       |
| `0x60006000556002600055`           | 5812     | 0          | 1      | 0     | 2     |       |
| `0x60026000556000600055`           | 5812     | 15000      | 1      | 2     | 0     |       |
| `0x60026000556003600055`           | 5812     | 0          | 1      | 2     | 3     |       |
| `0x60026000556001600055`           | 5812     | 4200       | 1      | 2     | 1     |       |
| `0x60026000556002600055`           | 5812     | 0          | 1      | 2     | 2     |       |
| `0x60016000556000600055`           | 5812     | 15000      | 1      | 1     | 0     |       |
| `0x60016000556002600055`           | 5812     | 0          | 1      | 1     | 2     |       |
| `0x60016000556001600055`           | 1612     | 0          | 1      | 1     | 1     |       |
| `0x600160005560006000556001600055` | 40818    | 19200      | 0      | 1     | 0     | 1     |
| `0x600060005560016000556000600055` | 10818    | 19200      | 1      | 0     | 1     | 0     |

## 実装

追加予定。

## 付録: 証明

*ストレージスロットの元の値*は、*現在のトランザクション*でリバージョンが発生したときの値と定義されているため、コールフレームが`SSTORE`ガス計算に影響を与え
ないことは明らかです。したがって、以下の証明はコールフレームなしで議論されていますが、コールフレームのある状況にも適用されます。*元の値*が0の場合と0でない場合を別々に議論し、`SSTORE`ガストコストのいくつかの性質を*帰納法*で証明します。

*最終値*はトランザクション終了時のある特定のストレージスロットの値です。*絶対ガス使用量*は*ガス使用量*からリファンドを引いた絶対値です。`N`はある特定のストレージスロットに対する`SSTORE`操作の総数を表します。以下で議論する状態については、*説明*セクションの*状態遷移*を参照してください。

以下の証明では、すべてのパラメーターが変更されないという前提で行いますが、`SLOAD_GAS`がどのように変更されても、証明は依然として適用されることに注意してください。

### 元の値が0の場合

*元の値*が0の場合、以下を証明したいと思います:

* **ケースI**: *最終値*が0のままの場合、`200 * N`ガスを請求したい。ディスクへの書き込みは必要ないため。
* **ケースII**: *最終値*が0以外の値になった場合、`20000 + 200 * (N-1)`ガスを請求したい。このスロットをディスクに書き込む必要があるため。

#### ベースケース

常に状態Aから始まります。最初の`SSTORE`は以下のようになります:

* 状態Aに行く: 200ガスが差し引かれる。*ケースI*を満たします。なぜなら`200 * N == 200 * 1`だからです。
* 状態Bに行く: 20000ガスが差し引かれる。*ケースII*を満たします。なぜなら`20000 + 200 * (N-1) == 20000 + 200 * 0`だからです。

#### 帰納ステップ

* AからAへ。前のガストコストは`200 * (N-1)`です。現在のガストコストは`200 + 200 * (N-1)`です。*ケースI*を満たします。
* AからBへ。前のガストコストは`200 * (N-1)`です。現在のガストコストは`20000 + 200 * (N-1)`です。*ケースII*を満たします。
* BからBへ。前のガストコストは`20000 + 200 * (N-2)`です。現在のガストコストは`200 + 20000 + 200 * (N-2)`です。*ケースII*を満たします。
* BからAへ。前のガストコストは`20000 + 200 * (N-2)`です。現在のガストコストは`200 - 19800 + 20000 + 200 * (N-2)`です。*ケースI*を満たします。

### 元の値が0でない場合

*元の値*が0でない場合、以下を証明したいと思います:

* **ケースI**: *最終値*が変わらない場合、`200 * N`ガスを請求したい。ディスクへの書き込みは必要ないため。
* **ケースII**: *最終値*が0になった場合、`5000 - 15000 + 200 * (N-1)`ガスを請求したい。実際の定義では`15000`がリファンドです。
* **ケースIII**: *最終値*が0以外の変更された値になった場合、`5000 + 200 * (N-1)`ガスを請求したい。

#### ベースケース

常に状態Xから始まります。最初の`SSTORE`は以下のようになります:

* 状態Xに行く: 200ガスが差し引かれる。*ケースI*を満たします。なぜなら`200 * N == 200 * 1`だからです。
* 状態Yに行く: 5000ガスが差し引かれる。*ケースIII*を満たします。なぜなら`5000 + 200 * (N-1) == 5000 + 200 * 0`だからです。
* 状態Zに行く: 絶対ガス使用量は`5000 - 15000`です。ここで15000がリファンドです。*ケースII*を満たします。なぜなら`5000 - 15000 + 200 * (N-1) == 5000 - 15000 + 200 * 0`だからです。

#### 帰納ステップ

* XからXへ。前のガストコストは`200 * (N-1)`です。現在のガストコストは`200 + 200 * (N-1)`です。*ケースI*を満たします。
* XからYへ。前のガストコストは`200 * (N-1)`です。現在のガストコストは`5000 + 200 * (N-1)`です。*ケースIII*を満たします。
* XからZへ。前のガストコストは`200 * (N-1)`です。現在の絶対ガストコストは`5000 - 15000 + 200 * (N-1)`です。*ケースII*を満たします。
* YからXへ。前のガストコストは`5000 + 200 * (N-2)`です。現在の絶対ガストコストは`200 - 4800 + 5000 + 200 * (N-2)`です。*ケースI*を満たします。
* YからYへ。前のガストコストは`5000 + 200 * (N-2)`です。現在のガストコストは`200 + 5000 + 200 * (N-2)`です。*ケースIII*を満たします。
* YからZへ。前のガストコストは`5000 + 200 * (N-2)`です。現在の絶対ガストコストは`200 - 15000 + 5000 + 200 * (N-2)`です。*ケースII*を満たします。
* ZからXへ。前のガストコストは`5000 - 15000 + 200 * (N-2)`です。現在の絶対ガストコストは`200 + 10200 + 5000 - 15000 + 200 * (N-2)`です。*ケースI*を満たします。
* ZからYへ。前のガストコストは`5000 - 15000 + 200 * (N-2)`です。現在の絶対ガストコストは`200 + 15000 + 5000 - 15000 + 200 * (N-2)`です。*ケースIII*を満たします。
* ZからZへ。前のガストコストは`5000 - 15000 + 200 * (N-2)`です。現在の絶対ガストコストは`200 + 5000 - 15000 + 200 * (N-2)`です。*ケースII*を満たします。

## 著作権

著作権およびその関連権利は[CC0](../LICENSE.md)で放棄されています。

[EIP-1283]: ./eip-1283.md
[EIP-1706]: ./eip-1706.md
[EIP-1884]: ./eip-1884.md
[EIP-1087]: ./eip-1087.md
[EIP-1153]: ./eip-1153.md
[EIP-658]: ./eip-658.md