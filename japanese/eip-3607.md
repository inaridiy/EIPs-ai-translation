---
original: c09f5db517b12ddf6cc8b001a5e5209d13cfc64a6cdb8e250f126799afdbf9cb
---

---
eip: 3607
title: 既にコードがデプロイされている送信者からのトランザクションを拒否する
description: `tx.sender`にコードがデプロイされている場合、そのトランザクションを許可しない。
author: Dankrad Feist (@dankrad), Dmitry Khovratovich (@khovratovich), Marius van der Wijden (@MariusVanDerWijden)
discussions-to: https://github.com/ethereum/EIPs/issues/3608
status: Final
type: Standards Track
category: Core
created: 2021-06-10
---

## 概要

Ethereumアドレスは現在160ビットしかありません。これは、契約アカウントと外部所有アカウント(EOA)の間でコリジョンを作成することが可能で、推定`2**80`の計算操作で実現できます。これは、大規模な予算(約100億ドル)があれば現在でも実行可能です。このEIPの修正は、ユーザーの資金を引き付けるために安全に見える契約(トークンラッパーやAMMタイプの契約など)がデプロイされ、その後EOAキーを使ってその資金が使用される可能性のある最悪の攻撃を防ぐものです。この修正は、すでにコードがデプロイされているアドレスをEOAアドレスとして使用することを許可しないことです。

## 動機

### アドレスコリジョンの生成

`2**80`のEOAのキーを作成し、これらのEOAから`2**80`の契約をデプロイ(1つずつ)してシミュレーションすると、EOAと同じアドレスを持つ契約が1つ見つかると予想されます。

この非常に単純な形態の攻撃には、`2**80`のアドレスを保存する必要があります。これは実際の障壁になります。これには`2.4*10**25`バイトのメモリ(24ヨッタバイト)が必要になります。ただし、大量のストレージを必要としないサイクル検索アルゴリズムを使用すれば、コリジョン検索を行うことができます。複雑さの推定は[こちら](https://hackmd.io/Vzhp5YJyTT-LhWm_s0JQpA)で行われています。ハードウェアと電力に約100億ドルを投資すれば、1年以内に契約とEOAの間でコリジョンを見つけられると推定されています。

### 背景

現在、Ethereumでは256ビットのアドレスに移行することが議論されており、これによりコリジョン耐性が`2**128`の複雑さに増加し、将来的に実現不可能とされています。しかし、160ビットのアドレスでは、上述のように、コリジョン問題を現在効果的に解決できます。

アドレスコリジョンを介して発生する攻撃の多くは非常に非現実的です。これらは、契約がデプロイされる前にユーザーがアドレスに資金を送信するというものです。これは実際の使用例ではほとんどなく、ユーザーは契約が安全にデプロイされ、十分な確認が行われるまで資金を送信しないことで、この攻撃を回避できます。

ただし、イエローペーパーでは、既にコントラクトコードがデプロイされているアカウントからトランザクションが送信された場合の処理方法を明示的に指定していません。おそらく、これが実現不可能と考えられていたためです。ほとんどのクライアントは、現在の状態ではこのようなトランザクションを許可すると想定されています。

このEIPは、このような動作を常に拒否するように指定するものです。これにより、アドレスコリジョンに起因する大部分の現実的または深刻な攻撃が修正されます。

## 仕様

`tx.sender`の`CODEHASH != EMPTYCODEHASH`である場合、そのトランザクションは無効とみなされ、拒否されなければなりません。ここで、`EMPTYCODEHASH = 0xc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470`です。
無効なトランザクションはクライアントによって拒否され、ブロックに含まれてはいけません。
そのようなトランザクションを含むブロックは無効とみなされなければなりません。

## 根拠

契約アカウントの動作は、その契約に含まれるコードによって制限されるべきであり、つまりアカウントの資金がある秘密鍵によって突然使用可能になるべきではないことが常に期待されていたことに注目します。過去には、160ビットのアドレス長がコリジョン耐性を提供するのに十分であると暗黙的に想定されていたため、この場合が発生することはないと考えられていました。この意味で、このEIPは、以前は定義されていなかったプロトコルの動作を明確化するものと見なすべきであり、コンセンサスルールの明示的な更新ではありません。

これにより、すべての可能な攻撃ベクトルが排除されるわけではありません。契約とEOAの間のアドレスコリジョンによる他の可能な攻撃ベクトルは以下のとおりです:

1. 攻撃者がユーザーにアドレスにデプロイ前に資金を送信するよう説得できる。一部のアプリケーションではこの動作が必要とされる(例:ステートチャネル)。
2. 契約がデプロイされた後にチェーンの再編成が発生する。再編成によって契約デプロイのトランザクションが削除された場合、その資金は秘密鍵を使って引き出せる。
3. 契約が自己破壊された場合、ERC20(またはその他のトークン)がその契約に残されていると、それらにアクセスできるようになる。

これらのシナリオはすべて攻撃者にとってはるかに難しく、収益性も低いため、経済的に実行可能な攻撃である可能性は低いと考えられます。

## 下位互換性

このような攻撃がEthereumメインネットで既に発生していないのは確実で、そうでなければ、誰かがこれを「機能」として使っていると考えられるからです。数十億ドルを費やしてハッシュコリジョンを見つけるよりも、単に契約にメソッドを追加するだけで、同じことができるはずです。

プライベートネットワークでは、ジェネシスで契約とEOAの両方として機能するものがデプロイされている可能性があり、このアップグレードがワークフローに影響しないことを確認する必要があります。

クライアントは、マルチシグ契約がこれらの呼び出しを使ってマルチシグ契約自体から発信されたかのようにトランザクションを作成する場合、`eth_call`や`eth_estimateGas`のようなRPCコールに対してこのルールを無効にすることを選択する可能性があります。

## テストケース

次のようなジェネシスアロケーションがある場合:
```
Address: 0x71562b71999873DB5b286dF957af199Ec94617F7
Balance: 1000000000000000000 // 1 ether
Nonce:   0,
Code:    0xB0B0FACE",
```
`0x715656...`(
`b71c71a67e1177ad4e901695e1b4b9ee17ae16c6668d313eac2f96dbcda3f291`)に対応する秘密鍵から送信されるすべてのトランザクションは拒否されるべきです。
これらのトランザクションは拒否され、ブロックに含まれてはいけません。

## 参考実装

トランザクションの送信者のノンスが正しいことを確認した後、次の確認をステートトランジションチェックに追加する必要があります。
送信者はトランザクションの署名から復元されたアドレスです。
```
// 送信者がEOAであることを確認する
送信者アカウントのCodeHashをchに設定する
chがEmptyCodeHashと等しくない場合
	ErrSenderNoEOAを返す
end if
```

go-ethereumにEIP-3607を実装するためのdiffは[こちら](../assets/eip-3607/geth.diff)にあります。

## セキュリティ上の考慮事項

このEIPは厳密なセキュリティアップグレードです。従来有効だったトランザクションの一部を無効にするだけです。そのようなトランザクションに正当な使用例はないため、セキュリティ上の欠点はありません。

このEIPはソフトフォークとして実装できます。新しい有効性ルールは以前の有効性ルールの厳密なスーパーセットだからです。

## 著作権
[CC0](../LICENSE.md)によりすべての著作権およびそれに関連する権利が放棄されています。