---
original: 22e3e7f29d7c5e0f0f8c8f5d167628f2ade0983f3135605ad7a0aa9715f238c4
---

---
eip: 3085
title: wallet_addEthereumChain RPCメソッド
description: EVMと互換性のあるチェーンを追加するためのRPCメソッドを追加する
author: Erik Marks (@rekmarks)、Pedro Gomes (@pedrouid)、Pandapip1 (@Pandapip1)
discussions-to: https://ethereum-magicians.org/t/eip-3085-wallet-addethereumchain/5469
status: 停滞
type: Standards Track
category: Interface
created: 2020-11-01
requires: 155
---

## 概要

このEIPは、ウォレットの名前空間に`wallet_addEtherereumChain`というRPCメソッドを追加し、Ethereumウォレットにチェーンを追加するための標準インターフェースを提供します。

## 仕様

この文書の中の「MUST」、「MUST NOT」、「REQUIRED」、「SHALL」、「SHALL NOT」、「SHOULD」、「SHOULD NOT」、「RECOMMENDED」、「MAY」、「OPTIONAL」というキーワードは、RFC 2119に記載されているように解釈されるものとします。

このプロポーザルでは、新しいRPCメソッド`wallet_addEthereumChain`を定義しています。

### `wallet_addEthereumChain`

`wallet_addEthereumChain`メソッドは、ウォレットにチェーンを追加することを提案するために使用されます。1つのパラメーターを受け取り、チェーンが正常に追加された場合は`null`を返し、チェーンが追加されなかった場合はエラーを返します。

#### `wallet_addEthereumChain`のパラメーター

`wallet_addEthereumChain`メソッドは1つのパラメーターを受け取り、それは`EthereumChainAddRequest`オブジェクトと定義されます:

```typescript
interface AddEthereumChainParameter {
  chainId: string;
  blockExplorerUrls?: string[];
  chainName?: string;
  iconUrls?: string[];
  nativeCurrency?: {
    name: string;
    symbol: string;
    decimals: number;
  };
  rpcUrls?: string[];
}
```

この仕様では、`chainId`のみが必須ですが、ウォレットはその他のフィールドを必須にしたり、無視したりすることができます。

フィールドがこの仕様の要件を満たしていない場合、ウォレットはリクエストを拒否しなければなりません。

`chainId`は、[EIP-155](./eip-155.md)に従って16進数の文字列で表されるチェーンのIDです。`blockExplorerUrls`、`iconUrls`、`rpcUrls`フィールドは、それぞれ有効なURLの文字列の配列です。`nativeCurrency`フィールドは、`name`、`symbol`、`decimals`フィールドを持つオブジェクトで、`decimals`は非負の整数で、[EIP-20](./eip-20.md)のように解釈されます。`chainName`フィールドは、チェーンの人間可読の名称を表す文字列です。

`chainId`が有効な16進数の文字列ではない場合、またはチェーンIDが有効でない場合、ウォレットはリクエストを拒否しなければなりません。

`rpcUrls`フィールドが提供されていない場合、または`rpcUrls`フィールドが空の配列の場合、ウォレットはリクエストを拒否しなければなりません。`rpcUrls`に有効なURLではない文字列が含まれている場合、ウォレットはリクエストを拒否しなければなりません。`chainId`が任意のRPCURLの`eth_chainId`メソッドの値と一致しない場合、ウォレットはリクエストを拒否しなければなりません。

`nativeCurrency`フィールドが提供されており、`name`、`symbol`、`decimals`のいずれかのフィールドが欠落している場合、ウォレットはリクエストを拒否しなければなりません。`decimals`フィールドが負の整数の場合、ウォレットはリクエストを拒否しなければなりません。

`blockExplorerUrls`フィールドが提供されており、URLのいずれかが有効でない場合、ウォレットはリクエストを拒否しなければなりません。

`iconUrls`フィールドが提供されており、URLのいずれかが有効でない、または有効な画像を指していない場合、ウォレットはリクエストを拒否しなければなりません。

ウォレットは、`file:`または`http:`スキームを使用するURLを拒否しなければなりません。

#### `wallet_addEthereumChain`の返り値

リクエストが成功した場合は`null`を返し、それ以外の場合はエラーを返します。ウォレットはいかなる理由でもリクエストを拒否することができます。

チェーンが自動的にウォレットで選択されるとは限りません。

既に追加されたチェーンを追加するリクエストは、ユーザーが拒否するか、検証に失敗しない限り、成功するべきです。

ウォレットは、同じ`chainId`を複数回追加することを許可してはいけません。詳細は[セキュリティ上の考慮事項](#セキュリティ上の考慮事項)を参照してください。

## 根拠

`wallet_addEthereumChain`の設計は、チェーンを「追加する」ことの意味を意図的に無視しています。
チェーンをウォレットに「追加する」ことの意味は、ウォレットの実装によって異なります。

メソッドを呼び出す際、`chainId`を指定することは常に必要です。なぜなら、Ethereumチェーンの世界では、[EIP-155](./eip-155.md)のチェーンIDが事実上チェーンのGUIDだからです。
残りのパラメーターは、著者の見積もりでは、ウォレットがチェーンを効果的にサポートし、ユーザーに表示するために最小限必要とするものです。
ネットワークID(`net_version` RPCメソッド)は、事実上チェーンIDに取って代わられているため省略されています。

[セキュリティ上の理由](#セキュリティ上の考慮事項)から、ウォレットは常に要求者が提供するチェーンのメタデータを検証する必要があり、メタデータを別の場所から取得することもできます。
いずれにしろ、チェーンを「追加」するために必要なメタデータは、ウォレットだけが知っています。
したがって、`chainId`以外のすべてのパラメーターはオプションとして指定されています。

この仕様では、ウォレットが「アクティブ」または「現在選択された」チェーンを「切り替える」ことを義務付けていません。
チェーンの「追加」と同様に、チェーンの「切り替え」はウォレットの実装の詳細であり、範囲外です。

## セキュリティ上の考慮事項

`wallet_addEthereumChain`は、正しく実装されないと、エンドユーザーに深刻なリスクをもたらす強力なメソッドです。
これらのリスクの多くは、ウォレットでリクエストデータを検証し、ウォレットのUIで異なるチェーンを明確に区別することで回避できます。

### チェーンID

トランザクションの署名に使用されるチェーンIDは、そのトランザクションが有効なチェーンを決定するため、チェーンIDの正しい処理は非常に重要です。
ウォレットは以下のことを行う必要があります:

- 提出されたチェーンIDが有効であることを確認する。
  - [EIP-695](./eip-695.md)に従って、`0x`プレフィックスの16進数の文字列であり、整数に解析できる必要があります。
- 同じチェーンIDが複数回追加されるのを防ぐ。
  - 複数のRPCエンドポイントの扱いについては次のセクションを参照してください。
- 提出されたチェーンIDのみを使ってトランザクションに署名し、RPCエンドポイントから受け取ったチェーンIDは**決して**使用しない。
  - 悪意のある、または不具合のあるエンドポイントが任意のチェーンIDを返す可能性があり、ユーザーが意図しないチェーンのトランザクションに署名させる可能性があります。
- 指定されたチェーンIDが、上述のように`eth_chainId`の返り値と一致することを確認する。

### RPCエンドポイントとRPCURL

ウォレットは一般的に、ある種のURLで識別されるRPCエンドポイントを介してチェーンと対話します。
ほとんどのウォレットは、信頼できるRPCエンドポイントを持つチェーンのセットを出荷しています。
`rpcUrls`パラメーターで識別されるエンドポイントは、誠実、正確、あるいは同じチェーンを指しているとは限りません。
さらに、信頼できるエンドポイントでも、データ収集の実践によってはユーザーのプライバシーリスクにさらされる可能性があります。

したがって、ウォレットは以下のことを行う必要があります:

- RPC エンドポイントとの対話によって、ユーザーのオンチェーンアクティビティとIPアドレスが露出されることをユーザーに通知する。
- ウォレットに未知のエンドポイントの場合、予期しない動作をする可能性があることをユーザーに通知する。
- エンドポイントとの対話時に、HTTPS を要求するなどの良いWebセキュリティ慣行を遵守する。
- ユーザーに、特定のチェーンとやり取りするために使用されているRPCURLを明確に通知し、同じチェーンの複数のRPCエンドポイントを使用することのリスクについて通知する。

### チェーンデータの検証

`wallet_addEthereumChain`を実装するウォレットは、ウォレットの開発者に完全に未知のチェーンのリクエストに遭遇することを期待する必要があります。
ただし、多くのEthereumチェーンのリクエストを検証するためのコミュニティリソースが存在します。
ウォレットは既知のチェーンのリストを維持し、そのリストに照らしてチェーンの追加リクエストを検証する必要があります。
実際、ウォレットは`wallet_addEthereumChain`リクエストで提供されたチェーンのメタデータよりも、自身のチェーンメタデータを優先することさえあるでしょう。

### ユーザーエクスペリエンス

新しいチェーンをウォレットに追加することは、ウォレットの機能とユーザーエクスペリエンスに大きな影響を与える可能性があります。
ユーザーの明示的な同意なしにチェーンを追加してはいけません。また、異なるチェーンはウォレットのUIで明確に区別されるべきです。
これらの目標を達成するために、ウォレットは以下のことを行う必要があります:

- `wallet_addEthereumChain`リクエストを受け取ったときに、特定のリクエスター がチェーンの追加を要求したことをユーザーに通知する確認画面を表示する。
- `nativeCurrency`や`blockExplorerUrls`などのチェーンメタデータが検証され、UIで最大限活用されるようにする。
- `iconUrls`から画像が提供された場合、ユーザーがそのアイコンによって実際に追加されたチェーンが誤って表現される可能性があることを理解していることを確認する。
- ウォレットのUIに「現在選択された」または「現在アクティブな」チェーンの概念がある場合、`wallet_addEthereumChain`を使って追加されたチェーンがいつ選択されるかをユーザーに明確に理解させる。

### ユーザープライバシーの保護

既に追加されたチェーンを追加するリクエストは一般的に成功とみなされるべきですが、そのようなリクエストを_自動的に_成功とすることで、ユーザーがウォレットに追加したチェーンに関する情報がリクエスターに漏洩してしまいます。
ユーザープライバシーを保護するために、`wallet_addEthereumChain`の実装者は、これらのケースでもユーザーの確認を表示することを検討する必要があります。
ユーザーがリクエストを拒否した場合、ウォレットは通常のユーザー拒否エラーと同じエラーを返す必要があります。これにより、リクエスターがウォレットでサポートされているチェーンを明示的な許可なしに学習することを防ぐことができます。

## 著作権

著作権およびそれに関連する権利は[CC0](../LICENSE.md)によって放棄されています。