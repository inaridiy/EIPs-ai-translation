---
original: 2aa7c2ba3db7ff1e37bd549bdbd674212b2890aaf46eeb83c8aca21ba04c544f
---

---
eip: 3336
title: EVMのページ型メモリ割り当て
author: Nick Johnson (@arachnid)
discussions-to: https://ethereum-magicians.org/t/eips-3336-and-3337-improving-the-evms-memory-model/5482
status: 停滞
type: Standards Track
category: Core
created: 2021-03-06
---

## 簡単な要約
EVMのメモリモデルをページ型に変更します。

## 概要
現在、EVMはメモリを0番地から始まる線形配列として扱っています。これは単純な用途には十分ですが、コンパイラがメモリを密に使うプログラムを生成しなければならず、メモリ要素の再割り当てによるガスの無駄や、ヒープとスタックの分離などの柔軟なメモリモデルを実現するのが難しくなります。この EIP では、実装に最小限の複雑さを追加しつつ、EVMプログラムの柔軟性を大幅に向上させるページ型のビリングモデルを提案します。

## 動機
ほとんどの現代のコンピューターは、ユーザースペースプログラムの「仮想メモリ」を実装しています。プログラムは大きなアドレス空間にアクセスでき、OSによって必要に応じてRAMのページが割り当てられます。これにより、再割り当てやコピーの必要性を最小限に抑えながらメモリ全体に効率的にデータを配置したり、寿命の異なるデータに対して柔軟にメモリを使ったりできます。EVMの内部でシンプルなページ型メモリを実装すれば、同様の柔軟性をEVMをターゲットとするコンパイラに提供できます。

## 仕様
### パラメータ

| 定数 | 値 |
| - | - |
| `FORK_BLOCK` | 未定 |
| `PAGE_BITS` | 10 |
| `PAGE_BASE_COST` | 96 |

`block.number >= FORK_BLOCK`の場合、以下の変更が適用されます。

### EVMの実装におけるメモリ割り当ての変更
メモリは`2**PAGE_BITS`バイトのページ単位で割り当てられます。メモリアドレスの上位`256 - PAGE_BITS`ビットがページ番号を表し、下位`PAGE_BITS`ビットがページ内のアドレスを表します。ページは全てゼロバイトで初期化され、最初のバイトが読み書きされたときに割り当てられます。

EVM実装では、ページ番号をキー、ページ内のバイト配列を値とするアソシアティブ配列(ハッシュテーブルやディクショナリなど)でページテーブルを保持することが推奨されます。

### メモリ拡張ガスコストの変更
現在、メモリを`a`ワード分まで拡張するコストは`Cmem(a) = 3 * a + floor(a ** 2 / 512)`です。メモリが既に`b`ワード分あるときの増分コストは`Cmem(a) - Cmem(b)`です。`a`は0番地から最後に読み書きされたワードまでをカバーするのに必要なワード数です。

この EIP では、割り当てられたページ数に基づく新しいメモリコスト関数を定義します。この関数は`Cmem'(p) = max(PAGE_BASE_COST * (p - 1) + floor(2 * (p - 1) ** 2), 0)`です。前述のように、メモリが既に`q`ページ割り当てられている場合の増分コストは`Cmem'(p) - Cmem'(q)`です。

### `MLOAD`と`MSTORE`の変更
メモリからの読み出しや書き込みには、まだ存在しないページを初期化するためのガスコストが加算されます。ただし、1ページ内に収まる場合は従来の3ガスのままです。2ページにまたがる場合は6ガスとなります。

### その他のメモリ操作命令の変更
`CALLDATACOPY`、`CODECOPY`、`EXTCODECOPY`、`CALL`、`CALLCODE`、`DELEGATECALL`、`STATICCALL`、`CREATE`、`MSTORE8`、およびメモリを読み書きするその他の命令は以下のように変更されます:
 - 読み書きするページが存在しない場合は初期化されます。
 - メモリ拡張ガスが上記の通り課金されます。

## 根拠
### メモリ拡張ガスコスト
新しいガスコストは従来のものと同じ曲線を描きますが、常に従来のコストと同等以下になるようにしています。これにより、メモリ割り当てガスコストに関する仮定を持つ既存のプログラムでエラーが発生するのを防ぐことができます。直感的には、ページ境界までのプログラムは1ページ分少ないコストを払い、ページ境界を1ワード超えるプログラムは1ワード分少ないコストを払うことになります。

このインクリメンタルな削減は、プログラムがより多くのRAMを使うほど比例的に小さくなるため、実効ガスリミットに大きな影響を与えないと考えています。

### 2ページにまたがるMLOADとMSTOREの追加コスト
2ページにまたがるデータの読み書きには、EVMの実装にとってより多くの処理が必要です。ページ境界で単語を分割し、2つ(場合によっては非連続な)ページを更新しなければならないためです。既存のEVMプログラムでページ境界に合わせた読み書きが保証されないため、これを完全に禁止することはできません。代わりに、それぞれ2つの読み書きとしてガス計算を行うことを提案します。これにより、この機能の使用を抑制し、追加の実行コストを反映することができます。

この変更により、このような操作を行うプログラムにはガスコストの増加が生じます。しかし、その影響は最小限であると考えており、今後の分析でそれを確認したいと思います。

## 後方互換性
新しいメモリ拡張ガスコスト関数は、常に現在のEVMが課金する額以下になるように設計されているため、後方互換性の問題は回避できます。ただし、ページ境界をまたぐMLOADとMSTOREでは、前述の通り追加のガスコストが発生する可能性があります。この変更の影響は最小限であり、ガス消費にも小さな影響しか及ぼさないと考えています。

## テストケース
未定

## セキュリティ上の考慮事項
新しいモデルに伴う潜在的なCPUのDoS問題は、ページ境界を超えた読み書きに対してより多くのガスを課金することで緩和されます。メモリ拡張のコストは現在のものに漸近するため、プログラムが現在よりも大幅にメモリを割り当てられるようになることはありません。

## 著作権
[CC0](../LICENSE.md)によりすべての著作権およびそれに関連する権利が放棄されています。