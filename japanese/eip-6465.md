---
original: a90c9d1b67b4d32315d4ca96ca4d83e0f9efa708ab44c51bb22b2325228394bb
---

---
eip: 6465
title: SSZ Withdrawals Root
description: 引き出しMPTコミットメントのSSZへの移行
author: Etan Kissling (@etan-status), Mikhail Kalinin (@mkalinin)
discussions-to: https://ethereum-magicians.org/t/eip-6465-ssz-withdrawals-root/12883
status: Review
type: Standards Track
category: Core
created: 2023-02-08
requires: 2718, 4895, 6493
---

## 概要

このEIPは、引き出しのMerkle-Patricia Trie (MPT)コミットメントを[Simple Serialize (SSZ)](https://github.com/ethereum/consensus-specs/blob/ef434e87165e9a4c82a99f54ffd4974ae113f732/ssz/simple-serialize.md)に移行するプロセスを定義しています。

## 動機

コンセンサス `ExecutionPayloadHeader` と実行ブロックヘッダーは概念的に対応していますが、エンコーディングが異なります。このEIPは、より最新のSSZフォーマットを活用して、`withdrawals_root`のエンコーディングを調整することを目的としています。これにより、いくつかの利点があります:

1. **複雑さの削減:** 提案されたデザインにより、Merkle-Patricia Trie (MPT)をサポートする必要があるユースケースが減少します。

2. **曖昧さの削減:** `withdrawals_root`という名称は現在、異なるルートを指すために使用されています。実行ブロックヘッダーはMerkle Patricia Trie (MPT)ルートを指しますが、コンセンサス `ExecutionPayloadHeader`はSSZルートを指します。この変更により、`withdrawals_root`は常に同じSSZルートを指すようになります。

## 仕様

このドキュメントの「MUST」、「MUST NOT」、「REQUIRED」、「SHALL」、「SHALL NOT」、「SHOULD」、「SHOULD NOT」、「RECOMMENDED」、「NOT RECOMMENDED」、「MAY」、「OPTIONAL」というキーワードは、RFC 2119およびRFC 8174に記載されているように解釈されるものとします。

### 既存の定義

このドキュメントで使用されている既存の仕様からの定義を、参照のために再掲します。

| 名称 | SSZ等価 |
| - | - |
| [`ValidatorIndex`](https://github.com/ethereum/consensus-specs/blob/ef434e87165e9a4c82a99f54ffd4974ae113f732/specs/phase0/beacon-chain.md#custom-types) | `uint64` |
| [`Gwei`](https://github.com/ethereum/consensus-specs/blob/ef434e87165e9a4c82a99f54ffd4974ae113f732/specs/phase0/beacon-chain.md#custom-types) | `uint64` |
| [`ExecutionAddress`](https://github.com/ethereum/consensus-specs/blob/ef434e87165e9a4c82a99f54ffd4974ae113f732/specs/bellatrix/beacon-chain.md#custom-types) | `Bytes20`
| [`WithdrawalIndex`](https://github.com/ethereum/consensus-specs/blob/ef434e87165e9a4c82a99f54ffd4974ae113f732/specs/capella/beacon-chain.md#custom-types) | `uint64` |

| 名称 | 値 |
| - | - |
| [`MAX_WITHDRAWALS_PER_PAYLOAD`](https://github.com/ethereum/consensus-specs/blob/ef434e87165e9a4c82a99f54ffd4974ae113f732/specs/capella/beacon-chain.md#execution) | `uint64(2**4)` (= 16) |
| [`TRANSACTION_TYPE_SSZ`](./eip-6493.md#eip-2718-transaction-types) | `0x04` |

### SSZ `Withdrawal` コンテナ

既存のコンセンサス [`Withdrawal`](https://github.com/ethereum/consensus-specs/blob/ef434e87165e9a4c82a99f54ffd4974ae113f732/specs/capella/beacon-chain.md#withdrawal) SSZコンテナを使用して、引き出しを表します。

```python
class Withdrawal(Container):
    index: WithdrawalIndex
    validator_index: ValidatorIndex
    address: ExecutionAddress
    amount: Gwei
```

### 実行ブロックヘッダーの変更

実行ブロックヘッダーの `withdrawals-root` は、コンセンサス [`ExecutionPayloadHeader.withdrawals_root`](https://github.com/ethereum/consensus-specs/blob/ef434e87165e9a4c82a99f54ffd4974ae113f732/specs/capella/beacon-chain.md#executionpayloadheader)と一致するように更新されます。

```python
withdrawals = List[Withdrawal, MAX_WITHDRAWALS_PER_PAYLOAD](
    withdrawal_0, withdrawal_1, withdrawal_2, ...)

block_header.withdrawals_root == withdrawals.hash_tree_root()
```

### 型付き引き出しエンベロープ

[EIP-2718](./eip-2718.md)に似た型付き引き出しエンベロープが、[Ethereum Wire Protocol](https://github.com/ethereum/devp2p/blob/6b259a7003b4bfb18365ba690f4b00ba8a26393b/caps/eth.md)を介して引き出しを交換するために導入されます。

```
withdrawal = {legacy-withdrawal, typed-withdrawal}
```

型なしの従来の引き出しは、[EIP-4895](./eip-4895.md)で定義されているようにRLPリストとして提供されます。

```
legacy-withdrawal = [
    index: P,
    validator-index: P,
    address: B_20,
    amount: P,
]
```

型付き引き出しは、最初のバイトが引き出しタイプ(`withdrawal-type`)で、残りのバイトがタイプ固有のデータであるRLPバイト配列としてエンコードされます。

```
typed-withdrawal = withdrawal-type || withdrawal-data
```

### ネットワーキング

[Ethereum Wire Protocol](https://github.com/ethereum/devp2p/blob/6b259a7003b4bfb18365ba690f4b00ba8a26393b/caps/eth.md)を介してSSZ引き出しを交換する際は、次の引き出しエンベロープを使用します:

- `Withdrawal`: `TRANSACTION_TYPE_SSZ || snappyFramed(ssz(Withdrawal))`

オブジェクトは[SSZ](https://github.com/ethereum/consensus-specs/blob/ef434e87165e9a4c82a99f54ffd4974ae113f732/ssz/simple-serialize.md)を使ってエンコードされ、Snappyフレーミング形式で圧縮されます。これは、[コンセンサスネットワーキング仕様](https://github.com/ethereum/consensus-specs/blob/ef434e87165e9a4c82a99f54ffd4974ae113f732/specs/phase0/p2p-interface.md#ssz-snappy-encoding-strategy)で定義されているコンセンサスオブジェクトのエンコーディングと一致しています。エンコーディングの一部として、非圧縮オブジェクトの長さが出力されます。オブジェクルあたりの推奨される制限は `8 + 8 + 20 + 8` (= 44) バイトです。

## 根拠

この変更は当初、Shanghaiに含まれる候補でしたが、引き出しの早期導入を加速するために延期されました。

### なぜ型付き引き出しエンベロープなのか?

RLPxシリアル化レイヤーは、引き出しが交換されるときのフォークスケジュールやブロックタイムスタンプを認識していない可能性があります。型付き引き出しエンベロープは、RLPとMPT `withdrawals_root`に基づいて過去のブロックを同期する際に役立ちます。

## 下位互換性

ブロックヘッダーのMPT `withdrawals_root`に依存するアプリケーションは、SSZ `withdrawals_root`に移行する必要があります。

クライアントは、最初のバイトを見ることで従来の引き出しと型付き引き出しを区別できます。最初のバイトが `[0, 0x7f]` の範囲にある場合は新しい引き出しタイプ、`[0xc0, 0xfe]` の範囲にある場合は従来の引き出しタイプです。 `0xff` はRLP符号化された引き出しとしては現実的ではないため、将来の拡張用のセンチネル値として予約されています。

## セキュリティ上の考慮事項

なし

## 著作権

著作権およびそれに関連する権利は[CC0](../LICENSE.md)で放棄されています。