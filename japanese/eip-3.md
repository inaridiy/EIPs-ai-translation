---
original: 6c5fa2dd2a5a204109beb8f65b5d55234047dc71ee4c3de1c73aefdaa78196e8
---

---
eip: 3
title: CALLDEPTH オペコードの追加
author: Martin Holst Swende <martin@swende.se>
status: 取り下げられた
type: Standards Track
category: Core
created: 2015-11-19
---

# 概要

これは、新しいオペコード `CALLDEPTH` を追加する提案です。`CALLDEPTH` オペコードは、残りの利用可能なコールスタックの深さを返します。

# 動機

コントラクトが他のコントラクトを呼び出す (「CALL」または「CALLCODE」を介して) 深さには制限があり、現在の制限は `256` です。この制限に達すると、呼び出し操作は失敗します。

この動作により、コントラクトが「コールスタック攻撃」[1]の対象となる可能性があります。このような攻撃では、攻撃者はまず適切な深さのスタックを作成します (例えば再帰呼び出しによって)。次に、攻撃対象のコントラクトを呼び出します。攻撃対象のコントラクトが別のコントラクトを呼び出すと、その呼び出しは失敗します。呼び出しが成功したかどうかを適切にチェックしていない場合、深刻な影響が生じる可能性があります。

例:

1. コントラクト `A` は定期的に呼び出されることを望み、ブロックごとにイーサを支払っています。
2. コントラクト `A` が呼び出されると、ガスを大量に消費するコントラクト `B` と `C` を呼び出します。呼び出し後、コントラクト `A` は呼び出し元にイーサを支払います。
3. 悪意のあるユーザー `X` は、コントラクト `A` を呼び出す前にスタックの深さを浅くします。`B` と `C` への呼び出しは失敗しますが、`X` は報酬を受け取ることができます。

この攻撃に対する防御策は2つあります:

1. 呼び出し後に返り値をチェックする。
2. 実験的にコールスタックの深さをチェックする。Piper Merriamによる[2]ライブラリがこの目的で使用できます。この方法はガスの消費が高くなります。

[1] 「shallow stack attack」や「stack attack」とも呼ばれますが、正確には「スタック」という用語は EVM 内部で異なる意味を持つため、「コールスタック」と混同しないよう注意が必要です。

[2] https://github.com/pipermerriam/ethereum-stack-depth-lib

# 仕様

`CALLDEPTH` オペコードは、残りのコールスタックの深さを返すべきです。値が `0` の場合、コールスタックが枯渇しており、これ以上の呼び出しはできないことを意味します。

# 根拠

実際のコールスタックの深さと、コールスタックの深さの制限は EVM 実行中に存在しますが、EVM 内部からは利用できません。実装は比較的簡単で、コールスタック攻撃に対する安価で簡単な防御策を提供できるはずです。

# 実装

未実装。