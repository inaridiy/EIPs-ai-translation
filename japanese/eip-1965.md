---
original: 4db5e806f47b6791519d7911011a5be630ce87cda11ce9945a59e28c786dcfce
---

---
eip: 1965
title: 特定のブロック番号でチェーンIDが有効かどうかを確認する方法
author: Ronan Sandford (@wighawag)
category: Core
type: Standards Track
discussions-to: https://ethereum-magicians.org/t/eip-1965-valid-chainid-for-specific-blocknumber-protect-all-forks/3181
status: Stagnant
created: 2019-04-20
requires: 155
---

## 概要
このEIPは、特定のチェーンID (EIP-155の一意の識別子) が特定のブロック番号で有効かどうかを返す前処理を追加します。チェーンIDは、新しいチェーンIDに置き換えられるブロック番号まで有効であると見なされます。

## 動機
[EIP-155](./eip-155.md)は、トランザクションの再生を防ぐためにチェーンIDを使用することを提案しています。特に[EIP-712](./eip-712.md)を使用するレイヤー2署名スキームを扱う際に、スマートコントラクト内でも同様の機能があると大変便利です。

[EIP-1344](./eip-1344.md)はこの問題を解決しようとしていますが、そのような値は変化するため不十分です。そのため、EIP-1344では問題を回避するためのコントラクトベースのソリューションが説明されています。より単純で安価で安全な方法で解決するのが望ましいでしょう。さらに、EIP-1344では、ブロック番号の正確性を保証できないため、マイノリティ主導のハードフォークに対して適切に再生を保護することはできません。

[EIP-1959](./eip-1959.md)はEIP-1344の問題を解決しますが、マイノリティ主導のハードフォークからの保護を試みていません。これは間違いだと考えています。なぜなら、それはフォークする自由を制限するからです。すべてのフォークに同等の機会が与えられるべきだと考えています。多数派が特定のフォークを無視する問題は解決できませんが、**マイノリティフォークと多数派チェーンの両方を使用するユーザーは、多数派チェーンがチェーンIDを更新するのを待つことなく、再生から保護されるべきです。**

## 仕様
新しい前処理を追加し、2つの引数を使用します。1つは32バイトの値で、テストするチェーンIDを表し、もう1つは32バイトの値で、チェーンIDがテストされるブロック番号を表します。チェーンIDがその特定のブロック番号で有効な場合は0x1を返し、そうでない場合は0x0を返します。チェーンIDは、新しいチェーンIDに置き換えられるブロック番号まで有効であると見なされます。つまり、置換後のすべてのブロック番号で有効です。

この操作の実行コストは、`G_blockhash` + `G_verylow`以下になります。ハードフォーク時にのみチェーンIDが導入されるため、これよりも低くなる可能性があります。

チェーンの履歴でチェーンIDの数が増えるにつれ、操作のコストを後で調整する必要があるかもしれません。

ただし、過去のチェーンIDを追跡するための代替案であるEIP-1344が提案するスマートコントラクトベースのキャッシュソリューションは、全体的なガスコストが高く、マイノリティ主導のハードフォークに問題がある(下記の根拠セクションを参照)ため、ガスコストはこの機能に必要な費用に過ぎません。

## 根拠

EIP-1959の根拠もここでも適用されます:

- オペコードはキャッシュシステムよりも優れています。より安価で安全で、ギャップがありません。
- 最新のチェーンIDに直接アクセスすると危険です。これにより、コントラクトがそれをリプレイ保護メカニズムとして使用しやすくなり、フォーク後に以前の有効なメッセージが無効になる可能性があります。これはユーザーに深刻な影響を与える可能性があります。
- フォーク前に署名されたすべてのオフチェーンメッセージは、フォークの両側で有効であるべきです。

唯一の違いは、現在の提案がマイノリティ主導のハードフォークを保護する解決策を提案していることです。

要約すると、2つの可能なフォークシナリオがあります:

1) 多数派がハードフォークを行うが、マイノリティが同意しない(ETCはそのような例です)。フォークはブロックXで計画されています。多数派がチェーンIDの割り当てを自動化するアクションを取らない場合、マイノリティには、同じブロックXでチェーンIDのアップグレードを計画する十分な時間があります。そうしない場合、ユーザーはメッセージが多数派チェーンで再生可能になる問題に直面します(これは逆の場合は当てはまりません。多数派がチェーンIDを変更することを前提としています)。そのため、そのままにしておく理由はありません。

2) マイノリティがフォークを作成し、多数派が同意しない(または単に無視する)。上記と同様のことが起こる可能性がありますが、マイノリティの場合、多数派が気にしない可能性があります。その場合、多数派がチェーンIDをアップグレードする動機はありません。つまり、両サイドのユーザーは、マイノリティチェーンがチェーンIDを変更しても、多数派チェーンに宛てられたメッセージを再生できてしまいます。

解決策は、メッセージに署名された時点のブロック番号を引数として使用することです。これにより、マイノリティがチェーンIDを変更した場合、以前のチェーンIDはそのブロック番号以降無効になります。したがって、多数派チェーンに宛てられた新しいメッセージをマイノリティフォークで再生することはできません。

## 下位互換性

EIP-712はまだドラフト段階ですが、ユーザーの保護のために、ウォレットが検証する値にブロック番号を含めるように更新する必要があります。

チェーンIDとブロック番号は変化するため、ドメイン区切り文字(一度生成されるものと想定)の一部ではなく、メッセージの別の部分に含める必要があります。

再生を気にしないコントラクトや、他の方法で再生を防ぐコントラクトでは、ペアはオプションとすることができますが、チェーンIDが存在する場合は、ブロック番号も存在する必要があります。また、どちらかが存在する場合、ウォレットは、使用中のチェーンの最新のチェーンIDと、署名時点の最新のブロック番号を確認する必要があります。フォーク遷移中は、ウォレットがブロック番号を使ってどのチェーンIDを使うべきかを判断できます。

## 参考文献
これは以前[EIP1959の議論](https://ethereum-magicians.org/t/eip-1959-valid-chainid-opcode/3170)の一部として提案されていました。

## 著作権
著作権およびそれに関連する権利は[CC0](../LICENSE.md)で放棄されています。