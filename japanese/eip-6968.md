---
original: 16f1502a45fd6ae7a892fb2efa2ad9ae97d6fd00942fd086703bb55be02a55e1
---

---
eip: 6968
title: EVM ベースの L2 上でのコントラクト セキュアド レベニュー
description: EVM ベースの L2 上でのコントラクト セキュアド レベニュー
author: Zak Cole <zak@numbergroup.xyz>、Zak Cole (@zscole)、Kevin Owocki <kevin@supermodular.xyz>、lightclient (@lightclient)
discussions-to: https://ethereum-magicians.org/t/eip-6968-generalized-csr-protocol/14178
status: 停滞
type: Standards Track
category: Core
created: 2023-05-01
---

## 概要

コントラクト セキュアド レベニュー (CSR) は、スマートコントラクト開発者がユーザーがそのスマートコントラクトと対話するときに支払われるすべてのトランザクション手数料の一部を請求できるようにします。

このEIPは、L2 上の CSR の導入を提案しており、L2 にデプロイされたスマートコントラクト開発者にレベニューストリームおよび/または公共財へのアクセスを提供します。

## 動機

L1 のプロトコル報酬を使ってスマートコントラクト開発を資金提供することは、現在の市場の動作方法に大きな変化をもたらすでしょう。このEIPは、*既存の Ethereum L1 への変更を提唱するものではありません*。

このEIPは、L2 が以下のために CSR を実験し始めることを提唱しています:

1. スマートコントラクト開発者の新しいレベニューストリームの作成
2. 公共財への新しい資金調達方法の作成
3. デベロッパーがアプリケーションをあなたのネットワークにデプロイするためのインセンティブの作成

## 仕様

### パラメーター

| 定数 | 値 |
|---|---|
| REVENUE_SHARE_QUOTIENT | 5 |

### 手数料メカニズム

現在の [EIP-1559](./eip-1559.md) の手数料動作が変更され、`header.base_fee_per_gas * REVENUE_SHARE_QUOTIENT` per ガスが、トランザクション中に実行されたそれぞれのコントラクトに比例して再配分されます。

暗黙のうちに、これは外部所有アカウント (EOA) への手数料の再配分がないことを意味します。

#### ガス追跡

手数料収益を公平に分配するために、新しいトランザクション全体のガストラッカーが定義されます。

ブロックを実行する際、`address` から `uint64` への `gas_used_by_address` マッピングを維持します。これにより、各アドレスが使用したガス量が追跡されます。新しい実行フレームをインスタンス化しない EVM 命令 (例: `CALL`、`CALLCODE`、`DELEGATECALL`、`STATICCALL`、`CREATE`、`CREATE2`) の場合、命令のコストをマッピングの現在の合計に追加します。

新しいフレームをインスタンス化する EVM 命令の場合、呼び出しフレームへのコストを正確に決定する必要があります。簡単のため、このコストは操作の合計コストから子フレームに渡されたガス量を引いたものと定義されます。子フレームに渡されたガスは [EIP-150](./eip-150.md) により決定されます。計算されたコストは、マッピングの現在の合計に追加されます。

さらに:

- アドレスがマッピングに存在しない場合、その合計ガス使用量は `0` です。
- 命令がガス切れ (OOG) エラーをスローした場合、実行フレームに割り当てられた残りのガス全体がアドレスの現在の合計ガス使用量に追加されます。
- その他の例外的な停止は、停止が発生したアドレスのカウンターに残りのガスを追加しません。

#### レベニュー受取人の設定

レベニュー受取人は、`address` から `address` への新しいトランザクション全体のマッピング `revenue_recipient` で追跡されます。すべてのキーのデフォルト値はキー自体です。たとえば、特に設定されていない限り、キー `0xdead...beef` は値 `0xdead...beef` にマッピングされます。

別のレベニュー受取人を設定するには、オペコード `0x49` を持つ新しい命令 `SETREVENUERECIPIENT` が導入されます。この操作は入力として `1` 個のスタック要素を取り、`0` 個のスタック要素を出力します。

入力スタック要素の下位 `20` バイトは、命令の呼び出し元の新しいレベニュー受取人アドレスです。`revenue_recipient` エントリはこれを反映するように更新されます。

この命令のコストは `3` ガスです。

#### レベニューの分散

トランザクションが完了した後、`gas_used_by_address` の各要素 (`addr`、`gas_used`) について、`revenue_recipient[addr]` の残高を `gas_used * (header.base_fee_per_gas // REVENUE_SHARE_QUOTIENT)` だけ増やします。

## 根拠

### ガスを比例的に追跡する

より単純なメカニズムは、トランザクションの全収益を取引の `to` 値に送信することです。しかし、これでは多数の異なるスマートコントラクトやアプリケーションの構成を正確に報酬することはできません。さらに、スマートコントラクトウォレットとの互換性がありません。これらは、定義上、多くの場合、トランザクションの最初の宛先です。

トランザクション全体のガス使用量トラッカーを維持することで、真に最も利用されているコントラクトに収益を分配することができます。

### 一時的なレベニュー受取人マッピング

各トランザクションで一時的にレベニュー受取人マッピングを構築することは、表面上は非効率に見えます。この値は比較的静的であると予想され、変更が必要な場合でも、受取人コントラクトによって容易に行うことができます。

残念ながら、そのような変更は EVM にとってはるかに侵襲的です。受取人の値をどこかに保存する必要があります。これには状態トライのアカウント構造の変更が必要です。また、受取人の値をいずれかの時点で設定する必要があります。これには、`CREATE*` オペコードの変更または `SETREVENUERECIPIENT` のような新しいオペコードの導入が必要になります。これは初期化コードによって「初期化」されます。

## セキュリティ上の考慮事項

### ブロックサイズ/複雑性の増加

EIP-1559 と同様に、これがブロックサイズに与える影響を考慮する必要があります。実装方法によっては、多数のコントラクトが CSR に参加した場合、最大ブロックサイズが増加する可能性があります。

## 著作権

[CC0](../LICENSE.md) によりワイバーされた著作権およびそれに関連する権利。