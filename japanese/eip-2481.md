---
original: 3454883b8640595802380d71fcab43f9511f78d144346e7fc5b4fa3a67aa3dcc
---

---
eip: 2481
title: eth/66リクエスト識別子
description: eth プロトコルのすべてのリクエストに対するリクエストIDを導入する
author: Christoph Burgdorf (@cburgdorf)
discussions-to: https://ethereum-magicians.org/t/eip-2481-eth-66-request-identifiers/12132
status: 最終
type: 標準トラック
category: ネットワーキング
created: 2020-01-17
requires: 2464
---

## 概要

`eth`プロトコルは、Ethereumノード間でデータを交換するために使用される様々なリクエストとレスポンスコマンドを定義しています。例えば、特定のヘッダーセットを要求するために、ノードは [`GetBlockHeaders`](https://github.com/ethereum/devp2p/blob/40ab248bf7e017e83cc9812a4e048446709623e8/caps/eth.md#getblockheaders-0x03)コマンドを送信します。

*[`GetBlockHeaders`仕様定義](https://github.com/ethereum/devp2p/blob/40ab248bf7e017e83cc9812a4e048446709623e8/caps/eth.md#getblockheaders-0x03)から引用:*

>`[block: {P, B_32}, maxHeaders: P, skip: P, reverse: P in {0, 1}]`

>ピアに`BlockHeaders`メッセージを返すよう要求する。応答には、`reverse`が`0`の場合は上昇番号の、`1`の場合は下降番号の、`skip`ブロック離れた、正規チェーンの`block`(番号またはハッシュで指定)から始まる、最大`maxHeaders`個のブロックヘッダーが含まれる必要がある。

`GetBlockHeaders`コマンドを受信したノードは、適切に`BlockHeaders`レスポンスコマンドで答える必要があります。

*[`BlockHeaders`仕様定義](https://github.com/ethereum/devp2p/blob/40ab248bf7e017e83cc9812a4e048446709623e8/caps/eth.md#blockheaders-0x04)から引用:*

>`[blockHeader_0, blockHeader_1, ...]`

>GetBlockHeadersへの応答。リスト内の項目(メッセージIDの後)は、メインのEthereum仕様で説明されているフォーマットのブロックヘッダーで、GetBlockHeadersメッセージで以前に要求されたものです。要求されたブロックヘッダーが見つからなかった場合、ブロックヘッダーが含まれていない場合があります。単一のメッセージで要求できるヘッダーの数は、実装依存の制限の対象となる可能性があります。

クライアントが1つのピアに対して`GetBlockHeaders`の多数の同時リクエストを行う場合を考えてみましょう。送信された順序でレスポンスが到着することは保証されていません。クライアントは、受信したレスポンスの内容に基づいて、保留中のすべてのリクエストをループして照合することで、正しいリクエストに関連付ける必要があります。

空のレスポンスなど、曖昧なレスポンスの場合、特に面倒です。

このEIPは、`GetBlockHeaders`と`BlockHeaders`コマンドに`request_id`を含めることを提案しています。

`request_id`は、クライアントがリクエストを行う際に設定される64ビットの整数です。応答側では、受信したリクエストと同じ`request_id`が応答オブジェクトに設定されます。

この変更により、クライアントは受信したレスポンスを保留中のリクエストと直接照合できるようになり、レスポンスデータに基づいて照合する必要がなくなります。

選択されたリクエスト/レスポンスペアは、`eth`ネットワークプロトコルの多くの類似するリクエスト/レスポンスペアの例として機能します。

## 動機

`eth`プロトコルのリクエスト/レスポンスペアにリクエスト識別子がないことで、すべてのEthereumクライアントにコード複雑性の不要な負担がかかっています。また、通信の効率も若干低下しています。さらに、リクエスト識別子の追加により、`les`プロトコルとより整合性が取れるようになるという議論もできます。

## 仕様

`eth`プロトコルの以下のメッセージタイプを変更します:

* `GetBlockHeaders (0x03)`
   * **現在(eth/65):** `[block: {P, B_32}, maxHeaders: P, skip: P, reverse: P in {0, 1}]`
   * **変更後(eth/66)**: `[request_id: P, [block: {P, B_32}, maxHeaders: P, skip: P, reverse: P in {0, 1}]]`
* `BlockHeaders (0x04)`
   * **現在(eth/65):** `[blockHeader_0, blockHeader_1, ...]`
   * **変更後(eth/66)**: `[request_id: P, [blockHeader_0, blockHeader_1, ...]]`
* `GetBlockBodies (0x05)`
   * **現在(eth/65):** `[hash_0: B_32, hash_1: B_32, ...]`
   * **変更後(eth/66)**: `[request_id: P, [hash_0: B_32, hash_1: B_32, ...]]`
* `GetPooledTransactions (0x09)`:
   * **現在(eth/65)**`[hash_0: B_32, hash_1: B_32, ...]`
   * **変更後(eth/66)**`[request_id: P, [hash_0: B_32, hash_1: B_32, ...]]`
* `PooledTransactions (0x0a)`:
   * **現在(eth/65)**`[[nonce: P, receivingAddress: B_20, value: P, ...], ...]`
   * **変更後(eth/66)**`[request_id: P, [[nonce: P, receivingAddress: B_20, value: P, ...], ...]]`
* `BlockBodies (0x06)`
   * **現在(eth/65):** `[hash_0: B_32, hash_1: B_32, ...]`
   * **変更後(eth/66)**: `[request_id: P, [hash_0: B_32, hash_1: B_32, ...]]`
* `GetNodeData (0x0d)`
   * **現在(eth/65):** `[hash_0: B_32, hash_1: B_32, ...]`
   * **変更後(eth/66)**: `[request_id: P, [hash_0: B_32, hash_1: B_32, ...]]`
* `NodeData (0x0e)`
   * **現在(eth/65):** `[value_0: B, value_1: B, ...]`
   * **変更後(eth/66)**: `[request_id: P, [value_0: B, value_1: B, ...]]`
* `GetReceipts (0x0f)`
   * **現在(eth/65):** `[blockHash_0: B_32, blockHash_1: B_32, ...]`
   * **変更後(eth/66)**: `[request_id: P, [blockHash_0: B_32, blockHash_1: B_32, ...]]`
* `Receipts (0x10)`
   * **現在(eth/65):** `[[receipt_0, receipt_1], ...]`
   * **変更後(eth/66)**: `[request_id: P, [[receipt_0, receipt_1], ...]]`


具体的には、各コマンドは以下のように変更されます:

1. `request_id`を最初の要素とするリストを作成する。
2. 現在のスキームですべてのコマンドを定義するリストを2番目の要素にする。

`request_id`には以下の特徴があります:

* 64ビットの整数
* 連続である必要はない(ランダムでもよい)
* 重複を許可する

## 根拠

**Q: 効率性の向上により、クライアントがピアに同時に多数のリクエストを送りつける可能性がある**

ピアは常に、自分が適切に扱われていないと感じた場合に、スロットリングやディスコネクトを行うことができます。これは現在と同じです。

**Q: `les`プロトコルがすでにこのようなコマンドを定義しているのであれば、なぜ`les`プロトコルを使わないのか?**

実際のところ、`les`プロトコルを提供するピアは、ネットワーク上ではるかに見つけにくいです。その理由は様々ですが、クライアントのデフォルト設定、未成熟な実装、インセンティブの欠如などが考えられます。

**Q: 現在のネットワーキングは機能しているので、これは単なるブロートに過ぎない**

これは1つのコマンドあたり1つの整数を追加するものですが、同時にコード複雑性を減らし、ネットワーキングの効率を向上させます。この追加は正当化できると思います。

**Q: なぜリクエストIDを連続にする必要がないのか?**

リクエストIDが常に`0`から数え始めると仮定すると、接続が失われてクライアントが再接続する際に、前のセッションで使用したのと同じリクエストIDを使うことになり、混乱が生じます。

**Q: なぜ重複したリクエストIDを許可するのか?**

主な利点は、実装側の柔軟性と簡単さです。クライアントは、自然に分離されているため、複数の異なるリクエストタイプ間で同じIDを共有することができます。クライアントは、リクエストIDに全く依存しないことを決めて、すべてのリクエストで同じ定数のリクエストIDを使うこともできます。

**Q: なぜリクエストIDに64ビットの整数を選んだのか**

`les`プロトコルとの互換性を維持するために、64ビットの整数を選択しました。

## 下位互換性

このEIPは、`eth`プロトコルを下位互換性のない方法で拡張し、新しいバージョン`eth/66`のリリースが必要です。ただし、`devp2p`は同じワイヤープロトコルの複数のバージョンを並行して実行することをサポートしているため、`eth/66`のロールアウトにはクライアントの調整は必要ありません。更新されていないクライアントは`eth/65`を継続して使用できます。

このEIPはコンセンサスエンジンを変更しないため、ハードフォークは*必要ありません*。

## テストケース

これらのテストケースは、すべての再定義されたメッセージタイプのRLP エンコーディングをカバーしています。ここで、`rlp`部分はデータ部分で定義されたメッセージのRLP エンコーディングです。 


```json
{
  "type": "GetBlockHeadersPacket66",
  "rlp": "0xe8820457e4a000000000000000000000000000000000000000000000000000000000deadc0de050580",
  "data": {
    "RequestId": 1111,
    "Origin": {
      "Hash": "0x00000000000000000000000000000000000000000000000000000000deadc0de",
      "Number": 0
    },
    "Amount": 5,
    "Skip": 5,
    "Reverse": false
  }
}
```

```json
{
  "type": "GetBlockHeadersPacket66",
  "rlp": "0xca820457c682270f050580",
  "data": {
    "RequestId": 1111,
    "Origin": {
      "Hash": "0x0000000000000000000000000000000000000000000000000000000000000000",
      "Number": 9999
    },
    "Amount": 5,
    "Skip": 5,
    "Reverse": false
  }
}
```

```json
{
  "type": "BlockHeadersPacket66",
  "rlp": "0xf90202820457f901fcf901f9a00000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000940000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000b90100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008208ae820d0582115c8215b3821a0a827788a00000000000000000000000000000000000000000000000000000000000000000880000000000000000",
  "data": {
    "RequestId": 1111,
    "BlockHeadersPacket": [
      {
        "parentHash": "0x0000000000000000000000000000000000000000000000000000000000000000",
        "sha3Uncles": "0x0000000000000000000000000000000000000000000000000000000000000000",
        "miner": "0x0000000000000000000000000000000000000000",
        "stateRoot": "0x0000000000000000000000000000000
000000000000000000000000000000",
        "transactionsRoot": "0x0000000000000000000000000000000000000000000000000000000000000000",
        "receiptsRoot": "0x0000000000000000000000000000000000000000000000000000000000000000",
        "logsBloom": "0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
        "difficulty": "0x8ae",
        "number": "0xd05",
        "gasLimit": "0x115c",
        "gasUsed": "0x15b3",
        "timestamp": "0x1a0a",
        "extraData": "0x7788",
        "mixHash": "0x0000000000000000000000000000000000000000000000000000000000000000",
        "nonce": "0x0000000000000000",
        "hash": "0x8c2f2af15b7b563b6ab1e09bed0e9caade7ed730aec98b70a993597a797579a9"
      }
    ]
  }
}
```

```json
{
  "type": "GetBlockBodiesPacket66",
  "rlp": "0xf847820457f842a000000000000000000000000000000000000000000000000000000000deadc0dea000000000000000000000000000000000000000000000000000000000feedbeef",
  "data": {
    "RequestId": 1111,
    "GetBlockBodiesPacket": [
      "0x00000000000000000000000000000000000000000000000000000000deadc0de",
      "0x00000000000000000000000000000000000000000000000000000000feedbeef"
    ]
  }
}
```

```json
{
  "type": "BlockBodiesPacket66",
  "rlp": "0xf902dc820457f902d6f902d3f8d2f867088504a817c8088302e2489435353535353535353535353535353535353535358202008025a064b1702d9298fee62dfeccc57d322a463ad55ca201256d01f62b45b2e1c21c12a064b1702d9298fee62dfeccc57d322a463ad55ca201256d01f62b45b2e1c21c10f867098504a817c809830334509435353535353535353535353535353535353535358202d98025a052f8f61201b2b11a78d6e866abc9c3db2ae8631fa656bfe5cb53668255367afba052f8f61201b2b11a78d6e866abc9c3db2ae8631fa656bfe5cb53668255367afbf901fcf901f9a00000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000940000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000000b90100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000008208ae820d0582115c8215b3821a0a827788a00000000000000000000000000000000000000000000000000000000000000000880000000000000000",
  "data": {
    "RequestId": 1111,
    "BlockBodiesPacket": [
      {
        "Transactions": [
          {
            "nonce": "0x8",
            "gasPrice": "0x4a817c808",
            "gas": "0x2e248",
            "to": "0x3535353535353535353535353535353535353535",
            "value": "0x200",
            "input": "0x",
            "v": "0x25",
            "r": "0x64b1702d9298fee62dfeccc57d322a463ad55ca201256d01f62b45b2e1c21c12",
            "s": "0x64b1702d9298fee62dfeccc57d322a463ad55ca201256d01f62b45b2e1c21c10",
            "hash": "0x588df025c4c2d757d3e314bd3dfbfe352687324e6b8557ad1731585e96928aed"
          },
          {
            "nonce": "0x9",
            "gasPrice": "0x4a817c809",
            "gas": "0x33450",
            "to": "0x3535353535353535353535353535353535353535",
            "value": "0x2d9",
            "input": "0x",
            "v": "0x25",
            "r": "0x52f8f61201b2b11a78d6e866abc9c3db2ae8631fa656bfe5cb53668255367afb",
            "s": "0x52f8f61201b2b11a78d6e866abc9c3db2ae8631fa656bfe5cb53668255367afb",
            "hash": "0xf39c7dac06a9f3abf09faf5e30439a349d3717611b3ed337cd52b0d192bc72da"
          }
        ],
        "Uncles": [
          {
            "parentHash": "0x0000000000000000000000000000000000000000000000000000000000000000",
            "sha3Uncles": "0x0000000000000000000000000000000000000000000000000000000000000000",
            "miner": "0x0000000000000000000000000000000000000000",
            "stateRoot": "0x0000000000000000000000000000000000000000000000000000000000000000",
            "transactionsRoot": "0x0000000000000000000000000000000000000000000000000000000000000000",
            "receiptsRoot": "0x0000000000000000000000000000000000000000000000000000000000000000",
            "logsBloom": "0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
            "difficulty": "0x8ae",
            "number": "0xd05",
            "gasLimit": "0x115c",
            "gasUsed": "0x15b3",
            "timestamp": "0x1a0a",
            "extraData": "0x7788",
            "mixHash": "0x0000000000000000000000000000000000000000000000000000000000000000",
            "nonce": "0x0000000000000000",
            "hash": "0x8c2f2af15b7b563b6ab1e09bed0e9caade7ed730aec98b70a993597a797579a9"
          }
        ]
      }
    ]
  }
}
```

```json
{
  "type": "GetNodeDataPacket66",
  "rlp": "0xf847820457f842a000000000000000000000000000000000000000000000000000000000deadc0dea000000000000000000000000000000000000000000000000000000000feedbeef",
  "data": {
    "RequestId": 1111,
    "GetNodeDataPacket": [
      "0x00000000000000000000000000000000000000000000000000000000deadc0de",
      "0x00000000000000000000000000000000000000000000000000000000feedbeef"
    ]
  }
}
```

```json
{
  "type": "NodeDataPacket66",
  "rlp": "0xce820457ca84deadc0de84feedbeef",
  "data": {
    "RequestId": 1111,
    "NodeDataPacket": [
      "0xdeadc0de",
      "0xfeedbeef"
    ]
  }
}
```

```json
{
  "type": "GetReceiptsPacket66",
  "rlp": "0xf847820457f842a000000000000000000000000000000000000000000000000000000000deadc0dea000000000000000000000000000000000000000000000000000000000feedbeef",
  "data": {
    "RequestId": 1111,
    "GetReceiptsPacket": [
      "0x00000000000000000000000000000000000000000000000000000000deadc0de",
      "0x00000000000000000000000000000000000000000000000000000000feedbeef"
    ]
  }
}
```

```json
{
  "type": "ReceiptsPacket66",
  "rlp": "0xf90172820457f9016cf90169f901668001b9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000f85ff85d940000000000000000000000000000000000000011f842a0000000000000000000000000000000000000000000000000000000000000deada0000000000000000000000000000000000000000000000000000000000000beef830100ff",
  "data": {
    "RequestId": 1111,
    "ReceiptsPacket": [
      [
        {
          "root": "0x",
          "status": "0x0",
          "cumulativeGasUsed": "0x1",
          "logsBloom": "0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
          "logs": [
            {
              "address": "0x0000000000000000000000000000000000000011",
              "topics": [
                "0x000000000000000000000000000000000000000000000000000000000000dead",
                "0x000000000000000000000000000000000000000000000000000000000000beef"
              ],
              "data": "0x0100ff",
              "blockNumber": "0x0",
              "transactionHash": "0x0000000000000000000000000000000000000000000000000000000000000000",
              "transactionIndex": "0x0",
              "blockHash": "0x0000000000000000000000000000000000000000000000000000000000000000",
              "logIndex": "0x0",
              "removed": false
            }
          ],
          "transactionHash": "0x00000000000000000000000000000000000000000000000000000000deadc0de",
          "contractAddress": "0x0000000000000000000000000000000000011111",
          "gasUsed": "0x1b207",
          "blockHash": "0x0000000000000000000000000000000000000000000000000000000000000000",
          "transactionIndex": "0x0"
        }
      ]
    ]
  }
}
```

```json
{
  "type": "GetPooledTransactionsPacket66",
  "rlp": "0xf847820457f842a000000000000000000000000000000000000000000000000000000000deadc0dea000000000000000000000000000000000000000000000000000000000feedbeef",
  "data": {
    "RequestId": 1111,
    "GetPooledTransactionsPacket": [
      "0x00000000000000000000000000000000000000000000000000000000deadc0de",
      "0x00000000000000000000000000000000000000000000000000000000feedbeef"
    ]
  }
}
```

```json
{
  "type": "PooledTransactionsPacket66",
  "rlp": "0xf8d7820457f8d2f867088504a817c8088302e2489435353535353535353535353535353535353535358202008025a064b1702d9298fee62dfeccc57d322a463ad55ca201256d01f62b45b2e1c21c12a064b1702d9298fee62dfeccc57d322a463ad55ca201256d01f62b45b2e1c21c10f867098504a817c809830334509435353535353535353535353535353535353535358202d98025a052f8f61201b2b11a78d6e866abc9c3db2ae8631fa656bfe5cb53668255367afba052f8f61201b2b11a78d6e866abc9c3db2ae8631fa656bfe5cb53668255367afb
",
  "data": {
    "RequestId": 1111,
    "PooledTransactionsPacket": [
      {
        "nonce": "0x8",
        "gasPrice": "0x4a817c808",
        "gas": "0x2e248",
        "to": "0x3535353535353535353535353535353535353535",
        "value": "0x200",
        "input": "0x",
        "v": "0x25",
        "r": "0x64b1702d9298fee62dfeccc57d322a463ad55ca201256d01f62b45b2e1c21c12",
        "s": "0x64b1702d9298fee62dfeccc57d322a463ad55ca201256d01f62b45b2e1c21c10",
        "hash": "0x588df025c4c2d757d3e314bd3dfbfe352687324e6b8557ad1731585e96928aed"
      },
      {
        "nonce": "0x9",
        "gasPrice": "0x4a817c809",
        "gas": "0x33450",
        "to": "0x3535353535353535353535353535353535353535",
        "value": "0x2d9",
        "input": "0x",
        "v": "0x25",
        "r": "0x52f8f61201b2b11a78d6e866abc9c3db2ae8631fa656bfe5cb53668255367afb",
        "s": "0x52f8f61201b2b11a78d6e866abc9c3db2ae8631fa656bfe5cb53668255367afb",
        "hash": "0xf39c7dac06a9f3abf09faf5e30439a349d3717611b3ed337cd52b0d192bc72da"
      }
    ]
  }
}