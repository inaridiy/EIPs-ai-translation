---
original: b1034f7b6f46a77c69b8233ee8aceac67c443f879c9446b052a1b593f7da58e6
---

---
eip: 1087
title: SSTORE操作のネットガスメーター
author: Nick Johnson (@arachnid)
discussions-to: https://ethereum-magicians.org/t/eip-net-storage-gas-metering-for-the-evm/383
status: 停滞
type: Standards Track
category: Core
created: 2018-05-17
---

## 概要
このEIPは、不適切な高いガス代を削減し、コントラクトストレージの新しい使用例を可能にするため、EVMの`SSTORE`操作のガス課金方法を変更することを提案します。

## 動機
現在、`SSTORE`(`0x55`)操作は以下のように課金されています:

 - スロットを0から非0に設定する場合は20,000ガス
 - その他の変更の場合は5,000ガス
 - 非0から0に設定する場合は10,000ガスの払い戻し。払い戻しはトランザクション終了時に適用されます。

単一の更新が行われるトランザクションでは、これらのガス代が消費されたリソースを適切に反映していると判断されています。しかし、複数の更新を行うシーケンスでは、過剰なガス代がかかってしまいます。

問題を示す例:

 - 空のストレージを持つコントラクトがスロット0を1に設定し、その後0に戻す場合、`20000 + 5000 - 10000 = 15000`ガスが課金されますが、このシーケンスではディスク書き込みは必要ありません。
 - 空のストレージを持つコントラクトがスロット0を5回インクリメントする場合、`20000 + 5 * 5000 = 45000`ガスが課金されますが、これは単一の書き込み(20000ガス)と同等の処理量です。
 - 口座AからBへの残高転送、続いてBからCへの転送(すべての口座の開始/終了残高が非0)の場合、`5000 * 4 = 20000`ガスが課金されます。

この問題に対処すれば、トランザクション終了時に純粋な変更がない一連の操作(reentrancy防止用のミューテックス、同一コントラクトへの複数呼び出しで渡されるコンテキスト情報など)を可能にする新しい使用例が生まれます。例えば、トークン規格の新しい`approveAndCall`操作などです。

## 仕様
EVMに以下の変更を加えます:

 - トランザクション単位で'dirty map'を維持し、現在のトランザクションで変更されたすべてのコントラクトのストレージスロットを追跡します。dirty mapの変更は、呼び出しがロールバックされた場合も保持されません。
 - 既存の値と同じ値でストレージスロットに書き込む場合は200ガス課金します。
 - ストレージスロットの値が初めて変更される場合、そのスロットをdirtyとマークします。スロットが以前0だった場合は20000ガス、それ以外の場合は5000ガス課金します。
 - dirty mapに既に登録されているスロットに書き込む場合は200ガス課金します。
 - トランザクション終了時に、dirty mapの各スロットについて以下を行います:
   - スロットが取引前後で0だった場合、19800ガスを払い戻す。
   - スロットが取引前後で非0だった場合で、値が変更されていない場合、4800ガスを払い戻す。
   - スロットが取引前は非0で、現在は0の場合、15000ガスを払い戻す。

これらの変更後、単一のストレージ変更を行うトランザクションは従来の課金方式を維持しますが、複数の変更を行うコントラクトでは大幅なガス代の削減が見込めます。前述の例を繰り返すと:

 - 空のストレージを持つコントラクトがスロット0を1に設定し、その後0に戻す場合、`20000 + 200 - 19800 = 400`ガスが課金されます(従来は15000ガス)。
 - 空のストレージを持つコントラクトがスロット0を5回インクリメントする場合、`20000 + 5 * 200 = 21000`ガスが課金されます(従来は45000ガス)。
 - 口座AからBへの残高転送、続いてBからCへの転送(すべての口座の開始/終了残高が非0)の場合、`5000 * 3 + 200 - 4800 = 10400`ガスが課金されます(従来は20000ガス)。

## 根拠
提案するメカニズムは、ノードが実際に負担するコストを反映するようにストレージガス代を削減する最も単純な方法だと考えています。他の代替案も検討しましたが、以下の理由で却下しました:

 - `SSTORE`操作に一律200ガスを課し、取引終了時に新規/変更値に対して19800/4800ガスを追加課金する方式は単純ですが、ガス消費の大部分をEVMスタックの外に押し出し、デバッグを複雑化させ、コントラクトによる呼び出し先のガス消費制限を困難にし、EVMに新しいメカニズムを導入することになります。
 - ストレージガス払い戻し用の別カウンターを維持すれば、払い戻しが消費ガスの半分に制限される問題は回避できますが、追加の複雑性が生じます。
 - ストレージスロットが初期値に戻される都度即時払い戻しを行うと、新しいメカニズム(即時払い戻し)を導入し、コントラクト間のガス会計を複雑化させ、マイナスの実行コストが発生する可能性があります。

## 下位互換性
このEIPの実装にはハードフォークが必要です。

ガス代が増加するコントラクトはなく、多くのコントラクトでガス消費が減少するため、コントラクトレベルの下位互換性の問題は予想されません。

## テストケース

 - 0を含むスロットに0以外の値xを書き込む (20kガス、払い戻しなし)
 - xを含むスロットに異なる値yを書き込む (xとyが0以外の場合、5kガス、払い戻しなし)
 - 非0の値xを含むスロットに0を書き込む (5kガス、10k払い戻し)
 - 0を含むスロットに0を書き込む (200ガス、払い戻しなし)
 - 0以外の値xを含むスロットに同じ値xを書き込む (200ガス、払い戻しなし)
 - 0を含むスロットにxを書き込み、次にyを書き込む (xとyが異なる場合、20200ガス、払い戻しなし)
 - 0を含むスロットにxを書き込み、次にyを書き込む (x、yが0以外で異なる場合、5200ガス、払い戻しなし)
 - 0を含むスロットにxを書き込み、次に0を書き込む (xが0以外の場合、20200ガス、19800払い戻し)
 - yを含むスロットにxを書き込み、次にyを書き込む (xとyが0以外で異なる場合、5200ガス、4800払い戻し)
 - 0を含むスロットにxを書き込み、その後スタックフレームをロールバックする (20200ガス、払い戻しなし)
 - yを含むスロットにxを書き込み、その後スタックフレームをロールバックする (5200ガス、払い戻しなし)
 - ネストフレームで0を含むスロットにxを書き込み、リターンしてから0を書き込む (20200ガス、19800払い戻し)

## 実装
TBD

## 著作権
[CC0](../LICENSE.md)によりすべての著作権およびそれに関連する権利が放棄されています。