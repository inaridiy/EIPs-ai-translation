---
original: 770932cc2102d495e7b76f92bd53d535d69fc81ae7780dda2c303690bf8ea0fd
---

---
eip: 778
title: Ethereum Node Records (ENR)
author: Felix Lange <fjl@ethereum.org>
type: Standards Track
category: Networking
status: Final
created: 2017-11-23
discussions-to: https://github.com/ethereum/devp2p/issues/43
---

# 概要

このEIPは、p2p接続情報の公開フォーマットである「Ethereum Node Records」を定義しています。

# 動機

Ethereumノードは、ノード発見プロトコルを通じて互いに発見されます。このプロトコルの目的は、secp256k1曲線上のノードIDの公開鍵、IPアドレス、2つのポート番号を中継することです。それ以外の情報は中継できません。

この仕様は、ノード発見プロトコルv4の制限を解除するために、「ノードレコード」と呼ばれる柔軟なフォーマットを定義しています。ノードレコードは、将来のノード発見プロトコルのバージョンや、DNS、ENS、devp2pサブプロトコルなどの任意のメカニズムを通じて中継できます。

ノードレコードは暗号アジリティと、プロトコルアップグレードの処理を改善します。レコードには、任意のトランスポートプロトコルと、それに関連する公開鍵情報を含めることができます。

新しいフォーマットの別の目的は、接続情報の信頼できる更新を提供することです。ノードが終端を変更し、新しいレコードを公開した場合、他のノードはどのレコードが新しいかを判断できるようになります。

# 仕様

ノードレコードの構成要素は以下の通りです:

- `signature`: レコードの内容の暗号署名
- `seq`: シーケンス番号、64ビットの符号なし整数。レコードが変更されるたびに、ノードはこの番号を増やしてレコードを再公開する必要があります。
- レコードの残りの部分は、任意のキー/値のペアで構成されます。

レコードの署名は、*アイデンティティスキーム*に従って作成および検証されます。アイデンティティスキームは、ノードのDHTアドレスを導出する責任も負っています。

キー/値のペアは、キーによってソートされ、一意でなければなりません。つまり、同じキーが複数回出現することはできません。キーは技術的には任意のバイト列でも構いませんが、ASCIIテキストが好ましいです。下の表のキー名には、あらかじめ定義された意味があります。

| キー         | 値                                         |
|:------------|:-------------------------------------------|
| `id`        | アイデンティティスキームの名称、例: "v4"     |
| `secp256k1` | 圧縮されたsecp256k1公開鍵、33バイト         |
| `ip`        | IPv4アドレス、4バイト                       |
| `tcp`       | TCPポート、ビッグエンディアン整数           |
| `udp`       | UDPポート、ビッグエンディアン整数           |
| `ip6`       | IPv6アドレス、16バイト                     |
| `tcp6`      | IPv6専用のTCPポート、ビッグエンディアン整数 |
| `udp6`      | IPv6専用のUDPポート、ビッグエンディアン整数 |

`id`以外のキーはすべてオプションです。IPアドレスとポートも同様です。署名が有効であれば、エンドポイント情報のないレコードも有効です。`tcp6`/`udp6`ポートが提供されていない場合、`tcp`/`udp`ポートが両方のIPアドレスに適用されます。`tcp`、`tcp6`または`udp`、`udp6`で同じポート番号を宣言するのは避けるべきですが、レコードを無効にするものではありません。

### RLP エンコーディング

ノードレコードの正準エンコーディングは、`[signature, seq, k, v, ...]`というRLPリストです。エンコードされたノードレコードの最大サイズは300バイトです。実装では、この制限を超えるレコードを拒否する必要があります。

レコードは以下のように署名およびエンコーディングされます:

    content   = [seq, k, v, ...]
    signature = sign(content)
    record    = [signature, seq, k, v, ...]

### テキストエンコーディング

ノードレコードのテキスト形式は、RLP表現のbase64エンコーディングで、`enr:`プレフィックスが付いています。実装では、[URL安全なbase64アルファベット][base64url]を使用し、パディング文字を省略する必要があります。

### "v4" アイデンティティスキーム

この仕様では、他のスキームが後続のEIPで定義されるまでのデフォルトとして、単一のアイデンティティスキームを定義しています。"v4"スキームは、ノード発見プロトコルv4で使用されていた暗号システムと下位互換性があります。

- このスキームでレコードの`content`に署名するには、EVMで使用されるkeccak256ハッシュ関数を`content`に適用し、ハッシュの署名を作成します。結果の64バイトの署名は、`r`と`s`署名値の連結として符号化されます(回復IDの`v`は省略されます)。
- レコードを検証するには、レコードの"secp256k1"キー/値ペアの公開鍵によって署名されたことを確認します。
- ノードアドレスを導出するには、非圧縮公開鍵のkeccak256ハッシュを取ります。

# 根拠

このフォーマットは、以下の2つの点で将来のニーズに適合するように設計されています:

- 新しいキー/値ペアの追加: これは常に可能で、実装の合意を必要としません。既存のクライアントは、内容を解釈できるかどうかに関わらず、任意のキー/値ペアを受け入れます。
- 新しいアイデンティティスキームの追加: これらは、ネットワークがその署名を受け入れるためには実装の合意が必要です。新しいアイデンティティスキームを導入するには、EIPを提案し、実装してもらう必要があります。ほとんどのクライアントがそのスキームを受け入れれば、すぐに使用できるようになります。

レコードのサイズは制限されています。これは、レコードが頻繁に中継され、DNSなどのサイズ制限のあるプロトコルに含まれる可能性があるためです。"v4"スキームを使って署名されたIPv4アドレスを含むレコードは、約120バイトを占めるため、追加のメタデータを十分に収容できます。

IPアドレスとポートに関連するキーが多数定義されている理由については、疑問に思うかもしれません。この必要性は、住宅用やモバイルネットワークの設定では、IPv4がNAT越しになることが多く、IPv6トラフィック(サポートされている場合)は同じホストに直接ルーティングされるためです。両方のアドレスタイプを宣言することで、IPv4のみをサポートする場所と、両プロトコルをサポートする場所の両方からノードに到達できるようになります。

# テストベクター

これは、IPv4アドレス`127.0.0.1`とUDPポート`30303`を含むサンプルレコードです。ノードIDは`a448f24c6d18e575453db13171562b71999873db5b286df957af199ec94617f7`です。

```text
enr:-IS4QHCYrYZbAKWCBRlAy5zzaDZXJBGkcnh4MHcBFZntXNFrdvJjX04jRzjzCBOonrkTfj499SZuOh8R33Ls8RRcy5wBgmlkgnY0gmlwhH8AAAGJc2VjcDI1NmsxoQPKY0yuDUmstAHYpMa2_oxVtw0RW_QAdpzBQA8yWM0xOIN1ZHCCdl8
```

このレコードは、シーケンス番号`1`と以下の秘密鍵を使用して、"v4"アイデンティティスキームで署名されています:

```text
b71c71a67e1177ad4e901695e1b4b9ee17ae16c6668d313eac2f96dbcda3f291
```

レコードのRLP構造は以下の通りです:

```text
[
  7098ad865b00a582051940cb9cf36836572411a47278783077011599ed5cd16b76f2635f4e234738f30813a89eb9137e3e3df5266e3a1f11df72ecf1145ccb9c,
  01,
  "id",
  "v4",
  "ip",
  7f000001,
  "secp256k1",
  03ca634cae0d49acb401d8a4c6b6fe8c55b70d115bf400769cc1400f3258cd3138,
  "udp",
  765f,
]
```

# 著作権

著作権およびそれに関連する権利は[CC0](../LICENSE.md)によって放棄されています。

[base64url]: https://tools.ietf.org/html/rfc4648#section-5