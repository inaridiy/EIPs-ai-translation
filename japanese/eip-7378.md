---
original: 926079a2b7e0ed1f3e35a4544956354b8d1ae54298498e09bed64ebf190baa67
---

---
eip: 7378
title: ベースフィーに時間加重平均を追加する
description: 過去のブロックサイズを考慮するための幾何学的重み付け
author: Guy Goren (@guy-goren) <guy.nahsholim@gmail.com>
discussions-to: https://ethereum-magicians.org/t/add-time-weighted-averaging-to-the-base-fee-mechanism/15142
status: 停滞
type: Standards Track
category: Core
created: 2023-07-22
---

## 概要

このEIPは、[EIP-1559](./eip-1559.md)から派生したベースフィーの更新式を提案します。現在のベースフィー更新式は、

$b[i+1]\triangleq  b[i] \cdot \left( 1+\frac{1}{8} \cdot \frac{s[i]-s^* }{s^* }\right)$

最後のブロックサイズ $s[i]$ のみを考慮しています。このメカニズムにより、提案者がユーザーと共謀してベースフィーを操作するインセンティブが生まれます。

我々は、最後のブロックサイズを指数移動平均に置き換えることで、過去のブロックサイズも考慮するよう提案します。具体的には、以下のようなベースフィー更新式を提案します:

$b[i+1]\triangleq  b[i] \cdot \left( 1+\frac{1}{8} \cdot \frac{s_{\textit{avg}}[i]-s^* }{s^* }\right)$

ここで、$s_{\textit{avg}}[i]$ は以下のように定義されます:

$s_{\textit{avg}}[i] \triangleq \alpha\sum_{k=1}^{\infty} (1-\alpha)^k\cdot s[i-k+1]$ 

$\alpha\in(0,1)$ は平滑化係数です。

## 動機

ブロックスペースの需要が高い場合のブライブ動機を減らし(インセンティブ考慮セクション参照)、オシレーションを減らすことで、より安定したフィー設定メカニズムを実現することが目的です。

提案者は、EIP-1559で説明されているメカニズムを使ってブロックに含めるメッセージを決定します。このメカニズムには「ベースフィー」という、トランザクションフィーの一部が焼却される部分が含まれています。ベースフィーは、ブロックの充填率に応じて変動します。ターゲットブロックサイズを超えた場合はベースフィーが上がり、下回った場合は下がります。

この分野の研究では、このトランザクションフィーメカニズムに問題があることが明らかになっています。[特定の場合に不安定であることが示されています](../assets/eip-7378/LMRSP.pdf)。さらに、ベースフィーが充填率に依存して動的に変化することで、[マイナー(提案者)とユーザーによる操作の可能性が生まれています](../assets/eip-7378/AGHH.pdf)。需要が高く安定している状態では、ベースフィー($b$)がガスフィーの主要部分を占め、チップ($\varepsilon$)が相対的に小さくなることが望ましい動作です(参考: Ethereumのベースフィーでは$\frac{b}{\varepsilon}\approx 20$)。[Roughgarden](../assets/eip-7378/TR1559.pdf)によると、これは提案者が先を見越さないという前提の下での合理的な均衡状態です。しかし、提案者は自身の将来の収益も考慮して最適化行動をすると予想されます。つまり、提案者もユーザーも焼却されるフィーを得られないため、共謀して焼却フィーを搾取する win-win の状況を作り出すことができます。

[理論的な研究](../assets/eip-7378/AGHH.pdf)では、提案者とユーザーがそのような攻撃を開始できることが示されています。例えば、コストを下げたいユーザー(またはユーザーグループ)が、現在のブロックの提案者(提案者の力量に関わらず)に空のブロックを提案するようブライブを行うことが考えられます。そのようなブライブのコストは$\varepsilon \times {s^* }$(チップ×ターゲットブロックサイズ)のみです。その結果、次のブロックでベースフィーが減少します。EIP-1559が目標を達成したと仮定すると、ユーザーは通常、最大支払意思額にわずかなチップ($\varepsilon$)を加えた単純な入札戦略を使うはずです。その場合、正直なユーザーの定常状態では、提案者はチップ$\varepsilon$しか得られません。他のユーザーが単純(または反応が遅い)と仮定すると、ブライブするユーザーはチップが$\varepsilon$より大きければ自身のトランザクションを含めることができ、$g \frac{b^* }{8} >s^* \varepsilon$のときに攻撃が収益的になります。

## 仕様

$s[i]$を$s_{\textit{avg}}[i]$に置き換えます。ここで、

$s_{\textit{avg}}[i] \triangleq \alpha\sum_{k=1}^{\infty} (1-\alpha)^k\cdot s[i-k+1]$ 

は以下の再帰式で簡略化できます:

$s_{\textit{avg}}[i] = \alpha\cdot s[i] + (1-\alpha)\cdot s_{\textit{avg}}[i-1]$

$\alpha\in(0, 1)$は平滑化係数です。$\alpha$が大きいほど、平均がブロックサイズの変化に素早く反応します(例えば$\alpha = 1$なら、提案式は現在のルールと同じになります)。

## 根拠

トランザクションフィーメカニズム(TFM)の直感的なオプションは、よく知られ研究されている*第一価格オークション*です。しかし、EthereumネットワークはトランザクションフィーメカニズムとしてEIP-1559を選択しました(ユーザーのフィー見積もりを簡素化し、高度なユーザーの優位性を減らすことが1つの理由として挙げられています)。本提案では、EIP-1559のTFMを改善し、それが引き起こす既知の問題を軽減することを目的としています。これらの問題の深刻さはブロックスペースの需要に直接関係しており、現在はEthereumネットワークにわずかな影響しか及ぼしていません。しかし、Ethereumの需要が増加した場合、これらの問題が悪化することが予想されるため、事前に対策を講じる必要があります。

この変更は、ブライブが収益的な合理的な戦略を説明した[この研究](../assets/eip-7378/AGHH.pdf)に基づいています。幾何級数による加重平均を選択することで、(i)計算量とメモリ使用量がともにO(1)であり、(ii)単一の外れ値ブロックの影響を徐々に薄めつつ、ベースフィーの大きな変動を引き起こさないという2つの望ましい性質が得られます。
さらに、この理論分析では、従来のMEV(サンドイッチ、フロントランニングなど)による収益は考慮されていません。(実際、説明された戦略は別の形態のMEVと見なすことができます。)従来のMEVに対する対策(トランザクションの不透明化など)では、この提案で扱う問題には効果がないことを意味しています。本EIPで取り組む問題は、MEVや無作為性の予測可能性などの追加の仮定なしに、ベースフィーメカニズムの根本的なものです。

注記: [ここ](../assets/eip-7378/AGHH.pdf)では十分に議論されていませんが、別の選択肢として「最大変化分母」(学習率)を1/8から小さい値に減らすことが考えられます。しかし、これは応答性を大幅に低下させ、ベースフィーが実際の持続的な変化に遅れて反応することになるため、問題があります。幾何級数加重を使う理由は、応答性を維持しつつインセンティブの不整合を軽減するという好ましいトレードオフを実現するためです。

### インセンティブ考慮

本提案は、TFMのインセンティブ整合性を改善するよう設計されています。[ゲーム理論的な分析](../assets/eip-7378/AGHH.pdf)によると、EIP-1559に基づくCurrentのTFMはブライブを奨励しています。

EIP-1559の主な目的の1つは、ユーザーのための入札を簡素化することでした。[Roughgarden](../assets/eip-7378/TR1559.pdf)によると、ユーザーが正直な評価額を入札するのが最適な戦略であると理論的に示されています。これに対し、TFMとしてビットコインやEthereumの以前のように第一価格オークションを使う場合、ユーザーにとって正直な評価額を入札するのが最適ではありません。つまり、ユーザーの好みを十分に明らかにしないTFMの方が良いと考えられています。しかし、ブライブを奨励するTFMは、好みを明らかにしないTFMよりも悪いと言えるかもしれません。

第一価格オークションはTFMに関して安全な選択肢ですが、Ethereumネットワークはゲーム理論的な理由以外の理由からEIP-1559とトランザクションフィーの焼却を選択しました。したがって、上記の提案を使ってブライブのための現在のインセンティブを軽減することを提案します。

## 下位互換性

ベースフィーは有効なブロックの強制要件であるため、このChange はハードフォークを必要とします。

## テストケース

TBD

## セキュリティ上の考慮事項

議論が必要です。

## 著作権

著作権およびそれに関連する権利は[CC0](../LICENSE.md)で放棄されています。