---
original: 36ff994fbb326797b8d54216e19796177935519ea9c317a0f8486b50c1994dd2
---

---
eip: 5000
title: MULDIVインストラクション
description: 512ビットの精度でx * y / zを実行する新しいインストラクションを導入する
author: Harikrishnan Mulackal (@hrkrshnn)、Alex Beregszaszi (@axic)、Paweł Bylica (@chfast)
discussions-to: https://ethereum-magicians.org/t/muldiv-instruction/9930
status: 停滞
type: Standards Track
category: Core
created: 2022-03-14
---

## 概要

`MULDIV(x, y, z)`という新しいインストラクションを導入し、512ビットの精度で`((x * y) / z) % 2**256`を実行する。`z = 0`の場合は`(x * y) / 2**256`の特殊ケースとする。

## 動機

Ethereumでは、特に金融アプリケーションの分野で、固定小数点演算が非常によく使用されます。

固定小数点の加算と減算は、それぞれ`add`と`sub`で簡単に行えますが、効率的に固定小数点の乗算と除算を行うことは非常に望まれる機能です。一般的に使用されている回避策は、`mulmod`ベースの複雑な実装(スタック操作を除いて約50命令)に頼るものです。このインストラクションはそれを単一のオペコードに削減します。

二次的な使用例は、暗号アプリケーションでの可能性です。`muldiv`インストラクションにより、256x256->512ビットの完全な精度の乗算が可能になります。`mul(x y)`(または`muldiv(x, y, 1)`)は下位256ビットを、`muldiv(x, y, 0)`は上位256ビットを計算します。

最後に、*チェック付き*と*チェックなし*の両方の算術ユースケースで効率的に使用できるインストラクションを提供することを目指しました。*チェック付き*とは、除算ゼロや桁あふれの動作を中止することを意味します。

## 仕様

新しいインストラクション`MULDIV`(`0x1e`)が導入されます。

- スタックから3つの値を取り出します。最初に`x`、次に`y`、最後に`z`です。
- `z == 0`の場合、`r = (uint512(x) * y) / 2**256`です。
- それ以外の場合、`r = (uint512(x) * y / z) % 2**256`で、中間計算は512ビットの精度で行われます。
- `r`をスタックにプッシュします。

```python
# 演算子`*`と`//`は512ビットの精度で行われます
def muldiv(x, y, z):
    if z == 0:
        return (x * y) // (2**256)
    else:
        return ((x * y) // z) % (2**256)
```

このインストラクションのコストは8 gas(つまり`mid`)で、`addmod`と`mulmod`と同じです。

## 根拠

### 0の特殊ケース

EVMのすべての算術インストラクションは、除算やモジュロ0を特別に扱い、0を返します。我々は、柔軟なオペコードを提供するために、この一貫性を破ることにしました。これにより、桁あふれの動作を検出することができます。

代替案には以下のようなものがあります:

- 桁あふれのフラグを返す
- 上位256ビットと下位256ビットの2つのスタックアイテムを返す
- EVMで上位256ビットを計算する:

```solidity
/// `x × y = hi × 2**256 + mul(x, y)`の`hi`を返す
function hob(uint x, uint y) returns (uint hi) {
    uint uint_max = type(uint).max;
    assembly {
        let lo := mul(x, y)
        let mm := mulmod(x, y, uint_max)
        hi := sub(sub(mm, lo), lt(mm, lo))
    }
}
```

この機能は賢明で有用ですが、呼び出し側は0を渡すと、他のEVMインストラクションとは大きく異なる動作をすることを認識しておく必要があります。

### 引数の順序

引数の順序は`addmod`と`mulmod`と一致しています。

## 下位互換性

これは以前にはない新しいインストラクションです。

## テストケース

```
PUSH 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
PUSH 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
PUSH 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
MULDIV
---
0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
```


```
PUSH 0x0000000000000000000000000000000000000000000000000000000000000000
PUSH 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
PUSH 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
MULDIV
---
0xfffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe
```

```
PUSH 0x0000000000000000000000000000000000000000000000000de0b6b3a7640000
PUSH 0x000000000000000000000000000000000000000000000000016345785d8a0000
PUSH 0x00000000000000000000000000000000000000000000d3c21bcecceda1000000
MULDIV
---
0x00000000000000000000000000000000000000000000152d02c7e14af6800000
```

## セキュリティ上の考慮事項

TBA

## 著作権

[CC0](../LICENSE.md)によりすべての著作権およびそれに関連する権利が放棄されています。