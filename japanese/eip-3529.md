---
original: 0446476577d3ebfd307e4524b565d0868b7aa2f078911908e5383ebff1ad6f3b
---

---
eip: 3529
title: リファンドの削減
author: Vitalik Buterin (@vbuterin), Martin Swende (@holiman)
discussions-to: https://ethereum-magicians.org/t/eip-3529-reduction-in-refunds-alternative-to-eip-3298-and-3403-that-better-preserves-existing-clearing-incentives/6097
status: Final
type: Standards Track
category: Core
created: 2021-04-22
requires: 2200, 2929, 2930
---

## 簡単な要約

`SELFDESTRUCT`のガスリファンドを削除し、`SSTORE`のガスリファンドを、現在の「リファンドメカニズムの悪用」が実行可能ではなくなるような低い水準に減らします。

## 動機

`SSTORE`と`SELFDESTRUCT`のガスリファンドは、アプリケーション開発者に「良好な状態管理」を行うよう動機付けるために導入されました。つまり、不要になったストレージスロットやコントラクトをクリアするよう動機付けるためです。しかし、この手法の利点は当初期待されていたよりはるかに低いことが証明されており、ガスリファンドには予期せぬ有害な結果がいくつか生じています:

* リファンドはGasTokenを生み出します。GasTokenには低料金期間から高料金期間にガス容量を移動する利点がありますが、ネットワークにも弊害があります。特に状態サイズの悪化(状態スロットが「バッテリー」として使用されるため)や、非効率的なブロックチェーンガス使用の増加などです。
* リファンドはブロックサイズのばらつきを増大させます。実際のガス消費量の理論上の最大値は、ガス制限の約2倍になります(リファンドにより後続のトランザクションのガス容量が増加するため、ただしリファンドは消費ガスの50%が上限)。これは致命的ではありませんが、望ましくありません。特に、リファンドを使用すれば2倍の使用量のスパイクを、EIP-1559よりも長期にわたって維持できるためです。

## 仕様

### パラメータ

| 定数 | 値 |
| - | - |
| `FORK_BLOCK` | 未定 |
| `MAX_REFUND_QUOTIENT` | 5 |

`block.number >= FORK_BLOCK`のブロックについて、以下の変更が適用されます。

1. `SELFDESTRUCT`リファンドを削除します。
2. `SSTORE_CLEARS_SCHEDULE`(EIP-2200で定義)を`SSTORE_RESET_GAS + ACCESS_LIST_STORAGE_KEY_COST`(EIP-2929とEIP-2930の下で4,800ガス)に置き換えます。
3. トランザクション後の最大リファンド量を`gas_used // MAX_REFUND_QUOTIENT`に制限します。

注記: 以前の_最大リファンド量_は`gas_used // 2`と定義されていました。ここでは定数`2`を`MAX_REFUND_QUOTIENT`と名付け、その値を`5`に変更しています。

## 根拠

[EIP-2200](./eip-2200.md#specification)では、3つのリファンドケースが導入されました:

1. 元の値が0以外で、新しい値が0の場合、リファンドカウンターに`SSTORE_CLEARS_SCHEDULE`(現在15,000)ガスを追加する
2. 元の値が0、現在の値が0以外、新しい値が0の場合、リファンドカウンターに`SSTORE_SET_GAS - SLOAD_GAS`(現在19,900)ガスを追加する
3. 元の値が0以外、現在の値が別の0以外の値、新しい値が元の値と等しい場合、リファンドカウンターに`SSTORE_RESET_GAS - SLOAD_GAS`(現在4,900)ガスを追加する

これらのうち、(1)のみがガストークンを可能にし、ブロックの実行ガスが ブロックガス制限を超えることを許可します。(2)はこの性質を持ちません。なぜなら、19,900リファンドを得るためには、_同じストレージスロット_が以前に0から0以外に変更されていなければならず、20,000ガスがかかるためです。ある1つのストレージスロットをクリアして別のストレージスロットを編集するためのガスを得ることができないため、ガストークンに使用できません。さらに、リファンドを得るには、ストレージ書き込みと拡張の効果を_元に戻す_必要があるため、リファンドされたガスはブロックの処理にクライアントの負荷とはなりません。(3)も同様に動作します。4,900リファンドは、同じストレージスロットに以前5,000ガスが費やされた場合にのみ得られます。

このEIPは(1)のケースを扱います。ガストークンが実行不可能な条件(つまり、ストレージスロットから得られるガスが投入したガスを超えない条件)を、同様の「ペアリング」引数を使って確立できます。各リファンドを、同じトランザクション内の同じストレージスロットに対する以前の支出にマッピングします。ストレージスロットが0以外の元の値から0に変更された場合、2つの可能性があります:

1. これがそのストレージスロットが0に設定された最初の場合です。この場合、この出来事を、ストレージスロットを初めて読み書きするための最小コスト`SSTORE_RESET_GAS + ACCESS_LIST_STORAGE_KEY_COST`にペアリングできます。
2. これがそのストレージスロットが2回目以降に0に設定された場合です。この場合、この出来事を、最後に0以外の値に設定された時点にペアリングできます。その際、`SSTORE_CLEARS_SCHEDULE`ガスが_削除_されます。

2回目以降の出来事については、`SSTORE_CLEARS_SCHEDULE`の値は問題ありません。なぜなら、その大きさのリファンドはすべて、同じ大きさのリファンド_削除_とペアリングされるためです。これは最初の出来事について当てはまります。スロットに費やされた総ガスが確実に正の値になるためには、`SSTORE_CLEARS_SCHEDULE <= SSTORE_RESET_GAS + ACCESS_LIST_STORAGE_KEY_COST`である必要があります。そのため、このEIPでは`SSTORE_CLEARS_SCHEDULE`をこれらの2つのコストの合計に減らします。

このEIPの別の直感的な説明は、まだ読まれていない(多くの場合「無用の」)データをクリアするためのネットリファンドはないが、読まれた(多くの場合「有用な」)データをクリアするためのネットリファンドは続くということです。

## 下位互換性

現在、リファンドはトランザクション実行の_後_にのみ適用されるため、特定のコールフレームの実行中に利用可能なガス量に影響を与えることはありません。したがって、それらを削除しても、コードの実行能力は損なわれませんが、一部のアプリケーションが経済的に実行不可能になります。

ガストークンは無価値になります。DeFiのアービトラージボットは、今日これらの機能しなくなったガストレージメカニズムへの呼び出しを削除するようにコードを書き換える必要があります。

ただし、`new = original = 0 != current`ケースでリファンドを完全に保持し、他の`nonzero -> zero`ケースでも一部のリファンドを維持することで、有利なガスコスト扱いを受ける主要なユースケースが継続できるようになります。例えば、`zero -> nonzero -> zero`のストレージ設定パターンは依然として約100ガスしかかかりません。そのような重要な例には以下のようなものがあります:

* 再入力ロック(通常、子呼び出しが始まる直前に0から1にフリップされ、子呼び出しが終了するときに0に戻される)
* ERC20の承認と送信(トークン転送が承認されると承認値が0から0以外に、トークン転送が処理されると0に戻る)

### ストレージクリアのインセンティブへの影響

以前のリファンド削除EIP([EIP-3298](./eip-3298.md)と[EIP-3403](./eip-3403.md))への批判は、これらのEIPが値を0に設定するインセンティブを完全に削除し、ユーザーがそのストレージスロットをもう一度使う可能性があっても、完全にクリアしないよう奨励するというものでした。

例えば、ERC20トークンを1単位持っていて、全残高を譲渡または売却する場合、0.999999単位のみを譲渡し、残りを残しておくことができます。将来、同じアカウントでそのトークンをもう一度取得する場合、ゼロから非ゼロへの設定ではなく、非ゼロから非ゼロへの設定(5,000ガス)のみで済みます。今日では、これは15,000ガスのリファンドによって相殺されているため、そのスロットをもう一度使う可能性が`15,000 / 17,100 = 87.7%`以上の場合にのみ、これを行う動機があります。EIP-3298やEIP-3403では、この相殺インセンティブがないため、そのスロットを再利用する可能性が0%を超えていれば、非ゼロに設定するのが良いことになります。

4,800ガスのリファンドが残されているため、ストレージスロットを非ゼロのままにしておく動機があるのは、そのスロットを再利用する可能性が`4,800 / 17,100 = 28.1%`以上の場合のみです。これは完璧ではありませんが、同じアドレスでトークンを再取得する可能性の平均よりも高い可能性だと考えられます。

リファンドを消費ガスの1/5に制限することで、このメカニズムをストレージ書き込み重視のサービス拒否攻撃に使用する能力が最大25%に制限されます。

## テストケース

### EIP-2929ガスコスト

注意: 「ホット」と「コールド」のスロットの違いがあります。このテーブルは、すべての触れられたストレージスロットが既に「ホット」(違いは一回限りの2,100ガスコスト)であることを前提としています。

| コード | 使用ガス | リファンド | 元の値 | 1回目 | 2回目 | 3回目 | 実効ガス(リファンド後)
| -- | -- | -- | -- | -- | -- | -- | -- |
| `0x60006000556000600055` | 212 | 0| 0 | 0 |  0 |  |  212 |
| `0x60006000556001600055` | 20112 | 0| 0 | 0 |  1 |  |  20112 |
| `0x60016000556000600055` | 20112 | 19900| 0 | 1 |  0 |  |  212 |
| `0x60016000556002600055` | 20112 | 0| 0 | 1 |  2 |  |  20112 |
| `0x60016000556001600055` | 20112 | 0| 0 | 1 |  1 |  |  20112 |
| `0x60006000556000600055` | 3012 | 15000| 1 | 0 |  0 |  |  -11988 |
| `0x60006000556001600055` | 3012 | 2800| 1 | 0 |  1 |  |  212 |
| `0x60006000556002600055` | 3012 | 0| 1 | 0 |  2 |  |  3012 |
| `0x60026000556000600055` | 3012 | 15000| 1 | 2 |  0 |  |  -11988 |
| `0x60026000556003600055` | 3012 | 0| 1 | 2 |  3 |  |  3012 |
| `0x60026000556001600055` | 3012 | 2800| 1 | 2 |  1 |  |  212 |
| `0x60026000556002600055` | 3012 | 0| 1 | 2 |  2 |  |  3012 |
| `0x60016000556000600055` | 3012 | 15000| 1 | 1 |  0 |  |  -11988 |
| `0x60016000556002600055` | 3012 | 0| 1 | 1 |  2 |  |  3012 |
| `0x60016000556001600055` | 212 | 0| 1 | 1 |  1 |  |  212 |
| `0x600160005560006000556001600055` | 40118 | 19900| 0 | 1 |  0 |  1 |  20218 |
| `0x600060005560016000556000600055` | 5918 | 17800| 1 | 0 |  1 |  0 |  -11882
Here is the continued translation:

### リファンド削減時

リファンドを部分的に削除する場合、つまり`SSTORE_CLEARS_SCHEDULE`を15,000から4,800に変更し(そして`SELFDESTRUCT`リファンドを削除)すると、比較表は以下のようになります。

| コード | 使用ガス | リファンド | 元の値 | 1回目 | 2回目 | 3回目 | 実効ガス(リファンド後)
| -- | -- | -- | -- | -- | -- | -- | -- |
| `0x60006000556000600055` | 212 | 0| 0 | 0 |  0 |  |  212 |
| `0x60006000556001600055` | 20112 | 0| 0 | 0 |  1 |  |  20112 |
| `0x60016000556000600055` | 20112 | 19900| 0 | 1 |  0 |  |  212 |
| `0x60016000556002600055` | 20112 | 0| 0 | 1 |  2 |  |  20112 |
| `0x60016000556001600055` | 20112 | 0| 0 | 1 |  1 |  |  20112 |
| `0x60006000556000600055` | 3012 | 4800| 1 | 0 |  0 |  |  -1788 |
| `0x60006000556001600055` | 3012 | 2800| 1 | 0 |  1 |  |  212 |
| `0x60006000556002600055` | 3012 | 0| 1 | 0 |  2 |  |  3012 |
| `0x60026000556000600055` | 3012 | 4800| 1 | 2 |  0 |  |  -1788 |
| `0x60026000556003600055` | 3012 | 0| 1 | 2 |  3 |  |  3012 |
| `0x60026000556001600055` | 3012 | 2800| 1 | 2 |  1 |  |  212 |
| `0x60026000556002600055` | 3012 | 0| 1 | 2 |  2 |  |  3012 |
| `0x60016000556000600055` | 3012 | 4800| 1 | 1 |  0 |  |  -1788 |
| `0x60016000556002600055` | 3012 | 0| 1 | 1 |  2 |  |  3012 |
| `0x60016000556001600055` | 212 | 0| 1 | 1 |  1 |  |  212 |
| `0x600160005560006000556001600055` | 40118 | 19900| 0 | 1 |  0 |  1 |  20218 |
| `0x600060005560016000556000600055` | 5918 | 7600| 1 | 0 |  1 |  0 |  -1682 |

## セキュリティ上の考慮事項

リファンドはトランザクション実行には見えないため、これによってトランザクション実行ロジックに影響はありません。

ブロック内の実行ガスの最大量は、ガス制限に制限されます。ただし、後に0に戻された0から非0への`SSTORE`は数えません。それらを数えないのは適切です。なぜなら、そのような`SSTORE`がリセットされた場合、ストレージは拡張されず、クライアントはメルクルツリーを調整する必要がないためです。ガス消費はリファンドされますが、通常それらのオペコードを処理するために必要な努力も取り消されます。**クライアントは、`new_value = original_value`の場合、ストレージ書き込みを行わないようにする必要があります。これはイーサリアムの初期から賢明な最適化でしたが、今後ますます重要になります。**

## 著作権
著作権およびその関連権利は[CC0](../LICENSE.md)により放棄されています。