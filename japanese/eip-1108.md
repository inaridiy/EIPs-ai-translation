---
original: 0f95bfdea9eddca5fb1a83ad2d09d0cb697fce0ee7f1e840539f2fa8fd275269
---

---
eip: 1108
title: alt_bn128 プリコンパイルのガスコストを削減する
author: Antonio Salazar Cardozo (@shadowfiend), Zachary Williamson (@zac-williamson)
discussions-to: https://ethereum-magicians.org/t/eip-1108-reduce-alt-bn128-precompile-gas-costs/3206
status: Final
type: Standards Track
category: Core
created: 2018-05-21
requires: 196, 197
---

## 簡単な要約

楕円曲線演算プリコンパイルは現在過剰に価格設定されています。プリコンパイルの再価格設定は、Ethereumのプライバシーソリューションとスケーリングソリューションの多くに大きな助けとなるでしょう。

## 概要

2018年に公式のGo参照実装で使用されていたライブラリが変更されたことにより、`ECADD`、`ECMUL`、および`alt_bn128`楕円曲線上のペアリングチェックプリコンパイルドコントラクトの大幅なパフォーマンス向上がもたらされました。

Parityクライアントでは、2018年にプリコンパイルアルゴリズムで使用されるフィールド演算が最適化され、`bn`クレートで使用されるペアリングアルゴリズムの最近の変更により、大幅な高速化が実現しました。

Ethereumクライアントでのより高速な演算は、ガスコストの削減に反映されるべきです。

## 動機

最近、[公式のGo参照実装](https://github.com/ethereum/go-ethereum)で`ECADD`(アドレス`0x06`)、`ECMUL`(アドレス`0x07`)、およびペアリングチェック(アドレス`0x08`)プリコンパイルドコントラクトを実装するために使用されていたライブラリが[Cloudflareのbn256ライブラリ](https://github.com/cloudflare/bn256)に変更されました。[この変更を導入したPRの初期段階](https://github.com/ethereum/go-ethereum/pull/16203)と[後の注釈](https://github.com/ethereum/go-ethereum/pull/16301#issuecomment-372687543)によると、`ECADD`、`ECMUL`、およびペアリングチェック(定数を除く)の計算コストは全体的に約1桁低下しています。

また、[Parityクライアント](https://github.com/paritytech/parity-ethereum)で使用されている`bn`ライブラリの[2018年](https://github.com/paritytech/bn/pull/9)と[2019年](https://github.com/paritytech/bn/pull/14)の最適化により、大幅なパフォーマンス向上が実現しました。これについては、[ベンチマーク](https://gist.github.com/zac-williamson/838410a3da179d47d31b25b586c15e53)と[以前の結果](https://gist.github.com/pdyraga/4649b74436940a01e8221d85e80bfeef)を比較して確認しました。

## 仕様

以下の表に、現在のガスコストと新しいガスコストを示します:

| コントラクト  | アドレス | 現在のガスコスト | 更新後のガスコスト |
| ------------- | --------- | ---------------- | ------------------ |
| `ECADD`       | `0x06`    | 500<sup>[1]</sup>| 150                |
| `ECMUL`       | `0x07`    | 40,000<sup>[1]</sup>| 6,000            |
| ペアリングチェック | `0x08` | 80,000 * k + 100,000<sup>[2]</sup>| 34,000 * k + 45,000 |

`ECADD`と`ECMUL`のガスコストは、EIP-196に記載されているコストを更新したものです。ペアリングチェックのガスコストは、EIP-197に記載されているコストを更新したものです。更新後のガスコストは、ベンチマークに基づいて、Parityクライアントのような低パフォーマンスクライアントに合わせて調整されています<sup>[3]</sup>。

これらの更新ガスコストを算出するために、`ecrecover`プリコンパイルのパフォーマンスを116マイクロ秒/`ecrecover`呼び出しと測定しました。`ecrecover`ガス価格が3,000ガスで適切であると仮定すると、プリコンパイルアルゴリズムの実行時間1マイクロ秒あたり25.86ガスとなります。これに基づいて、ペアリングプリコンパイルは1ペアリングの計算に3,037マイクロ秒、10ペアリングの計算に14,663マイクロ秒かかることがわかりました。つまり、ペアリングアルゴリズムには1,745マイクロ秒の固定ベースランタイムと、ペアリング1つあたり1,292マイクロ秒のリニアコストがあります。アルゴリズムの構造上、固定コストとペアリング数に応じたリニアコストを分離できるためです。

したがって、1マイクロ秒あたり25.86ガスの「適正」価格を使うと、ペアリング数`k`に対して`35,000 * k + 45,000`ガスという式が導出されます。[4]

[1]- [EIP-196](./eip-196.md)を参照。

[2]- [EIP-197](./eip-197.md)を参照。

[3]- [Parityベンチマーク](https://gist.github.com/zac-williamson/838410a3da179d47d31b25b586c15e53)

[4]- [ガスコスト計算に関するPRのコメント](https://github.com/ethereum/EIPs/pull/1987#discussion_r280977066)

## 根拠

### 既存のプロトコルが楕円曲線暗号の低コスト化から大きな恩恵を受ける

高速な楕円曲線暗号は、Ethereumの上に構築された多くのプロトコルの重要な基盤となっています。いくつかの例を挙げると:

* [AZTECプロトコル](https://github.com/AztecProtocol/AZTEC)は、[ERC-1723](https://github.com/ethereum/EIPs/issues/1723)および[ERC-1724](https://github.com/ethereum/EIPs/issues/1724)標準に従って、プライベートトークンの構築にプリコンパイルを利用しています。
* [Matter Labs](https://github.com/matter-labs/matter-network)は、Ignis(秒間500トランザクションの処理能力を持つスケーリングソリューション)の実装にプリコンパイルを使用しています。
* [Rollup](https://github.com/rollup/rollup)は、メインネットの追加コンセンサスレイヤーなしでトランザクションの正確性を保証するL2スケーリングソリューションの実装にプリコンパイルを使用しています。
* [ZEther](https://crypto.stanford.edu/~buenz/papers/zether.pdf)は、`ECADD`と`ECMUL`プリコンパイルを使用して機密トランザクションを構築しています。

これらはすべて、メインネットにデプロイされているか、デプロイ準備中の技術です。これらのプロトコルはすべて、プリコンパイルのガスコスト削減から恩恵を受けるでしょう。

具体的な例として、典型的なAZTEC機密トランザクションの暗号検証には現在`820,000`ガスかかりますが、プリコンパイルのガス料金がEthereum ネットワークに与える負荷を適切に反映すれば、この費用は`197,000`ガスに抑えられます。これにより、Ethereumでのプライベートアセットの潜在的な使用事例が大幅に広がります。AZTECは、Ethereumにいくつかの暗号プロトコルをデプロイする予定ですが、現在のプリコンパイルコストでは実用的な限界に達しています:

* 機密投票
* 暗号化された注文の部分的な注文執行、プライベートな分散型取引所向け
* 匿名の身元共有証明(ホワイトリストに登録されていることを証明するが、誰であるかは明かさない)
* メインネットとL2アプリケーション間の機密通信チャネルとしての多対1の支払いと1対多の機密支払い

Ethereumのzk-SNARKベースのプロトコルについては、EIP-1108により、zk-SNARKの検証ガスコストが大幅に削減されるだけでなく、[複数のzk-SNARKプルーフをまとめて検証する](https://github.com/matter-labs/Groth16BatchVerifier)ことも可能になります。これは、大規模なzk-SNARK回路を小さな個別の回路に分割する手法にも役立ちます。これにより、zk-SNARKの構築とデプロイが容易になります。

ZEtherのトランザクションは現在約`6,000,000`ガスかかりますが、このEIPにより`1,000,000`ガスまで削減できるため、プロトコルがより実用的になります。

要約すると、メインネットに既に存在する多くのプロトコルが、この EIPから大きな恩恵を受けるでしょう。楕円曲線暗号は、スケーリングやプライバシーなど、Ethereumに価値ある解決策を提供できますが、`bn128`プリコンパイルのガスコストがネットワークに与える負荷を正確に反映すれば、これらの解決策の範囲と規模を拡大できます。

### 計算量を節約してストレージを節約できる

RollupやIgnisのようなソリューションは、個別のトランザクションをzk-SNARKプルーフにバッチ処理し、オンチェーンの状態をわずかなMerkleルートで表現することができます。

zk-SNARK検証コストが削減されれば、これらのソリューションをより広範な用途に展開でき、Rollupスタイルのトランザクションをより多くのブロックで処理できるようになります。

### Parityとgethはすでに高速なアルゴリズムを実装しており、ガスコストの削減を正当化できる

このEIPでは、Parityやgethに新しい暗号ライブラリの導入を要求するものではありません。`bn128`アルゴリズムは既にこれらのクライアントに統合されています。このEIPをIstanbulに提案する目的は、[EIP-1829](./eip-1829.md)(任意の楕円曲線上の演算)を補完し、より高度なソリューションが開発、定義、デプロイされる間に、差し迫った暗号コストの問題に即座に対処することです。

## テストケース

基礎となるアルゴリズムは変更されないため、追加のテストケースは必要ありません。

## 実装

Parityクライアントとgethクライアントはすでに、ベンチマークに匹敵する速度の`bn128`暗号ライブラリを実装しています。参考として、`bn128`曲線をサポートし、Parityのベンチマークと同等以上の実行時間を持つ、C++、Go、Rustの楕円曲線ライブラリを以下に示します。

* [Parityのbnクレート(Rust)](https://github.com/paritytech/bn)
* [gethのbn256ライブラリ(Go)](https://github.com/ethereum/go-ethereum/tree/master/crypto/bn256/cloudflare)
* [MCL、ポータブルなC++ペアリングライブラリ](https://github.com/herumi/mcl)
* [Libff、多くのzk-SNARKライブラリで使用されているC++ペアリングライブラリ](https://github.com/scipr-lab/libff)

## 追加の参考資料

@vuterin氏は、この EIPが最初に作成された後に、同様の削減を提案しています。その根拠も似ているため、[ethereum/EIPs#1187](https://github.com/ethereum/EIPs/issues/1187)を参照してください。

## 著作権
著作権およびその関連権利は[CC0](../LICENSE.md)で放棄されています。