---
original: f0a59d5440099021d39d7a23784a0d4d2baa33704359edcd78da0efa0abdaf27
---

---
eip: 210
title: ブロックハッシュのリファクタリング
author: Vitalik Buterin (@vbuterin)
type: Standards Track
category: Core
status: Stagnant
created: 2017-02-10
---

### 概要

ブロックハッシュをステートに保存することで、BLOCKHASHオペコードを処理するためのプロトコルの複雑さと、クライアントの実装の複雑さを削減します。また、ブロックハッシュのチェックの範囲を拡張し、非常に離れたブロック番号のブロック間に直接リンクを作ることで、初期のライトクライアントの同期をより効率的に行えるようになります。

### パラメータ

* `CONSTANTINOPLE_FORK_BLKNUM`: 未定
* `SUPER_USER`: 2**160 - 2
* `BLOCKHASH_CONTRACT_ADDR`: 0xf0 (つまり 240)
* `BLOCKHASH_CONTRACT_CODE`: 以下を参照

### 仕様

`block.number == CONSTANTINOPLE_FORK_BLKNUM`の場合、ブロックを処理する前に、トランザクションの処理を行う前に、BLOCKHASH_CONTRACT_ADDRのコードをBLOCKHASH_CONTRACT_CODEに設定します。

`block.number >= CONSTANTINOPLE_FORK_BLKNUM`の場合、ブロックを処理する前に、トランザクションの処理を行う前に、以下のパラメータでコールを実行します:

* `SENDER`: SUPER_USER
* `GAS`: 1000000
* `TO`: BLOCKHASH_CONTRACT_ADDR
* `VALUE`: 0
* `DATA`: &lt;ブロックの前のハッシュに対応する32バイト&gt;

`block.number >= CONSTANTINOPLE_FORK_BLKNUM + 256`の場合、BLOCKHASHオペコードは、以下のパラメータでコール(トランザクションではない)を実行した結果を返します:

* `SENDER`: &lt;オペコードが呼び出された アカウント&gt;
* `GAS`: 1000000
* `TO`: BLOCKHASH_CONTRACT_ADDR
* `VALUE`: 0
* `DATA`: オペコードに渡されたスタックの引数を32バイトのゼロ埋めした整数

また、`block.number >= CONSTANTINOPLE_FORK_BLKNUM`のブロックについては、コントラクトコード内のアルゴリズムの処理コストが高くなるため、ガスコストが20から800に増加します。

### BLOCKHASH_CONTRACT_CODE

Serpentのソースコードは以下の通りです:

```python
with offset = 0:
    if msg.sender == 0xfffffffffffffffffffffffffffffffffffffffe:
        with bn = block.number - 1:
            while bn:
                ~sstore(offset + ~mod(bn, 256), ~calldataload(0))
                if ~mod(bn, 256):
                    ~stop()
                bn = ~div(bn, 256)
                offset += 256
    elif ~calldataload(0) >= 0 and ~calldataload(0) < block.number:
        with tbn = ~calldataload(0):
            with dist_minus_one = block.number - tbn - 1:
                while dist_minus_one >= 256 && ~mod(tbn, 256) == 0:
                    offset += 256
                    tbn = ~div(tbn, 256) 
                    dist_minus_one = ~div(dist_minus_one, 256)
                if dist_minus_one >= 256:
                    return(0)
                return(~sload(offset + ~mod(tbn, 256)))
    else:
        return(0)
```

EVMのイニットコードは以下の通りです:

```
0x6100f58061000e60003961010356600073fffffffffffffffffffffffffffffffffffffffe33141561005857600143035b801561005257600035610100820683015561010081061561003f57005b6101008104905061010082019150610022565b506100f3565b600060003512151561006e574360003512610071565b60005b156100e7576000356001814303035b6101008112151561009857600061010083061461009b565b60005b156100ba57610100830192506101008204915061010081049050610080565b610100811215156100d057600060a052602060a0f35b610100820683015460c052602060c0f350506100f2565b600060e052602060e0f35b5b505b6000f3
```

コントラクトコードに設定されるEVMバイトコードは以下の通りです:

```
0x600073fffffffffffffffffffffffffffffffffffffffe33141561005857600143035b801561005257600035610100820683015561010081061561003f57005b6101008104905061010082019150610022565b506100f3565b600060003512151561006e574360003512610071565b60005b156100e7576000356001814303035b6101008112151561009857600061010083061461009b565b60005b156100ba57610100830192506101008204915061010081049050610080565b610100811215156100d057600060a052602060a0f35b610100820683015460c052602060c0f350506100f2565b600060e052602060e0f35b5b50
```

### 根拠

これにより、実装がブロックハッシュの履歴を明示的に参照する必要がなくなり、プロトコルの定義が単純化され、「暗黙のステート」(ステートツリーの一部ではないが、ステートとして扱われる情報)の大きな部分が削減されるため、プロトコルがより「純粋」になります。さらに、遠い過去のブロックを直接指すことができるようになるため、極めて効率的で安全なライトクライアントプロトコルを実現できます。