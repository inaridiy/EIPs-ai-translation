---
original: 86c218e014022a832af42335ee71cf70612f629207ffbd9bf1c16e0c0607c8fa
---

---
eip: 7620
title: EOF コントラクト作成
description: `EOFCREATE` と `RETURNCONTRACT` 命令の導入
author: Alex Beregszaszi (@axic)、Paweł Bylica (@chfast)、Andrei Maiboroda (@gumb0)、Piotr Dobaczewski (@pdobacz)
discussions-to: https://ethereum-magicians.org/t/eip-7620-eof-contract-creation-instructions/18625
status: Review
type: Standards Track
category: Core
created: 2024-02-12
requires: 170, 684, 2929, 3540, 3541, 3670
---

## 概要

EVM オブジェクトフォーマット (EOF) は、`CREATE` または `CREATE2` 命令を使ってコントラクトを作成する可能性を排除します。 `EOFCREATE` と `RETURNCONTRACT` という新しい/置換の命令のペアを導入し、EOF コンテナを使ってコントラクトを作成する方法を提供します。

## 動機

このEIPは、[EIP-3540](./eip-3540.md) で導入されたEOFフォーマットの用語を使用しています。

EOFは、コードの可視性を排除することを目的としています。これは、`CREATE` や `CREATE2` などのレガシースタイルのコントラクト作成ロジックの前提条件です。なぜなら、initcodeとコードの両方がEVMに公開され、操作できるためです。同じ前提に基づいて、EOFは `CODECOPY` や `EXTCODECOPY` などのオペコードを排除し、サブコンテナをファクトリーコントラクトが他のコントラクトを作成するための代替手段として導入しています。

このEIPで導入された新しい命令は、ファクトリーコントラクトのユースケースをレガシーEVMが提供していたものを、EOFコンテナを使って実現します。

## 仕様

このドキュメントの「MUST」、「MUST NOT」、「REQUIRED」、「SHALL」、「SHALL NOT」、「SHOULD」、「SHOULD NOT」、「RECOMMENDED」、「NOT RECOMMENDED」、「MAY」、「OPTIONAL」というキーワードは、RFC 2119およびRFC 8174に記載されているように解釈されるものとします。

### パラメータ

| 定数 | 値 |
| - | - |
| `GAS_KECCAK256_WORD` | [Ethereum Execution Layer Specs](https://github.com/ethereum/execution-specs/blob/0f9e4345b60d36c23fffaa69f70cf9cdb975f4ba/src/ethereum/shanghai/vm/gas.py#L37C1-L37C19)で `6` と定義されています |
| `TX_CREATE_COST` | [Ethereum Execution Layer Specs](https://github.com/ethereum/execution-specs/blob/0f9e4345b60d36c23fffaa69f70cf9cdb975f4ba/src/ethereum/shanghai/fork_types.py#L42)で `32000` と定義されています |
| `STACK_DEPTH_LIMIT` | [Ethereum Execution Layer Specs](https://github.com/ethereum/execution-specs/blob/0f9e4345b60d36c23fffaa69f70cf9cdb975f4ba/src/ethereum/shanghai/vm/interpreter.py#L60)で `1024` と定義されています |
| `GAS_CODE_DEPOSIT` | [Ethereum Execution Layer Specs](https://github.com/ethereum/execution-specs/blob/0f9e4345b60d36c23fffaa69f70cf9cdb975f4ba/src/ethereum/shanghai/vm/gas.py#L44)で `200` と定義されています |
| `MAX_CODE_SIZE` | [EIP-170](./eip-170.md)で `24576` と定義されています |

[EIP-3540](./eip-3540.md)が有効になる同じブロック番号で、2つの新しい命令を導入します:

1. `EOFCREATE` (`0xec`)
2. `RETURNCONTRACT` (`0xee`)

### 実行セマンティクス

- `CREATE`、`CREATE2` 命令は廃止され、EOF コントラクトでは拒否されます。これらの命令はレガシーコントラクトでのみ利用可能です。
- `CREATE` および `CREATE2` 命令の initcode が EOF コード (先頭が `EF00` のマジックナンバー) の場合:
    - デプロイに失敗する (スタックに 0 を返す)
    - 呼び出し側のノンスは更新されず、initcode 実行のガスも消費されない

#### 新しいコントラクト作成フローの概要

EOF EVM では、新しいバイトコードは作成トランザクション (宛先が空の) の形で EOF コンテナ (`initcontainer`) として配信されます。このコンテナには任意の深さのネストされたサブコンテナを含めることができます。`initcontainer` とそのサブコンテナは、適用されるすべての検証ルールに従って再帰的に検証されます。次に、`initcontainer` の 0 番目のコードセクションが実行され、最終的に `RETURNCONTRACT` 命令を呼び出して、デプロイされるサブコンテナを参照することができます。

EOF 作成トランザクション (宛先が空で `data` が `EF00` マジックナンバーで始まるもの) は、別の EIP で詳細に定義されています。

一方、`EOFCREATE` 命令は、ファクトリーコントラクトが他のコントラクトを作成できるようにするための `CREATE` および `CREATE2` レガシー命令の置換です。作成トランザクションとの主な違いは、`initcontainer` が `EOFCREATE` を呼び出しているEOFコンテナのサブコンテナの1つとして選択されることです。ファクトリーコントラクトがデプロイされた時点で既に検証が行われているため、この時点では検証は行われません。

各命令の詳細は次のセクションで説明します。

#### `EOFCREATE`

- `TX_CREATE_COST` ガスを差し引く
- 即値オペランド `initcontainer_index` (8 ビットの符号なし値でエンコーded) を読み取る
- スタックから `value`、`salt`、`input_offset`、`input_size` をポップする
- `[input_offset, input_size]` を使ってメモリ拡張を行い、その分のガスを請求する
- `EOFCREATE` が実行されているコンテナの `initcontainer_index` 番目のサブコンテナをロードする
    - その EOF コンテナを `initcontainer`、その長さをバイト単位で `initcontainer_size` とする
- `GAS_KECCAK256_WORD * ((initcontainer_size + 31) // 32)` ガス (ハッシング料金) を差し引く
- 現在のコールデプスが `STACK_DEPTH_LIMIT` 未満であり、呼び出し側の残高が `value` を転送するのに十分であることを確認する
    - 失敗した場合はスタックに 0 を返し、呼び出し側のノンスは更新されず、initcode 実行のガスも消費されない
- 呼び出し側のメモリスライス [`input_offset`:`input_size`] がコールデータとして使用される
- コンテナを実行し、実行ガスを差し引く。[EIP-150](./eip-150.md)の 63/64 ルールが適用される
- 送信者アカウントのノンスをインクリメントする
- `new_address` を `keccak256(0xff || sender || salt || keccak256(initcontainer))[12:]` として計算する
- `accessed_addresses` への影響と、アドレスの衝突については `CREATE2` と同じ (EIP-684 と EIP-2929 の `CREATE2` のルールが `EOFCREATE` にも適用される)
- initcode の実行が失敗した場合はスタックに `0` を押し込む
    - `REVERT` した場合は returndata を設定できる
- 実行が成功すると、initcode が `RETURNCONTRACT{deploy_container_index}(aux_data_offset, aux_data_size)` 命令で終了する (下記参照)。その後:
    - `RETURNCONTRACT` が実行されているコンテナの `deploy_container_index` 番目のサブコンテナをロードする
    - データセクションに `(aux_data_offset, aux_data_offset + aux_data_size)` メモリセグメントを連結し、ヘッダのデータサイズを更新する
    - 更新後のデプロイコンテナのサイズが `MAX_CODE_SIZE` を超える場合、命令は例外的に中断する
    - `state[new_address].code` に更新されたデプロイコンテナを設定する
    - `new_address` をスタックにプッシュする
- `GAS_CODE_DEPOSIT * deployed_code_size` ガスを差し引く

#### `RETURNCONTRACT`

- 即値オペランド `deploy_container_index` (8 ビットの符号なし値でエンコーded) を読み取る
- スタックから 2 つの値 `aux_data_offset`、`aux_data_size` をポップする。これらはデプロイされるコンテナのデータに追加されるメモリセグメントを指す
- 0 ガス + 必要に応じてaux dataのためのメモリ拡張コストがかかる
- initcode フレームの実行を終了し、EOFCREATE/4 呼び出し元フレームに制御を返す。そこで `deploy_container_index` と `aux_data` が使用されてデプロイされるコントラクトが構築される (上記参照)
- データセクションのサイズがヘッダで宣言されたサイズを超えるか、下回る (つまり、データセクションサイズより小さくなる) 場合、命令は例外的に中断する

### コード検証

[EIP-3670](./eip-3670.md)で定義されているコードセクション検証ルールを拡張します。

1. `EOFCREATE` の `initcontainer_index` は `num_container_sections` 未満でなければならない
2. `EOFCREATE` が参照するサブコンテナの `len(data_section)` は `data_size` と等しくなければならない。つまり、データセクションの内容がヘッダで宣言されたサイズと正確に一致する (「データセクションのライフサイクル」を参照)
3. `EOFCREATE` が参照するサブコンテナには、`RETURN` や `STOP` 命令を含めることはできない
4. `RETURNCONTRACT` の `deploy_container_index` は `num_container_sections` 未満でなければならない
5. `RETURNCONTRACT` が参照するサブコンテナには `RETURNCONTRACT` 命令を含めることはできない
6. コンテナに `RETURNCONTRACT` と `RETURN` または `STOP` の両方が含まれているのは誤りである
7. 親コンテナで参照されていないサブコンテナがあるのは誤りである
8. 同一のサブコンテナが `RETURNCONTRACT` と `EOFCREATE` の両方で参照されるのは誤りである
9. `RJUMP`、`RJUMPI`、`RJUMPV` の即値引数 (ジャンプ先のオフセット) の検証: `EOFCREATE` または `RETURNCONTRACT` 命令の直後のバイトを指すオフセットの場合、コードセクションは無効とみなされる

### データセクションのライフサイクル

**まだデプロイされていないEOFコンテナの場合**、`data_section` は最終的な `data_section` の一部分にすぎません。
これを `pre_deploy_data_section` と定義し、そのコンテナのヘッダに宣言されている `data_size` を `pre_deploy_data_size` と定義します。
`pre_deploy_data_size >= len(pre_deploy_data_section)` であり、これは `pre_deploy_data_section` にデプロイ時にさらにデータが追加されることを示しています。

```
pre_deploy_data_section
|                                      |
\___________pre_deploy_data_size______/
```

**デプロイ済みのEOFコンテナの場合**、最終的な `data_section` は以下のようになります:

```
pre_deploy_data_section | static_aux_data | dynamic_aux_data
|                         |             |                  |
|                          \___________aux_data___________/
|                                       |                  |
\___________pre_deploy_data_size______/                    |
|                                                          |
\________________________data_size_______________________/
```

ここで:

- `aux_data` は `RETURNCONTRACT` 命令によって `pre_deploy_data_section` に追加されるデータです。
- `static_aux_data` は `aux_data` の一部分で、その長さは `RETURNCONTRACT` 実行前に既知であり、`pre_deploy_data_size - len(pre_deploy_data_section)` に等しい。
- `dynamic_aux_data` は `aux_data` の残りの部分です。

デプロイ済みのコンテナヘッダの `data_size` は `len(data_section)` に更新されます。

要約すると、最終的なデータセクションには `pre_deploy_data_size` バイトが確実に存在し、さらに `len(dynamic_aux_data)` バイトが存在することが分かります。これは、`DATALOAD`、`DATALOADN`、`DATACOPY` などのデータセクションアクセス命令の検証と動作に影響を与えます。詳細は[EIP-7480
## 理由

### データセクションの追加

データセクションはコントラクト作成時に追加され、ヘッダのサイズも更新される必要があります。以下のような代替案も検討されました:

- データ用の追加のセクションタイプの導入
- サブコンテナを記述する追加のフィールドの導入
- データセクションを上書きするのではなく、デプロイ前に0バイトで埋める

これらの代替案はいずれも、シンプルなデータ構造を複雑化したり、有用な機能(データセクションの動的なサイズ部分など)を失わせてしまいます。

## 後方互換性

この変更は、EIP-3540と同時に導入されるため、後方互換性のリスクはありません。新しい命令はレガシーバイトコード(EOFフォーマットではないコード)には導入されず、コントラクト作成オプションもレガシーバイトコードには変更されません。

`CREATE` および `CREATE2` の呼び出しで `EF00` initcodeを使う場合、initcodeの実行を開始せずに早期に失敗します。以前は両方の場合、initcodeの実行が始まり、最初の未定義の命令 `EF` で失敗していました。

## テストケース

作成トランザクション、`CREATE` および `CREATE2` の *コード* が `0xEF` で始まることはできませんが、そのようなケースは既に[EIP-3541](./eip-3541.md)でカバーされています。ただし、`CREATE` または `CREATE2` の *initcode* が(有効または無効な)EOFフォーマットになっているケースを新たに追加する必要があります:

| Initcode | 期待される結果 |
| - | - |
| `0xEF` | initcodeの実行が始まり、失敗する |
| `0xEF01` | initcodeの実行が始まり、失敗する |
| `0xEF5f` | initcodeの実行が始まり、失敗する |
| `0xEF00` | `CREATE` / `CREATE2` が早期に失敗し、0を返し、送信者のノンスは変更されない |
| `0xEF0001` | 上記と同様 |
| 有効なEOFv1コンテナ | 上記と同様 |

## セキュリティ上の考慮事項

外部の検証されていないコードが状態に入り込むのは、別のEIPで指定されるEOF作成トランザクションの方なので、そこに詳細な検討と議論が必要です。その中には以下のようなものが含まれます:

1. DoS攻撃を排除するために、複雑さが適切に管理されていること
2. 常に適切に課金され、支払われていること
3. 検証が包括的で、問題のあるコードが状態に保存されないこと

## 著作権

著作権およびそれに関連する権利は[CC0](../LICENSE.md)で放棄されています。