---
original: e444f46802cd11103fb390e0ba0d74c9d12336f78b3b6a770593078d9699242c
---

---
eip: 7686
title: Linear EVM memory limits
description: EVM実行の総メモリ消費量を明確な線形上限に収めるため、サブコールのメモリ制限とガス制限を調整する
author: Vitalik Buterin (@vbuterin)
discussions-to: https://ethereum-magicians.org/t/eip-7686-linear-evm-memory-limits/19448
status: Draft
type: Standards Track
category: Core
created: 2024-04-15
---

## 概要

現在のコンテキストのガス制限と等しい固定のメモリ制限を追加する。サブコールのガス消費上限をその時点のメモリ使用量に依存させる。これら2つのルールにより、Nガスのトランザクションは最大Nバイトのメモリを使用できるようになる。

## 動機

現在のメモリ価格ルールは複雑です。メモリ拡張の二次コストや、子コールに使えるガス量の63/64ルールなどがあります。これにより、特定のEVM実行に必要な最大メモリ量を正確に計算するのが極めて困難になっています。

本提案のルールは単純化し、新たに次のような上限を設けます。Nガスのコールは最大Nバイトのメモリを使用できる。この上限は厳密です。Nガスのコールが`N - O(1)`バイトのメモリを使用する方法は簡単に見つかります。

## 仕様

`memory_cost`を次のように変更する:

```python
memory_size_word = (memory_byte_size + 31) / 32
memory_cost = 3 * memory_size_word
```

さらに、メモリ拡張によって`memory_byte_size`が現在のコールの初期ガス制限を超える場合、エラーを返す。

あらゆるタイプのコールについて、最大ガス制限を現在の[EIP-150](eip-150.md)定義から次のように変更する:

```python
def max_call_gas(gas, memory_byte_size):
    return gas - max(gas // 64, memory_byte_size)
```

## 根拠

本EIPにより、Nガスのコールをメモリ容量Nバイトの単純なバイト配列で処理できるEVM実装が可能になります。現在のコンテキストにすべてのバイトを割り当て、子コールの際はメモリ位置`memory_byte_size`から残りのメモリを使用するといった具合です。

このような明確な不変条件は、特に制約環境(ZK-SNARKプルーバーなど)のEVM実装に有用です。

ワードあたり3ガスのメモリ拡張コストは維持されます。これはMCOPYと同等であり、子コール終了時のメモリクリア(一般マシンでは安価だが、ZK-SNARKやその他の特殊環境では高価)を、MCOPYオペコードの実装と同じロジックで行えるためです。

63/64ルールは、現在の事実上のコールスタック深さ制限(約537)を維持するために保持されます。

## 下位互換性

ガス制限が低い場合に、メモリの高インデックスにアクセスするEVMコードが動作しなくなる可能性はあります。しかし、ほとんどのEVM実行では、メモリよりもはるかに多くのコードを消費します。たとえば、状態変更を引き起こすコールには最低5000ガスが必要です。これにより5000バイトのメモリが使用できますが、ほとんどのアプリケーションではこれ以上は必要ありません。より複雑なアプリケーションでも、さらに高い制限が必要になります。

## セキュリティ上の考慮事項

特に懸念事項はありません。

## 著作権

[CC0](../LICENSE.md)によりすべての著作権およびそれに関連する権利を放棄します。