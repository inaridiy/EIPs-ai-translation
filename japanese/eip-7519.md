---
original: e2f7f3a4a4085d2e7079f2bf6190bb31ea5ed3bdaae3c37f9841bc5e9d0013c2
---

---
eip: 7519
title: 原子ストレージ操作 SCREDIT と SDEBIT
description: ストレージスロットの増減のための原子操作を追加する
author: Danno Ferrin (@shemnon)
discussions-to: https://ethereum-magicians.org/t/eip-7519-atomic-storage-operations-scredit-and-sdebit/15818
status: 停滞
type: Standards Track
category: Core
created: 2023-09-16
requires: 2200, 2929
---

## 概要

ストレージを原子的に変更する2つの新しいオペコード、SCREDIT (ストレージスロットを指定した値だけ増加させる) と SDEBIT (ストレージスロットを指定した値だけ減少させる) が提案されています。オーバーフローとアンダーフローのエラーは強制的に発生し、符号なし256ビット整数がオーバーフローまたはアンダーフローする場合は巻き戻されます。

## 動機

複数のチェーンにわたる並列 EVM に関する多くのエネルギーがありますが、楽観的同時性制御 (OCC) 以外のモデルをサポートするための並列プリミティブが EVM 内に欠けています。増減の並列プリミティブを追加することで、レイヤー2ネットワークでより高度な並列環境を導入できます。

これにより、増減の主要な使用例であるトークンバランスを提供する機会も得られます。オーバーフローとアンダーフローの条件で失敗を導入し、並列使用例以外でも有用な操作を提供できます。

## 仕様

ストレージを原子的に増減するための2つの操作が `0xTBD` で導入されます。各操作はスタック引数2つを取り、即時引数はありません。ガススケジュールは SSTORE と同じです。

| ニーモニック | Op        | 入力 | 出力 |
|-------------|-----------|-------|-------|
| `SCREDIT`   | `0xTBD`   | `2`   | `0`    |
| `SDEBIT`    | `0xTBD+1` | `2`   | `0`    |

### SCREDIT

`SCREDIT: slot, value`

#### 説明

`slot` のコントラクトストレージに格納されている値に `value` を加算します。オーバーフローが発生する場合、操作は例外的に停止します。

#### ガス課金

SSTORE と同じガス課金方式を使用します。SSTORE のガス課金の将来の変更も SCREDIT に適用されます。

#### 実行

*有効な Python ではなく、EELS には適していません*

```
slot = evm_stack.pop()
value = evm_stack.pop()

storage_value = read_contract_storage(slot)
storage_value = storage_value + value

if storage_value >= 2**256 :
  raise Exception("scredit overflow")
 
write_contract_storage(storage_value)
```

### SDEBIT

`SDEBIT: slot, value`

#### 説明

`slot` のコントラクトストレージに格納されている値から `value` を減算します。アンダーフローが発生する場合、操作は例外的に停止します。

#### ガス課金

SSTORE と同じガス課金方式を使用します。SSTORE のガス課金の将来の変更も SDEBIT に適用されます。

#### 実行

*有効な Python ではなく、EELS には適していません*

```
slot = evm_stack.pop()
value = evm_stack.pop()

storage_value = read_contract_storage(slot)
storage_value = storage_value - value

if storage_value < 0 :
  raise Exception("sdebit underflow")
 
write_contract_storage(storage_value)
```

## 根拠

代替案を選択する際の主な考慮事項は、主な対象者がトークンコントラクトやその他の資産追跡コントラクトであり、その使用例を可能にするために必要最小限の変更を行いたいということです。一般的な並行性制御は、この EIP の目標ではありません。

### オーバーフローセマンティクスの強制

順序外実行を許可する場合、可能な実行順序をすべて処理する仕組みが必要です。OCC はプリ/ポストコンディションの検証と、それらの不変量が保持されていない場合の再評価によってこれを処理します。この手法は、バランスとカウンターの書き込みでは機能しません。

オーバーフロー/アンダーフローチェック付きの増減は、バランスとカウンターの簡単な処理を可能にし、正確な値に依存することなく十分なバランスまたはカウントが存在することを確認する機能読み取りをサポートします。これにより、ストレージスロットが可能な再注文をすべて処理できることを確認するだけのポストコンディションチェックで評価モデルを実現できます。

### ガススケジュール

SSTORE と全く同じ値でこれらの操作にコストをかけることを決めたのは、実装の容易さと、コンパイラや開発者への奨励の両方の理由によるものです。

これらのセマンティクスは今日の EVM で実装できますが、SLOAD、DUP、LT、JUMPI、REVERT の命令も含める必要があります。ただし、EVM はこれらの操作をオペコードよりもはるかに効率的に実行できます。まず、各 SSTORE は [EIP-2200](./eip-2200.md) のガス計算ルールを適用するために必ずスロットの読み込みが行われます。この読み込みは、ペアの SLOAD がない場合に不可欠です。256ビットの数値ライブラリはすべて、オーバーフローとアンダーフローに敏感に対応できるように簡単に作成できます (まだ対応していない場合)。条件付きロジックの処理も、ほとんどのオーバーヘッドがオペレーション解析とスタック管理の際に発生するため、操作ロジック内の方が高速です。

最も関連性の高い操作 (SSTORE を超える ADD と LT 操作) の純粋なコストは 4 ガスで、現在の SSTORE コストの 0.2% に過ぎません。最後に、データベースアクセスコストが実際の操作コストを支配します。0.2% のオーバーヘッドはI/Oの待機時間に隠れてしまうかもしれません。

コストを同じに保つことで、ガス課金の実装が非常に簡単になります。

### ストレージスロットのみ

この EIP の最も重要な使用例はアセットバランスであり、一般的な並行性制御ではありません。したがって、ストレージスロット (トランザクション間で永続化される) のみでクレジットとデビットの操作を可能にします。トランザクション内の並列実行や、ロックやセマフォなどのより一般的なツールは、この範囲内ではほとんど有用性がありません。トランザクション内の並列実行の欠如により、[EIP-1153](./eip-1153.md) で定義されているような一時的なストレージに対してそのようなプリミティブを使用することもできません。

### オペコードではなくシステムコントラクト

特にレイヤー2チェーンにとって、SCREDIT と SDEBIT をシステムコントラクトとして実装するのは別の選択肢です。他の操作に対するシステムコントラクトを拒む主な理由は、呼び出しを構築するガスコストのオーバーヘッドです。SSTORE のコストが常に呼び出しのコストを上回るため、割引を設けることができます。ただし、そのような呼び出しを呼び出すために必要なコードサイズに対する対応はありません。

## 下位互換性

これらのオペコードは SLOAD-(ADD|SUB)-SSTORE シーケンスの単純な置き換えではありません。オーバーフロー/アンダーフローチェックが行われるためです。

この提案によって EVM の機能は削除されません。

## テストケース

以下の値とその前後の値について、オーバーフローとノンオーバーフローをテストします:

1, 2^8, 2^16, 2^32, 2^64, 2^128 2^255, 2^256-1.

## 参考実装

/# TBD

## セキュリティ上の考慮事項

オーバーフロー/アンダーフローを処理するためのrevertは、監査者がリエントランシーの懸念を検討する際に考慮する必要のある新しい停止条件を表します。

## 著作権

著作権およびその関連権利は [CC0](../LICENSE.md) で放棄されています。