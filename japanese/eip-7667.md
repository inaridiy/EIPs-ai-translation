---
original: 31d39402dfa4ddacb27d84f2d09c35463b8cbb2f7eff0a09ef99962c74b50450
---

---
eip: 7667
title: ハッシュ関数のガスコストの引き上げ
description: ZK-EVMのプルーバーの費用に合わせて、ハッシュ関数のオペコードとプリコンパイルのガスコストを引き上げる
author: Vitalik Buterin (@vbuterin)
discussions-to: https://ethereum-magicians.org/t/eip-7562-raise-gas-costs-of-hash-functions/19446
status: Draft
type: Standards Track
category: Core
created: 2024-03-31
---

## 概要

ハッシュ関数のオペコードとプリコンパイルのガスコストを引き上げる。

## 動機

ハッシュ関数のオペコードとプリコンパイルのガスコストは、通常のCPUで実行するのにかかる時間に基づいて当初設定されていました。しかし、その後、EVMが実行される別の重要な実行基盤として、ゼロ知識証明(ZK-SNARK)システムが登場しました。この基準では、これらのオペコードとプリコンパイルは他の操作に比べて非常に過小評価されています。

ハッシュ関数の実行が多い ブロックは、平均的なブロックに比べてZK-SNARKプルーフの生成に非常に時間がかかります。現在、多くのレイヤー2プロトコルは、任意の制限やセントラライズドシーケンサーによって強制されるルールなどの回避策を使っています。これらの回避策は設計が適切ではなく、不要なセキュリティとセントラリゼーションの問題を引き起こしています。

さらに、最終的にはZK-SNARKSを使ってレイヤー1のイーサリアムブロックの正しさを証明することが設計目標の1つです。そのためには、イーサリアムの実行ブロックの正しさを証明するZK-SNARKプルーフの生成時間の上限を非常に厳しく設定する必要があります。現在、平均的なプルーフ生成時間と最悪のプルーフ生成時間の差は大きく、ハッシュ関数の実行がその最大の理由となっています。

Verkleツリーは、Merkle Patricia ツリーでのKeccakハッシュの問題の一部を解決します。現在の理論上の最悪のケースは、`30000000 / 2600 = 11538`個のアカウントアクセスがあるブロック(EVMのオーバーヘッドの小さな割合を引いたもの)で、各アクセスのプルーフには`24000`バイトのコードと、`512 * log(500m) / log(16) = 3712`バイトのMerkle-Patriciaプルーフ、つまり`305 MB`のハッシュと`83650`回のハッシュ呼び出しが必要です。Verkleツリーはこの問題を解決します。しかし、オペコードを使うと、ブロックの実行にはおおよそ以下のようなハッシュが必要になります:

| ハッシュ | 1ワードあたりのコスト | 30 million gasからの最大バイト数 |
| - | - | - |
| `KECCAK` (オペコード) | 6 | 160 million |
| `SHA256` (プリコンパイル) | 12 | 80 million |
| `RIPEMD` (プリコンパイル) | 120 | 8 million |
| `BLAKE2` (プリコンパイル) | 3 (128バイトごとに12) | 320 million |
| `LOG*` (ハッシュデータ) | 256 (1バイトあたり8) | 3.75 million | 

これらのハッシュ関数は、CPUで高速に計算できるように最適化されています。たとえば、この著者のノートPCでは160 million バイトのkeccakを半秒未満で計算できます。しかし、ZK-SNARKSでは、これらの操作は非常に時間がかかり非効率です。小さな領域に基づく新しいプルーフシステムでは軽減されていますが、ハッシュは依然として過小評価されています。

## 仕様

| パラメータ | 以前の値 | 新しい値 | 
| - | - | - |
| `KECCAK_BASE_COST` | 30 | 300 |
| `KECCAK_WORD_COST` | 6 | 60 |
| `SHA256_BASE_COST` | 60 | 300 |
| `SHA256_WORD_COST` | 12 | 60 |
| `RIPEMD_BASE_COST` | 600 | 600 |
| `RIPEMD_WORD_COST` | 120 | 120 |
| `BLAKE2_GFROUND` | 1 | 10 |
| `GLOGBYTE` | 8 | 10 |

上記のパラメータを新しい値に変更する。

## 根拠

上記の変更により、EVMで大量のハッシュを必要とするすべてのオペコードとプリコンパイルのガスコストが引き上げられます。すべてのハッシュコストが1ハッシュあたり300、1ワードあたり60に引き上げられます(すでにこれ以上の場合は変更されません)。

この方法の代替案として、マルチディメンショナルガス価格設定(つまり、ハッシュ用の別個の変動ベースフィーと1ブロックあたりのターゲットと上限)や、[EIP-7623](eip-7623.md)が calldata に対して行っているような "総ガスコストの下限"を実装することが考えられます。しかし、calldata やブロブとは異なり、EVMのガス制限はユーザーだけでなく、サブコールを行う他のコントラクトによっても設定されるため、ハッシュ用のこのような新しいトランザクションタイプを追加するのは非常に難しいです。

## 下位互換性

ほとんどのアプリケーションでは、EVMでハッシュされるデータがcalldataとして持ち込まれるという合理的な上限があります。ハッシュが行われているのがバイナリMerkleプルーフの検証の場合、32バイトのデータごとに64バイト(2ワード)のハッシュが必要です。1ワードのコストは512ガスです。新しいコストの下では、その状況でのハッシュ1ワードあたりのコストは `300 + 60 * 2 = 420` ガスになります。したがって、このアプリケーションのそのコンポーネントのガス消費は2倍未満の増加となります。

具体的には、長さ20のKeccak ベースのバイナリMerkleプルーフのガスコストは、`(512 + 42) * 20 = 11080` から `(512 + 420) * 20 = 18640` に増加します。これは小さな増加で、そのようなアプリケーションに関連するその他のコストを考慮すると問題ありません。

## セキュリティ上の考慮事項

新しい操作が導入されたり、より安価になったりするわけではないため、セキュリティ上の懸念は指摘されていません。

## 著作権

[CC0](../LICENSE.md)によりすべての著作権およびそれに関連する権利が放棄されています。