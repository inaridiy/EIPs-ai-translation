---
original: cc23cad80c3e57874dd407c24649b0084f310174b6e184aead192633a5f95f1e
---

---
eip: 2666
title: プリコンパイルとKeccak256関数の再価格付け
author: Alex Vlasov (@shamatar)
discussions-to: https://ethereum-magicians.org/t/eip2666-global-precompiles-repricing-and-many-more-discussion-thread/4332
status: 停滞
type: Standards Track
category: Core
created: 2020-05-22
requires: 1352, 2046, 2565
---

## 簡単な要約

このEIPは、パフォーマンス、消費リソース、EVMの最新の変更に合わせて、特定のプリコンパイルと組み込みEVM関数の価格を設定することを試みています。

以下の新しい価格計算式が提案されています:
- SHA256プリコンパイル (`0x02`)
- RIPEMDプリコンパイル (`0x03`)
- KECCAK256オペコード (`0x20`)

## 概要

多くのプリコンパイルと組み込み関数のコストは、現在のクライアントの状態では無効です。このEIPには、基礎となる計算の構造をより良く反映するための価格計算式の変更のリストが含まれています。

## 動機

EVMでのこれらの関数の歴史的な価格設定は、基礎となるハッシュ関数の内部構造を反映していません。

- EIP-2046は`STATICCALL (0xfa)`コストをプリコンパイルに変更したため、古い大きなコスト(`700`ガス)を考慮し、それを補償しようとしていた一部のプリコンパイルのコストを調整する必要がある可能性があります。
- 一部のプリコンパイルは過剰に価格が設定されており、価格計算式は基礎となる関数の構造を反映していません。
- EVMのKeccak256組み込み関数(オペコード)の価格設定は、基礎となるハッシュ関数の構造を反映していません。

## 仕様

`block_number >= X`の場合、以下のプリコンパイルとKeccak256オペコードのガスコストを設定します:
- SHA256 (プリコンパイル `0x02`): `10 + ((len(input) + 8)/64 + 1) * 9`
- RIPEMD (プリコンパイル `0x03`): `6 + ((len(input) + 8)/64 + 1) * 12`
- KECCAK256 (`0x20`): `13 + (len(input)/136 + 1)*15`

このEIPは、[EIP-2565](./eip-2565.md)で実装された`MODEXP`の再価格付けが、古い`STATICCALL (0xfa)`コスト(pre-2046)の暗黙的な補償がないことを正確に反映するのに*理想的*に必要とされます。

## 根拠
関数の実行コストは実際のCPU時間を正確に反映する必要があるため、現在のプリコンパイルとKeccak256関数について、入力パラメータに対する実行時間を測定するベンチマークを実行しました。

### 再価格付けアプローチの詳細な要約

このEIPは以下の2つの事実に依存しています:
- ハッシュ関数の内部構造に関する事前の知識
- クライアントチームが提供した、ランダムな入力長に対するベンチマーク(ランダムなバイト文字列の長さ)

### 最も一般的なクライアントのベンチマーク

EIP-2666に必要なベンチマークは、クライアントによって提供され、生のデータは[こちら](https://docs.google.com/spreadsheets/d/1aCQnk7prrp3Mbcf011BE5zZnkbc3Iw7QAixn6mLbKS0/edit?usp=sharing)にまとめられています。

- SHA256プリコンパイル

現在は`60`ガス + `32`バイトワードごとに`12`ガスです(ワードの数は`ceil(len(input)/word_len)`です。`floor`や`ceil`の指定がない場合、以下の除算はすべて整数除算(floor除算)です)。提案の計算式は`A * ((len(input) + 8) / 64 + 1) + B`で、係数は以下の通りです。

|   |   | A  | B  |
|---|---|---|---|
| Geth  |   | 5  | 3  |
| OE  |   | 9  | 4  |
| Besu  |   | 5  | 10  |
| Nethermind  |   | 10  | 5  |

EIP-2666は`A = 9`、`B = 10`を提案しています。このプリコンパイルには大きな一回限りのコストはないため、EIP-2046に対応しています。

- RIPEMDプリコンパイル

現在は`600`ガス + `32`バイトワードごとに`120`ガスです。提案の計算式は`A * ((len(input) + 8) / 64 + 1) + B`で、係数は以下の通りです。

|   |   | A  | B  |
|---|---|---|---|
| Geth  |   | 12  | 6  |
| OE  |   | 8  | 2  |
| Besu  |   | 29  | 16  |
| Nethermind  |   | 10  | 6  |

EIP-2666は`A = 12`、`B = 6`を提案しています。このプリコンパイルには大きな一回限りのコストはないため、EIP-2046に対応しています。Besuは今年末までにパフォーマンスの改善を予定しています。

- Keccak256のパフォーマンス

現在は`30`ガス + `32`バイトワードごとに`6`ガスです。提案の計算式は`A * (len(input) / 136 + 1) + B`で、係数は以下の通りです。

|   |   | A  | B  |
|---|---|---|---|
| Geth  |   | 13  | 13  |
| OE  |   | 15  | 2  |
| Besu  |   | 19  | 28  |
| Nethermind  |   | 16  | 3  |

EIP-2666は`A = 15`、`B = 13`を提案しています。このプリコンパイルには大きな一回限りのコストはないため、EIP-2046に対応しています。Besuは今年末までにパフォーマンスの改善を予定しています。

### ツールとデータ

さまざまなクライアントのベンチマークから得られた参考資料(生データ)は[こちら](https://docs.google.com/spreadsheets/d/1aCQnk7prrp3Mbcf011BE5zZnkbc3Iw7QAixn6mLbKS0/edit?usp=sharing)にあります。

プリコンパイルのベンチマークとテストに使用できる入力が用意されたリポジトリが[こちら](https://github.com/shamatar/bench_precompiles)にあります。

Besuの[ベンチマーク](https://gist.github.com/shemnon/0ddba91be501fa23291bdec9107fe99a)もあります。

### 計算式の構造に関する注意

`A * 1`のような項がありますが、これらは`B`係数に結合されていないことに注意してください。これは、空のバイト配列のハッシュを計算するには、ハッシュの1ラウンドを実行する必要があることを反映しています。

## 下位互換性
プリコンパイルの再価格付けは過去に行われており、標準的な手順と見なされています。多くのコントラクトのガスコストが減少することで、固定ガスコストに基づくリエントラント保護が破壊される可能性があります。そのような保護は、良い最終的な設計ではありませんでした。

## テストケース

`0`、`64`、`160`バイトのKeccak256ハッシュの簡単な例を考えましょう。これは実装の単純な健全性チェックです。

- `0`バイトのハッシュ:
  - 旧価格: `30 + 6 * ceil(0 / 32) = 30` ガス
  - 新価格: `15 * (0/136 + 1) + 13 = 28` ガス
- `64`バイトのハッシュ
  - 旧価格: `30 + 6 * ceil(64 / 32) = 42` ガス
  - 新価格: `15 * (64/136 + 1) + 13 = 28` ガス
- `160`バイトのハッシュ
  - 旧価格: `30 + 6 * ceil(160 / 32) = 60` ガス
  - 新価格: `15 * (160/136 + 1) + 13 = 43` ガス

## 実装

執筆時点では、主要なクライアントでの定数の単純な変更が必要なため、参照実装はありません。

## セキュリティ上の考慮事項

下位互換性の項で説明したように、コストの削減により、以前は予期されていなかったリエントラントなどが可能になる場合があります。しかし、固定ガスコストに基づくリエントラント保護は、設計上の欠陥であると考えています。

## 著作権
著作権およびその関連権利は[CC0](../LICENSE.md)で放棄されています。