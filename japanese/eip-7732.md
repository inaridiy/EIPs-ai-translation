---
original: 4a4cd0e56278201e419b10f3068f02d4bfa5c2601f0ca312dfb392a285fb1de0
---

---
eip: 7732
title: 承認済みの提案者-ビルダー分離
description: イーサリアムブロックをコンセンサスと実行の部分に分離し、コンセンサスの提案者が実行の提案者を選択するメカニズムを追加します。
author: Francesco D'Amato <francesco.damato@ethereum.org>、Barnabé Monnot <barnabe.monnot@ethereum.org>、Michael Neuder <michael.neuder@ethereum.org>、Potuz (@potuz)、Terence Tsao <ttsao@offchainlabs.com>
discussions-to: https://ethereum-magicians.org/t/eip-7732-enshrined-proposer-builder-separation-epbs/19634
status: Draft
type: Standards Track
category: Core
created: 2024-06-28
---

## 概要

このEIPは、論理的にも時間的にも、実行の検証をコンセンサスの検証から分離することで、イーサリアムブロックの検証方法を根本的に変更します。これは、新しい任意の属性(「ビルダー」であること)と新しい義務(「ペイロードの適時性アテステーション」の提出)をイーサリアムのバリデーターに導入することで実現されます。`BeaconBlockBody`の`ExecutionPayload`フィールドが削除され、代わりに、ビルダーが後に対応する実行ペイロードを明らかにするための署名付きのコミットメント(`SignedExecutionPayloadHeader`オブジェクト)が導入されます。このコミットメントには、特に実行ブロックのブロックハッシュと、ビーコンブロックの提案者に支払われる「値」が指定されています。`BeaconBlock`を処理する際、コミットされた値がビルダーのビーコンチェーンバランスから差し引かれ、ビーコンブロックの提案者に加算されます。ビーコンコミッティーの一部のバリデーターが「ペイロードの適時性委員会」(PTC)に割り当てられ、これらのバリデーターは、対応するビルダーが適時にコミットされた実行ペイロードを明らかにしたかどうかを(「PayloadAttestationMessage」をブロードキャストすることで)証明する責任を負います。PTC メンバーは実行ペイロードの検証を行う必要はなく、実行の検証は次のビーコンブロックの検証まで延期されます。

## 動機

このEIPは、関連性のない重要な問題を解決します。

- ビーコンブロックの提案者の大多数が、ブロック内の実行ペイロードの構築を第三者(以下「ビルダー」と呼ぶ)に委託しています。そのために、約束された実行ペイロードのハッシュツリールート(HTR)を要求し、信頼できる当事者に`SignedBlindedBeaconBlock`を提出して、HTRを(ビルダーから受け取った実行ペイロードで)置き換えてから配信させています。このEIPにより、ビーコンブロックの提案者とビルダーの間で信頼できる公平な交換が可能になり、正直なビーコンブロックの提案者がビルダーの行動に関係なく支払いを受け取り、正直なビルダーのペイロードが提案者の行動に関係なく正規のチェーンの先頭になることが保証されます。
- 現在、バリデーターは、完全なビーコンブロック(実行ペイロードを含む)を受け取ってから、アテステーションの締切り(イーサリアムメインネットでは4秒)までの間に、コンセンサスと実行の状態遷移関数の両方を実行し、ブロブデータの可用性を確認し、ブロックチェーンの新しい先頭を評価しなければなりません。スロットの残りの時間は、CPU集約的でない重要でない作業に費やされます。実行とコンセンサスの検証を分離することで、バリデーターはアテステーションの前に、コンセンサスの状態遷移関数のみを実行する必要があり、実行とデータ可用性の検証は、ビルダーの明らかにする時間とその次のアテステーションの締切りの間に行うことができます。
- コンセンサスブロックから実行ペイロードのサイズを削除することで、重要なパスでのネットワーク伝播が高速化されます。
- ブロブトランザクションをブロックに含めることによる再編成の可能性の増加を排除します。これは、DA可用性チェックのタイムラインの自然な増加と、ビルダーがビーコンブロックのアテステーションがリリースされる前にブロブサイドカーをブロードキャストする可能性があるためです。
- バリデーターがアテステーションを逸失するのを防ぎ、ビルダーが無効なペイロードを生成した場合のフォークチョイスの重み特性を強化します。
- ブロック構築をビルダーに委任するために信頼できるミドルウェアを使用する必要がなくなります。

## 仕様

### 実行レイヤー

変更は必要ありません。

### コンセンサスレイヤー

完全なコンセンサスの変更は、コンセンサス仕様GitHubリポジトリにあります。それらは以下に分かれています:

- [ビーコンチェーン](https://github.com/ethereum/consensus-specs/blob/1508f51b80df5488a515bfedf486f98435200e02/specs/_features/eipxxxx/beacon-chain.md)の変更。
- [フォークチョイス](https://github.com/ethereum/consensus-specs/blob/1508f51b80df5488a515bfedf486f98435200e02/specs/_features/eipxxxx/fork-choice.md)の変更。
- [P2P](https://github.com/ethereum/consensus-specs/blob/1508f51b80df5488a515bfedf486f98435200e02/specs/_features/eipxxxx/p2p-interface.md)の変更。
- [正直なバリデーターガイド](https://github.com/ethereum/consensus-specs/blob/1508f51b80df5488a515bfedf486f98435200e02/specs/_features/eipxxxx/validator.md)の変更。
- 新しい[正直なビルダー](https://github.com/ethereum/consensus-specs/blob/1508f51b80df5488a515bfedf486f98435200e02/specs/_features/eipxxxx/builder.md)ガイド。
- [フォークロジック](https://github.com/ethereum/consensus-specs/blob/1508f51b80df5488a515bfedf486f98435200e02/specs/_features/eipxxxx/fork.md)の変更。

主な変更点の概要を以下に示します。[根拠](#根拠)セクションには、これらの変更に関する設計上の意思決定の説明が含まれています。

#### ビーコンチェーンの変更

##### 定数

| 名称 | 値 |
| - | - |
| `PAYLOAD_ABSENT` | `uint8(0)` |
| `PAYLOAD_PRESENT` | `uint8(1)` |
| `PAYLOAD_WITHHELD` | `uint8(2)` |
| `PAYLOAD_INVALID_STATUS` | `uint8(3)` |

##### プリセット

| 名称 | 値 |
| - | - |
| `PTC_SIZE` | `uint64(2**9)` (=512) |
| `DOMAIN_BEACON_BUILDER` | `DomainType('0x1B000000')` |
| `DOMAIN_PTC_ATTESTER` | `DomainType('0x0C000000')` |
| `MAX_PAYLOAD_ATTESTATIONS` | `2**2` (= 4) |

##### コンテナ

```python
class PayloadAttestationData(Container):
    beacon_block_root: Root
    slot: Slot
    payload_status: uint8
```

```python
class PayloadAttestation(Container):
    aggregation_bits: Bitvector[PTC_SIZE]
    data: PayloadAttestationData
    signature: BLSSignature
```

```python
class PayloadAttestationMessage(Container):
    validator_index: ValidatorIndex
    data: PayloadAttestationData
    signature: BLSSignature
```

```python
class IndexedPayloadAttestation(Container):
    attesting_indices: List[ValidatorIndex, PTC_SIZE]
    data: PayloadAttestationData
    signature: BLSSignature
```

```python
class SignedExecutionPayloadHeader(Container):
    message: ExecutionPayloadHeader
    signature: BLSSignature
```

```python
class ExecutionPayloadEnvelope(Container):
    payload: ExecutionPayload
    builder_index: ValidatorIndex
    beacon_block_root: Root
    blob_kzg_commitments: List[KZGCommitment, MAX_BLOB_COMMITMENTS_PER_BLOCK]
    payload_withheld: boolean
    state_root: Root
```

```python
class SignedExecutionPayloadEnvelope(Container):
    message: ExecutionPayloadEnvelope
    signature: BLSSignature
```

`BeaconState`コンテナに以下の追加がされました:

- 最後の実行ペイロードのブロックハッシュを追跡する`latest_block_hash`(型`Hash32`)。
- 最後にペイロードが含まれたスロットを追跡する`latest_full_slot`(型`Slot`)。
- ビーコンチェーンでの処理時に控除された最新の引き出しのハッシュツリールートを追跡する`latest_widthdrawals_root`(型`Root`)。

`BeaconBlockBody`が以下のように変更されました:

- ビルダーのコミットメントである`signed_execution_payload_header`(型`SignedExecutionPayloadHeader`)。
- 前のスロットからのPTCアテステーションのリスト`payload_attestations`(型`List[PayloadAttestation, MAX_PAYLOAD_ATTESTATIONS]`)。

`ExecutionPayloadHeader`オブジェクトは、ビルダーのペイロードにコミットするために必要な最小限の情報のみを追跡するように変更されました。

状態遷移ロジックが以下のように変更されました:

- 新しいビーコン状態ゲッター`get_ptc`は、指定されたスロットのPTCメンバーを返します。
- `get_attesting_indices`は、PTCに含まれるビーコンコミッティーメンバーを返さないように変更されました。
- `process_withdrawals`が以下のように変更されました。引き出しはビーコン状態から直接取得され、ビーコンチェーンから控除されます。ビーコン状態の`latest_widthdrawals_root`がこのリストのHTRで更新されます。次の実行ペイロードには、`state.latest_withdrawals_root`と一致する引き出しが含まれている必要があります。
- `process_block`から`process_execution_payload`が削除されました。代わりに新しい関数`process_execution_payload_header`が含まれ、`BeaconBlockBody`に含まれる`SignedExecutionPayloadHeader`を検証し、ビルダーのバランスから提案者に支払いを移します。
- `process_operations`から`process_deposit_request`が削除され、`process_execution_payload`に延期されました。
- `process_operations`から`process_withdrawal_request`が削除され、`process_execution_payload`に延期されました。
- `process_operations`から`process_consolidation_request`が削除され、`process_execution_payload`に延期されました。
- 新しい`process_payload_attestation`が`process_operations`に追加され、PTCメンバーがブロードキャストしたペイロードの適時性アテステーションを検証します。
- `process_execution_payload`は、P2Pレイヤーで`SignedExecutionPayloadEnvelope`を受信したときに別のヘルパーとして呼び出されます。この関数は特に、結果のビーコン状態のHTRが、ペイロードエンベロープ内のコミットされたものと一致することを確認します。

#### フォークチョイスの変更

##### 定数

| 名称 | 値 |
| - | - |
| `PAYLOAD_TIMELY_THRESHOLD` | `PTC_SIZE/2` (=`uint64(256)`) |
| `INTERVALS_PER_SLOT` | `4` |
| `PROPOSER_SCORE_BOOST` | `20` |
| `PAYLOAD_WITHHOLD_BOOST` | `40` |
| `PAYLOAD_REVEAL_BOOST` | `40` |

##### コンテナ

```python
class ChildNode(Container):
    root: Root
    slot: Slot
    is_payload_present: bool
```

`LatestMessage`クラスがエポックではなくスロットを追跡するように変更されました:

```python
@dataclass(eq=True, frozen=True)
class LatestMessage(object):
    slot: Slot
    root: Root
```

`Store`クラスが以下のフィールドを追跡するように変更されました:

```python
    execution_payload_states: Dict[Root, BeaconState] = field(default_factory=dict)
    ptc_vote: Dict[Root, Vector[uint8, PTC_SIZE]] = field(default_factory=dict)
    payload_withhold_boost_root: Root
    payload_withhold_boost_full: bool
    payload_reveal_boost_root: Root
```

- 新しいハンドラー`on_payload_attestation_message`は、P2Pネットワークから`PayloadAttestationMessage`を受信したときに呼び出されます。
- 新しいハンドラー`on_execution_payload`は、P2Pネットワークから`SignedExecutionPayloadEnv
elope`を受信したときに呼び出されます。

#### P2Pの変更

- `SignedExecutionPayloadHeader`メッセージ(ビルダーの入札)をブロードキャストするための新しいグローバルトピック。
- `PayloadAttestationMessage`オブジェクトをブロードキャストするための新しいグローバルトピック。

### エンジンAPI

変更は必要ありません。

## 根拠

### ステークされたビルダー

ビルダーであることは、バリデーターの新しい属性です。そのため、ビルダーはビーコンチェーンでステークされています。これにより、ビルダーの提案者への支払いを、プロトコル内で信頼できる方法で強制することができます。代替案として、支払いを実行レイヤー(EL)で強制することもできますが、その場合は対応するELコンセンサス変更ロジックを追加する必要があります。ELでの支払いには、ペイロードが明らかにされる前に資金が利用可能であるという利点があります。コンセンサスレイヤー(CL)では、ビルダーにステークさせることで、これを実現しています。ELでは、ブロックの最初のトランザクションであれば、ペイロードを実行せずに支払いトランザクションを確認できます。

### 遅延検証

ペイロードの適時性委員会のメンバーは、アテステーションを行う前に実行ペイロードを検証する必要はありません。ビルダーの署名の検証や、正しいブロックハッシュが含まれていることなどの基本的なチェックを行います。これにより、イーサリアムブロックの検証の重要なパスから、完全な実行ペイロードの検証が取り除かれ、次の提案者に6秒(`SECONDS_PER_SLOT * 2 // INTERVALS_PER_SLOT`)、その他すべてのバリデーターに9秒(`SECONDS_PER_SLOT * 3 // INTERVALS_PER_SLOT`)の時間が与えられます。ユーザーエクスペリエンスの観点から、スロット`N`でビルダーによって含められたトランザクションは、スロット`N+1`の提案者がスロット`N`のブロックを先頭として最初にビーコンブロックをリリースし、スロット`N+1`のアテスターがこのビーコンブロックをチェーンの先頭として投票するまで、広く検証されません。

### (ブロック、スロット、ペイロード) - フォークチョイス

以下の機能は、指定された安全性の限界内で保証されます:

- 提案者の無条件の支払い。
- ビルダーの明らかにする安全性。
- ビルダーの保留の安全性。

提案者の無条件の支払いとは、以下のことを指します。イーサリアムのスロットは以下のいずれかになります:

- *完全*: ビーコンブロックと実行ペイロードの両方が明らかにされ、オンチェーンに含まれている。
- *スキップ*: このスロットにビーコンブロック(したがって実行ペイロードも)がオンチェーンに含まれていない。
- *空*: ビーコンブロックがオンチェーンに含まれているが、コミットされた実行ペイロードは含まれていない。

提案者の無条件の支払いとは、3番目のシナリオでビーコンブロックの提案者が対応するビルダーから支払いを受け取ることを意味します。

ビルダーの明らかにする安全性とは、ビルダーが誠実に行動し、適時にペイロードを明らかにした(PTCによって証明された)場合、明らかにされたペイロードがオンチェーンに含まれることを意味します。これは、フォークチョイスノードにペイロードを含むブロックに新しい`BUILDER_REVEAL_BOOST`を追加することで強制されます。

ビルダーの保留の安全性とは、ビルダーのコミットメントを含むいくつかのビーコンブロックが保留され、遅れて明らかにされた場合、そのビーコンブロックルートが正直なバリデーターの視点では正規のチェーンの先頭にはならないことを意味します。

これを強制するために、スロット`N`のアテステーションが前のスロットからのブロックを支持するだけでなく、実際にはスロット`N`のブロックに反対するようになっています。これが`(ブロック、スロット)`投票の内容です。同様に、スロット`N+1`のコンセンサスが、スロット`N`のコンセンサスブロックを親ブロックとしているが、スロット`N-1`で明らかにされた実行ペイロードを親実行ブロックとしている(したがって、スロット`N`中に明らかにされた可能性のある実行ペイロードを無視している)場合、このコンセンサスブロック`N+1`に対するアテステーションは、コンセンサスブロック`N`(つまり、完全なスロット`N`)に由来する実行ペイロードを持つチェーンを支持しません。これが`(ブロック、スロット、ペイロード)`投票の内容です。

### ビルダーの適時性ブースト

ビルダーが期待されたペイロードを明らかにし、PTCが`PAYLOAD_PRESENT`に対して`PAYLOAD_TIMELY_THRESHOLD`以上の票を得た場合、つまり適時であると合意した場合、完全なスロット(コンセンサスブロックとそのペイロードを含む)を含むフォークチョイスノードには、ビーコンコミッティーの40%に相当するブーストが付与されます。

同様に、ビルダーが`PAYLOAD_WITHHELD`メッセージを明らかにし、PTCが`PAYLOAD_WITHHELD`に対して`PAYLOAD_TIMELY_THRESHOLD`以上の票を得た場合、つまり保留であると合意した場合、親コンセンサスブロックには、ビーコンコミッティーの40%に相当するブーストが付与されます。`(ブロック、スロット)`フォークチョイス投票の性質上、このブーストは、ビルダーのコミットメントを含むコンセンサスブロックに対して**反対**します。

これらのブーストは、[セキュリティ上の考慮事項](#セキュリティ上の考慮事項)セクションで説明されているパラメーターの下でビルダーの明らかにする安全性と保留の安全性を保証するために存在します。

### PTCの矛盾

PTCやペイロードの矛盾(つまり、正しいペイロードと同時に保留メッセージも明らかにすること)に対するペナルティはありません。ネットワークパーティションを制御するビルダーと1人の悪意のあるPTCメンバーが共謀すれば、ペイロードが保留されたと合意し、同時にペイロードが存在すると合意することで、分断された視点を引き起こすことができます。これは、`PAYLOAD_TIMELY_THRESHOLD`を2/3のPTCに設定することで緩和できます。その場合、悪意のある運営者が少なくとも33%のPTCを制御する必要があります。

別の緩和策は、ペイロードの矛盾やPTCの矛盾(どちらも署名されたバリデーターメッセージ)に対する新しいスラッシング条件を追加することです。

この攻撃はビルダーにとってコストがかかる分割ビューを引き起こすため(ペイロードが明らかにされ、含まれない可能性がある)、このEIPは実装の簡単さを選択しました。

### 引き出し

ビーコンチェーンからの引き出しは複雑な性質を持っており、一方のレイヤーから資金を削除し、別のレイヤーに入金するものであり、両方のレイヤーから開始できるトリガーメカニズムが異なります。事前の状態`pre_state`とサインされたビーコンブロック`block`を処理してビーコン状態の状態遷移関数を適用する前に、ビーコンチェーンから控除されることが期待される引き出しのセットは完全に`pre_state`によって決定されます。このEIPの前は、実行レイヤーに入金される引き出しのセットが`block`に含まれていました。これらの引き出しが一致しない場合、ブロックは無効とみなされました。このEIPで導入された分離により、これらの控除と入金の操作は非同期になります:

- ビーコンブロックを処理する際、引き出しがビーコンチェーンから控除されます。
- 控除された引き出しのセットが`post_state`ビーコン状態にコミットされます。
- `post_state`を親ビーコン状態とする任意の実行ペイロードを処理する際、ペイロードは`post_state`にコミットされたリストの引き出しを含んでいない場合、無効とみなされます。

この非同期メカニズムには一部の影響があります。スロットが*空*になる可能性があるためです(上記で定義したとおり)。この場合、コンセンサスレイヤーは、実行ペイロードが未処理の引き出しを履行するまで、これ以上の引き出しを処理しません。別の設計では、すべての引き出し処理を実行ペイロードの検証フェーズ(つまり`process_execution_payload`)に延期することができます。これにより、ビーコンチェーンで履行された引き出しを追跡する必要がなくなります。複数のペイロードが欠落している場合のロジックの変更は、前のメカニズムでは可能だった引き出しが、後者では異なる、あるいは不可能になる可能性があるという点で異なります。

### 3つの状態遷移関数

現在のEIPは、ブロック処理にイーサリアムに追加の状態遷移関数を追加しています。`SignedBeaconBlock`の処理はコンセンサスレイヤーの`BeaconState`を変更します。`SignedExecutionPayloadEnvelope`は、実行レイヤーの状態とコンセンサスレイヤーの状態の両方を変更します。そのため、エンベロープはコンセンサスレイヤーの状態遷移後のビーコン状態ルートにコミットします。

### 互換性のある設計

#### 包含リスト

このEIPは、[EIP-7547](./eip-7547.md)や同様の前方包含リストと完全に互換性があります。

#### スロットオークション

このEIPの簡単な変更は、`SignedExecutionPayloadHeader`からブロックハッシュのコミットメントを削除することです。これにより、ビルダーはスロットに任意のペイロードをコミットできます。初期的なセキュリティ分析によると、ペイロードの矛盾はFFGのフォークチョイスを弱めません。スロットオークションの利点には以下のようなものがあります:

- ユーザーエクスペリエンスが向上します。スロットの最初の半分に送信されたトランザクションでも、次のブロックに含めることができます(ブロックオークションの場合、次のブロックにしか含められません)。
- ブロックを構築する連続時間が長くなります。
- フォークチョイスで強制的な包含リストの提案との互換性が向上します。

## 下位互換性

このEIPは、コンセンサスレイヤーのブロック検証ルールセットに下位互換性のない変更を導入し、ハードフォークを伴う必要があります。

## セキュリティ上の考慮事項

### 再編成への耐性

`PROPOSER_SCORE_BOOST`は40から20に減少しました。これにより、総ステークの20%を持つ提案者による事前の再編成は許可されませんが、20%以上の総ステークを制御する共謀するプロポーザーとアテスターのセットによる1スロットサンドイッチ再編成は防ぐことはできません。

### ビルダーの安全性

- 連続するブロックと総ステークの20%以上を制御する共謀するプロポーザーとアテスターのセットは、ビルダーのペイロードを再編成し、入札額の支払いを強制できます。
- 同一スロット内でビルダーのペイロードを「バンドル解除」することはできません。つまり、ビルダーが現在のチェーンの先頭に対してペイロードを明らかにした場合、その他のペイロードは現在のスロットでは不可能です。

### 悪意のあるPTC

総ステークの35%を制御する悪意のある攻撃者が、PTCの過半数を獲得するまでの予想時間は205,000年です。

## 著作権

著作権およびその関連権利は[CC0](../LICENSE.md)で放棄されています。