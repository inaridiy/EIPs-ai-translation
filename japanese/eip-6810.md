---
original: 2d476fca395395087194f966f02cb548fba5cbf0ba74fe5a861895eb94847071
---

---
eip: 6810
title: 事後的な連鎖的な取り消し
description: 確認後にトランザクションを取り消すことを可能にする
author: William Morriss (@wjmelements)
discussions-to: https://ethereum-magicians.org/t/eip-6810-ex-post-facto-cascading-revert/13630
status: 停滞
type: Standards Track
category: Core
created: 2023-04-01
requires: 2718, 2929
---

## 概要

送信者の過去のトランザクションと、それに依存する他のトランザクションを再帰的に取り消す新しいトランザクションタイプ。

## 動機

Ethereumにはスマートコントラクトを通じて取り消し可能なトランザクションの機能がありますが、即時決済がデフォルトとなっています。
しかし、時には利用者が間違いを犯すことがあります。
ほとんどの間違いは早期に発見されますが、一度トランザクションが確認されると、それは確定されてしまいます。
確定したトランザクションを取り消す多くの使用例があります。
最も一般的な間違いの一部を以下に示します。

- 間違った受取人
- 意図しない結果
- 詐欺に遭った

この機能はこれらの問題と他の問題に対処し、すべての後悔を終わらせます。

## 仕様

### パラメータ

新しい[EIP-2718](./eip-2718.md)トランザクションが`TransactionType` `0x5a`で導入されます。
[EIP-2718](./eip-2718.md) `TransactionPayload`は`rlp([chainId, nonce, revertNonce, budget, signatureYParity, signatureR, signatureS])`です。
このトランザクションの`signatureYParity, signatureR, signatureS`要素は、`keccak256(0x5a || rlp([chainId, nonce, revertNonce, budget]))`に対するsecp256k1署名を表します。
[EIP-2718](./eip-2718.md) `ReceiptPayload`は`rlp([status, budgetUsed, removedLogsBloom, [newReceiptPayloads]])`で、`newReceiptPayloads`は取り消されたすべてのトランザクションの更新された領収書の順次配列です。

### ブロックガス制限

`0x5a`タイプのトランザクションは、そのブロックの唯一のトランザクションでなければなりません。

### 連鎖的な取り消し操作

`budget`で指定された値をトランザクション手数料の初期値とします。この予算はこのタイプのトランザクションの手数料です。取り消されたトランザクションの手数料はこの予算から返金されます。予算が不足している場合、事後的な連鎖的な取り消しトランザクションは失敗し、全額がブロックヘッダーの`COINBASE`に支払われます。それ以外の場合、すべてのトランザクションが取り消された後の残りの予算がCOINBASEアカウントに支払われます。

状態は`revertNonce`で指定されたトランザクションの開始時点に巻き戻されます。アクセスリストは空で初期化されます。取り消されたトランザクションによって以前に変更された状態がアクセスリストに追加されます。アクセスリストに含まれる状態を読み取ったり使用したりする後続のトランザクションも取り消されなければなりません。この操作は現在のブロックまで連鎖的に進行します。

状態には以下が含まれます:

- イーサ残高
- コントラクトコード
- アカウントのnonce
- ストレージキー

### スナップシンク

このようなトランザクションによって変更される状態が大量にある可能性があるため、より遅いクライアントはスナップシンクを使用して新しい状態を読み込むべきです。

## 根拠

トランザクションはMEV攻撃を防ぐためにブロック全体を埋める必要があります。

一部の連鎖的な取り消しは非常に重大な影響を及ぼしますが、他のものはかなり簡単です。予算は操作の完全なネットワークコストが支払われることを保証します。例えば、間違った受取人への トークン転送を取り消すのは比較的安価です。一方、カストディ型取引所への全ての預金を取り消すのは非常に高価になる可能性があります。

トランザクション手数料は、コンセンサスプロトコルのセキュリティを保護するために、前のブロック報酬ではなくこの予算から返金されなければなりません。

状態ルートが無効な場合、ブロック生成者が罰金を科される可能性があるため、スナップシンクは安全であるはずです。

## 下位互換性

下位互換性の問題が見つかった場合は、それらのトランザクションを取り消すことができるかもしれません。
それでも解決できない場合は、別のハードフォークが必要かもしれません。

## テストケース

- アカウントに資金を提供したことのあるトランザクションを取り消すと、そのアカウントのその後のすべてのトランザクションが取り消されます。
- コントラクトをデプロイしたトランザクションを取り消すと、そのコントラクトとの全てのトランザクションが取り消されます。
- 新しいアカウントへの転送を取り消しても、他のトランザクションは取り消されません。

## 参考実装

簡単そうです。
後で実装します。数時間で完成するはずです。

## セキュリティ上の考慮事項

この仕様はイリノイ州上院議員のRobert Petersによって監査されました。
脆弱性は見つかりませんでした。

## 著作権

著作権およびそれに関連する権利は[CC0](../LICENSE.md)によって放棄されています。